<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Results database &#8212; abiflows 0.5.dev documentation</title>
    <link rel="stylesheet" href="_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="_static/my_style.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Errors and failures" href="failures.html" />
    <link rel="prev" title="Abinit Workflows" href="workflows.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="index.html">
          abiflows</a>
        <span class="navbar-text navbar-version pull-left"><b>0.5.dev</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Getting AbiFlows</a></li>
<li class="toctree-l1"><a class="reference internal" href="setup.html">Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="workflows.html">Abinit Workflows</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Results database</a></li>
<li class="toctree-l1"><a class="reference internal" href="failures.html">Errors and failures</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="useful_links.html">Useful links</a></li>
<li class="toctree-l1"><a class="reference internal" href="zzbiblio.html">Bibliography</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="api/modules.html">abiflows</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">Results database</a><ul>
<li><a class="reference internal" href="#workflow-output">Workflow output</a></li>
<li><a class="reference internal" href="#mongoengine-documents">Mongoengine documents</a></li>
<li><a class="reference internal" href="#database-connection-definition">Database connection definition</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="workflows.html" title="Previous Chapter: Abinit Workflows"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; Abinit Workflows</span>
    </a>
  </li>
  <li>
    <a href="failures.html" title="Next Chapter: Errors and failures"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">Errors and failures &raquo;</span>
    </a>
  </li>
              
            
            
            
            
              <li class="hidden-sm">
<div id="sourcelink">
  <a href="_sources/results_db.rst.txt"
     rel="nofollow">Source</a>
</div></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <div class="section" id="results-database">
<span id="results-db"></span><h1>Results database<a class="headerlink" href="#results-database" title="Permalink to this headline">¶</a></h1>
<p>Abiflows provides an automated way to store the output of the workflow in a
MongoDB database. The default approach is that of storing the output of the
whole workflow in a single document of a MongoDB collection. Each type of
workflow produces one specific output, storing the most relevant information
produced by that workflow. In the following we describe the infrastructure
used to store and retrieve the output documents.</p>
<div class="section" id="workflow-output">
<h2>Workflow output<a class="headerlink" href="#workflow-output" title="Permalink to this headline">¶</a></h2>
<p>The approach in the storage of the results is that in the MongoDB document only
data that are expected to be used are query parameters are included. A few examples
of what this includes are the composition and symmetry of the structure and the main
configuration options of the calculation. Other values that can be found in the
document are some basic output values that are likely to be accessed more frequently
or to be used as a filtering as well, like the final magnetization of the system or
the statistics of execution of the calculations.</p>
<p>On the other hand the fully detailed values of the results rarely needs to be queried
on. In the Abiflows output these values are kept in the native machine readable format
produced directly by Abinit, i.e. in NetCDF files. These files contain the full set of
data produced by the calculations and Abipy offers a full support to analyse and plot
their content. These files are stored in MongoDB GridFS as they are and referenced in the
main document. Usually some files in text format are also stored, both for necessity,
when the mainly supported version of an output file is a text one (e.g. the DDB file),
and for completeness. These files usually cover all the relevant outputs produced
by the workflow.</p>
</div>
<div class="section" id="mongoengine-documents">
<h2>Mongoengine documents<a class="headerlink" href="#mongoengine-documents" title="Permalink to this headline">¶</a></h2>
<p>In order to provide a common base for the standard keywords that are stored in the
database and for the structure of the documents produced by the different workflows,
the interaction with the output database in Abiflows is handled using
<a class="reference external" href="http://mongoengine.org/">mongoengine</a>. For this purpose a set of
mongoengine <code class="docutils literal notranslate"><span class="pre">Document</span></code> objects are implemented in the
<a class="reference internal" href="api/abiflows.database.mongoengine.html#module-abiflows.database.mongoengine.abinit_results" title="abiflows.database.mongoengine.abinit_results"><code class="xref py py-mod docutils literal notranslate"><span class="pre">abiflows.database.mongoengine.abinit_results</span></code></a> module.</p>
<p>From a technical point of view, the results documents are obtained composing different
mixins, each of which define a specific set of properties that are likely to be queried
and that are usually shared by different kinds of workflows (e.g. the
<a class="reference internal" href="api/abiflows.database.mongoengine.html#abiflows.database.mongoengine.mixins.MaterialMixin" title="abiflows.database.mongoengine.mixins.MaterialMixin"><code class="xref py py-class docutils literal notranslate"><span class="pre">abiflows.database.mongoengine.mixins.MaterialMixin</span></code></a>). In this way the uniformity
of the notation for common keywords is guaranteed across the different kind of outputs.</p>
<p>The queries to the documents can be done using the standard mongoengine approach:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">RelaxResult</span><span class="o">.</span><span class="n">objects</span><span class="p">(</span><span class="n">nsites</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">pretty_formula</span><span class="p">)</span>
</pre></div>
</div>
<p>where it is possible to query the properties in the <code class="docutils literal notranslate"><span class="pre">Document</span></code> object. See the
<a class="reference external" href="http://docs.mongoengine.org/guide/index.html">mongoengine user guide</a> for more
details.</p>
</div>
<div class="section" id="database-connection-definition">
<h2>Database connection definition<a class="headerlink" href="#database-connection-definition" title="Permalink to this headline">¶</a></h2>
<p>The information required to connect to the database (e.g. address, username, …)
are stored in a specific object <a class="reference internal" href="api/abiflows.database.mongoengine.html#abiflows.database.mongoengine.utils.DatabaseData" title="abiflows.database.mongoengine.utils.DatabaseData"><code class="xref py py-class docutils literal notranslate"><span class="pre">abiflows.database.mongoengine.utils.DatabaseData</span></code></a>
so that it can be used to define where to store the results and to access, passing
it to the task responsible to generate the document with the output of the workflow.</p>
<p>In addition, since mongoengine uses the name of the class as default name for the collection
where to store and retrieve the data, <code class="docutils literal notranslate"><span class="pre">DatabaseData</span></code> offers a shortcut for the
<a class="reference external" href="http://docs.mongoengine.org/guide/connecting.html#context-managers">switch_collection</a>
method. You can thus use it to query the database, as shown in the <a class="reference internal" href="workflows.html#examples-wf-phonons"><span class="std std-ref">Phonons</span></a>
example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">db</span> <span class="o">=</span> <span class="n">DatabaseData</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;db_address&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">27017</span><span class="p">,</span> <span class="n">collection</span><span class="o">=</span><span class="s1">&#39;collection_name&#39;</span><span class="p">,</span>
                  <span class="n">database</span><span class="o">=</span><span class="s1">&#39;db_name&#39;</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;pass&#39;</span><span class="p">)</span>


<span class="k">with</span> <span class="n">source_db</span><span class="o">.</span><span class="n">switch_collection</span><span class="p">(</span><span class="n">RelaxResult</span><span class="p">)</span> <span class="k">as</span> <span class="n">RelaxResult</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">RelaxResult</span><span class="o">.</span><span class="n">objects</span><span class="p">(</span><span class="n">nsites</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">pretty_formula</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Even though it might be convenient to rely on the mongoengine documents to interact
with the results produced by Abiflows, this is by no means a strict requirement
and the database can be queried using the standard MongoDB connections and queries.</p>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2017, The Abinit group.<br/>
      Last updated on Jan 10, 2020.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.2.0.<br/>
    </p>
  </div>
</footer>
  </body>
</html>