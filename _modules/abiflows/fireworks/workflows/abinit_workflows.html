<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>abiflows.fireworks.workflows.abinit_workflows &#8212; abiflows 0.6 documentation</title>
    <link rel="stylesheet" href="../../../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/my_style.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../../../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../../../../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../../../../_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../../../../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../../index.html">
          abiflows</a>
        <span class="navbar-text navbar-version pull-left"><b>0.6</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation.html">Getting AbiFlows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../setup.html">Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../workflows.html">Abinit Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../results_db.html">Results database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../failures.html">Errors and failures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../changelog.html">Changelog</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../useful_links.html">Useful links</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../zzbiblio.html">Bibliography</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/modules.html">abiflows</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
              
                
              
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <h1>Source code for abiflows.fireworks.workflows.abinit_workflows</h1><div class="highlight"><pre>
<span></span><span class="c1"># coding: utf-8</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Generators of Firework workflows</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">abipy.abio.input_tags</span> <span class="k">as</span> <span class="nn">atags</span>
<span class="kn">import</span> <span class="nn">traceback</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">abipy.abio.factories</span> <span class="kn">import</span> <span class="n">HybridOneShotFromGsFactory</span><span class="p">,</span> <span class="n">ScfFactory</span><span class="p">,</span> <span class="n">IoncellRelaxFromGsFactory</span>
<span class="kn">from</span> <span class="nn">abipy.abio.factories</span> <span class="kn">import</span> <span class="n">PhononsFromGsFactory</span><span class="p">,</span> <span class="n">ScfForPhononsFactory</span><span class="p">,</span> <span class="n">InputFactory</span>
<span class="kn">from</span> <span class="nn">abipy.abio.factories</span> <span class="kn">import</span> <span class="n">ion_ioncell_relax_input</span><span class="p">,</span> <span class="n">scf_input</span><span class="p">,</span> <span class="n">dte_from_gsinput</span><span class="p">,</span> <span class="n">scf_for_phonons</span>
<span class="kn">from</span> <span class="nn">abipy.abio.factories</span> <span class="kn">import</span> <span class="n">dfpt_from_gsinput</span>
<span class="kn">from</span> <span class="nn">abipy.abio.inputs</span> <span class="kn">import</span> <span class="n">AbinitInput</span><span class="p">,</span> <span class="n">AnaddbInput</span>
<span class="kn">from</span> <span class="nn">abipy.abio.abivars_db</span> <span class="kn">import</span> <span class="n">get_abinit_variables</span>
<span class="kn">from</span> <span class="nn">abipy.dfpt.anaddbnc</span> <span class="kn">import</span> <span class="n">AnaddbNcFile</span>
<span class="kn">from</span> <span class="nn">abipy.flowtk.abiobjects</span> <span class="kn">import</span> <span class="n">KSampling</span>
<span class="kn">from</span> <span class="nn">fireworks.core.firework</span> <span class="kn">import</span> <span class="n">Firework</span><span class="p">,</span> <span class="n">Workflow</span><span class="p">,</span> <span class="n">FWorker</span>
<span class="kn">from</span> <span class="nn">fireworks.core.launchpad</span> <span class="kn">import</span> <span class="n">LaunchPad</span>
<span class="kn">from</span> <span class="nn">monty.json</span> <span class="kn">import</span> <span class="n">MontyDecoder</span>

<span class="kn">from</span> <span class="nn">abiflows.core.mastermind_abc</span> <span class="kn">import</span> <span class="n">ControlProcedure</span>
<span class="kn">from</span> <span class="nn">abiflows.core.controllers</span> <span class="kn">import</span> <span class="n">AbinitController</span><span class="p">,</span> <span class="n">WalltimeController</span><span class="p">,</span> <span class="n">MemoryController</span>
<span class="kn">from</span> <span class="nn">abiflows.fireworks.tasks.abinit_tasks</span> <span class="kn">import</span> <span class="n">AbiFireTask</span><span class="p">,</span> <span class="n">ScfFWTask</span><span class="p">,</span> <span class="n">RelaxFWTask</span><span class="p">,</span> <span class="n">NscfFWTask</span><span class="p">,</span> <span class="n">PhononTask</span><span class="p">,</span> <span class="n">BecTask</span><span class="p">,</span> <span class="n">DteTask</span>
<span class="kn">from</span> <span class="nn">abiflows.fireworks.tasks.abinit_tasks_src</span> <span class="kn">import</span> <span class="n">AbinitSetupTask</span><span class="p">,</span> <span class="n">AbinitRunTask</span><span class="p">,</span> <span class="n">AbinitControlTask</span>
<span class="kn">from</span> <span class="nn">abiflows.fireworks.tasks.abinit_tasks_src</span> <span class="kn">import</span> <span class="n">ScfTaskHelper</span><span class="p">,</span> <span class="n">NscfTaskHelper</span><span class="p">,</span> <span class="n">DdkTaskHelper</span>
<span class="kn">from</span> <span class="nn">abiflows.fireworks.tasks.abinit_tasks_src</span> <span class="kn">import</span> <span class="n">RelaxTaskHelper</span>
<span class="kn">from</span> <span class="nn">abiflows.fireworks.tasks.abinit_tasks_src</span> <span class="kn">import</span> <span class="n">GeneratePiezoElasticFlowFWSRCAbinitTask</span>
<span class="kn">from</span> <span class="nn">abiflows.fireworks.tasks.abinit_tasks_src</span> <span class="kn">import</span> <span class="n">Cut3DAbinitTask</span>
<span class="kn">from</span> <span class="nn">abiflows.fireworks.tasks.abinit_tasks_src</span> <span class="kn">import</span> <span class="n">BaderTask</span>
<span class="kn">from</span> <span class="nn">abiflows.fireworks.tasks.abinit_tasks</span> <span class="kn">import</span> <span class="n">HybridFWTask</span><span class="p">,</span> <span class="n">RelaxDilatmxFWTask</span><span class="p">,</span> <span class="n">GeneratePhononFlowFWAbinitTask</span>
<span class="kn">from</span> <span class="nn">abiflows.fireworks.tasks.abinit_tasks</span> <span class="kn">import</span> <span class="n">AutoparalTask</span><span class="p">,</span> <span class="n">DdeTask</span>
<span class="kn">from</span> <span class="nn">abiflows.fireworks.tasks.abinit_tasks</span> <span class="kn">import</span> <span class="n">AnaDdbAbinitTask</span><span class="p">,</span> <span class="n">StrainPertTask</span><span class="p">,</span> <span class="n">DdkTask</span><span class="p">,</span> <span class="n">MergeDdbAbinitTask</span>
<span class="kn">from</span> <span class="nn">abiflows.fireworks.tasks.abinit_tasks</span> <span class="kn">import</span> <span class="n">NscfWfqFWTask</span>
<span class="kn">from</span> <span class="nn">abiflows.fireworks.tasks.src_tasks_abc</span> <span class="kn">import</span> <span class="n">createSRCFireworks</span>
<span class="kn">from</span> <span class="nn">abiflows.fireworks.tasks.utility_tasks</span> <span class="kn">import</span> <span class="n">FinalCleanUpTask</span><span class="p">,</span> <span class="n">DatabaseInsertTask</span><span class="p">,</span> <span class="n">MongoEngineDBInsertionTask</span>
<span class="c1">#from abiflows.fireworks.tasks.utility_tasks import createSRCFireworksOld</span>
<span class="kn">from</span> <span class="nn">abiflows.fireworks.utils.fw_utils</span> <span class="kn">import</span> <span class="n">append_fw_to_wf</span><span class="p">,</span> <span class="n">get_short_single_core_spec</span><span class="p">,</span> <span class="n">links_dict_update</span>
<span class="kn">from</span> <span class="nn">abiflows.fireworks.utils.fw_utils</span> <span class="kn">import</span> <span class="n">set_short_single_core_to_spec</span><span class="p">,</span> <span class="n">get_last_completed_launch</span>
<span class="kn">from</span> <span class="nn">abiflows.fireworks.utils.fw_utils</span> <span class="kn">import</span> <span class="n">get_time_report_for_wf</span><span class="p">,</span> <span class="n">FWTaskManager</span>
<span class="kn">from</span> <span class="nn">abiflows.database.mongoengine.abinit_results</span> <span class="kn">import</span> <span class="n">RelaxResult</span><span class="p">,</span> <span class="n">PhononResult</span><span class="p">,</span> <span class="n">DteResult</span><span class="p">,</span> <span class="n">DfptResult</span>
<span class="kn">from</span> <span class="nn">abiflows.fireworks.utils.task_history</span> <span class="kn">import</span> <span class="n">TaskEvent</span>


<span class="c1"># logging.basicConfig()</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">))</span>


<span class="c1">#TODO AbstractFWWorkflow should not be a subclass of Workflow, should be removed.</span>
<div class="viewcode-block" id="AbstractFWWorkflow"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.AbstractFWWorkflow">[docs]</a><span class="nd">@six</span><span class="o">.</span><span class="n">add_metaclass</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">AbstractFWWorkflow</span><span class="p">(</span><span class="n">Workflow</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract class of the workflow generators.</span>
<span class="sd">    Subclasses should define a &quot;wf&quot; attribute at the end of the init, containing an instance of a fireworks Workflow.</span>
<span class="sd">    Normally subclasses should alse define attributes containing the different Fireworks that have been generated.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="AbstractFWWorkflow.add_to_db"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.AbstractFWWorkflow.add_to_db">[docs]</a>    <span class="k">def</span> <span class="nf">add_to_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lpad</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add the workflows to the fireworks DB.</span>

<span class="sd">        Args:</span>
<span class="sd">            lpad: A LaunchPad. If None the LaunchPad will be generated with auto_load.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: mapping between old and new Firework ids</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">lpad</span><span class="p">:</span>
            <span class="n">lpad</span> <span class="o">=</span> <span class="n">LaunchPad</span><span class="o">.</span><span class="n">auto_load</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">lpad</span><span class="o">.</span><span class="n">add_wf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wf</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractFWWorkflow.append_fw"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.AbstractFWWorkflow.append_fw">[docs]</a>    <span class="k">def</span> <span class="nf">append_fw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw</span><span class="p">,</span> <span class="n">short_single_spec</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Append a Firework at the end of the workflow.</span>

<span class="sd">        Args:</span>
<span class="sd">            fw: A Firework object</span>
<span class="sd">            short_single_spec: if True the _queueadapter parameters will be set to a single core for a short time.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">short_single_spec</span><span class="p">:</span>
            <span class="n">fw</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">set_short_single_core_to_spec</span><span class="p">())</span>
        <span class="n">append_fw_to_wf</span><span class="p">(</span><span class="n">fw</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wf</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractFWWorkflow.set_short_single_core_to_spec"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.AbstractFWWorkflow.set_short_single_core_to_spec">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">set_short_single_core_to_spec</span><span class="p">(</span><span class="n">spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">master_mem_overhead</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the _queueadapter parameter in the spec for a single process job with a short run time.</span>

<span class="sd">        Args:</span>
<span class="sd">            spec: A spec. If None a new dictionary will be created.</span>
<span class="sd">            master_mem_overhead:</span>

<span class="sd">        Returns:</span>
<span class="sd">            The spec with the _queueadapter parameters set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

        <span class="n">qadapter_spec</span> <span class="o">=</span> <span class="n">get_short_single_core_spec</span><span class="p">(</span><span class="n">master_mem_overhead</span><span class="o">=</span><span class="n">master_mem_overhead</span><span class="p">)</span>
        <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;mpi_ncpus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;_queueadapter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qadapter_spec</span>
        <span class="k">return</span> <span class="n">spec</span></div>

<div class="viewcode-block" id="AbstractFWWorkflow.add_mongoengine_db_insertion"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.AbstractFWWorkflow.add_mongoengine_db_insertion">[docs]</a>    <span class="k">def</span> <span class="nf">add_mongoengine_db_insertion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db_data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a Firework containing a task for the insertion of the results in the database, based on mongoengine.</span>

<span class="sd">        Args:</span>
<span class="sd">            db_data: A DatabaseData with the connection information to the database.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">([</span><span class="n">MongoEngineDBInsertionTask</span><span class="p">(</span><span class="n">db_data</span><span class="o">=</span><span class="n">db_data</span><span class="p">)],</span>
                      <span class="n">spec</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;_add_launchpad_and_fw_id&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;DB_insertion&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">append_fw</span><span class="p">(</span><span class="n">fw</span><span class="p">,</span> <span class="n">short_single_spec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractFWWorkflow.add_final_cleanup"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.AbstractFWWorkflow.add_final_cleanup">[docs]</a>    <span class="k">def</span> <span class="nf">add_final_cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_exts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">additional_spec</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a Firework with a FinalCleanUpTask.</span>
<span class="sd">        _queueadapter parameter in the spec are set for a single process job with a short run time</span>

<span class="sd">        Args:</span>
<span class="sd">            out_exts: list of extensions that should be cleaned</span>
<span class="sd">            additional_spec: dict with additional keys to be added to the spec</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">out_exts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out_exts</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;WFK&quot;</span><span class="p">,</span> <span class="s2">&quot;1WF&quot;</span><span class="p">,</span> <span class="s2">&quot;DEN&quot;</span><span class="p">]</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_short_single_core_to_spec</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">additional_spec</span><span class="p">:</span>
            <span class="n">spec</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">additional_spec</span><span class="p">)</span>
        <span class="c1"># high priority</span>
        <span class="c1">#TODO improve the handling of the priorities</span>
        <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;_priority&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;_add_launchpad_and_fw_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">cleanup_fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">(</span><span class="n">FinalCleanUpTask</span><span class="p">(</span><span class="n">out_exts</span><span class="o">=</span><span class="n">out_exts</span><span class="p">),</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span>
                              <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;final_cleanup&quot;</span><span class="p">)[:</span><span class="mi">15</span><span class="p">])</span>

        <span class="n">append_fw_to_wf</span><span class="p">(</span><span class="n">cleanup_fw</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wf</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractFWWorkflow.add_db_insert_and_cleanup"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.AbstractFWWorkflow.add_db_insert_and_cleanup">[docs]</a>    <span class="k">def</span> <span class="nf">add_db_insert_and_cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mongo_database</span><span class="p">,</span> <span class="n">out_exts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">insertion_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                  <span class="n">criteria</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Appends a Firework with a DatabaseInsertTask and a FinalCleanUpTask. N.B. this does not add a</span>
<span class="sd">        MongoEngineDBInsertionTask.</span>

<span class="sd">        Args:</span>
<span class="sd">            mongo_database: a MongoDatabase object describing the connection to the database.</span>
<span class="sd">            out_exts: list of extensions that should be cleaned.</span>
<span class="sd">            insertion_data: dictionary describing the functions that should be called to insert the data.</span>
<span class="sd">            criteria: identifies the entry that should be updated. If None a new entry will be created.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">out_exts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out_exts</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;WFK&quot;</span><span class="p">,</span> <span class="s2">&quot;1WF&quot;</span><span class="p">,</span> <span class="s2">&quot;DEN&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">insertion_data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">insertion_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;structure&#39;</span><span class="p">:</span> <span class="s1">&#39;get_final_structure_and_history&#39;</span><span class="p">}</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_short_single_core_to_spec</span><span class="p">()</span>
        <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;mongo_database&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mongo_database</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
        <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;_add_launchpad_and_fw_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">insert_and_cleanup_fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">([</span><span class="n">DatabaseInsertTask</span><span class="p">(</span><span class="n">insertion_data</span><span class="o">=</span><span class="n">insertion_data</span><span class="p">,</span> <span class="n">criteria</span><span class="o">=</span><span class="n">criteria</span><span class="p">),</span>
                                          <span class="n">FinalCleanUpTask</span><span class="p">(</span><span class="n">out_exts</span><span class="o">=</span><span class="n">out_exts</span><span class="p">)],</span>
                                         <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span>
                                         <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wf</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot;_insclnup&quot;</span><span class="p">)[:</span><span class="mi">15</span><span class="p">])</span>

        <span class="n">append_fw_to_wf</span><span class="p">(</span><span class="n">insert_and_cleanup_fw</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wf</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractFWWorkflow.add_cut3d_den_to_cube_task"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.AbstractFWWorkflow.add_cut3d_den_to_cube_task">[docs]</a>    <span class="k">def</span> <span class="nf">add_cut3d_den_to_cube_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">den_task_type_source</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Appends a FW with a task to convert a DEN file to cube format using cut3d.</span>

<span class="sd">        Args:</span>
<span class="sd">            den_task_type_source: Option to be i.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_short_single_core_to_spec</span><span class="p">()</span>
        <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;_add_launchpad_and_fw_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">den_task_type_source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cut3d_fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">(</span><span class="n">Cut3DAbinitTask</span><span class="o">.</span><span class="n">den_to_cube</span><span class="p">(</span><span class="n">deps</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DEN&#39;</span><span class="p">]),</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span>
                                <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wf</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s2">&quot;_cut3d&quot;</span><span class="p">)[:</span><span class="mi">15</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Cut3D from specified task_type source not yet implemented&#39;</span><span class="p">)</span>

        <span class="n">append_fw_to_wf</span><span class="p">(</span><span class="n">cut3d_fw</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wf</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractFWWorkflow.add_bader_task"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.AbstractFWWorkflow.add_bader_task">[docs]</a>    <span class="k">def</span> <span class="nf">add_bader_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">den_task_type_source</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Appends a FW with a task to calculate the bader charges.</span>

<span class="sd">        Args:</span>
<span class="sd">            den_task_type_source: The task type from which the DEN file should be taken. If None the default is &#39;scf&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_short_single_core_to_spec</span><span class="p">()</span>
        <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;_add_launchpad_and_fw_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">den_task_type_source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">den_task_type_source</span> <span class="o">=</span> <span class="s1">&#39;scf&#39;</span>
        <span class="c1"># Find the Firework that should compute the DEN file</span>
        <span class="n">den_fw</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">control_fw_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">fw_id</span><span class="p">,</span> <span class="n">fw</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">wf</span><span class="o">.</span><span class="n">id_fw</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">AbinitSetupTask</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">task_type</span> <span class="o">==</span> <span class="n">den_task_type_source</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">den_fw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">den_fw</span> <span class="o">=</span> <span class="n">fw</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">task</span><span class="o">.</span><span class="n">pass_input</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Abinit task with task_type &quot;</span><span class="si">{}</span><span class="s1">&quot; should pass the input to the &#39;</span>
                                                 <span class="s1">&#39;Bader task&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">den_task_type_source</span><span class="p">))</span>
                            <span class="n">den_fw_id</span> <span class="o">=</span> <span class="n">fw_id</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wf</span><span class="o">.</span><span class="n">links</span><span class="p">[</span><span class="n">den_fw_id</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;AbinitSetupTask has </span><span class="si">{:d}</span><span class="s1"> children while it should have exactly &#39;</span>
                                                 <span class="s1">&#39;one&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wf</span><span class="o">.</span><span class="n">links</span><span class="p">[</span><span class="n">den_fw_id</span><span class="p">])))</span>
                            <span class="n">run_fw_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wf</span><span class="o">.</span><span class="n">links</span><span class="p">[</span><span class="n">den_fw_id</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wf</span><span class="o">.</span><span class="n">links</span><span class="p">[</span><span class="n">run_fw_id</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;AbinitRunTask has </span><span class="si">{:d}</span><span class="s1"> children while it should have exactly &#39;</span>
                                                 <span class="s1">&#39;one&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wf</span><span class="o">.</span><span class="n">links</span><span class="p">[</span><span class="n">run_fw_id</span><span class="p">])))</span>
                            <span class="n">control_fw_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wf</span><span class="o">.</span><span class="n">links</span><span class="p">[</span><span class="n">run_fw_id</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Found more than one Firework with Abinit &#39;</span>
                                             <span class="s1">&#39;task_type &quot;</span><span class="si">{}</span><span class="s1">&quot;.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">den_task_type_source</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">den_fw</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Firework with Abinit task_type &quot;</span><span class="si">{}</span><span class="s1">&quot; not found.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">den_task_type_source</span><span class="p">))</span>
        <span class="c1"># # Set the pass_input variable of the task to True (needed to get the pseudo valence electrons)</span>
        <span class="c1"># for task in den_fw.tasks:</span>
        <span class="c1">#     if isinstance(task, AbinitSetupTask):</span>
        <span class="c1">#         task.pass_input = True</span>
        <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;den_task_type_source&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">den_task_type_source</span>
        <span class="n">cut3d_task</span> <span class="o">=</span> <span class="n">Cut3DAbinitTask</span><span class="o">.</span><span class="n">den_to_cube</span><span class="p">(</span><span class="n">deps</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DEN&#39;</span><span class="p">])</span>
        <span class="n">bader_task</span> <span class="o">=</span> <span class="n">BaderTask</span><span class="p">()</span>
        <span class="n">bader_fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">([</span><span class="n">cut3d_task</span><span class="p">,</span> <span class="n">bader_task</span><span class="p">],</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span>
                            <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;bader&quot;</span><span class="p">)[:</span><span class="mi">15</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wf</span><span class="o">.</span><span class="n">append_wf</span><span class="p">(</span><span class="n">new_wf</span><span class="o">=</span><span class="n">Workflow</span><span class="o">.</span><span class="n">from_Firework</span><span class="p">(</span><span class="n">bader_fw</span><span class="p">),</span> <span class="n">fw_ids</span><span class="o">=</span><span class="p">[</span><span class="n">control_fw_id</span><span class="p">],</span>
                          <span class="n">detour</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pull_spec_mods</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractFWWorkflow.get_bader_charges"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.AbstractFWWorkflow.get_bader_charges">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_bader_charges</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">wf</span><span class="p">):</span>
        <span class="c1"># I dont think we need that here ...</span>
        <span class="c1"># assert wf.metadata[&#39;workflow_class&#39;] == self.workflow_class</span>
        <span class="c1"># assert wf.metadata[&#39;workflow_module&#39;] == self.workflow_module</span>
        <span class="n">final_fw_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">fw_id</span><span class="p">,</span> <span class="n">fw</span> <span class="ow">in</span> <span class="n">wf</span><span class="o">.</span><span class="n">id_fw</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">fw</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;bader&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">final_fw_id</span><span class="p">:</span>
                    <span class="n">final_fw_id</span> <span class="o">=</span> <span class="n">fw_id</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Multiple Fireworks found with name equal to &quot;bader&quot;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">final_fw_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Bader analysis not found ...&#39;</span><span class="p">)</span>
        <span class="n">myfw</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">id_fw</span><span class="p">[</span><span class="n">final_fw_id</span><span class="p">]</span>
        <span class="c1">#TODO add a check on the state of the launches</span>
        <span class="n">last_launch</span> <span class="o">=</span> <span class="p">(</span><span class="n">myfw</span><span class="o">.</span><span class="n">archived_launches</span> <span class="o">+</span> <span class="n">myfw</span><span class="o">.</span><span class="n">launches</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1">#TODO add a cycle to find the instance of AbiFireTask?</span>
        <span class="n">myfw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">setup_rundir</span><span class="p">(</span><span class="n">rundir</span><span class="o">=</span><span class="n">last_launch</span><span class="o">.</span><span class="n">launch_dir</span><span class="p">)</span>
        <span class="n">bader_data</span> <span class="o">=</span> <span class="n">myfw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_bader_data</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">myfw</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;previous_fws&#39;</span><span class="p">][</span><span class="n">myfw</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;den_task_type_source&#39;</span><span class="p">]])</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Found &quot;</span><span class="si">{:d}</span><span class="s1">&quot; previous fws with task_type &quot;</span><span class="si">{}</span><span class="s1">&quot; while there should be only &#39;</span>
                             <span class="s1">&#39;one.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">myfw</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;previous_fws&#39;</span><span class="p">][</span><span class="n">myfw</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;den_task_type_source&#39;</span><span class="p">]]),</span>
                                           <span class="n">myfw</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;den_task_type_source&#39;</span><span class="p">]))</span>
        <span class="n">abinit_input</span> <span class="o">=</span> <span class="n">myfw</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;previous_fws&#39;</span><span class="p">][</span><span class="n">myfw</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;den_task_type_source&#39;</span><span class="p">]][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;input&#39;</span><span class="p">]</span>
        <span class="n">psp_valences</span> <span class="o">=</span> <span class="n">abinit_input</span><span class="o">.</span><span class="n">valence_electrons_per_atom</span>
        <span class="n">bader_charges</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="p">[</span><span class="s1">&#39;charge&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">bader_data</span><span class="p">]</span>
        <span class="n">bader_charges_transfer</span> <span class="o">=</span> <span class="p">[</span><span class="n">bader_charges</span><span class="p">[</span><span class="n">iatom</span><span class="p">]</span><span class="o">-</span><span class="n">psp_valences</span><span class="p">[</span><span class="n">iatom</span><span class="p">]</span> <span class="k">for</span> <span class="n">iatom</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">psp_valences</span><span class="p">))]</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;bader_analysis&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;pseudo_valence_charges&#39;</span><span class="p">:</span> <span class="n">psp_valences</span><span class="p">,</span>
                                   <span class="s1">&#39;bader_charges&#39;</span><span class="p">:</span> <span class="n">bader_charges</span><span class="p">,</span>
                                   <span class="s1">&#39;bader_charges_transfer&#39;</span><span class="p">:</span> <span class="n">bader_charges_transfer</span><span class="p">}}</span></div>

<div class="viewcode-block" id="AbstractFWWorkflow.add_metadata"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.AbstractFWWorkflow.add_metadata">[docs]</a>    <span class="k">def</span> <span class="nf">add_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">additional_metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">additional_metadata</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">additional_metadata</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">wf_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">structure</span><span class="p">:</span>
            <span class="n">composition</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">composition</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;nsites&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;elements&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span><span class="o">.</span><span class="n">symbol</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">composition</span><span class="o">.</span><span class="n">elements</span><span class="p">]</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;reduced_formula&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">composition</span><span class="o">.</span><span class="n">reduced_formula</span>

        <span class="n">metadata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">additional_metadata</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wf</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractFWWorkflow.get_reduced_formula"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.AbstractFWWorkflow.get_reduced_formula">[docs]</a>    <span class="k">def</span> <span class="nf">get_reduced_formula</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the reduced formula of the structure used in the workflow.</span>

<span class="sd">        Args:</span>
<span class="sd">            input: An |AbinitInput| object or a |Structure|</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">structure</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">AbinitInput</span><span class="p">):</span>
                <span class="n">structure</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">structure</span>
            <span class="k">elif</span> <span class="s1">&#39;structure&#39;</span> <span class="ow">in</span> <span class="nb">input</span><span class="o">.</span><span class="n">kwargs</span><span class="p">:</span>
                <span class="n">structure</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;structure&#39;</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="n">InputFactory</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">structure</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                    <span class="n">structure</span> <span class="o">=</span> <span class="nb">input</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;structure&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t get the structure from the input: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()))</span>

        <span class="k">return</span> <span class="n">structure</span><span class="o">.</span><span class="n">composition</span><span class="o">.</span><span class="n">reduced_formula</span> <span class="k">if</span> <span class="n">structure</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span></div>

<div class="viewcode-block" id="AbstractFWWorkflow.add_spec_to_all_fws"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.AbstractFWWorkflow.add_spec_to_all_fws">[docs]</a>    <span class="k">def</span> <span class="nf">add_spec_to_all_fws</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the spec of all the Fireworks with the input dictionary</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">fw</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">wf</span><span class="o">.</span><span class="n">fws</span><span class="p">:</span>
            <span class="n">fw</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbstractFWWorkflow.set_preserve_fworker"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.AbstractFWWorkflow.set_preserve_fworker">[docs]</a>    <span class="k">def</span> <span class="nf">set_preserve_fworker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the _preserve_fworker key in the spec of all the Fireworks</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_spec_to_all_fws</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">_preserve_fworker</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span></div>

<div class="viewcode-block" id="AbstractFWWorkflow.fix_fworker"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.AbstractFWWorkflow.fix_fworker">[docs]</a>    <span class="k">def</span> <span class="nf">fix_fworker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the _fworker key to the name specified and adds _preserve_fworker to the spec of all the fws.</span>
<span class="sd">        If name is None the name is taken from the FWorker loaded with FWorker.auto_load (the default being the</span>
<span class="sd">        file ~/.fireworks/my_fworker.yaml)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">FWorker</span><span class="o">.</span><span class="n">auto_load</span><span class="p">()</span><span class="o">.</span><span class="n">name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_spec_to_all_fws</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">_preserve_fworker</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">_fworker</span><span class="o">=</span><span class="n">name</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="InputFWWorkflow"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.InputFWWorkflow">[docs]</a><span class="k">class</span> <span class="nc">InputFWWorkflow</span><span class="p">(</span><span class="n">AbstractFWWorkflow</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generator of a fireworks workflow with a single abinit task based on a generic |AbinitInput|.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">abiinput</span><span class="p">,</span> <span class="n">task_type</span><span class="o">=</span><span class="n">AbiFireTask</span><span class="p">,</span> <span class="n">autoparal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initialization_info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            abiinput: an |AbinitInput| object</span>
<span class="sd">            task_type: the class of the task created</span>
<span class="sd">            autoparal: if True autoparal will be used at runtime to optimize the number of processes.</span>
<span class="sd">            spec: a dict with additional spec for the Firework.</span>
<span class="sd">            initialization_info: a dict defining additional information about the initialization of the workflow.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">initialization_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">initialization_info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">abitask</span> <span class="o">=</span> <span class="n">task_type</span><span class="p">(</span><span class="n">abiinput</span><span class="p">,</span> <span class="n">is_autoparal</span><span class="o">=</span><span class="n">autoparal</span><span class="p">)</span>

        <span class="n">spec</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;initialization_info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initialization_info</span>
        <span class="k">if</span> <span class="n">autoparal</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_short_single_core_to_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">(</span><span class="n">abitask</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wf</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">fw</span><span class="p">])</span></div>


<div class="viewcode-block" id="ScfFWWorkflow"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.ScfFWWorkflow">[docs]</a><span class="k">class</span> <span class="nc">ScfFWWorkflow</span><span class="p">(</span><span class="n">AbstractFWWorkflow</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generator of a fireworks workflow with a single abinit task performing a SCF calculation</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">abiinput</span><span class="p">,</span> <span class="n">autoparal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initialization_info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            abiinput: an |AbinitInput| object for a SCF calculation.</span>
<span class="sd">            autoparal: if True autoparal will be used at runtime to optimize the number of processes.</span>
<span class="sd">            spec: a dict with additional spec for the Firework.</span>
<span class="sd">            initialization_info: a dict defining additional information about the initialization of the workflow.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">initialization_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">initialization_info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">abitask</span> <span class="o">=</span> <span class="n">ScfFWTask</span><span class="p">(</span><span class="n">abiinput</span><span class="p">,</span> <span class="n">is_autoparal</span><span class="o">=</span><span class="n">autoparal</span><span class="p">)</span>

        <span class="n">spec</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;initialization_info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initialization_info</span>
        <span class="n">start_task_index</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">autoparal</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_short_single_core_to_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
            <span class="n">start_task_index</span> <span class="o">=</span> <span class="s1">&#39;autoparal&#39;</span>

        <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;wf_task_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;scf_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">start_task_index</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scf_fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">(</span><span class="n">abitask</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wf</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">scf_fw</span><span class="p">])</span>

<div class="viewcode-block" id="ScfFWWorkflow.from_factory"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.ScfFWWorkflow.from_factory">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_factory</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">pseudos</span><span class="p">,</span> <span class="n">kppa</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ecut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pawecutdg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nband</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">accuracy</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span>
                     <span class="n">spin_mode</span><span class="o">=</span><span class="s2">&quot;polarized&quot;</span><span class="p">,</span> <span class="n">smearing</span><span class="o">=</span><span class="s2">&quot;fermi_dirac:0.1 eV&quot;</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">scf_algorithm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">shift_mode</span><span class="o">=</span><span class="s2">&quot;Monkhorst-Pack&quot;</span><span class="p">,</span> <span class="n">extra_abivars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">decorators</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">autoparal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">initialization_info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates an instance of ScfFWWorkflow using the scf_input factory function. See the description</span>
<span class="sd">        of the factory for the definition of the arguments.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">extra_abivars</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">extra_abivars</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">decorators</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">decorators</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">initialization_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">initialization_info</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">abiinput</span> <span class="o">=</span> <span class="n">scf_input</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">pseudos</span><span class="p">,</span> <span class="n">kppa</span><span class="o">=</span><span class="n">kppa</span><span class="p">,</span> <span class="n">ecut</span><span class="o">=</span><span class="n">ecut</span><span class="p">,</span> <span class="n">pawecutdg</span><span class="o">=</span><span class="n">pawecutdg</span><span class="p">,</span> <span class="n">nband</span><span class="o">=</span><span class="n">nband</span><span class="p">,</span>
                             <span class="n">accuracy</span><span class="o">=</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">spin_mode</span><span class="o">=</span><span class="n">spin_mode</span><span class="p">,</span> <span class="n">smearing</span><span class="o">=</span><span class="n">smearing</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="n">charge</span><span class="p">,</span>
                             <span class="n">scf_algorithm</span><span class="o">=</span><span class="n">scf_algorithm</span><span class="p">,</span> <span class="n">shift_mode</span><span class="o">=</span><span class="n">shift_mode</span><span class="p">)</span>
        <span class="n">abiinput</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">extra_abivars</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">decorators</span><span class="p">:</span>
            <span class="n">d</span><span class="p">(</span><span class="n">abiinput</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">abiinput</span><span class="p">,</span> <span class="n">autoparal</span><span class="o">=</span><span class="n">autoparal</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">initialization_info</span><span class="o">=</span><span class="n">initialization_info</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ScfFWWorkflowSRC"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.ScfFWWorkflowSRC">[docs]</a><span class="k">class</span> <span class="nc">ScfFWWorkflowSRC</span><span class="p">(</span><span class="n">AbstractFWWorkflow</span><span class="p">):</span>

    <span class="n">workflow_class</span> <span class="o">=</span> <span class="s1">&#39;ScfFWWorkflowSRC&#39;</span>
    <span class="n">workflow_module</span> <span class="o">=</span> <span class="s1">&#39;abiflows.fireworks.workflows.abinit_workflows&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">abiinput</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initialization_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pass_input</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">initialization_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">initialization_info</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">scf_helper</span> <span class="o">=</span> <span class="n">ScfTaskHelper</span><span class="p">()</span>
        <span class="n">control_procedure</span> <span class="o">=</span> <span class="n">ControlProcedure</span><span class="p">(</span><span class="n">controllers</span><span class="o">=</span><span class="p">[</span><span class="n">AbinitController</span><span class="o">.</span><span class="n">from_helper</span><span class="p">(</span><span class="n">scf_helper</span><span class="p">),</span>
                                                          <span class="n">WalltimeController</span><span class="p">(),</span> <span class="n">MemoryController</span><span class="p">()])</span>
        <span class="n">setup_task</span> <span class="o">=</span> <span class="n">AbinitSetupTask</span><span class="p">(</span><span class="n">abiinput</span><span class="o">=</span><span class="n">abiinput</span><span class="p">,</span> <span class="n">task_helper</span><span class="o">=</span><span class="n">scf_helper</span><span class="p">,</span> <span class="n">pass_input</span><span class="o">=</span><span class="n">pass_input</span><span class="p">)</span>
        <span class="n">run_task</span> <span class="o">=</span> <span class="n">AbinitRunTask</span><span class="p">(</span><span class="n">control_procedure</span><span class="o">=</span><span class="n">control_procedure</span><span class="p">,</span> <span class="n">task_helper</span><span class="o">=</span><span class="n">scf_helper</span><span class="p">)</span>
        <span class="n">control_task</span> <span class="o">=</span> <span class="n">AbinitControlTask</span><span class="p">(</span><span class="n">control_procedure</span><span class="o">=</span><span class="n">control_procedure</span><span class="p">,</span> <span class="n">task_helper</span><span class="o">=</span><span class="n">scf_helper</span><span class="p">)</span>

        <span class="n">scf_fws</span> <span class="o">=</span> <span class="n">createSRCFireworks</span><span class="p">(</span><span class="n">setup_task</span><span class="o">=</span><span class="n">setup_task</span><span class="p">,</span> <span class="n">run_task</span><span class="o">=</span><span class="n">run_task</span><span class="p">,</span> <span class="n">control_task</span><span class="o">=</span><span class="n">control_task</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span>
                                     <span class="n">task_index</span><span class="o">=</span><span class="s1">&#39;scf&#39;</span><span class="p">,</span> <span class="n">initialization_info</span><span class="o">=</span><span class="n">initialization_info</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wf</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">fireworks</span><span class="o">=</span><span class="n">scf_fws</span><span class="p">[</span><span class="s1">&#39;fws&#39;</span><span class="p">],</span> <span class="n">links_dict</span><span class="o">=</span><span class="n">scf_fws</span><span class="p">[</span><span class="s1">&#39;links_dict&#39;</span><span class="p">],</span>
                           <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;workflow_class&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow_class</span><span class="p">,</span>
                                     <span class="s1">&#39;workflow_module&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow_module</span><span class="p">})</span>

<div class="viewcode-block" id="ScfFWWorkflowSRC.from_factory"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.ScfFWWorkflowSRC.from_factory">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_factory</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">pseudos</span><span class="p">,</span> <span class="n">kppa</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ecut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pawecutdg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nband</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">accuracy</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span>
                     <span class="n">spin_mode</span><span class="o">=</span><span class="s2">&quot;polarized&quot;</span><span class="p">,</span> <span class="n">smearing</span><span class="o">=</span><span class="s2">&quot;fermi_dirac:0.1 eV&quot;</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">scf_algorithm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">shift_mode</span><span class="o">=</span><span class="s2">&quot;Monkhorst-Pack&quot;</span><span class="p">,</span> <span class="n">extra_abivars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">decorators</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">autoparal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">initialization_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pass_input</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">extra_abivars</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">extra_abivars</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">decorators</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">decorators</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">initialization_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">initialization_info</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">abiinput</span> <span class="o">=</span> <span class="n">scf_input</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">pseudos</span><span class="p">,</span> <span class="n">kppa</span><span class="o">=</span><span class="n">kppa</span><span class="p">,</span> <span class="n">ecut</span><span class="o">=</span><span class="n">ecut</span><span class="p">,</span> <span class="n">pawecutdg</span><span class="o">=</span><span class="n">pawecutdg</span><span class="p">,</span> <span class="n">nband</span><span class="o">=</span><span class="n">nband</span><span class="p">,</span>
                             <span class="n">accuracy</span><span class="o">=</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">spin_mode</span><span class="o">=</span><span class="n">spin_mode</span><span class="p">,</span> <span class="n">smearing</span><span class="o">=</span><span class="n">smearing</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="n">charge</span><span class="p">,</span>
                             <span class="n">scf_algorithm</span><span class="o">=</span><span class="n">scf_algorithm</span><span class="p">,</span> <span class="n">shift_mode</span><span class="o">=</span><span class="n">shift_mode</span><span class="p">)</span>
        <span class="n">abiinput</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">extra_abivars</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">decorators</span><span class="p">:</span>
            <span class="n">d</span><span class="p">(</span><span class="n">abiinput</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">abiinput</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">initialization_info</span><span class="o">=</span><span class="n">initialization_info</span><span class="p">,</span> <span class="n">pass_input</span><span class="o">=</span><span class="n">pass_input</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="RelaxFWWorkflow"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.RelaxFWWorkflow">[docs]</a><span class="k">class</span> <span class="nc">RelaxFWWorkflow</span><span class="p">(</span><span class="n">AbstractFWWorkflow</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generator of a firework workflow performing a relax of structure (atomic positions, cell shape and size).</span>
<span class="sd">    Can converge the dilatmx during the cell relaxtion up to a custom value.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">workflow_class</span> <span class="o">=</span> <span class="s1">&#39;RelaxFWWorkflow&#39;</span>
    <span class="n">workflow_module</span> <span class="o">=</span> <span class="s1">&#39;abiflows.fireworks.workflows.abinit_workflows&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ion_input</span><span class="p">,</span> <span class="n">ioncell_input</span><span class="p">,</span> <span class="n">autoparal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initialization_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">target_dilatmx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip_ion</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            ion_input: an AbinitInput for the relax of the atomic position calculation.</span>
<span class="sd">            ioncell_input: an AbinitInput for the relax of both atomic position and cell size and shape.</span>
<span class="sd">            autoparal: if True autoparal will be used at runtime to optimize the number of processes.</span>
<span class="sd">            spec: a dict with additional spec for the Firework.</span>
<span class="sd">            initialization_info: a dict defining additional information about the initialization of the workflow.</span>
<span class="sd">            target_dilatmx: target value for the dilatmx. The workflow will progressively reduce the value of</span>
<span class="sd">                dilatmx and relax the structure again until this value is reached.</span>
<span class="sd">            skip_ion: if True the first step with relax of the atomic position will not be performed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">initialization_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">initialization_info</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">start_task_index</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;initialization_info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initialization_info</span>
        <span class="k">if</span> <span class="n">autoparal</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_short_single_core_to_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
            <span class="n">start_task_index</span> <span class="o">=</span> <span class="s1">&#39;autoparal&#39;</span>

        <span class="n">fws</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">deps</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_ion</span><span class="p">:</span>
            <span class="n">rf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_reduced_formula</span><span class="p">(</span><span class="n">ion_input</span><span class="p">)</span>
            <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;wf_task_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ion_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">start_task_index</span><span class="p">)</span>
            <span class="n">ion_task</span> <span class="o">=</span> <span class="n">RelaxFWTask</span><span class="p">(</span><span class="n">ion_input</span><span class="p">,</span> <span class="n">is_autoparal</span><span class="o">=</span><span class="n">autoparal</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ion_fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">(</span><span class="n">ion_task</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">rf</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;relax_ion&quot;</span><span class="p">)</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="p">{</span><span class="n">ion_task</span><span class="o">.</span><span class="n">task_type</span><span class="p">:</span> <span class="s1">&#39;@structure&#39;</span><span class="p">}</span>
            <span class="n">fws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ion_fw</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_reduced_formula</span><span class="p">(</span><span class="n">ioncell_input</span><span class="p">)</span>

        <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;wf_task_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ioncell_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">start_task_index</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">target_dilatmx</span><span class="p">:</span>
            <span class="n">ioncell_task</span> <span class="o">=</span> <span class="n">RelaxDilatmxFWTask</span><span class="p">(</span><span class="n">ioncell_input</span><span class="p">,</span> <span class="n">is_autoparal</span><span class="o">=</span><span class="n">autoparal</span><span class="p">,</span> <span class="n">target_dilatmx</span><span class="o">=</span><span class="n">target_dilatmx</span><span class="p">,</span>
                                              <span class="n">deps</span><span class="o">=</span><span class="n">deps</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ioncell_task</span> <span class="o">=</span> <span class="n">RelaxFWTask</span><span class="p">(</span><span class="n">ioncell_input</span><span class="p">,</span> <span class="n">is_autoparal</span><span class="o">=</span><span class="n">autoparal</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="n">deps</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ioncell_fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">(</span><span class="n">ioncell_task</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">rf</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="s2">&quot;relax_ioncell&quot;</span><span class="p">)</span>

        <span class="n">fws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ioncell_fw</span><span class="p">)</span>

        <span class="n">fw_deps</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">skip_ion</span> <span class="k">else</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ion_fw</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ioncell_fw</span><span class="p">]}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wf</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">fws</span><span class="p">,</span> <span class="n">fw_deps</span><span class="p">,</span>
                           <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;workflow_class&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow_class</span><span class="p">,</span>
                                     <span class="s1">&#39;workflow_module&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow_module</span><span class="p">})</span>

<div class="viewcode-block" id="RelaxFWWorkflow.get_final_structure_and_history"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.RelaxFWWorkflow.get_final_structure_and_history">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_final_structure_and_history</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">wf</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">wf</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;workflow_class&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">workflow_class</span>
        <span class="k">assert</span> <span class="n">wf</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;workflow_module&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">workflow_module</span>
        <span class="n">ioncell</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">final_fw_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">fw_id</span><span class="p">,</span> <span class="n">fw</span> <span class="ow">in</span> <span class="n">wf</span><span class="o">.</span><span class="n">id_fw</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;wf_task_index&#39;</span> <span class="ow">in</span> <span class="n">fw</span><span class="o">.</span><span class="n">spec</span> <span class="ow">and</span> <span class="n">fw</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;wf_task_index&#39;</span><span class="p">][:</span><span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ioncell_&#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">this_ioncell</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fw</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;wf_task_index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="c1"># skip if the index is not an int</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">this_ioncell</span> <span class="o">&gt;</span> <span class="n">ioncell</span><span class="p">:</span>
                    <span class="n">ioncell</span> <span class="o">=</span> <span class="n">this_ioncell</span>
                    <span class="n">final_fw_id</span> <span class="o">=</span> <span class="n">fw_id</span>
        <span class="k">if</span> <span class="n">final_fw_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Final structure not found ...&#39;</span><span class="p">)</span>
        <span class="n">myfw</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">id_fw</span><span class="p">[</span><span class="n">final_fw_id</span><span class="p">]</span>
        <span class="c1">#TODO add a check on the state of the launches</span>
        <span class="n">last_launch</span> <span class="o">=</span> <span class="p">(</span><span class="n">myfw</span><span class="o">.</span><span class="n">archived_launches</span> <span class="o">+</span> <span class="n">myfw</span><span class="o">.</span><span class="n">launches</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1">#TODO add a cycle to find the instance of AbiFireTask?</span>
        <span class="n">myfw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_workdir</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">last_launch</span><span class="o">.</span><span class="n">launch_dir</span><span class="p">)</span>
        <span class="n">structure</span> <span class="o">=</span> <span class="n">myfw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_final_structure</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">last_launch</span><span class="o">.</span><span class="n">launch_dir</span><span class="p">,</span> <span class="s1">&#39;history.json&#39;</span><span class="p">),</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">history</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">MontyDecoder</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;structure&#39;</span><span class="p">:</span> <span class="n">structure</span><span class="o">.</span><span class="n">as_dict</span><span class="p">(),</span> <span class="s1">&#39;history&#39;</span><span class="p">:</span> <span class="n">history</span><span class="p">}</span></div>

<div class="viewcode-block" id="RelaxFWWorkflow.get_runtime_secs"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.RelaxFWWorkflow.get_runtime_secs">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_runtime_secs</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">wf</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">wf</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;workflow_class&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">workflow_class</span>
        <span class="k">assert</span> <span class="n">wf</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;workflow_module&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">workflow_module</span>
        <span class="n">time_secs</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">fw_id</span><span class="p">,</span> <span class="n">fw</span> <span class="ow">in</span> <span class="n">wf</span><span class="o">.</span><span class="n">id_fw</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;wf_task_index&#39;</span> <span class="ow">in</span> <span class="n">fw</span><span class="o">.</span><span class="n">spec</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fw</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;wf_task_index&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">9</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;autoparal&#39;</span><span class="p">:</span>
                    <span class="n">time_secs</span> <span class="o">+=</span> <span class="n">fw</span><span class="o">.</span><span class="n">launches</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">runtime_secs</span>
                <span class="k">elif</span> <span class="n">fw</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;wf_task_index&#39;</span><span class="p">][:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ion_&#39;</span><span class="p">:</span>
                    <span class="n">time_secs</span> <span class="o">+=</span> <span class="n">fw</span><span class="o">.</span><span class="n">launches</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">runtime_secs</span> <span class="o">*</span> <span class="n">fw</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;mpi_ncpus&#39;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">fw</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;wf_task_index&#39;</span><span class="p">][:</span><span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;ioncell_&#39;</span><span class="p">:</span>
                    <span class="n">time_secs</span> <span class="o">+=</span> <span class="n">fw</span><span class="o">.</span><span class="n">launches</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">runtime_secs</span> <span class="o">*</span> <span class="n">fw</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;mpi_ncpus&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">time_secs</span></div>

<div class="viewcode-block" id="RelaxFWWorkflow.get_mongoengine_results"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.RelaxFWWorkflow.get_mongoengine_results">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_mongoengine_results</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">wf</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates the RelaxResult mongoengine document containing the results of the calculation.</span>
<span class="sd">        The workflow should have been generated from this class and requires an open connection to the</span>
<span class="sd">        fireworks database and access to the file system containing the calculations.</span>

<span class="sd">        Args:</span>
<span class="sd">            wf: the fireworks Workflow instance of the workflow.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A RelaxResult document.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="n">wf</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;workflow_class&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">workflow_class</span>
        <span class="k">assert</span> <span class="n">wf</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;workflow_module&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">workflow_module</span>

        <span class="n">ioncell_fws</span> <span class="o">=</span> <span class="p">[</span><span class="n">fw</span> <span class="k">for</span> <span class="n">fw</span> <span class="ow">in</span> <span class="n">wf</span><span class="o">.</span><span class="n">fws</span> <span class="k">if</span> <span class="n">fw</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wf_task_index&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ioncell_&#39;</span><span class="p">)</span>
                       <span class="ow">and</span> <span class="ow">not</span> <span class="n">fw</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wf_task_index&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;autoparal&#39;</span><span class="p">)]</span>
        <span class="n">ioncell_fws</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wf_task_index&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">last_ioncell_fw</span> <span class="o">=</span> <span class="n">ioncell_fws</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">last_ioncell_launch</span> <span class="o">=</span> <span class="n">get_last_completed_launch</span><span class="p">(</span><span class="n">last_ioncell_fw</span><span class="p">)</span>

        <span class="n">ion_fws</span> <span class="o">=</span> <span class="p">[</span><span class="n">fw</span> <span class="k">for</span> <span class="n">fw</span> <span class="ow">in</span> <span class="n">wf</span><span class="o">.</span><span class="n">fws</span> <span class="k">if</span> <span class="n">fw</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wf_task_index&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ion_&#39;</span><span class="p">)</span>
                   <span class="ow">and</span> <span class="ow">not</span> <span class="n">fw</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wf_task_index&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;autoparal&#39;</span><span class="p">)]</span>
        <span class="n">ion_fws</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wf_task_index&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">ion_fws</span><span class="p">:</span>
            <span class="n">first_fw</span> <span class="o">=</span> <span class="n">ion_fws</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">first_fw</span> <span class="o">=</span> <span class="n">ioncell_fws</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">relax_task</span> <span class="o">=</span> <span class="n">last_ioncell_fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">relax_task</span><span class="o">.</span><span class="n">set_workdir</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">last_ioncell_launch</span><span class="o">.</span><span class="n">launch_dir</span><span class="p">)</span>
        <span class="n">structure</span> <span class="o">=</span> <span class="n">relax_task</span><span class="o">.</span><span class="n">get_final_structure</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">last_ioncell_launch</span><span class="o">.</span><span class="n">launch_dir</span><span class="p">,</span> <span class="s1">&#39;history.json&#39;</span><span class="p">),</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">history_ioncell</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">MontyDecoder</span><span class="p">)</span>

        <span class="n">document</span> <span class="o">=</span> <span class="n">RelaxResult</span><span class="p">()</span>

        <span class="n">document</span><span class="o">.</span><span class="n">abinit_output</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
        <span class="n">document</span><span class="o">.</span><span class="n">set_material_data_from_structure</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>

        <span class="n">final_input</span> <span class="o">=</span> <span class="n">history_ioncell</span><span class="o">.</span><span class="n">get_events_by_types</span><span class="p">(</span><span class="n">TaskEvent</span><span class="o">.</span><span class="n">FINALIZED</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">details</span><span class="p">[</span><span class="s1">&#39;final_input&#39;</span><span class="p">]</span>
        <span class="n">document</span><span class="o">.</span><span class="n">abinit_input</span><span class="o">.</span><span class="n">last_input</span> <span class="o">=</span> <span class="n">final_input</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
        <span class="n">document</span><span class="o">.</span><span class="n">abinit_input</span><span class="o">.</span><span class="n">set_abinit_basic_from_abinit_input</span><span class="p">(</span><span class="n">final_input</span><span class="p">)</span>
        <span class="c1"># need to set the structure as the initial one</span>
        <span class="n">document</span><span class="o">.</span><span class="n">abinit_input</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="n">first_fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>

        <span class="n">document</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">history_ioncell</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>

        <span class="n">document</span><span class="o">.</span><span class="n">set_dir_names_from_fws_wf</span><span class="p">(</span><span class="n">wf</span><span class="p">)</span>

        <span class="n">initialization_info</span> <span class="o">=</span> <span class="n">history_ioncell</span><span class="o">.</span><span class="n">get_events_by_types</span><span class="p">(</span><span class="n">TaskEvent</span><span class="o">.</span><span class="n">INITIALIZED</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;initialization_info&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">document</span><span class="o">.</span><span class="n">abinit_input</span><span class="o">.</span><span class="n">kppa</span> <span class="o">=</span> <span class="n">initialization_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kppa&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">document</span><span class="o">.</span><span class="n">mp_id</span> <span class="o">=</span> <span class="n">initialization_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mp_id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">document</span><span class="o">.</span><span class="n">custom</span> <span class="o">=</span> <span class="n">initialization_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;custom&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">document</span><span class="o">.</span><span class="n">abinit_input</span><span class="o">.</span><span class="n">pseudopotentials</span><span class="o">.</span><span class="n">set_pseudos_from_files_file</span><span class="p">(</span><span class="n">relax_task</span><span class="o">.</span><span class="n">files_file</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                                                                           <span class="nb">len</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">composition</span><span class="o">.</span><span class="n">elements</span><span class="p">))</span>

        <span class="n">document</span><span class="o">.</span><span class="n">time_report</span> <span class="o">=</span> <span class="n">get_time_report_for_wf</span><span class="p">(</span><span class="n">wf</span><span class="p">)</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>

        <span class="n">document</span><span class="o">.</span><span class="n">fw_id</span> <span class="o">=</span> <span class="n">last_ioncell_fw</span><span class="o">.</span><span class="n">fw_id</span>

        <span class="n">document</span><span class="o">.</span><span class="n">created_on</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">document</span><span class="o">.</span><span class="n">modified_on</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">relax_task</span><span class="o">.</span><span class="n">gsr_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">document</span><span class="o">.</span><span class="n">abinit_output</span><span class="o">.</span><span class="n">gsr</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="c1"># first get all the file paths. If something goes wrong in this loop no file is left dangling in the db</span>
        <span class="n">hist_files_path</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">fw</span> <span class="ow">in</span> <span class="n">ion_fws</span> <span class="o">+</span> <span class="n">ioncell_fws</span><span class="p">:</span>
            <span class="n">task_index</span> <span class="o">=</span> <span class="n">fw</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wf_task_index&#39;</span><span class="p">)</span>
            <span class="n">last_launch</span> <span class="o">=</span> <span class="n">get_last_completed_launch</span><span class="p">(</span><span class="n">fw</span><span class="p">)</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">task</span><span class="o">.</span><span class="n">set_workdir</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">last_launch</span><span class="o">.</span><span class="n">launch_dir</span><span class="p">)</span>
            <span class="n">hist_files_path</span><span class="p">[</span><span class="n">task_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">hist_nc_path</span>

        <span class="c1"># now save all the files in the db</span>
        <span class="c1">#TODO I would prefer to avoid the import of mongoengine related objects here and delegate to some other specific module</span>
        <span class="c1">#from abiflows.core.models import AbiGridFSProxy</span>
        <span class="c1"># This is an alternative from importing the object explicitely. Still quite a dirty hack</span>
        <span class="n">proxy_class</span> <span class="o">=</span> <span class="n">RelaxResult</span><span class="o">.</span><span class="n">abinit_output</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">hist_files</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">proxy_class</span>
        <span class="n">collection_name</span> <span class="o">=</span> <span class="n">RelaxResult</span><span class="o">.</span><span class="n">abinit_output</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">hist_files</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">collection_name</span>
        <span class="n">hist_files</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">task_index</span><span class="p">,</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">hist_files_path</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">file_field</span> <span class="o">=</span> <span class="n">proxy_class</span><span class="p">(</span><span class="n">collection_name</span><span class="o">=</span><span class="n">collection_name</span><span class="p">)</span>
                <span class="n">file_field</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">hist_files</span><span class="p">[</span><span class="n">task_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_field</span>

        <span class="c1"># read in binary for py3k compatibility with mongoengine</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">relax_task</span><span class="o">.</span><span class="n">output_file</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">document</span><span class="o">.</span><span class="n">abinit_output</span><span class="o">.</span><span class="n">outfile_ioncell</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="n">document</span><span class="o">.</span><span class="n">abinit_output</span><span class="o">.</span><span class="n">hist_files</span> <span class="o">=</span> <span class="n">hist_files</span>

        <span class="k">return</span> <span class="n">document</span></div>

<div class="viewcode-block" id="RelaxFWWorkflow.from_factory"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.RelaxFWWorkflow.from_factory">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_factory</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">pseudos</span><span class="p">,</span> <span class="n">kppa</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nband</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ecut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pawecutdg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">accuracy</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span>
                     <span class="n">spin_mode</span><span class="o">=</span><span class="s2">&quot;polarized&quot;</span><span class="p">,</span> <span class="n">smearing</span><span class="o">=</span><span class="s2">&quot;fermi_dirac:0.1 eV&quot;</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">scf_algorithm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">extra_abivars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">decorators</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">autoparal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initialization_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">target_dilatmx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip_ion</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">shift_mode</span><span class="o">=</span><span class="s2">&quot;Monkhorst-Pack&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates an instance of RelaxFWWorkflow using the ion_ioncell_relax_input factory function. See the description</span>
<span class="sd">        of the factory for the definition of the arguments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">extra_abivars</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">extra_abivars</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">decorators</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">decorators</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">initialization_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">initialization_info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">ion_ioncell_input</span> <span class="o">=</span> <span class="n">ion_ioncell_relax_input</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="n">structure</span><span class="p">,</span> <span class="n">pseudos</span><span class="o">=</span><span class="n">pseudos</span><span class="p">,</span> <span class="n">kppa</span><span class="o">=</span><span class="n">kppa</span><span class="p">,</span> <span class="n">nband</span><span class="o">=</span><span class="n">nband</span><span class="p">,</span> <span class="n">ecut</span><span class="o">=</span><span class="n">ecut</span><span class="p">,</span>
                                                    <span class="n">pawecutdg</span><span class="o">=</span><span class="n">pawecutdg</span><span class="p">,</span> <span class="n">accuracy</span><span class="o">=</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">spin_mode</span><span class="o">=</span><span class="n">spin_mode</span><span class="p">,</span>
                                                    <span class="n">smearing</span><span class="o">=</span><span class="n">smearing</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="n">charge</span><span class="p">,</span> <span class="n">scf_algorithm</span><span class="o">=</span><span class="n">scf_algorithm</span><span class="p">,</span>
                                                    <span class="n">shift_mode</span><span class="o">=</span><span class="n">shift_mode</span><span class="p">)</span>

        <span class="n">ion_ioncell_input</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="o">**</span><span class="n">extra_abivars</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">decorators</span><span class="p">:</span>
            <span class="n">ion_ioncell_input</span> <span class="o">=</span> <span class="n">d</span><span class="p">(</span><span class="n">ion_ioncell_input</span><span class="p">)</span>

        <span class="n">ion_input</span> <span class="o">=</span> <span class="n">ion_ioncell_input</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">skip_ion</span><span class="p">:</span>
            <span class="n">ioncell_input</span> <span class="o">=</span> <span class="n">ion_ioncell_input</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ioncell_input</span> <span class="o">=</span> <span class="n">IoncellRelaxFromGsFactory</span><span class="p">(</span><span class="n">accuracy</span><span class="o">=</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">extra_abivars</span><span class="o">=</span><span class="n">extra_abivars</span><span class="p">,</span>
                                                     <span class="n">decorators</span><span class="o">=</span><span class="n">decorators</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">ion_input</span><span class="p">,</span> <span class="n">ioncell_input</span><span class="p">,</span> <span class="n">autoparal</span><span class="o">=</span><span class="n">autoparal</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">initialization_info</span><span class="o">=</span><span class="n">initialization_info</span><span class="p">,</span>
                   <span class="n">target_dilatmx</span><span class="o">=</span><span class="n">target_dilatmx</span><span class="p">,</span><span class="n">skip_ion</span><span class="o">=</span><span class="n">skip_ion</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="RelaxFWWorkflowSRC"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.RelaxFWWorkflowSRC">[docs]</a><span class="k">class</span> <span class="nc">RelaxFWWorkflowSRC</span><span class="p">(</span><span class="n">AbstractFWWorkflow</span><span class="p">):</span>
    <span class="n">workflow_class</span> <span class="o">=</span> <span class="s1">&#39;RelaxFWWorkflowSRC&#39;</span>
    <span class="n">workflow_module</span> <span class="o">=</span> <span class="s1">&#39;abiflows.fireworks.workflows.abinit_workflows&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ion_input</span><span class="p">,</span> <span class="n">ioncell_input</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initialization_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">additional_controllers</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">initialization_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">initialization_info</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">fws</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">links_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">additional_controllers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">additional_controllers</span> <span class="o">=</span> <span class="p">[</span><span class="n">WalltimeController</span><span class="p">(),</span> <span class="n">MemoryController</span><span class="p">()]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">additional_controllers</span> <span class="o">=</span> <span class="n">additional_controllers</span>

        <span class="c1">#1. Relax run at fixed cell</span>
        <span class="n">relax_helper</span> <span class="o">=</span> <span class="n">RelaxTaskHelper</span><span class="p">()</span>
        <span class="n">relax_controllers</span> <span class="o">=</span> <span class="p">[</span><span class="n">AbinitController</span><span class="o">.</span><span class="n">from_helper</span><span class="p">(</span><span class="n">relax_helper</span><span class="p">)]</span>
        <span class="n">relax_controllers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">additional_controllers</span><span class="p">)</span>
        <span class="n">relax_control_procedure</span> <span class="o">=</span> <span class="n">ControlProcedure</span><span class="p">(</span><span class="n">controllers</span><span class="o">=</span><span class="n">relax_controllers</span><span class="p">)</span>
        <span class="n">setup_relax_ions_task</span> <span class="o">=</span> <span class="n">AbinitSetupTask</span><span class="p">(</span><span class="n">abiinput</span><span class="o">=</span><span class="n">ion_input</span><span class="p">,</span> <span class="n">task_helper</span><span class="o">=</span><span class="n">relax_helper</span><span class="p">)</span>
        <span class="n">run_relax_ions_task</span> <span class="o">=</span> <span class="n">AbinitRunTask</span><span class="p">(</span><span class="n">control_procedure</span><span class="o">=</span><span class="n">relax_control_procedure</span><span class="p">,</span> <span class="n">task_helper</span><span class="o">=</span><span class="n">relax_helper</span><span class="p">,</span>
                                            <span class="n">task_type</span><span class="o">=</span><span class="s1">&#39;ion&#39;</span><span class="p">)</span>
        <span class="n">control_relax_ions_task</span> <span class="o">=</span> <span class="n">AbinitControlTask</span><span class="p">(</span><span class="n">control_procedure</span><span class="o">=</span><span class="n">relax_control_procedure</span><span class="p">,</span>
                                                    <span class="n">task_helper</span><span class="o">=</span><span class="n">relax_helper</span><span class="p">)</span>

        <span class="n">relax_ions_fws</span> <span class="o">=</span> <span class="n">createSRCFireworks</span><span class="p">(</span><span class="n">setup_task</span><span class="o">=</span><span class="n">setup_relax_ions_task</span><span class="p">,</span> <span class="n">run_task</span><span class="o">=</span><span class="n">run_relax_ions_task</span><span class="p">,</span>
                                            <span class="n">control_task</span><span class="o">=</span><span class="n">control_relax_ions_task</span><span class="p">,</span>
                                            <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">initialization_info</span><span class="o">=</span><span class="n">initialization_info</span><span class="p">)</span>

        <span class="n">fws</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">relax_ions_fws</span><span class="p">[</span><span class="s1">&#39;fws&#39;</span><span class="p">])</span>
        <span class="n">links_dict_update</span><span class="p">(</span><span class="n">links_dict</span><span class="o">=</span><span class="n">links_dict</span><span class="p">,</span> <span class="n">links_update</span><span class="o">=</span><span class="n">relax_ions_fws</span><span class="p">[</span><span class="s1">&#39;links_dict&#39;</span><span class="p">])</span>

        <span class="c1">#2. Relax run with cell relaxation</span>
        <span class="n">setup_relax_ions_cell_task</span> <span class="o">=</span> <span class="n">AbinitSetupTask</span><span class="p">(</span><span class="n">abiinput</span><span class="o">=</span><span class="n">ioncell_input</span><span class="p">,</span> <span class="n">task_helper</span><span class="o">=</span><span class="n">relax_helper</span><span class="p">,</span>
                                                     <span class="n">deps</span><span class="o">=</span><span class="p">{</span><span class="n">run_relax_ions_task</span><span class="o">.</span><span class="n">task_type</span><span class="p">:</span> <span class="s1">&#39;@structure&#39;</span><span class="p">})</span>
        <span class="n">run_relax_ions_cell_task</span> <span class="o">=</span> <span class="n">AbinitRunTask</span><span class="p">(</span><span class="n">control_procedure</span><span class="o">=</span><span class="n">relax_control_procedure</span><span class="p">,</span> <span class="n">task_helper</span><span class="o">=</span><span class="n">relax_helper</span><span class="p">,</span>
                                                 <span class="n">task_type</span><span class="o">=</span><span class="s1">&#39;ioncell&#39;</span><span class="p">)</span>
        <span class="n">control_relax_ions_cell_task</span> <span class="o">=</span> <span class="n">AbinitControlTask</span><span class="p">(</span><span class="n">control_procedure</span><span class="o">=</span><span class="n">relax_control_procedure</span><span class="p">,</span>
                                                         <span class="n">task_helper</span><span class="o">=</span><span class="n">relax_helper</span><span class="p">)</span>

        <span class="n">relax_ions_cell_fws</span> <span class="o">=</span> <span class="n">createSRCFireworks</span><span class="p">(</span><span class="n">setup_task</span><span class="o">=</span><span class="n">setup_relax_ions_cell_task</span><span class="p">,</span>
                                                 <span class="n">run_task</span><span class="o">=</span><span class="n">run_relax_ions_cell_task</span><span class="p">,</span>
                                                 <span class="n">control_task</span><span class="o">=</span><span class="n">control_relax_ions_cell_task</span><span class="p">,</span>
                                                 <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">initialization_info</span><span class="o">=</span><span class="n">initialization_info</span><span class="p">)</span>

        <span class="n">fws</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">relax_ions_cell_fws</span><span class="p">[</span><span class="s1">&#39;fws&#39;</span><span class="p">])</span>
        <span class="n">links_dict_update</span><span class="p">(</span><span class="n">links_dict</span><span class="o">=</span><span class="n">links_dict</span><span class="p">,</span> <span class="n">links_update</span><span class="o">=</span><span class="n">relax_ions_cell_fws</span><span class="p">[</span><span class="s1">&#39;links_dict&#39;</span><span class="p">])</span>

        <span class="n">links_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">relax_ions_fws</span><span class="p">[</span><span class="s1">&#39;control_fw&#39;</span><span class="p">]:</span> <span class="n">relax_ions_cell_fws</span><span class="p">[</span><span class="s1">&#39;setup_fw&#39;</span><span class="p">]})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wf</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">fireworks</span><span class="o">=</span><span class="n">fws</span><span class="p">,</span>
                           <span class="n">links_dict</span><span class="o">=</span><span class="n">links_dict</span><span class="p">,</span>
                           <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;workflow_class&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow_class</span><span class="p">,</span>
                                     <span class="s1">&#39;workflow_module&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow_module</span><span class="p">})</span>

<div class="viewcode-block" id="RelaxFWWorkflowSRC.get_final_structure"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.RelaxFWWorkflowSRC.get_final_structure">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_final_structure</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">wf</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">wf</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;workflow_class&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">workflow_class</span>
        <span class="k">assert</span> <span class="n">wf</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;workflow_module&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">workflow_module</span>
        <span class="n">ioncell</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">final_fw_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">fw_id</span><span class="p">,</span> <span class="n">fw</span> <span class="ow">in</span> <span class="n">wf</span><span class="o">.</span><span class="n">id_fw</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;SRC_task_index&#39;</span> <span class="ow">in</span> <span class="n">fw</span><span class="o">.</span><span class="n">spec</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">src_type</span> <span class="o">!=</span> <span class="s1">&#39;run&#39;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">task_index</span> <span class="o">=</span> <span class="n">fw</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;SRC_task_index&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">task_index</span><span class="o">.</span><span class="n">task_type</span> <span class="o">==</span> <span class="s1">&#39;ioncell&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">task_index</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">ioncell</span><span class="p">:</span>
                        <span class="n">ioncell</span> <span class="o">=</span> <span class="n">task_index</span><span class="o">.</span><span class="n">index</span>
                        <span class="n">final_fw_id</span> <span class="o">=</span> <span class="n">fw_id</span>
        <span class="k">if</span> <span class="n">final_fw_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Final structure not found ...&#39;</span><span class="p">)</span>
        <span class="n">myfw</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">id_fw</span><span class="p">[</span><span class="n">final_fw_id</span><span class="p">]</span>
        <span class="n">mytask</span> <span class="o">=</span> <span class="n">myfw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1">#TODO add a check on the state of the launches</span>
        <span class="n">last_launch</span> <span class="o">=</span> <span class="p">(</span><span class="n">myfw</span><span class="o">.</span><span class="n">archived_launches</span> <span class="o">+</span> <span class="n">myfw</span><span class="o">.</span><span class="n">launches</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1">#TODO add a cycle to find the instance of AbiFireTask?</span>
        <span class="c1"># myfw.tasks[-1].set_workdir(workdir=last_launch.launch_dir)</span>
        <span class="c1"># mytask.setup_rundir(last_launch.launch_dir, create_dirs=False)</span>
        <span class="n">helper</span> <span class="o">=</span> <span class="n">RelaxTaskHelper</span><span class="p">()</span>
        <span class="n">helper</span><span class="o">.</span><span class="n">set_task</span><span class="p">(</span><span class="n">mytask</span><span class="p">)</span>
        <span class="n">helper</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">setup_rundir</span><span class="p">(</span><span class="n">last_launch</span><span class="o">.</span><span class="n">launch_dir</span><span class="p">,</span> <span class="n">create_dirs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">structure</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">get_final_structure</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;structure&#39;</span><span class="p">:</span> <span class="n">structure</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()}</span></div>

<div class="viewcode-block" id="RelaxFWWorkflowSRC.get_final_structure_and_history"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.RelaxFWWorkflowSRC.get_final_structure_and_history">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_final_structure_and_history</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">wf</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">wf</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;workflow_class&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">workflow_class</span>
        <span class="k">assert</span> <span class="n">wf</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;workflow_module&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">workflow_module</span>
        <span class="n">ioncell</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">final_fw_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">fw_id</span><span class="p">,</span> <span class="n">fw</span> <span class="ow">in</span> <span class="n">wf</span><span class="o">.</span><span class="n">id_fw</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;SRC_task_index&#39;</span> <span class="ow">in</span> <span class="n">fw</span><span class="o">.</span><span class="n">spec</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">src_type</span> <span class="o">!=</span> <span class="s1">&#39;run&#39;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">task_index</span> <span class="o">=</span> <span class="n">fw</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;SRC_task_index&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">task_index</span><span class="o">.</span><span class="n">task_type</span> <span class="o">==</span> <span class="s1">&#39;ioncell&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">task_index</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">ioncell</span><span class="p">:</span>
                        <span class="n">ioncell</span> <span class="o">=</span> <span class="n">task_index</span><span class="o">.</span><span class="n">index</span>
                        <span class="n">final_fw_id</span> <span class="o">=</span> <span class="n">fw_id</span>
        <span class="k">if</span> <span class="n">final_fw_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Final structure not found ...&#39;</span><span class="p">)</span>
        <span class="n">myfw</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">id_fw</span><span class="p">[</span><span class="n">final_fw_id</span><span class="p">]</span>
        <span class="n">mytask</span> <span class="o">=</span> <span class="n">myfw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1">#TODO add a check on the state of the launches</span>
        <span class="n">last_launch</span> <span class="o">=</span> <span class="p">(</span><span class="n">myfw</span><span class="o">.</span><span class="n">archived_launches</span> <span class="o">+</span> <span class="n">myfw</span><span class="o">.</span><span class="n">launches</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1">#TODO add a cycle to find the instance of AbiFireTask?</span>
        <span class="c1"># myfw.tasks[-1].set_workdir(workdir=last_launch.launch_dir)</span>
        <span class="c1"># mytask.setup_rundir(last_launch.launch_dir, create_dirs=False)</span>
        <span class="n">helper</span> <span class="o">=</span> <span class="n">RelaxTaskHelper</span><span class="p">()</span>
        <span class="n">helper</span><span class="o">.</span><span class="n">set_task</span><span class="p">(</span><span class="n">mytask</span><span class="p">)</span>
        <span class="n">helper</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">setup_rundir</span><span class="p">(</span><span class="n">last_launch</span><span class="o">.</span><span class="n">launch_dir</span><span class="p">,</span> <span class="n">create_dirs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># helper.set_task(mytask)</span>

        <span class="n">structure</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">get_final_structure</span><span class="p">()</span>

        <span class="c1"># with open(os.path.join(last_launch.launch_dir, &#39;history.json&#39;), &quot;rt&quot;) as fh:</span>
        <span class="c1">#     history = json.load(fh, cls=MontyDecoder)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;structure&#39;</span><span class="p">:</span> <span class="n">structure</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()}</span></div>

<div class="viewcode-block" id="RelaxFWWorkflowSRC.get_computed_entry"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.RelaxFWWorkflowSRC.get_computed_entry">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_computed_entry</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">wf</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">wf</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;workflow_class&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">workflow_class</span>
        <span class="k">assert</span> <span class="n">wf</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;workflow_module&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">workflow_module</span>
        <span class="n">ioncell</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">final_fw_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">fw_id</span><span class="p">,</span> <span class="n">fw</span> <span class="ow">in</span> <span class="n">wf</span><span class="o">.</span><span class="n">id_fw</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;SRC_task_index&#39;</span> <span class="ow">in</span> <span class="n">fw</span><span class="o">.</span><span class="n">spec</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">src_type</span> <span class="o">!=</span> <span class="s1">&#39;run&#39;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">task_index</span> <span class="o">=</span> <span class="n">fw</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;SRC_task_index&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">task_index</span><span class="o">.</span><span class="n">task_type</span> <span class="o">==</span> <span class="s1">&#39;ioncell&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">task_index</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">ioncell</span><span class="p">:</span>
                        <span class="n">ioncell</span> <span class="o">=</span> <span class="n">task_index</span><span class="o">.</span><span class="n">index</span>
                        <span class="n">final_fw_id</span> <span class="o">=</span> <span class="n">fw_id</span>
        <span class="k">if</span> <span class="n">final_fw_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Final structure not found ...&#39;</span><span class="p">)</span>
        <span class="n">myfw</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">id_fw</span><span class="p">[</span><span class="n">final_fw_id</span><span class="p">]</span>
        <span class="n">mytask</span> <span class="o">=</span> <span class="n">myfw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1">#TODO add a check on the state of the launches</span>
        <span class="n">last_launch</span> <span class="o">=</span> <span class="p">(</span><span class="n">myfw</span><span class="o">.</span><span class="n">archived_launches</span> <span class="o">+</span> <span class="n">myfw</span><span class="o">.</span><span class="n">launches</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1">#TODO add a cycle to find the instance of AbiFireTask?</span>
        <span class="c1"># myfw.tasks[-1].set_workdir(workdir=last_launch.launch_dir)</span>
        <span class="c1"># mytask.setup_rundir(last_launch.launch_dir, create_dirs=False)</span>
        <span class="n">helper</span> <span class="o">=</span> <span class="n">RelaxTaskHelper</span><span class="p">()</span>
        <span class="n">helper</span><span class="o">.</span><span class="n">set_task</span><span class="p">(</span><span class="n">mytask</span><span class="p">)</span>
        <span class="n">helper</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">setup_rundir</span><span class="p">(</span><span class="n">last_launch</span><span class="o">.</span><span class="n">launch_dir</span><span class="p">,</span> <span class="n">create_dirs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># helper.set_task(mytask)</span>

        <span class="n">computed_entry</span> <span class="o">=</span> <span class="n">helper</span><span class="o">.</span><span class="n">get_computed_entry</span><span class="p">()</span>
        <span class="c1"># with open(os.path.join(last_launch.launch_dir, &#39;history.json&#39;), &quot;rt&quot;) as fh:</span>
        <span class="c1">#     history = json.load(fh, cls=MontyDecoder)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;computed_entry&#39;</span><span class="p">:</span> <span class="n">computed_entry</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()}</span></div></div>


<div class="viewcode-block" id="NscfFWWorkflow"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.NscfFWWorkflow">[docs]</a><span class="k">class</span> <span class="nc">NscfFWWorkflow</span><span class="p">(</span><span class="n">AbstractFWWorkflow</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generator of a fireworks workflow with a SCF followed by a NSCF calculation. For the calculation of</span>
<span class="sd">    band structure or DOS.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">workflow_class</span> <span class="o">=</span> <span class="s1">&#39;NscfFWWorkflow&#39;</span>
    <span class="n">workflow_module</span> <span class="o">=</span> <span class="s1">&#39;abiflows.fireworks.workflows.abinit_workflows&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scf_input</span><span class="p">,</span> <span class="n">nscf_input</span><span class="p">,</span> <span class="n">autoparal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initialization_info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            scf_input: an AbinitInput for the SCF calculation.</span>
<span class="sd">            nscf_input: an AbinitInput for the NSCF calculation.</span>
<span class="sd">            autoparal: if True autoparal will be used at runtime to optimize the number of processes.</span>
<span class="sd">            spec: a dict with additional spec for the Firework.</span>
<span class="sd">            initialization_info: a dict defining additional information about the initialization of the workflow.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">start_task_index</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">initialization_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">initialization_info</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">spec</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;initialization_info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initialization_info</span>
        <span class="k">if</span> <span class="n">autoparal</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_short_single_core_to_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
            <span class="n">start_task_index</span> <span class="o">=</span> <span class="s2">&quot;autoparal&quot;</span>

        <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;wf_task_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;scf_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">start_task_index</span><span class="p">)</span>
        <span class="n">scf_task</span> <span class="o">=</span> <span class="n">ScfFWTask</span><span class="p">(</span><span class="n">scf_input</span><span class="p">,</span> <span class="n">is_autoparal</span><span class="o">=</span><span class="n">autoparal</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scf_fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">(</span><span class="n">scf_task</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">)</span>

        <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;wf_task_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;nscf_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">start_task_index</span><span class="p">)</span>
        <span class="n">nscf_task</span> <span class="o">=</span> <span class="n">NscfFWTask</span><span class="p">(</span><span class="n">nscf_input</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="p">{</span><span class="n">scf_task</span><span class="o">.</span><span class="n">task_type</span><span class="p">:</span> <span class="s1">&#39;DEN&#39;</span><span class="p">},</span> <span class="n">is_autoparal</span><span class="o">=</span><span class="n">autoparal</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nscf_fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">(</span><span class="n">nscf_task</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wf</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">scf_fw</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nscf_fw</span><span class="p">],</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scf_fw</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nscf_fw</span><span class="p">]},</span>
                           <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;workflow_class&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow_class</span><span class="p">,</span>
                                     <span class="s1">&#39;workflow_module&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow_module</span><span class="p">})</span></div>


<div class="viewcode-block" id="NscfFWWorkflowSRC"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.NscfFWWorkflowSRC">[docs]</a><span class="k">class</span> <span class="nc">NscfFWWorkflowSRC</span><span class="p">(</span><span class="n">AbstractFWWorkflow</span><span class="p">):</span>
    <span class="n">workflow_class</span> <span class="o">=</span> <span class="s1">&#39;NscfFWWorkflowSRC&#39;</span>
    <span class="n">workflow_module</span> <span class="o">=</span> <span class="s1">&#39;abiflows.fireworks.workflows.abinit_workflows&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scf_input</span><span class="p">,</span> <span class="n">nscf_input</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initialization_info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">initialization_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">initialization_info</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Initializes fws list and links_dict</span>
        <span class="n">fws</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">links_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="s1">&#39;additional_controllers&#39;</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">:</span>
            <span class="n">additional_controllers</span> <span class="o">=</span> <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;additional_controllers&#39;</span><span class="p">]</span>
            <span class="n">spec</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;additional_controllers&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">additional_controllers</span> <span class="o">=</span> <span class="p">[</span><span class="n">WalltimeController</span><span class="p">(),</span> <span class="n">MemoryController</span><span class="p">()]</span>
        <span class="c1"># Self-consistent calculation</span>
        <span class="n">scf_helper</span> <span class="o">=</span> <span class="n">ScfTaskHelper</span><span class="p">()</span>
        <span class="n">scf_controllers</span> <span class="o">=</span> <span class="p">[</span><span class="n">AbinitController</span><span class="o">.</span><span class="n">from_helper</span><span class="p">(</span><span class="n">scf_helper</span><span class="p">)]</span>
        <span class="n">scf_controllers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">additional_controllers</span><span class="p">)</span>
        <span class="n">scf_control_procedure</span> <span class="o">=</span> <span class="n">ControlProcedure</span><span class="p">(</span><span class="n">controllers</span><span class="o">=</span><span class="n">scf_controllers</span><span class="p">)</span>
        <span class="n">setup_scf_task</span> <span class="o">=</span> <span class="n">AbinitSetupTask</span><span class="p">(</span><span class="n">abiinput</span><span class="o">=</span><span class="n">scf_input</span><span class="p">,</span> <span class="n">task_helper</span><span class="o">=</span><span class="n">scf_helper</span><span class="p">)</span>
        <span class="n">run_scf_task</span> <span class="o">=</span> <span class="n">AbinitRunTask</span><span class="p">(</span><span class="n">control_procedure</span><span class="o">=</span><span class="n">scf_control_procedure</span><span class="p">,</span> <span class="n">task_helper</span><span class="o">=</span><span class="n">scf_helper</span><span class="p">)</span>
        <span class="n">control_scf_task</span> <span class="o">=</span> <span class="n">AbinitControlTask</span><span class="p">(</span><span class="n">control_procedure</span><span class="o">=</span><span class="n">scf_control_procedure</span><span class="p">,</span> <span class="n">task_helper</span><span class="o">=</span><span class="n">scf_helper</span><span class="p">)</span>

        <span class="n">scf_fws</span> <span class="o">=</span> <span class="n">createSRCFireworks</span><span class="p">(</span><span class="n">setup_task</span><span class="o">=</span><span class="n">setup_scf_task</span><span class="p">,</span> <span class="n">run_task</span><span class="o">=</span><span class="n">run_scf_task</span><span class="p">,</span> <span class="n">control_task</span><span class="o">=</span><span class="n">control_scf_task</span><span class="p">,</span>
                                     <span class="n">task_index</span><span class="o">=</span><span class="n">scf_helper</span><span class="o">.</span><span class="n">task_type</span><span class="p">,</span>
                                     <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">initialization_info</span><span class="o">=</span><span class="n">initialization_info</span><span class="p">)</span>

        <span class="n">fws</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">scf_fws</span><span class="p">[</span><span class="s1">&#39;fws&#39;</span><span class="p">])</span>
        <span class="n">links_dict_update</span><span class="p">(</span><span class="n">links_dict</span><span class="o">=</span><span class="n">links_dict</span><span class="p">,</span> <span class="n">links_update</span><span class="o">=</span><span class="n">scf_fws</span><span class="p">[</span><span class="s1">&#39;links_dict&#39;</span><span class="p">])</span>

        <span class="c1"># Non self-consistent calculation</span>
        <span class="n">nscf_helper</span> <span class="o">=</span> <span class="n">NscfTaskHelper</span><span class="p">()</span>
        <span class="n">nscf_controllers</span> <span class="o">=</span> <span class="p">[</span><span class="n">AbinitController</span><span class="o">.</span><span class="n">from_helper</span><span class="p">(</span><span class="n">nscf_helper</span><span class="p">)]</span>
        <span class="n">nscf_controllers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">additional_controllers</span><span class="p">)</span>
        <span class="n">nscf_control_procedure</span> <span class="o">=</span> <span class="n">ControlProcedure</span><span class="p">(</span><span class="n">controllers</span><span class="o">=</span><span class="n">nscf_controllers</span><span class="p">)</span>
        <span class="n">setup_nscf_task</span> <span class="o">=</span> <span class="n">AbinitSetupTask</span><span class="p">(</span><span class="n">abiinput</span><span class="o">=</span><span class="n">nscf_input</span><span class="p">,</span> <span class="n">task_helper</span><span class="o">=</span><span class="n">nscf_helper</span><span class="p">,</span>
                                          <span class="n">deps</span><span class="o">=</span><span class="p">{</span><span class="n">run_scf_task</span><span class="o">.</span><span class="n">task_type</span><span class="p">:</span> <span class="s1">&#39;DEN&#39;</span><span class="p">})</span>
        <span class="n">run_nscf_task</span> <span class="o">=</span> <span class="n">AbinitRunTask</span><span class="p">(</span><span class="n">control_procedure</span><span class="o">=</span><span class="n">nscf_control_procedure</span><span class="p">,</span> <span class="n">task_helper</span><span class="o">=</span><span class="n">nscf_helper</span><span class="p">)</span>
        <span class="n">control_nscf_task</span> <span class="o">=</span> <span class="n">AbinitControlTask</span><span class="p">(</span><span class="n">control_procedure</span><span class="o">=</span><span class="n">nscf_control_procedure</span><span class="p">,</span> <span class="n">task_helper</span><span class="o">=</span><span class="n">nscf_helper</span><span class="p">)</span>

        <span class="n">nscf_fws</span> <span class="o">=</span> <span class="n">createSRCFireworks</span><span class="p">(</span><span class="n">setup_task</span><span class="o">=</span><span class="n">setup_nscf_task</span><span class="p">,</span> <span class="n">run_task</span><span class="o">=</span><span class="n">run_nscf_task</span><span class="p">,</span>
                                      <span class="n">control_task</span><span class="o">=</span><span class="n">control_nscf_task</span><span class="p">,</span> <span class="n">task_index</span><span class="o">=</span><span class="n">nscf_helper</span><span class="o">.</span><span class="n">task_type</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span>
                                      <span class="n">initialization_info</span><span class="o">=</span><span class="n">initialization_info</span><span class="p">)</span>

        <span class="n">fws</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">nscf_fws</span><span class="p">[</span><span class="s1">&#39;fws&#39;</span><span class="p">])</span>
        <span class="n">links_dict_update</span><span class="p">(</span><span class="n">links_dict</span><span class="o">=</span><span class="n">links_dict</span><span class="p">,</span> <span class="n">links_update</span><span class="o">=</span><span class="n">nscf_fws</span><span class="p">[</span><span class="s1">&#39;links_dict&#39;</span><span class="p">])</span>
        <span class="c1">#Link with previous SCF</span>
        <span class="n">links_dict_update</span><span class="p">(</span><span class="n">links_dict</span><span class="o">=</span><span class="n">links_dict</span><span class="p">,</span>
                          <span class="n">links_update</span><span class="o">=</span><span class="p">{</span><span class="n">scf_fws</span><span class="p">[</span><span class="s1">&#39;control_fw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fw_id</span><span class="p">:</span> <span class="n">nscf_fws</span><span class="p">[</span><span class="s1">&#39;setup_fw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fw_id</span><span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wf</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">fireworks</span><span class="o">=</span><span class="n">fws</span><span class="p">,</span> <span class="n">links_dict</span><span class="o">=</span><span class="n">links_dict</span><span class="p">,</span>
                           <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;workflow_class&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow_class</span><span class="p">,</span>
                                     <span class="s1">&#39;workflow_module&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow_module</span><span class="p">})</span>

<div class="viewcode-block" id="NscfFWWorkflowSRC.from_factory"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.NscfFWWorkflowSRC.from_factory">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_factory</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">pseudos</span><span class="p">,</span> <span class="n">kppa</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ecut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pawecutdg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nband</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">accuracy</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span>
                     <span class="n">spin_mode</span><span class="o">=</span><span class="s2">&quot;polarized&quot;</span><span class="p">,</span> <span class="n">smearing</span><span class="o">=</span><span class="s2">&quot;fermi_dirac:0.1 eV&quot;</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">scf_algorithm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">shift_mode</span><span class="o">=</span><span class="s2">&quot;Monkhorst-Pack&quot;</span><span class="p">,</span> <span class="n">extra_abivars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">decorators</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">autoparal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">initialization_info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">extra_abivars</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">extra_abivars</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">decorators</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">decorators</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">initialization_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">initialization_info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;from_factory class method not yet implemented for NscfWorkflowSRC&#39;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="HybridOneShotFWWorkflow"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.HybridOneShotFWWorkflow">[docs]</a><span class="k">class</span> <span class="nc">HybridOneShotFWWorkflow</span><span class="p">(</span><span class="n">AbstractFWWorkflow</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generator of a fireworks workflow that performs a SCF calculation with hybrid functional based on GW.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scf_inp</span><span class="p">,</span> <span class="n">hybrid_input</span><span class="p">,</span> <span class="n">autoparal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initialization_info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            scf_input: an AbinitInput for the SCF calculation.</span>
<span class="sd">            hybrid_input: an AbinitInput for the hybrid functional calculation.</span>
<span class="sd">            autoparal: if True autoparal will be used at runtime to optimize the number of processes.</span>
<span class="sd">            spec: a dict with additional spec for the Firework.</span>
<span class="sd">            initialization_info: a dict defining additional information about the initialization of the workflow.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">initialization_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">initialization_info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">rf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_reduced_formula</span><span class="p">(</span><span class="n">scf_inp</span><span class="p">)</span>

        <span class="n">scf_task</span> <span class="o">=</span> <span class="n">ScfFWTask</span><span class="p">(</span><span class="n">scf_inp</span><span class="p">,</span> <span class="n">is_autoparal</span><span class="o">=</span><span class="n">autoparal</span><span class="p">)</span>

        <span class="n">spec</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;initialization_info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initialization_info</span>
        <span class="k">if</span> <span class="n">autoparal</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_short_single_core_to_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scf_fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">(</span><span class="n">scf_task</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">rf</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">scf_task</span><span class="o">.</span><span class="n">task_type</span><span class="p">)</span>

        <span class="n">hybrid_task</span> <span class="o">=</span> <span class="n">HybridFWTask</span><span class="p">(</span><span class="n">hybrid_input</span><span class="p">,</span> <span class="n">is_autoparal</span><span class="o">=</span><span class="n">autoparal</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;WFK&quot;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hybrid_fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">(</span><span class="n">hybrid_task</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">rf</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">hybrid_task</span><span class="o">.</span><span class="n">task_type</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wf</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">scf_fw</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hybrid_fw</span><span class="p">],</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scf_fw</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hybrid_fw</span><span class="p">})</span>

<div class="viewcode-block" id="HybridOneShotFWWorkflow.from_factory"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.HybridOneShotFWWorkflow.from_factory">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_factory</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">pseudos</span><span class="p">,</span> <span class="n">kppa</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ecut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pawecutdg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nband</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">accuracy</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span>
                     <span class="n">spin_mode</span><span class="o">=</span><span class="s2">&quot;polarized&quot;</span><span class="p">,</span> <span class="n">smearing</span><span class="o">=</span><span class="s2">&quot;fermi_dirac:0.1 eV&quot;</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">scf_algorithm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">shift_mode</span><span class="o">=</span><span class="s2">&quot;Monkhorst-Pack&quot;</span><span class="p">,</span> <span class="n">hybrid_functional</span><span class="o">=</span><span class="s2">&quot;hse06&quot;</span><span class="p">,</span> <span class="n">ecutsigx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gw_qprange</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">extra_abivars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">decorators</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">autoparal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initialization_info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates an instance of HybridOneShotFWWorkflow using the scf_input and  hybrid_oneshot_input factory functions.</span>
<span class="sd">        See the description of the factories for the definition of the arguments.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">extra_abivars</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">extra_abivars</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">decorators</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">decorators</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">initialization_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">initialization_info</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">scf_fact</span> <span class="o">=</span> <span class="n">ScfFactory</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="n">structure</span><span class="p">,</span> <span class="n">pseudos</span><span class="o">=</span><span class="n">pseudos</span><span class="p">,</span> <span class="n">kppa</span><span class="o">=</span><span class="n">kppa</span><span class="p">,</span> <span class="n">ecut</span><span class="o">=</span><span class="n">ecut</span><span class="p">,</span> <span class="n">pawecutdg</span><span class="o">=</span><span class="n">pawecutdg</span><span class="p">,</span>
                              <span class="n">nband</span><span class="o">=</span><span class="n">nband</span><span class="p">,</span> <span class="n">accuracy</span><span class="o">=</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">spin_mode</span><span class="o">=</span><span class="n">spin_mode</span><span class="p">,</span> <span class="n">smearing</span><span class="o">=</span><span class="n">smearing</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="n">charge</span><span class="p">,</span>
                              <span class="n">scf_algorithm</span><span class="o">=</span><span class="n">scf_algorithm</span><span class="p">,</span> <span class="n">shift_mode</span><span class="o">=</span><span class="n">shift_mode</span><span class="p">,</span> <span class="n">extra_abivars</span><span class="o">=</span><span class="n">extra_abivars</span><span class="p">,</span>
                              <span class="n">decorators</span><span class="o">=</span><span class="n">decorators</span><span class="p">)</span>

        <span class="n">hybrid_fact</span> <span class="o">=</span> <span class="n">HybridOneShotFromGsFactory</span><span class="p">(</span><span class="n">functional</span><span class="o">=</span><span class="n">hybrid_functional</span><span class="p">,</span> <span class="n">ecutsigx</span><span class="o">=</span><span class="n">ecutsigx</span><span class="p">,</span> <span class="n">gw_qprange</span><span class="o">=</span><span class="n">gw_qprange</span><span class="p">,</span>
                                                 <span class="n">decorators</span><span class="o">=</span><span class="n">decorators</span><span class="p">,</span> <span class="n">extra_abivars</span><span class="o">=</span><span class="n">extra_abivars</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">scf_fact</span><span class="p">,</span> <span class="n">hybrid_fact</span><span class="p">,</span> <span class="n">autoparal</span><span class="o">=</span><span class="n">autoparal</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">initialization_info</span><span class="o">=</span><span class="n">initialization_info</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="PhononFWWorkflow"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.PhononFWWorkflow">[docs]</a><span class="k">class</span> <span class="nc">PhononFWWorkflow</span><span class="p">(</span><span class="n">AbstractFWWorkflow</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generator of a fireworks workflow for the calculation of phonon properties with DFPT.</span>
<span class="sd">    Parallelization over all the perturbations. The phononic perturbations will be generated at runtime based on the</span>
<span class="sd">    last input used in the SCF calculation.</span>
<span class="sd">    Warning: for calculations requiring a large number of perturbations (&gt;1000 perturbations) the generation step will</span>
<span class="sd">    fail due to limitations in the size of documents in mongodb database. Use PhononFullFWWorkflow if this may</span>
<span class="sd">    be an issue.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">workflow_class</span> <span class="o">=</span> <span class="s1">&#39;PhononFWWorkflow&#39;</span>
    <span class="n">workflow_module</span> <span class="o">=</span> <span class="s1">&#39;abiflows.fireworks.workflows.abinit_workflows&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scf_inp</span><span class="p">,</span> <span class="n">phonon_factory</span><span class="p">,</span> <span class="n">autoparal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initialization_info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            scf_inp: an |AbinitInput| object for the SCF calculation.</span>
<span class="sd">            phonon_factory: an PhononsFromGsFactory for the generation of the inputs for phonon perturbations.</span>
<span class="sd">            autoparal: if True autoparal will be used at runtime to optimize the number of processes.</span>
<span class="sd">            spec: a dict with additional spec for the Firework.</span>
<span class="sd">            initialization_info: a dict defining additional information about the initialization of the workflow.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">initialization_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">initialization_info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">start_task_index</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">rf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_reduced_formula</span><span class="p">(</span><span class="n">scf_inp</span><span class="p">)</span>

        <span class="n">scf_task</span> <span class="o">=</span> <span class="n">ScfFWTask</span><span class="p">(</span><span class="n">scf_inp</span><span class="p">,</span> <span class="n">is_autoparal</span><span class="o">=</span><span class="n">autoparal</span><span class="p">)</span>

        <span class="n">spec</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;initialization_info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initialization_info</span>
        <span class="k">if</span> <span class="n">autoparal</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_short_single_core_to_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
            <span class="n">start_task_index</span> <span class="o">=</span> <span class="s1">&#39;autoparal&#39;</span>

        <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;wf_task_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;scf_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">start_task_index</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scf_fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">(</span><span class="n">scf_task</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">rf</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">scf_task</span><span class="o">.</span><span class="n">task_type</span><span class="p">)</span>

        <span class="n">ph_generation_task</span> <span class="o">=</span> <span class="n">GeneratePhononFlowFWAbinitTask</span><span class="p">(</span><span class="n">phonon_factory</span><span class="p">,</span> <span class="n">previous_task_type</span><span class="o">=</span><span class="n">scf_task</span><span class="o">.</span><span class="n">task_type</span><span class="p">,</span>
                                                            <span class="n">with_autoparal</span><span class="o">=</span><span class="n">autoparal</span><span class="p">)</span>

        <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;wf_task_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;gen_ph&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ph_generation_fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">(</span><span class="n">ph_generation_task</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">rf</span><span class="o">+</span><span class="s2">&quot;_gen_ph&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wf</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">scf_fw</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph_generation_fw</span><span class="p">],</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scf_fw</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph_generation_fw</span><span class="p">},</span>
                           <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;workflow_class&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow_class</span><span class="p">,</span>
                                     <span class="s1">&#39;workflow_module&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow_module</span><span class="p">})</span>

<div class="viewcode-block" id="PhononFWWorkflow.from_factory"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.PhononFWWorkflow.from_factory">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_factory</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">pseudos</span><span class="p">,</span> <span class="n">kppa</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ecut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pawecutdg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nband</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">accuracy</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span>
                     <span class="n">spin_mode</span><span class="o">=</span><span class="s2">&quot;polarized&quot;</span><span class="p">,</span> <span class="n">smearing</span><span class="o">=</span><span class="s2">&quot;fermi_dirac:0.1 eV&quot;</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">scf_algorithm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">shift_mode</span><span class="o">=</span><span class="s2">&quot;Symmetric&quot;</span><span class="p">,</span> <span class="n">ph_ngqpt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">qpoints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">qppa</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">with_ddk</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_dde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">with_bec</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">scf_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ph_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ddk_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dde_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wfq_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">qpoints_to_skip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extra_abivars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">decorators</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">autoparal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">initialization_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates an instance of PhononFWWorkflow using the scf_for_phonons and phonons_from_gsinput factory functions.</span>
<span class="sd">        See the description of the factories for the definition of the arguments.</span>
<span class="sd">        The manager can be a TaskManager or a FWTaskManager.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">extra_abivars</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">extra_abivars</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">decorators</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">decorators</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">initialization_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">initialization_info</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="n">FWTaskManager</span><span class="p">):</span>
            <span class="n">manager</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">task_manager</span>
            <span class="k">if</span> <span class="n">manager</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;A TaskManager is required in the FWTaskManager.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">qppa</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ph_ngqpt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">qpoints</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;qppa is incompatible with ph_ngqpt and qpoints&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">qppa</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">initialization_info</span><span class="p">[</span><span class="s1">&#39;qppa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qppa</span>
            <span class="n">ph_ngqpt</span> <span class="o">=</span> <span class="n">KSampling</span><span class="o">.</span><span class="n">automatic_density</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">qppa</span><span class="p">,</span> <span class="n">chksymbreak</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">kpts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">initialization_info</span><span class="p">[</span><span class="s1">&#39;ngqpt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ph_ngqpt</span>
        <span class="n">initialization_info</span><span class="p">[</span><span class="s1">&#39;qpoints&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qpoints</span>
        <span class="k">if</span> <span class="s1">&#39;kppa&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">initialization_info</span><span class="p">:</span>
            <span class="n">initialization_info</span><span class="p">[</span><span class="s1">&#39;kppa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kppa</span>

        <span class="n">extra_abivars_scf</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">extra_abivars</span><span class="p">)</span>
        <span class="n">extra_abivars_scf</span><span class="p">[</span><span class="s1">&#39;tolwfr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scf_tol</span> <span class="k">if</span> <span class="n">scf_tol</span> <span class="k">else</span> <span class="mf">1.e-22</span>
        <span class="n">scf_fact</span> <span class="o">=</span> <span class="n">ScfForPhononsFactory</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="n">structure</span><span class="p">,</span> <span class="n">pseudos</span><span class="o">=</span><span class="n">pseudos</span><span class="p">,</span> <span class="n">kppa</span><span class="o">=</span><span class="n">kppa</span><span class="p">,</span> <span class="n">ecut</span><span class="o">=</span><span class="n">ecut</span><span class="p">,</span> <span class="n">pawecutdg</span><span class="o">=</span><span class="n">pawecutdg</span><span class="p">,</span>
                                        <span class="n">nband</span><span class="o">=</span><span class="n">nband</span><span class="p">,</span> <span class="n">accuracy</span><span class="o">=</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">spin_mode</span><span class="o">=</span><span class="n">spin_mode</span><span class="p">,</span> <span class="n">smearing</span><span class="o">=</span><span class="n">smearing</span><span class="p">,</span>
                                        <span class="n">charge</span><span class="o">=</span><span class="n">charge</span><span class="p">,</span> <span class="n">scf_algorithm</span><span class="o">=</span><span class="n">scf_algorithm</span><span class="p">,</span> <span class="n">shift_mode</span><span class="o">=</span><span class="n">shift_mode</span><span class="p">,</span>
                                        <span class="n">extra_abivars</span><span class="o">=</span><span class="n">extra_abivars_scf</span><span class="p">,</span> <span class="n">decorators</span><span class="o">=</span><span class="n">decorators</span><span class="p">)</span>

        <span class="n">phonon_fact</span> <span class="o">=</span> <span class="n">PhononsFromGsFactory</span><span class="p">(</span><span class="n">ph_ngqpt</span><span class="o">=</span><span class="n">ph_ngqpt</span><span class="p">,</span> <span class="n">with_ddk</span><span class="o">=</span><span class="n">with_ddk</span><span class="p">,</span> <span class="n">with_dde</span><span class="o">=</span><span class="n">with_dde</span><span class="p">,</span> <span class="n">with_bec</span><span class="o">=</span><span class="n">with_bec</span><span class="p">,</span>
                                           <span class="n">ph_tol</span><span class="o">=</span><span class="n">ph_tol</span><span class="p">,</span> <span class="n">ddk_tol</span><span class="o">=</span><span class="n">ddk_tol</span><span class="p">,</span> <span class="n">dde_tol</span><span class="o">=</span><span class="n">dde_tol</span><span class="p">,</span> <span class="n">wfq_tol</span><span class="o">=</span><span class="n">wfq_tol</span><span class="p">,</span>
                                           <span class="n">qpoints_to_skip</span><span class="o">=</span><span class="n">qpoints_to_skip</span><span class="p">,</span> <span class="n">extra_abivars</span><span class="o">=</span><span class="n">extra_abivars</span><span class="p">,</span>
                                           <span class="n">qpoints</span><span class="o">=</span><span class="n">qpoints</span><span class="p">,</span> <span class="n">decorators</span><span class="o">=</span><span class="n">decorators</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">)</span>

        <span class="n">ph_wf</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">scf_fact</span><span class="p">,</span> <span class="n">phonon_fact</span><span class="p">,</span> <span class="n">autoparal</span><span class="o">=</span><span class="n">autoparal</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">initialization_info</span><span class="o">=</span><span class="n">initialization_info</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ph_wf</span></div>

<div class="viewcode-block" id="PhononFWWorkflow.from_gs_input"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.PhononFWWorkflow.from_gs_input">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_gs_input</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">gs_input</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ph_ngqpt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">qpoints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">qppa</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">with_ddk</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">with_dde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">with_bec</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">scf_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ph_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ddk_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dde_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wfq_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">qpoints_to_skip</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extra_abivars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">decorators</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">autoparal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">initialization_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates an instance of PhononFWWorkflow using a custom |AbinitInput| for a ground state calculation and the</span>
<span class="sd">        phonons_from_gsinput factory function. Tolerances for the scf will be set accordingly to scf_tol (with</span>
<span class="sd">        default 1e-22) and keys relative to relaxation and parallelization will be removed from gs_input.</span>
<span class="sd">        See the description of the phonons_from_gsinput factory for the definition of the arguments.</span>
<span class="sd">        The manager can be a TaskManager or a FWTaskManager.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">extra_abivars</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">extra_abivars</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">decorators</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">decorators</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">initialization_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">initialization_info</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="n">FWTaskManager</span><span class="p">):</span>
            <span class="n">manager</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">task_manager</span>
            <span class="k">if</span> <span class="n">manager</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;A TaskManager is required in the FWTaskManager.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">qppa</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ph_ngqpt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">qpoints</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;qppa is incompatible with ph_ngqpt and qpoints&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">qppa</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">structure</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">structure</span> <span class="o">=</span> <span class="n">gs_input</span><span class="o">.</span><span class="n">structure</span>
            <span class="n">initialization_info</span><span class="p">[</span><span class="s1">&#39;qppa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qppa</span>
            <span class="n">ph_ngqpt</span> <span class="o">=</span> <span class="n">KSampling</span><span class="o">.</span><span class="n">automatic_density</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">qppa</span><span class="p">,</span> <span class="n">chksymbreak</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">kpts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">initialization_info</span><span class="p">[</span><span class="s1">&#39;ngqpt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ph_ngqpt</span>
        <span class="n">initialization_info</span><span class="p">[</span><span class="s1">&#39;qpoints&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qpoints</span>

        <span class="n">scf_inp</span> <span class="o">=</span> <span class="n">gs_input</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">structure</span><span class="p">:</span>
            <span class="n">scf_inp</span><span class="o">.</span><span class="n">set_structure</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scf_tol</span><span class="p">:</span>
            <span class="n">scf_inp</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">scf_tol</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scf_inp</span><span class="p">[</span><span class="s1">&#39;tolwfr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.e-22</span>
        <span class="n">scf_inp</span><span class="p">[</span><span class="s1">&#39;chksymbreak&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">scf_inp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nbdbuf&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">scf_inp</span><span class="p">[</span><span class="s1">&#39;nbdbuf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">scf_inp</span><span class="p">[</span><span class="s1">&#39;nband&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scf_inp</span><span class="p">[</span><span class="s1">&#39;nband&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span>
        <span class="n">abi_vars</span> <span class="o">=</span> <span class="n">get_abinit_variables</span><span class="p">()</span>
        <span class="c1"># remove relaxation variables in case gs_input is a relaxation</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">abi_vars</span><span class="o">.</span><span class="n">vars_with_varset</span><span class="p">(</span><span class="s1">&#39;rlx&#39;</span><span class="p">):</span>
            <span class="n">scf_inp</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># remove parallelization variables in case gs_input is coming from a previous run with parallelization</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">abi_vars</span><span class="o">.</span><span class="n">vars_with_varset</span><span class="p">(</span><span class="s1">&#39;paral&#39;</span><span class="p">):</span>
            <span class="n">scf_inp</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">scf_inp</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">extra_abivars</span><span class="p">)</span>

        <span class="n">phonon_fact</span> <span class="o">=</span> <span class="n">PhononsFromGsFactory</span><span class="p">(</span><span class="n">ph_ngqpt</span><span class="o">=</span><span class="n">ph_ngqpt</span><span class="p">,</span> <span class="n">with_ddk</span><span class="o">=</span><span class="n">with_ddk</span><span class="p">,</span> <span class="n">with_dde</span><span class="o">=</span><span class="n">with_dde</span><span class="p">,</span> <span class="n">with_bec</span><span class="o">=</span><span class="n">with_bec</span><span class="p">,</span>
                                           <span class="n">ph_tol</span><span class="o">=</span><span class="n">ph_tol</span><span class="p">,</span> <span class="n">ddk_tol</span><span class="o">=</span><span class="n">ddk_tol</span><span class="p">,</span> <span class="n">dde_tol</span><span class="o">=</span><span class="n">dde_tol</span><span class="p">,</span> <span class="n">wfq_tol</span><span class="o">=</span><span class="n">wfq_tol</span><span class="p">,</span>
                                           <span class="n">qpoints_to_skip</span><span class="o">=</span><span class="n">qpoints_to_skip</span><span class="p">,</span> <span class="n">extra_abivars</span><span class="o">=</span><span class="n">extra_abivars</span><span class="p">,</span>
                                           <span class="n">qpoints</span><span class="o">=</span><span class="n">qpoints</span><span class="p">,</span> <span class="n">decorators</span><span class="o">=</span><span class="n">decorators</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">)</span>

        <span class="n">ph_wf</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">scf_inp</span><span class="p">,</span> <span class="n">phonon_fact</span><span class="p">,</span> <span class="n">autoparal</span><span class="o">=</span><span class="n">autoparal</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">initialization_info</span><span class="o">=</span><span class="n">initialization_info</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ph_wf</span></div>

<div class="viewcode-block" id="PhononFWWorkflow.add_anaddb_ph_bs_fw"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.PhononFWWorkflow.add_anaddb_ph_bs_fw">[docs]</a>    <span class="k">def</span> <span class="nf">add_anaddb_ph_bs_fw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">ph_ngqpt</span><span class="p">,</span> <span class="n">ndivsm</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">nqsmall</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Appends a Firework with a task for the calculation of phonon band structure and dos with anaddb.</span>

<span class="sd">        Args:</span>
<span class="sd">            structure: the input structure</span>
<span class="sd">            ngqpt: Monkhorst-Pack divisions for the phonon Q-mesh (coarse one)</span>
<span class="sd">            nqsmall: Used to generate the (dense) mesh for the DOS.</span>
<span class="sd">                It defines the number of q-points used to sample the smallest lattice vector.</span>
<span class="sd">            ndivsm: Used to generate a normalized path for the phonon bands.</span>
<span class="sd">                If gives the number of divisions for the smallest segment of the path.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">anaddb_input</span> <span class="o">=</span> <span class="n">AnaddbInput</span><span class="o">.</span><span class="n">phbands_and_dos</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="n">structure</span><span class="p">,</span> <span class="n">ngqpt</span><span class="o">=</span><span class="n">ph_ngqpt</span><span class="p">,</span> <span class="n">ndivsm</span><span class="o">=</span><span class="n">ndivsm</span><span class="p">,</span><span class="n">nqsmall</span><span class="o">=</span><span class="n">nqsmall</span><span class="p">,</span>
                                                   <span class="n">asr</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">chneut</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dipdip</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">lo_to_splitting</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">anaddb_task</span> <span class="o">=</span> <span class="n">AnaDdbAbinitTask</span><span class="p">(</span><span class="n">anaddb_input</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="p">{</span><span class="n">MergeDdbAbinitTask</span><span class="o">.</span><span class="n">task_type</span><span class="p">:</span> <span class="s2">&quot;DDB&quot;</span><span class="p">})</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scf_fw</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;wf_task_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;anaddb&#39;</span>

        <span class="n">anaddb_fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">(</span><span class="n">anaddb_task</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anaddb&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">append_fw</span><span class="p">(</span><span class="n">anaddb_fw</span><span class="p">,</span> <span class="n">short_single_spec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="PhononFWWorkflow.get_mongoengine_results"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.PhononFWWorkflow.get_mongoengine_results">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_mongoengine_results</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">wf</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates the PhononResult mongoengine document containing the results of the calculation.</span>
<span class="sd">        The workflow should have been generated from this class and requires an open connection to the</span>
<span class="sd">        fireworks database and access to the file system containing the calculations.</span>

<span class="sd">        Args:</span>
<span class="sd">            wf: the fireworks Workflow instance of the workflow.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A PhononResult document.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="n">wf</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;workflow_class&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">workflow_class</span>
        <span class="k">assert</span> <span class="n">wf</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;workflow_module&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">workflow_module</span>

        <span class="n">scf_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ph_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ddk_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">dde_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">wfq_index</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">anaddb_task</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">fw</span> <span class="ow">in</span> <span class="n">wf</span><span class="o">.</span><span class="n">fws</span><span class="p">:</span>
            <span class="n">task_index</span> <span class="o">=</span> <span class="n">fw</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wf_task_index&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">task_index</span> <span class="o">==</span> <span class="s1">&#39;anaddb&#39;</span><span class="p">:</span>
                <span class="n">anaddb_launch</span> <span class="o">=</span> <span class="n">get_last_completed_launch</span><span class="p">(</span><span class="n">fw</span><span class="p">)</span>
                <span class="n">anaddb_task</span> <span class="o">=</span> <span class="n">fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">anaddb_task</span><span class="o">.</span><span class="n">set_workdir</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">anaddb_launch</span><span class="o">.</span><span class="n">launch_dir</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">task_index</span> <span class="o">==</span> <span class="s1">&#39;mrgddb&#39;</span><span class="p">:</span>
                <span class="n">mrgddb_launch</span> <span class="o">=</span> <span class="n">get_last_completed_launch</span><span class="p">(</span><span class="n">fw</span><span class="p">)</span>
                <span class="n">mrgddb_task</span> <span class="o">=</span> <span class="n">fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">mrgddb_task</span><span class="o">.</span><span class="n">set_workdir</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">mrgddb_launch</span><span class="o">.</span><span class="n">launch_dir</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">task_index</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;scf_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">task_index</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;autoparal&#39;</span><span class="p">):</span>
                <span class="n">current_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">task_index</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">current_index</span> <span class="o">&gt;</span> <span class="n">scf_index</span><span class="p">:</span>
                    <span class="n">scf_index</span> <span class="o">=</span> <span class="n">current_index</span>
                    <span class="n">scf_fw</span> <span class="o">=</span> <span class="n">fw</span>
            <span class="k">elif</span> <span class="n">task_index</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;phonon_0&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">task_index</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;autoparal&#39;</span><span class="p">):</span>
                <span class="n">current_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">task_index</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">current_index</span> <span class="o">&gt;</span> <span class="n">ph_index</span><span class="p">:</span>
                    <span class="n">ph_index</span> <span class="o">=</span> <span class="n">current_index</span>
                    <span class="n">ph_fw</span> <span class="o">=</span> <span class="n">fw</span>
            <span class="k">elif</span> <span class="n">task_index</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ddk_0&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">task_index</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;autoparal&#39;</span><span class="p">):</span>
                <span class="n">current_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">task_index</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">current_index</span> <span class="o">&gt;</span> <span class="n">ddk_index</span><span class="p">:</span>
                    <span class="n">ddk_index</span> <span class="o">=</span> <span class="n">current_index</span>
                    <span class="n">ddk_fw</span> <span class="o">=</span> <span class="n">fw</span>
            <span class="k">elif</span> <span class="n">task_index</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;dde_0&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">task_index</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;autoparal&#39;</span><span class="p">):</span>
                <span class="n">current_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">task_index</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">current_index</span> <span class="o">&gt;</span> <span class="n">dde_index</span><span class="p">:</span>
                    <span class="n">dde_index</span> <span class="o">=</span> <span class="n">current_index</span>
                    <span class="n">dde_fw</span> <span class="o">=</span> <span class="n">fw</span>
            <span class="k">elif</span> <span class="n">task_index</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;nscf_wfq_0&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">task_index</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;autoparal&#39;</span><span class="p">):</span>
                <span class="n">current_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">task_index</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">current_index</span> <span class="o">&gt;</span> <span class="n">wfq_index</span><span class="p">:</span>
                    <span class="n">wfq_index</span> <span class="o">=</span> <span class="n">current_index</span>
                    <span class="n">wfq_fw</span> <span class="o">=</span> <span class="n">fw</span>

        <span class="n">scf_launch</span> <span class="o">=</span> <span class="n">get_last_completed_launch</span><span class="p">(</span><span class="n">scf_fw</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">scf_launch</span><span class="o">.</span><span class="n">launch_dir</span><span class="p">,</span> <span class="s1">&#39;history.json&#39;</span><span class="p">),</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">scf_history</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">MontyDecoder</span><span class="p">)</span>
        <span class="n">scf_task</span> <span class="o">=</span> <span class="n">scf_fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">scf_task</span><span class="o">.</span><span class="n">set_workdir</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">scf_launch</span><span class="o">.</span><span class="n">launch_dir</span><span class="p">)</span>

        <span class="n">document</span> <span class="o">=</span> <span class="n">PhononResult</span><span class="p">()</span>

        <span class="n">gs_input</span> <span class="o">=</span> <span class="n">scf_history</span><span class="o">.</span><span class="n">get_events_by_types</span><span class="p">(</span><span class="n">TaskEvent</span><span class="o">.</span><span class="n">FINALIZED</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">details</span><span class="p">[</span><span class="s1">&#39;final_input&#39;</span><span class="p">]</span>

        <span class="n">document</span><span class="o">.</span><span class="n">abinit_input</span><span class="o">.</span><span class="n">gs_input</span> <span class="o">=</span> <span class="n">gs_input</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
        <span class="n">document</span><span class="o">.</span><span class="n">abinit_input</span><span class="o">.</span><span class="n">set_abinit_basic_from_abinit_input</span><span class="p">(</span><span class="n">gs_input</span><span class="p">)</span>

        <span class="n">structure</span> <span class="o">=</span> <span class="n">gs_input</span><span class="o">.</span><span class="n">structure</span>
        <span class="n">document</span><span class="o">.</span><span class="n">abinit_output</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
        <span class="n">document</span><span class="o">.</span><span class="n">set_material_data_from_structure</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>

        <span class="n">initialization_info</span> <span class="o">=</span> <span class="n">scf_history</span><span class="o">.</span><span class="n">get_events_by_types</span><span class="p">(</span><span class="n">TaskEvent</span><span class="o">.</span><span class="n">INITIALIZED</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;initialization_info&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">document</span><span class="o">.</span><span class="n">mp_id</span> <span class="o">=</span> <span class="n">initialization_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mp_id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">document</span><span class="o">.</span><span class="n">custom</span> <span class="o">=</span> <span class="n">initialization_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;custom&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">document</span><span class="o">.</span><span class="n">relax_db</span> <span class="o">=</span> <span class="n">initialization_info</span><span class="p">[</span><span class="s1">&#39;relax_db&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;relax_db&#39;</span> <span class="ow">in</span> <span class="n">initialization_info</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">document</span><span class="o">.</span><span class="n">relax_id</span> <span class="o">=</span> <span class="n">initialization_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;relax_id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">document</span><span class="o">.</span><span class="n">abinit_input</span><span class="o">.</span><span class="n">ngqpt</span> <span class="o">=</span> <span class="n">initialization_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ngqpt&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">document</span><span class="o">.</span><span class="n">abinit_input</span><span class="o">.</span><span class="n">qpoints</span> <span class="o">=</span> <span class="n">initialization_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;qpoints&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">document</span><span class="o">.</span><span class="n">abinit_input</span><span class="o">.</span><span class="n">qppa</span> <span class="o">=</span> <span class="n">initialization_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;qppa&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">document</span><span class="o">.</span><span class="n">abinit_input</span><span class="o">.</span><span class="n">kppa</span> <span class="o">=</span> <span class="n">initialization_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kppa&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">document</span><span class="o">.</span><span class="n">abinit_input</span><span class="o">.</span><span class="n">pseudopotentials</span><span class="o">.</span><span class="n">set_pseudos_from_files_file</span><span class="p">(</span><span class="n">scf_task</span><span class="o">.</span><span class="n">files_file</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                                                                           <span class="nb">len</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">composition</span><span class="o">.</span><span class="n">elements</span><span class="p">))</span>

        <span class="n">document</span><span class="o">.</span><span class="n">created_on</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">document</span><span class="o">.</span><span class="n">modified_on</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="n">document</span><span class="o">.</span><span class="n">set_dir_names_from_fws_wf</span><span class="p">(</span><span class="n">wf</span><span class="p">)</span>

        <span class="c1"># read in binary for py3k compatibility with mongoengine</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">mrgddb_task</span><span class="o">.</span><span class="n">merged_ddb_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">document</span><span class="o">.</span><span class="n">abinit_output</span><span class="o">.</span><span class="n">ddb</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ph_index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ph_task</span> <span class="o">=</span> <span class="n">ph_fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">document</span><span class="o">.</span><span class="n">abinit_input</span><span class="o">.</span><span class="n">phonon_input</span> <span class="o">=</span> <span class="n">ph_task</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">ddk_index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ddk_task</span> <span class="o">=</span> <span class="n">ddk_fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">document</span><span class="o">.</span><span class="n">abinit_input</span><span class="o">.</span><span class="n">ddk_input</span> <span class="o">=</span> <span class="n">ddk_task</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">dde_index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dde_task</span> <span class="o">=</span> <span class="n">dde_fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">document</span><span class="o">.</span><span class="n">abinit_input</span><span class="o">.</span><span class="n">dde_input</span> <span class="o">=</span> <span class="n">dde_task</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">wfq_index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">wfq_task</span> <span class="o">=</span> <span class="n">wfq_fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">document</span><span class="o">.</span><span class="n">abinit_input</span><span class="o">.</span><span class="n">wfq_input</span> <span class="o">=</span> <span class="n">wfq_task</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">anaddb_task</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">anaddb_task</span><span class="o">.</span><span class="n">phbst_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">document</span><span class="o">.</span><span class="n">abinit_output</span><span class="o">.</span><span class="n">phonon_bs</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">anaddb_task</span><span class="o">.</span><span class="n">phdos_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">document</span><span class="o">.</span><span class="n">abinit_output</span><span class="o">.</span><span class="n">phonon_dos</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">anaddb_task</span><span class="o">.</span><span class="n">anaddb_nc_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">document</span><span class="o">.</span><span class="n">abinit_output</span><span class="o">.</span><span class="n">anaddb_nc</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="n">document</span><span class="o">.</span><span class="n">fw_id</span> <span class="o">=</span> <span class="n">scf_fw</span><span class="o">.</span><span class="n">fw_id</span>

        <span class="n">document</span><span class="o">.</span><span class="n">time_report</span> <span class="o">=</span> <span class="n">get_time_report_for_wf</span><span class="p">(</span><span class="n">wf</span><span class="p">)</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">scf_task</span><span class="o">.</span><span class="n">gsr_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">document</span><span class="o">.</span><span class="n">abinit_output</span><span class="o">.</span><span class="n">gs_gsr</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="c1"># read in binary for py3k compatibility with mongoengine</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">scf_task</span><span class="o">.</span><span class="n">output_file</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">document</span><span class="o">.</span><span class="n">abinit_output</span><span class="o">.</span><span class="n">gs_outfile</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">document</span></div></div>


<div class="viewcode-block" id="PhononFullFWWorkflow"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.PhononFullFWWorkflow">[docs]</a><span class="k">class</span> <span class="nc">PhononFullFWWorkflow</span><span class="p">(</span><span class="n">PhononFWWorkflow</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generator of a fireworks workflow for the calculation of phonon properties with DFPT.</span>
<span class="sd">    Parallelization over all the perturbations.</span>
<span class="sd">    Subclass of PhononFWWorkflow but the Fireworks with phonon perturbations will be generated immediately.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">workflow_class</span> <span class="o">=</span> <span class="s1">&#39;PhononFullFWWorkflow&#39;</span>
    <span class="n">workflow_module</span> <span class="o">=</span> <span class="s1">&#39;abiflows.fireworks.workflows.abinit_workflows&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scf_inp</span><span class="p">,</span> <span class="n">phonon_factory</span><span class="p">,</span> <span class="n">autoparal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initialization_info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            scf_inp: an |AbinitInput| for the SCF calculation.</span>
<span class="sd">            phonon_factory: an PhononsFromGsFactory for the generation of the inputs for phonon perturbations.</span>
<span class="sd">            autoparal: if True autoparal will be used at runtime to optimize the number of processes.</span>
<span class="sd">            spec: a dict with additional spec for the Firework.</span>
<span class="sd">            initialization_info: a dict defining additional information about the initialization of the workflow.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">spec</span> <span class="o">=</span> <span class="n">spec</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">initialization_info</span> <span class="o">=</span> <span class="n">initialization_info</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">start_task_index</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">rf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_reduced_formula</span><span class="p">(</span><span class="n">scf_inp</span><span class="p">)</span>

        <span class="n">scf_task</span> <span class="o">=</span> <span class="n">ScfFWTask</span><span class="p">(</span><span class="n">scf_inp</span><span class="p">,</span> <span class="n">is_autoparal</span><span class="o">=</span><span class="n">autoparal</span><span class="p">)</span>

        <span class="n">spec</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;initialization_info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initialization_info</span>
        <span class="k">if</span> <span class="n">autoparal</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_short_single_core_to_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
            <span class="n">start_task_index</span> <span class="o">=</span> <span class="s1">&#39;autoparal&#39;</span>

        <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;wf_task_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;scf_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">start_task_index</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scf_fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">(</span><span class="n">scf_task</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">rf</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">scf_task</span><span class="o">.</span><span class="n">task_type</span><span class="p">)</span>

        <span class="c1"># Generate the phononic part of the workflow</span>
        <span class="c1"># Since everything is being generated here factories should be used to generate the AbinitInput</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scf_inp</span><span class="p">,</span> <span class="n">InputFactory</span><span class="p">):</span>
            <span class="n">scf_inp</span> <span class="o">=</span> <span class="n">scf_inp</span><span class="o">.</span><span class="n">build_input</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phonon_factory</span><span class="p">,</span> <span class="n">InputFactory</span><span class="p">):</span>
            <span class="n">initialization_info</span><span class="p">[</span><span class="s1">&#39;input_factory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phonon_factory</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
            <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;initialization_info&#39;</span><span class="p">][</span><span class="s1">&#39;input_factory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phonon_factory</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
            <span class="n">ph_inputs</span> <span class="o">=</span> <span class="n">phonon_factory</span><span class="o">.</span><span class="n">build_input</span><span class="p">(</span><span class="n">scf_inp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ph_inputs</span> <span class="o">=</span> <span class="n">phonon_factory</span>

        <span class="n">ph_q_pert_inputs</span> <span class="o">=</span> <span class="n">ph_inputs</span><span class="o">.</span><span class="n">filter_by_tags</span><span class="p">(</span><span class="n">atags</span><span class="o">.</span><span class="n">PH_Q_PERT</span><span class="p">)</span>
        <span class="n">ddk_inputs</span> <span class="o">=</span> <span class="n">ph_inputs</span><span class="o">.</span><span class="n">filter_by_tags</span><span class="p">(</span><span class="n">atags</span><span class="o">.</span><span class="n">DDK</span><span class="p">)</span>
        <span class="n">dde_inputs</span> <span class="o">=</span> <span class="n">ph_inputs</span><span class="o">.</span><span class="n">filter_by_tags</span><span class="p">(</span><span class="n">atags</span><span class="o">.</span><span class="n">DDE</span><span class="p">)</span>
        <span class="n">bec_inputs</span> <span class="o">=</span> <span class="n">ph_inputs</span><span class="o">.</span><span class="n">filter_by_tags</span><span class="p">(</span><span class="n">atags</span><span class="o">.</span><span class="n">BEC</span><span class="p">)</span>

        <span class="n">nscf_inputs</span> <span class="o">=</span> <span class="n">ph_inputs</span><span class="o">.</span><span class="n">filter_by_tags</span><span class="p">(</span><span class="n">atags</span><span class="o">.</span><span class="n">NSCF</span><span class="p">)</span>

        <span class="n">previous_task_type</span> <span class="o">=</span> <span class="n">scf_task</span><span class="o">.</span><span class="n">task_type</span>

        <span class="n">nscf_fws</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">nscf_inputs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nscf_fws</span><span class="p">,</span> <span class="n">nscf_fw_deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fws</span><span class="p">(</span><span class="n">nscf_inputs</span><span class="p">,</span> <span class="n">NscfWfqFWTask</span><span class="p">,</span>
                                                 <span class="p">{</span><span class="n">previous_task_type</span><span class="p">:</span> <span class="s2">&quot;DEN&quot;</span><span class="p">},</span> <span class="n">spec</span><span class="p">)</span>

        <span class="n">ph_fws</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">ph_q_pert_inputs</span><span class="p">:</span>
            <span class="n">ph_q_pert_inputs</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">prtwf</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ph_fws</span><span class="p">,</span> <span class="n">ph_fw_deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fws</span><span class="p">(</span><span class="n">ph_q_pert_inputs</span><span class="p">,</span> <span class="n">PhononTask</span><span class="p">,</span> <span class="p">{</span><span class="n">previous_task_type</span><span class="p">:</span> <span class="s2">&quot;WFK&quot;</span><span class="p">},</span> <span class="n">spec</span><span class="p">,</span>
                                              <span class="n">nscf_fws</span><span class="p">)</span>

        <span class="n">ddk_fws</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">ddk_inputs</span><span class="p">:</span>
            <span class="n">ddk_fws</span><span class="p">,</span> <span class="n">ddk_fw_deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fws</span><span class="p">(</span><span class="n">ddk_inputs</span><span class="p">,</span> <span class="n">DdkTask</span><span class="p">,</span> <span class="p">{</span><span class="n">previous_task_type</span><span class="p">:</span> <span class="s2">&quot;WFK&quot;</span><span class="p">},</span> <span class="n">spec</span><span class="p">)</span>

        <span class="n">dde_fws</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">dde_inputs</span><span class="p">:</span>
            <span class="n">dde_inputs</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">prtwf</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dde_fws</span><span class="p">,</span> <span class="n">dde_fw_deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fws</span><span class="p">(</span><span class="n">dde_inputs</span><span class="p">,</span> <span class="n">DdeTask</span><span class="p">,</span>
                                                <span class="p">{</span><span class="n">previous_task_type</span><span class="p">:</span> <span class="s2">&quot;WFK&quot;</span><span class="p">,</span> <span class="n">DdkTask</span><span class="o">.</span><span class="n">task_type</span><span class="p">:</span> <span class="s2">&quot;DDK&quot;</span><span class="p">},</span> <span class="n">spec</span><span class="p">)</span>

        <span class="n">bec_fws</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">bec_inputs</span><span class="p">:</span>
            <span class="n">bec_inputs</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">prtwf</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">bec_fws</span><span class="p">,</span> <span class="n">bec_fw_deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fws</span><span class="p">(</span><span class="n">bec_inputs</span><span class="p">,</span> <span class="n">BecTask</span><span class="p">,</span>
                                                <span class="p">{</span><span class="n">previous_task_type</span><span class="p">:</span> <span class="s2">&quot;WFK&quot;</span><span class="p">,</span> <span class="n">DdkTask</span><span class="o">.</span><span class="n">task_type</span><span class="p">:</span> <span class="s2">&quot;DDK&quot;</span><span class="p">},</span> <span class="n">spec</span><span class="p">)</span>

        <span class="n">mrgddb_spec</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">mrgddb_spec</span><span class="p">[</span><span class="s1">&#39;wf_task_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;mrgddb&#39;</span>
        <span class="c1">#FIXME import here to avoid circular imports.</span>
        <span class="c1">#from abiflows.fireworks.utils.fw_utils import get_short_single_core_spec</span>
        <span class="n">qadapter_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_short_single_core_to_spec</span><span class="p">(</span><span class="n">mrgddb_spec</span><span class="p">)</span>
        <span class="n">mrgddb_spec</span><span class="p">[</span><span class="s1">&#39;mpi_ncpus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># Set a higher priority to favour the end of the WF</span>
        <span class="c1">#TODO improve the handling of the priorities</span>
        <span class="n">mrgddb_spec</span><span class="p">[</span><span class="s1">&#39;_priority&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">num_ddbs_to_be_merged</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ph_fws</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">dde_fws</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">bec_fws</span><span class="p">)</span>
        <span class="n">mrgddb_fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">(</span><span class="n">MergeDdbAbinitTask</span><span class="p">(</span><span class="n">num_ddbs</span><span class="o">=</span><span class="n">num_ddbs_to_be_merged</span><span class="p">,</span> <span class="n">delete_source_ddbs</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">spec</span><span class="o">=</span><span class="n">mrgddb_spec</span><span class="p">,</span>
                             <span class="n">name</span><span class="o">=</span><span class="n">ph_inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">composition</span><span class="o">.</span><span class="n">reduced_formula</span><span class="o">+</span><span class="s1">&#39;_mergeddb&#39;</span><span class="p">)</span>

        <span class="n">fws_deps</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

        <span class="n">autoparal_fws</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">autoparal</span><span class="p">:</span>
            <span class="c1"># add an AutoparalTask for each type and relative dependencies</span>
            <span class="n">dfpt_autoparal_fw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_autoparal_fw</span><span class="p">(</span><span class="n">ph_q_pert_inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;dfpt&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">previous_task_type</span><span class="p">:</span> <span class="s2">&quot;WFK&quot;</span><span class="p">},</span> <span class="n">spec</span><span class="p">,</span>
                                                      <span class="n">nscf_fws</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">autoparal_fws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dfpt_autoparal_fw</span><span class="p">)</span>

            <span class="n">fws_deps</span><span class="p">[</span><span class="n">dfpt_autoparal_fw</span><span class="p">]</span> <span class="o">=</span> <span class="n">ph_fws</span> <span class="o">+</span> <span class="n">ddk_fws</span> <span class="o">+</span> <span class="n">dde_fws</span> <span class="o">+</span> <span class="n">bec_fws</span>
            <span class="n">fws_deps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scf_fw</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dfpt_autoparal_fw</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">nscf_fws</span><span class="p">:</span>
                <span class="n">nscf_autoparal_fw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_autoparal_fw</span><span class="p">(</span><span class="n">nscf_inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;nscf&#39;</span><span class="p">,</span>
                                                          <span class="p">{</span><span class="n">previous_task_type</span><span class="p">:</span> <span class="s2">&quot;DEN&quot;</span><span class="p">},</span> <span class="n">spec</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">fws_deps</span><span class="p">[</span><span class="n">nscf_autoparal_fw</span><span class="p">]</span> <span class="o">=</span> <span class="n">nscf_fws</span>
                <span class="n">autoparal_fws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nscf_autoparal_fw</span><span class="p">)</span>
                <span class="n">fws_deps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scf_fw</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nscf_autoparal_fw</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ddk_fws</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ddk_fw</span> <span class="ow">in</span> <span class="n">ddk_fws</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dde_fws</span><span class="p">:</span>
                    <span class="n">fws_deps</span><span class="p">[</span><span class="n">ddk_fw</span><span class="p">]</span> <span class="o">=</span> <span class="n">dde_fws</span>
                <span class="k">if</span> <span class="n">bec_fws</span><span class="p">:</span>
                    <span class="n">fws_deps</span><span class="p">[</span><span class="n">ddk_fw</span><span class="p">]</span> <span class="o">=</span> <span class="n">bec_fws</span>

        <span class="c1"># all the abinit related FWs should depend on the scf calculation for the WFK</span>
        <span class="n">abinit_fws</span> <span class="o">=</span> <span class="n">nscf_fws</span> <span class="o">+</span> <span class="n">ddk_fws</span> <span class="o">+</span> <span class="n">dde_fws</span> <span class="o">+</span> <span class="n">ph_fws</span> <span class="o">+</span> <span class="n">bec_fws</span>
        <span class="n">fws_deps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scf_fw</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">abinit_fws</span><span class="p">)</span>

        <span class="n">ddb_fws</span> <span class="o">=</span> <span class="n">dde_fws</span> <span class="o">+</span> <span class="n">ph_fws</span> <span class="o">+</span> <span class="n">bec_fws</span>
        <span class="c1">#TODO pass all the tasks to the MergeDdbTask for logging or easier retrieve of the DDK?</span>
        <span class="k">for</span> <span class="n">ddb_fw</span> <span class="ow">in</span> <span class="n">ddb_fws</span><span class="p">:</span>
            <span class="n">fws_deps</span><span class="p">[</span><span class="n">ddb_fw</span><span class="p">]</span> <span class="o">=</span> <span class="n">mrgddb_fw</span>

        <span class="n">total_list_fws</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scf_fw</span><span class="p">]</span> <span class="o">+</span> <span class="n">ddb_fws</span><span class="o">+</span><span class="n">ddk_fws</span><span class="o">+</span><span class="p">[</span><span class="n">mrgddb_fw</span><span class="p">]</span> <span class="o">+</span> <span class="n">nscf_fws</span> <span class="o">+</span> <span class="n">autoparal_fws</span>

        <span class="n">fws_deps</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ph_fw_deps</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wf</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">total_list_fws</span><span class="p">,</span> <span class="n">links_dict</span><span class="o">=</span><span class="n">fws_deps</span><span class="p">,</span>
                           <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;workflow_class&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow_class</span><span class="p">,</span>
                                     <span class="s1">&#39;workflow_module&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow_module</span><span class="p">})</span>

<div class="viewcode-block" id="PhononFullFWWorkflow.get_fws"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.PhononFullFWWorkflow.get_fws">[docs]</a>    <span class="k">def</span> <span class="nf">get_fws</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multi_inp</span><span class="p">,</span> <span class="n">task_class</span><span class="p">,</span> <span class="n">deps</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">nscf_fws</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepares the fireworks for a specific type of calculation</span>

<span class="sd">        Args:</span>
<span class="sd">            multi_inp: |MultiDataset| with the inputs that should be run</span>
<span class="sd">            task_class: class of the tasks that should be generated</span>
<span class="sd">            deps: dict with the dependencies already set for this type of task</span>
<span class="sd">            spec: spec for the new Fireworks that will be created</span>
<span class="sd">            nscf_fws: list of NSCF fws for the calculation of WFQ files, in case they are present.</span>
<span class="sd">                Will be linked if needed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (tuple): tuple containing:</span>

<span class="sd">                - fws (list): The list of new Fireworks.</span>
<span class="sd">                - fw_deps (dict): The dependencies related to these fireworks.</span>
<span class="sd">                    Should be used when generating the workflow.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">formula</span> <span class="o">=</span> <span class="n">multi_inp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">composition</span><span class="o">.</span><span class="n">reduced_formula</span>
        <span class="n">fws</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fw_deps</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">autoparal_spec</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">inp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">multi_inp</span><span class="p">):</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
            <span class="n">start_task_index</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="n">current_deps</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">deps</span><span class="p">)</span>
            <span class="n">parent_fw</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">nscf_fws</span><span class="p">:</span>
                <span class="n">qpt</span> <span class="o">=</span> <span class="n">inp</span><span class="p">[</span><span class="s1">&#39;qpt&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">nscf_fw</span> <span class="ow">in</span> <span class="n">nscf_fws</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">nscf_fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">abiinput</span><span class="p">[</span><span class="s1">&#39;qpt&#39;</span><span class="p">],</span> <span class="n">qpt</span><span class="p">):</span>
                        <span class="n">parent_fw</span> <span class="o">=</span> <span class="n">nscf_fw</span>
                        <span class="n">current_deps</span><span class="p">[</span><span class="n">nscf_fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">task_type</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;WFQ&quot;</span>
                        <span class="k">break</span>

            <span class="n">task</span> <span class="o">=</span> <span class="n">task_class</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="n">current_deps</span><span class="p">,</span> <span class="n">is_autoparal</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># this index is for the different task, each performing a different perturbation</span>
            <span class="n">indexed_task_type</span> <span class="o">=</span> <span class="n">task_class</span><span class="o">.</span><span class="n">task_type</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="c1"># this index is to index the restarts of the single task</span>
            <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;wf_task_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">indexed_task_type</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">start_task_index</span><span class="p">)</span>
            <span class="n">fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="n">formula</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">indexed_task_type</span><span class="p">)[:</span><span class="mi">15</span><span class="p">])</span>
            <span class="n">fws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fw</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">parent_fw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fw_deps</span><span class="p">[</span><span class="n">parent_fw</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fw</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fws</span><span class="p">,</span> <span class="n">fw_deps</span></div>

<div class="viewcode-block" id="PhononFullFWWorkflow.get_autoparal_fw"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.PhononFullFWWorkflow.get_autoparal_fw">[docs]</a>    <span class="k">def</span> <span class="nf">get_autoparal_fw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inp</span><span class="p">,</span> <span class="n">task_type</span><span class="p">,</span> <span class="n">deps</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">nscf_fws</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepares a single Firework conatining an AutoparalTask to perform the autoparal for each group of calculations.</span>

<span class="sd">        Args:</span>
<span class="sd">            inp: one of the inputs for which the autoparal should be run</span>
<span class="sd">            task_type: task_type of the class for the current type of calculation</span>
<span class="sd">            deps: dict with the dependencies already set for this type of task</span>
<span class="sd">            spec: spec for the new Fireworks that will be created</span>
<span class="sd">            nscf_fws: list of NSCF fws for the calculation of WFQ files, in case they are present.</span>
<span class="sd">                Will be linked if needed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (tuple): tuple containing:</span>

<span class="sd">                - fws (list): The new Firework.</span>
<span class="sd">                - fw_deps (dict): The dependencies between related to this firework.</span>
<span class="sd">                    Should be used when generating the workflow.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">formula</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">composition</span><span class="o">.</span><span class="n">reduced_formula</span>
        <span class="n">fw_deps</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

        <span class="n">current_deps</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">deps</span><span class="p">)</span>
        <span class="n">parent_fw</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">nscf_fws</span><span class="p">:</span>
            <span class="n">qpt</span> <span class="o">=</span> <span class="n">inp</span><span class="p">[</span><span class="s1">&#39;qpt&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">nscf_fw</span> <span class="ow">in</span> <span class="n">nscf_fws</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">nscf_fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">abiinput</span><span class="p">[</span><span class="s1">&#39;qpt&#39;</span><span class="p">],</span> <span class="n">qpt</span><span class="p">):</span>
                    <span class="n">parent_fw</span> <span class="o">=</span> <span class="n">nscf_fw</span>
                    <span class="n">current_deps</span><span class="p">[</span><span class="n">nscf_fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">task_type</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;WFQ&quot;</span>
                    <span class="k">break</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">AutoparalTask</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="n">current_deps</span><span class="p">,</span> <span class="n">forward_spec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># this index is for the different task, each performing a different perturbation</span>
        <span class="n">indexed_task_type</span> <span class="o">=</span> <span class="n">AutoparalTask</span><span class="o">.</span><span class="n">task_type</span>
        <span class="c1"># this index is to index the restarts of the single task</span>
        <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;wf_task_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">indexed_task_type</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">task_type</span>
        <span class="n">fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="n">formula</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">indexed_task_type</span><span class="p">)[:</span><span class="mi">15</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">parent_fw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fw_deps</span><span class="p">[</span><span class="n">parent_fw</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fw</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fw</span><span class="p">,</span> <span class="n">fw_deps</span></div></div>


<div class="viewcode-block" id="DteFWWorkflow"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.DteFWWorkflow">[docs]</a><span class="k">class</span> <span class="nc">DteFWWorkflow</span><span class="p">(</span><span class="n">AbstractFWWorkflow</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generator of a fireworks workflow for the calculation of third derivatives with respect to electric field and</span>
<span class="sd">    atomic position to calculate  non-linear optical susceptibilities of a material using DFPT.</span>
<span class="sd">    Parallelization over all the perturbations. The phonon perturbations are optional.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">workflow_class</span> <span class="o">=</span> <span class="s1">&#39;DteFWWorkflow&#39;</span>
    <span class="n">workflow_module</span> <span class="o">=</span> <span class="s1">&#39;abiflows.fireworks.workflows.abinit_workflows&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scf_inp</span><span class="p">,</span> <span class="n">ddk_inp</span><span class="p">,</span> <span class="n">dde_inp</span><span class="p">,</span> <span class="n">dte_inp</span><span class="p">,</span> <span class="n">ph_inp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">autoparal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">initialization_info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            scf_inp: an |AbinitInput| for the SCF calculation.</span>
<span class="sd">            ddk_inp: a |MultiDataset| with the inputs for the DDK perturbations.</span>
<span class="sd">            dde_inp: a |MultiDataset| with the inputs for the DDE perturbations.</span>
<span class="sd">            dte_inp: a |MultiDataset| with the inputs for the DTE perturbations.</span>
<span class="sd">            ph_inp: a |MultiDataset| with the inputs for the phonon perturbations. If None phonon perturbations</span>
<span class="sd">                will not be considered.</span>
<span class="sd">            autoparal: if True autoparal will be used at runtime to optimize the number of processes.</span>
<span class="sd">            spec: a dict with additional spec for the Firework.</span>
<span class="sd">            initialization_info: a dict defining additional information about the initialization of the workflow.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">initialization_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">initialization_info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">start_task_index</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">rf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_reduced_formula</span><span class="p">(</span><span class="n">scf_inp</span><span class="p">)</span>

        <span class="n">scf_task</span> <span class="o">=</span> <span class="n">ScfFWTask</span><span class="p">(</span><span class="n">scf_inp</span><span class="p">,</span> <span class="n">is_autoparal</span><span class="o">=</span><span class="n">autoparal</span><span class="p">)</span>

        <span class="n">spec</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;initialization_info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initialization_info</span>
        <span class="k">if</span> <span class="n">autoparal</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_short_single_core_to_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
            <span class="n">start_task_index</span> <span class="o">=</span> <span class="s1">&#39;autoparal&#39;</span>

        <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;wf_task_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;scf_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">start_task_index</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scf_fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">(</span><span class="n">scf_task</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">rf</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">scf_task</span><span class="o">.</span><span class="n">task_type</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ph_fws</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">ph_inp</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ph_fws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fws</span><span class="p">(</span><span class="n">ph_inp</span><span class="p">,</span> <span class="n">PhononTask</span><span class="p">,</span> <span class="p">{</span><span class="n">ScfFWTask</span><span class="o">.</span><span class="n">task_type</span><span class="p">:</span> <span class="s2">&quot;WFK&quot;</span><span class="p">},</span> <span class="n">spec</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ddk_fws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fws</span><span class="p">(</span><span class="n">ddk_inp</span><span class="p">,</span> <span class="n">DdkTask</span><span class="p">,</span> <span class="p">{</span><span class="n">ScfFWTask</span><span class="o">.</span><span class="n">task_type</span><span class="p">:</span> <span class="s2">&quot;WFK&quot;</span><span class="p">},</span> <span class="n">spec</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dde_fws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fws</span><span class="p">(</span><span class="n">dde_inp</span><span class="p">,</span> <span class="n">DdeTask</span><span class="p">,</span> <span class="p">{</span><span class="n">ScfFWTask</span><span class="o">.</span><span class="n">task_type</span><span class="p">:</span> <span class="s2">&quot;WFK&quot;</span><span class="p">,</span> <span class="n">DdkTask</span><span class="o">.</span><span class="n">task_type</span><span class="p">:</span> <span class="s2">&quot;DDK&quot;</span><span class="p">},</span> <span class="n">spec</span><span class="p">)</span>

        <span class="n">dte_deps</span> <span class="o">=</span> <span class="p">{</span><span class="n">ScfFWTask</span><span class="o">.</span><span class="n">task_type</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;WFK&quot;</span><span class="p">,</span> <span class="s2">&quot;DEN&quot;</span><span class="p">],</span> <span class="n">DdeTask</span><span class="o">.</span><span class="n">task_type</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;1WF&quot;</span><span class="p">,</span> <span class="s2">&quot;1DEN&quot;</span><span class="p">]}</span>
        <span class="k">if</span> <span class="n">ph_inp</span><span class="p">:</span>
            <span class="n">dte_deps</span><span class="p">[</span><span class="n">PhononTask</span><span class="o">.</span><span class="n">task_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;1WF&quot;</span><span class="p">,</span> <span class="s2">&quot;1DEN&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dte_fws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fws</span><span class="p">(</span><span class="n">dte_inp</span><span class="p">,</span> <span class="n">DteTask</span><span class="p">,</span> <span class="n">dte_deps</span><span class="p">,</span> <span class="n">spec</span><span class="p">)</span>

        <span class="n">mrgddb_spec</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">mrgddb_spec</span><span class="p">[</span><span class="s1">&#39;wf_task_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;mrgddb&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_short_single_core_to_spec</span><span class="p">(</span><span class="n">mrgddb_spec</span><span class="p">)</span>
        <span class="n">mrgddb_spec</span><span class="p">[</span><span class="s1">&#39;mpi_ncpus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">num_ddbs_to_be_merged</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ph_fws</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dde_fws</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dte_fws</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mrgddb_fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">(</span><span class="n">MergeDdbAbinitTask</span><span class="p">(</span><span class="n">num_ddbs</span><span class="o">=</span><span class="n">num_ddbs_to_be_merged</span><span class="p">,</span> <span class="n">delete_source_ddbs</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                                  <span class="n">spec</span><span class="o">=</span><span class="n">mrgddb_spec</span><span class="p">,</span><span class="n">name</span><span class="o">=</span><span class="n">scf_inp</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">composition</span><span class="o">.</span><span class="n">reduced_formula</span><span class="o">+</span><span class="s1">&#39;_mergeddb&#39;</span><span class="p">)</span>

        <span class="n">fws_deps</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">autoparal_fws</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># non-linear calculations do not support autoparal</span>
        <span class="k">if</span> <span class="n">autoparal</span><span class="p">:</span>
            <span class="c1"># add an AutoparalTask for each type and relative dependencies</span>
            <span class="n">dfpt_autoparal_fw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_autoparal_fw</span><span class="p">(</span><span class="n">ddk_inp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;dfpt&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">ScfFWTask</span><span class="o">.</span><span class="n">task_type</span><span class="p">:</span> <span class="s2">&quot;WFK&quot;</span><span class="p">},</span> <span class="n">spec</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">autoparal_fws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dfpt_autoparal_fw</span><span class="p">)</span>

            <span class="n">fws_deps</span><span class="p">[</span><span class="n">dfpt_autoparal_fw</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph_fws</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddk_fws</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dde_fws</span>

            <span class="c1"># being a fake autoparal it doesn&#39;t need to follow the dde tasks. No other dependencies are enforced.</span>
            <span class="n">dte_autoparal_fw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_autoparal_fw</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;dte&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span>
                                                     <span class="n">ddk_inp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">composition</span><span class="o">.</span><span class="n">reduced_formula</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">autoparal_fws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dte_autoparal_fw</span><span class="p">)</span>

            <span class="n">fws_deps</span><span class="p">[</span><span class="n">dte_autoparal_fw</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dte_fws</span>

        <span class="k">for</span> <span class="n">ddk_fw</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddk_fws</span><span class="p">:</span>
            <span class="n">fws_deps</span><span class="p">[</span><span class="n">ddk_fw</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dde_fws</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dte_fws</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">dde_fw</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dde_fws</span><span class="p">:</span>
            <span class="n">fws_deps</span><span class="p">[</span><span class="n">dde_fw</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dte_fws</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph_fws</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ph_fw</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph_fws</span><span class="p">:</span>
                <span class="n">fws_deps</span><span class="p">[</span><span class="n">ph_fw</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dte_fws</span><span class="p">)</span>

        <span class="n">ddb_fws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dde_fws</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ph_fws</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dte_fws</span>
        <span class="k">for</span> <span class="n">ddb_fw</span> <span class="ow">in</span> <span class="n">ddb_fws</span><span class="p">:</span>
            <span class="n">fws_deps</span><span class="p">[</span><span class="n">ddb_fw</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mrgddb_fw</span><span class="p">)</span>

        <span class="n">fws_deps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scf_fw</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ddb_fws</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">ddk_fws</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoparal_fws</span><span class="p">)</span>

        <span class="n">total_list_fws</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scf_fw</span><span class="p">]</span> <span class="o">+</span> <span class="n">ddb_fws</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">ddk_fws</span><span class="o">+</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mrgddb_fw</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoparal_fws</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wf</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">total_list_fws</span><span class="p">,</span> <span class="n">fws_deps</span><span class="p">,</span>
                           <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;workflow_class&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow_class</span><span class="p">,</span> <span class="s1">&#39;workflow_module&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow_module</span><span class="p">})</span>

<div class="viewcode-block" id="DteFWWorkflow.get_fws"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.DteFWWorkflow.get_fws">[docs]</a>    <span class="k">def</span> <span class="nf">get_fws</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multi_inp</span><span class="p">,</span> <span class="n">task_class</span><span class="p">,</span> <span class="n">deps</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepares the fireworks for a specific type of calculation</span>

<span class="sd">        Args:</span>
<span class="sd">            multi_inp: |MultiDataset| with the inputs that should be run</span>
<span class="sd">            task_class: class of the tasks that should be generated</span>
<span class="sd">            deps: dict with the dependencies already set for this type of task</span>
<span class="sd">            spec: spec for the new Fireworks that will be created</span>

<span class="sd">        Returns:</span>
<span class="sd">            The list of new Fireworks.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">formula</span> <span class="o">=</span> <span class="n">multi_inp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">composition</span><span class="o">.</span><span class="n">reduced_formula</span>
        <span class="n">fws</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">autoparal_spec</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">inp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">multi_inp</span><span class="p">):</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
            <span class="n">start_task_index</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">task_class</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">deps</span><span class="p">),</span> <span class="n">is_autoparal</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># this index is for the different task, each performing a different perturbation</span>
            <span class="n">indexed_task_type</span> <span class="o">=</span> <span class="n">task_class</span><span class="o">.</span><span class="n">task_type</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="c1"># this index is to index the restarts of the single task</span>
            <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;wf_task_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">indexed_task_type</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">start_task_index</span><span class="p">)</span>
            <span class="n">fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="n">formula</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">indexed_task_type</span><span class="p">)[:</span><span class="mi">15</span><span class="p">])</span>
            <span class="n">fws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fw</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fws</span></div>

<div class="viewcode-block" id="DteFWWorkflow.get_autoparal_fw"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.DteFWWorkflow.get_autoparal_fw">[docs]</a>    <span class="k">def</span> <span class="nf">get_autoparal_fw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inp</span><span class="p">,</span> <span class="n">task_type</span><span class="p">,</span> <span class="n">deps</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">formula</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepares a single Firework conatining an AutoparalTask to perform the autoparal for each group of calculations.</span>

<span class="sd">        Args:</span>
<span class="sd">            inp: one of the inputs for which the autoparal should be run</span>
<span class="sd">            task_type: task_type of the class for the current type of calculation</span>
<span class="sd">            deps: dict with the dependencies already set for this type of task</span>
<span class="sd">            spec: spec for the new Fireworks that will be created</span>

<span class="sd">        Returns:</span>
<span class="sd">            The Firework with the autoparal.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">deps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">formula</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">formula</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">composition</span><span class="o">.</span><span class="n">reduced_formula</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">AutoparalTask</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">deps</span><span class="p">),</span> <span class="n">forward_spec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># this index is for the different task, each performing a different perturbation</span>
        <span class="n">indexed_task_type</span> <span class="o">=</span> <span class="n">AutoparalTask</span><span class="o">.</span><span class="n">task_type</span>
        <span class="c1"># this index is to index the restarts of the single task</span>
        <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;wf_task_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">indexed_task_type</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">task_type</span>
        <span class="n">fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="n">formula</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">indexed_task_type</span><span class="p">)[:</span><span class="mi">15</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">fw</span></div>

<div class="viewcode-block" id="DteFWWorkflow.from_factory"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.DteFWWorkflow.from_factory">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_factory</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">pseudos</span><span class="p">,</span> <span class="n">kppa</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ecut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pawecutdg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nband</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">accuracy</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span>
                     <span class="n">spin_mode</span><span class="o">=</span><span class="s2">&quot;polarized&quot;</span><span class="p">,</span> <span class="n">smearing</span><span class="o">=</span><span class="s2">&quot;fermi_dirac:0.1 eV&quot;</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">scf_algorithm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">shift_mode</span><span class="o">=</span><span class="s2">&quot;Symmetric&quot;</span><span class="p">,</span> <span class="n">scf_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ph_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ddk_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dde_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">use_phonons</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">extra_abivars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">decorators</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">autoparal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">initialization_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip_dte_permutations</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates an instance of DteFWWorkflow using the scf_for_phonons and dte_from_gsinput factory functions.</span>
<span class="sd">        See the description of the factories for the definition of the arguments.</span>
<span class="sd">        The manager can be a TaskManager or a FWTaskManager.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">extra_abivars</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">extra_abivars</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">decorators</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">decorators</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">initialization_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">initialization_info</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="n">FWTaskManager</span><span class="p">):</span>
            <span class="n">manager</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">task_manager</span>
            <span class="k">if</span> <span class="n">manager</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;A TaskManager is required in the FWTaskManager.&quot;</span><span class="p">)</span>

        <span class="n">initialization_info</span><span class="p">[</span><span class="s1">&#39;use_phonons&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">use_phonons</span>
        <span class="k">if</span> <span class="s1">&#39;kppa&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">initialization_info</span><span class="p">:</span>
            <span class="n">initialization_info</span><span class="p">[</span><span class="s1">&#39;kppa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kppa</span>

        <span class="k">if</span> <span class="n">scf_tol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scf_tol</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;tolwfr&#39;</span><span class="p">:</span> <span class="mf">1e-22</span><span class="p">}</span>

        <span class="n">scf_inp</span> <span class="o">=</span> <span class="n">scf_for_phonons</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="n">structure</span><span class="p">,</span> <span class="n">pseudos</span><span class="o">=</span><span class="n">pseudos</span><span class="p">,</span> <span class="n">kppa</span><span class="o">=</span><span class="n">kppa</span><span class="p">,</span> <span class="n">ecut</span><span class="o">=</span><span class="n">ecut</span><span class="p">,</span> <span class="n">pawecutdg</span><span class="o">=</span><span class="n">pawecutdg</span><span class="p">,</span>
                                  <span class="n">nband</span><span class="o">=</span><span class="n">nband</span><span class="p">,</span> <span class="n">accuracy</span><span class="o">=</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">spin_mode</span><span class="o">=</span><span class="n">spin_mode</span><span class="p">,</span> <span class="n">smearing</span><span class="o">=</span><span class="n">smearing</span><span class="p">,</span>
                                  <span class="n">charge</span><span class="o">=</span><span class="n">charge</span><span class="p">,</span> <span class="n">scf_algorithm</span><span class="o">=</span><span class="n">scf_algorithm</span><span class="p">,</span> <span class="n">shift_mode</span><span class="o">=</span><span class="n">shift_mode</span><span class="p">)</span>

        <span class="c1"># Set the additional variables coming from the user to the scf_inp before passing it to the factory.</span>
        <span class="c1"># Here is mandatory since often it would be needed to set manually the ixc, if the proper pseudopotential</span>
        <span class="c1"># are not available and the generation of the dte inputs will fail if an unsupported ixc is used.</span>
        <span class="n">scf_inp</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">extra_abivars</span><span class="p">)</span>
        <span class="n">scf_inp</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">scf_tol</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">decorators</span><span class="p">:</span>
            <span class="n">d</span><span class="p">(</span><span class="n">scf_inp</span><span class="p">)</span>

        <span class="n">inp</span> <span class="o">=</span> <span class="n">dte_from_gsinput</span><span class="p">(</span><span class="n">scf_inp</span><span class="p">,</span> <span class="n">use_phonons</span><span class="o">=</span><span class="n">use_phonons</span><span class="p">,</span> <span class="n">dde_tol</span><span class="o">=</span><span class="n">dde_tol</span><span class="p">,</span> <span class="n">ddk_tol</span><span class="o">=</span><span class="n">ddk_tol</span><span class="p">,</span> <span class="n">ph_tol</span><span class="o">=</span><span class="n">ph_tol</span><span class="p">,</span>
                               <span class="n">skip_dte_permutations</span><span class="o">=</span><span class="n">skip_dte_permutations</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">)</span>

        <span class="c1"># set the additional variables coming from the user</span>
        <span class="n">scf_inp</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">extra_abivars</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">decorators</span><span class="p">:</span>
            <span class="n">d</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>

        <span class="n">dte_wf</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">scf_inp</span><span class="p">,</span> <span class="n">ddk_inp</span><span class="o">=</span><span class="n">inp</span><span class="o">.</span><span class="n">filter_by_tags</span><span class="p">(</span><span class="n">atags</span><span class="o">.</span><span class="n">DDK</span><span class="p">),</span> <span class="n">dde_inp</span><span class="o">=</span><span class="n">inp</span><span class="o">.</span><span class="n">filter_by_tags</span><span class="p">(</span><span class="n">atags</span><span class="o">.</span><span class="n">DDE</span><span class="p">),</span>
                     <span class="n">dte_inp</span><span class="o">=</span><span class="n">inp</span><span class="o">.</span><span class="n">filter_by_tags</span><span class="p">(</span><span class="n">atags</span><span class="o">.</span><span class="n">DTE</span><span class="p">),</span> <span class="n">ph_inp</span><span class="o">=</span><span class="n">inp</span><span class="o">.</span><span class="n">filter_by_tags</span><span class="p">(</span><span class="n">atags</span><span class="o">.</span><span class="n">PH_Q_PERT</span><span class="p">),</span> <span class="n">autoparal</span><span class="o">=</span><span class="n">autoparal</span><span class="p">,</span>
                     <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">initialization_info</span><span class="o">=</span><span class="n">initialization_info</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dte_wf</span></div>

<div class="viewcode-block" id="DteFWWorkflow.from_gs_input"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.DteFWWorkflow.from_gs_input">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_gs_input</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">gs_input</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scf_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ph_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ddk_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dde_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">use_phonons</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">extra_abivars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">decorators</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">autoparal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">initialization_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip_dte_permutations</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates an instance of DteFWWorkflow using a custom AbinitInput for a ground state calculation and the</span>
<span class="sd">        dte_from_gsinput factory function. Tolerances for the scf will be set accordingly to scf_tol (with</span>
<span class="sd">        default 1e-22) and keys relative to relaxation and parallelization will be removed from gs_input.</span>
<span class="sd">        See the description of the dte_from_gsinput factory for the definition of the arguments.</span>
<span class="sd">        The manager can be a TaskManager or a FWTaskManager.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">extra_abivars</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">extra_abivars</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">decorators</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">decorators</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">initialization_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">initialization_info</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="n">FWTaskManager</span><span class="p">):</span>
            <span class="n">manager</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">task_manager</span>
            <span class="k">if</span> <span class="n">manager</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;A TaskManager is required in the FWTaskManager.&quot;</span><span class="p">)</span>

        <span class="n">initialization_info</span><span class="p">[</span><span class="s1">&#39;use_phonos&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">use_phonons</span>

        <span class="n">scf_inp</span> <span class="o">=</span> <span class="n">gs_input</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">structure</span><span class="p">:</span>
            <span class="n">scf_inp</span><span class="o">.</span><span class="n">set_structure</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scf_tol</span><span class="p">:</span>
            <span class="n">scf_inp</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">scf_tol</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scf_inp</span><span class="p">[</span><span class="s1">&#39;tolwfr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.e-22</span>
        <span class="n">scf_inp</span><span class="p">[</span><span class="s1">&#39;chksymbreak&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">scf_inp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nbdbuf&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">scf_inp</span><span class="p">[</span><span class="s1">&#39;nbdbuf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">scf_inp</span><span class="p">[</span><span class="s1">&#39;nband&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scf_inp</span><span class="p">[</span><span class="s1">&#39;nband&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span>
        <span class="n">abi_vars</span> <span class="o">=</span> <span class="n">get_abinit_variables</span><span class="p">()</span>
        <span class="c1"># remove relaxation variables in case gs_input is a relaxation</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">abi_vars</span><span class="o">.</span><span class="n">vars_with_varset</span><span class="p">(</span><span class="s1">&#39;rlx&#39;</span><span class="p">):</span>
            <span class="n">scf_inp</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># remove parallelization variables in case gs_input is coming from a previous run with parallelization</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">abi_vars</span><span class="o">.</span><span class="n">vars_with_varset</span><span class="p">(</span><span class="s1">&#39;paral&#39;</span><span class="p">):</span>
            <span class="n">scf_inp</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Set the additional variables coming from the user to the scf_inp before passing it to the factory.</span>
        <span class="c1"># Here is mandatory since often it would be needed to set manually the ixc, if the proper pseudopotential</span>
        <span class="c1"># are not available and the generation of the dte inputs will fail if an unsupported ixc is used.</span>
        <span class="n">scf_inp</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">extra_abivars</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">decorators</span><span class="p">:</span>
            <span class="n">d</span><span class="p">(</span><span class="n">scf_inp</span><span class="p">)</span>

        <span class="n">inp</span> <span class="o">=</span> <span class="n">dte_from_gsinput</span><span class="p">(</span><span class="n">scf_inp</span><span class="p">,</span> <span class="n">use_phonons</span><span class="o">=</span><span class="n">use_phonons</span><span class="p">,</span> <span class="n">dde_tol</span><span class="o">=</span><span class="n">dde_tol</span><span class="p">,</span> <span class="n">ddk_tol</span><span class="o">=</span><span class="n">ddk_tol</span><span class="p">,</span> <span class="n">ph_tol</span><span class="o">=</span><span class="n">ph_tol</span><span class="p">,</span>
                               <span class="n">skip_dte_permutations</span><span class="o">=</span><span class="n">skip_dte_permutations</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">)</span>

        <span class="c1"># set the additional variables coming from the user</span>
        <span class="n">scf_inp</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">extra_abivars</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">decorators</span><span class="p">:</span>
            <span class="n">d</span><span class="p">(</span><span class="n">inp</span><span class="p">)</span>

        <span class="n">dte_wf</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">scf_inp</span><span class="p">,</span> <span class="n">ddk_inp</span><span class="o">=</span><span class="n">inp</span><span class="o">.</span><span class="n">filter_by_tags</span><span class="p">(</span><span class="n">atags</span><span class="o">.</span><span class="n">DDK</span><span class="p">),</span> <span class="n">dde_inp</span><span class="o">=</span><span class="n">inp</span><span class="o">.</span><span class="n">filter_by_tags</span><span class="p">(</span><span class="n">atags</span><span class="o">.</span><span class="n">DDE</span><span class="p">),</span>
                     <span class="n">dte_inp</span><span class="o">=</span><span class="n">inp</span><span class="o">.</span><span class="n">filter_by_tags</span><span class="p">(</span><span class="n">atags</span><span class="o">.</span><span class="n">DTE</span><span class="p">),</span> <span class="n">ph_inp</span><span class="o">=</span><span class="n">inp</span><span class="o">.</span><span class="n">filter_by_tags</span><span class="p">(</span><span class="n">atags</span><span class="o">.</span><span class="n">PH_Q_PERT</span><span class="p">),</span> <span class="n">autoparal</span><span class="o">=</span><span class="n">autoparal</span><span class="p">,</span>
                     <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">initialization_info</span><span class="o">=</span><span class="n">initialization_info</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dte_wf</span></div>

<div class="viewcode-block" id="DteFWWorkflow.add_anaddb_dte_fw"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.DteFWWorkflow.add_anaddb_dte_fw">[docs]</a>    <span class="k">def</span> <span class="nf">add_anaddb_dte_fw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">dieflag</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nlflag</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ramansr</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alphon</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">prtmbm</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Appends a Firework with a task for the calculation of the third derivatives with anaddb.</span>

<span class="sd">        Args:</span>
<span class="sd">            structure: the input structure.</span>
<span class="sd">            dieflag: see anaddb documentation.</span>
<span class="sd">            nlflag: see anaddb documentation.</span>
<span class="sd">            ramansr: see anaddb documentation.</span>
<span class="sd">            alphon: see anaddb documentation.</span>
<span class="sd">            prtmbm: see anaddb documentation.</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">anaddb_input</span> <span class="o">=</span> <span class="n">AnaddbInput</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="n">structure</span><span class="p">)</span>
        <span class="n">anaddb_input</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">dieflag</span><span class="o">=</span><span class="n">dieflag</span><span class="p">,</span> <span class="n">nlflag</span><span class="o">=</span><span class="n">nlflag</span><span class="p">,</span> <span class="n">ramansr</span><span class="o">=</span><span class="n">ramansr</span><span class="p">,</span> <span class="n">alphon</span><span class="o">=</span><span class="n">alphon</span><span class="p">,</span> <span class="n">prtmbm</span><span class="o">=</span><span class="n">prtmbm</span><span class="p">)</span>
        <span class="n">anaddb_task</span> <span class="o">=</span> <span class="n">AnaDdbAbinitTask</span><span class="p">(</span><span class="n">anaddb_input</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="p">{</span><span class="n">MergeDdbAbinitTask</span><span class="o">.</span><span class="n">task_type</span><span class="p">:</span> <span class="s2">&quot;DDB&quot;</span><span class="p">})</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scf_fw</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;wf_task_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;anaddb&#39;</span>

        <span class="n">anaddb_fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">(</span><span class="n">anaddb_task</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anaddb&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">append_fw</span><span class="p">(</span><span class="n">anaddb_fw</span><span class="p">,</span> <span class="n">short_single_spec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="DteFWWorkflow.get_mongoengine_results"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.DteFWWorkflow.get_mongoengine_results">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_mongoengine_results</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">wf</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates the DteResult mongoengine document containing the results of the calculation.</span>
<span class="sd">        The workflow should have been generated from this class and requires an open connection to the</span>
<span class="sd">        fireworks database and access to the file system containing the calculations.</span>

<span class="sd">        Args:</span>
<span class="sd">            wf: the fireworks Workflow instance of the workflow.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A DteResult document.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="n">wf</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;workflow_class&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">workflow_class</span>
        <span class="k">assert</span> <span class="n">wf</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;workflow_module&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">workflow_module</span>

        <span class="n">scf_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ph_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ddk_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">dde_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">dte_index</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">anaddb_task</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">fw</span> <span class="ow">in</span> <span class="n">wf</span><span class="o">.</span><span class="n">fws</span><span class="p">:</span>
            <span class="n">task_index</span> <span class="o">=</span> <span class="n">fw</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wf_task_index&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">task_index</span> <span class="o">==</span> <span class="s1">&#39;anaddb&#39;</span><span class="p">:</span>
                <span class="n">anaddb_launch</span> <span class="o">=</span> <span class="n">get_last_completed_launch</span><span class="p">(</span><span class="n">fw</span><span class="p">)</span>
                <span class="n">anaddb_task</span> <span class="o">=</span> <span class="n">fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">anaddb_task</span><span class="o">.</span><span class="n">set_workdir</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">anaddb_launch</span><span class="o">.</span><span class="n">launch_dir</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">task_index</span> <span class="o">==</span> <span class="s1">&#39;mrgddb&#39;</span><span class="p">:</span>
                <span class="n">mrgddb_launch</span> <span class="o">=</span> <span class="n">get_last_completed_launch</span><span class="p">(</span><span class="n">fw</span><span class="p">)</span>
                <span class="n">mrgddb_task</span> <span class="o">=</span> <span class="n">fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">mrgddb_task</span><span class="o">.</span><span class="n">set_workdir</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">mrgddb_launch</span><span class="o">.</span><span class="n">launch_dir</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">task_index</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;scf_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">task_index</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;autoparal&#39;</span><span class="p">):</span>
                <span class="n">current_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">task_index</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">current_index</span> <span class="o">&gt;</span> <span class="n">scf_index</span><span class="p">:</span>
                    <span class="n">scf_index</span> <span class="o">=</span> <span class="n">current_index</span>
                    <span class="n">scf_fw</span> <span class="o">=</span> <span class="n">fw</span>
            <span class="k">elif</span> <span class="n">task_index</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;phonon_0&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">task_index</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;autoparal&#39;</span><span class="p">):</span>
                <span class="n">current_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">task_index</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">current_index</span> <span class="o">&gt;</span> <span class="n">ph_index</span><span class="p">:</span>
                    <span class="n">ph_index</span> <span class="o">=</span> <span class="n">current_index</span>
                    <span class="n">ph_fw</span> <span class="o">=</span> <span class="n">fw</span>
            <span class="k">elif</span> <span class="n">task_index</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ddk_0&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">task_index</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;autoparal&#39;</span><span class="p">):</span>
                <span class="n">current_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">task_index</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">current_index</span> <span class="o">&gt;</span> <span class="n">ddk_index</span><span class="p">:</span>
                    <span class="n">ddk_index</span> <span class="o">=</span> <span class="n">current_index</span>
                    <span class="n">ddk_fw</span> <span class="o">=</span> <span class="n">fw</span>
            <span class="k">elif</span> <span class="n">task_index</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;dde_0&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">task_index</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;autoparal&#39;</span><span class="p">):</span>
                <span class="n">current_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">task_index</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">current_index</span> <span class="o">&gt;</span> <span class="n">dde_index</span><span class="p">:</span>
                    <span class="n">dde_index</span> <span class="o">=</span> <span class="n">current_index</span>
                    <span class="n">dde_fw</span> <span class="o">=</span> <span class="n">fw</span>
            <span class="k">elif</span> <span class="n">task_index</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;dte_0&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">task_index</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;autoparal&#39;</span><span class="p">):</span>
                <span class="n">current_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">task_index</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">current_index</span> <span class="o">&gt;</span> <span class="n">dte_index</span><span class="p">:</span>
                    <span class="n">dte_index</span> <span class="o">=</span> <span class="n">current_index</span>
                    <span class="n">dte_fw</span> <span class="o">=</span> <span class="n">fw</span>

        <span class="n">scf_launch</span> <span class="o">=</span> <span class="n">get_last_completed_launch</span><span class="p">(</span><span class="n">scf_fw</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">scf_launch</span><span class="o">.</span><span class="n">launch_dir</span><span class="p">,</span> <span class="s1">&#39;history.json&#39;</span><span class="p">),</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">scf_history</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">MontyDecoder</span><span class="p">)</span>
        <span class="n">scf_task</span> <span class="o">=</span> <span class="n">scf_fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">scf_task</span><span class="o">.</span><span class="n">set_workdir</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">scf_launch</span><span class="o">.</span><span class="n">launch_dir</span><span class="p">)</span>

        <span class="n">document</span> <span class="o">=</span> <span class="n">DteResult</span><span class="p">()</span>

        <span class="n">gs_input</span> <span class="o">=</span> <span class="n">scf_history</span><span class="o">.</span><span class="n">get_events_by_types</span><span class="p">(</span><span class="n">TaskEvent</span><span class="o">.</span><span class="n">FINALIZED</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">details</span><span class="p">[</span><span class="s1">&#39;final_input&#39;</span><span class="p">]</span>

        <span class="n">document</span><span class="o">.</span><span class="n">abinit_input</span><span class="o">.</span><span class="n">gs_input</span> <span class="o">=</span> <span class="n">gs_input</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
        <span class="n">document</span><span class="o">.</span><span class="n">abinit_input</span><span class="o">.</span><span class="n">set_abinit_basic_from_abinit_input</span><span class="p">(</span><span class="n">gs_input</span><span class="p">)</span>

        <span class="n">structure</span> <span class="o">=</span> <span class="n">gs_input</span><span class="o">.</span><span class="n">structure</span>
        <span class="n">document</span><span class="o">.</span><span class="n">abinit_output</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
        <span class="n">document</span><span class="o">.</span><span class="n">set_material_data_from_structure</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>

        <span class="n">initialization_info</span> <span class="o">=</span> <span class="n">scf_history</span><span class="o">.</span><span class="n">get_events_by_types</span><span class="p">(</span><span class="n">TaskEvent</span><span class="o">.</span><span class="n">INITIALIZED</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;initialization_info&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">document</span><span class="o">.</span><span class="n">mp_id</span> <span class="o">=</span> <span class="n">initialization_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mp_id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">document</span><span class="o">.</span><span class="n">custom</span> <span class="o">=</span> <span class="n">initialization_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;custom&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">document</span><span class="o">.</span><span class="n">relax_db</span> <span class="o">=</span> <span class="n">initialization_info</span><span class="p">[</span><span class="s1">&#39;relax_db&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;relax_db&#39;</span> <span class="ow">in</span> <span class="n">initialization_info</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">document</span><span class="o">.</span><span class="n">relax_id</span> <span class="o">=</span> <span class="n">initialization_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;relax_id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">document</span><span class="o">.</span><span class="n">abinit_input</span><span class="o">.</span><span class="n">kppa</span> <span class="o">=</span> <span class="n">initialization_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kppa&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># True if set in the initialization_info. Otherwise True if phonon inputs are present.</span>
        <span class="n">document</span><span class="o">.</span><span class="n">abinit_input</span><span class="o">.</span><span class="n">with_phonons</span> <span class="o">=</span> <span class="n">initialization_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;use_phonons&#39;</span><span class="p">,</span> <span class="n">ph_index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">document</span><span class="o">.</span><span class="n">abinit_input</span><span class="o">.</span><span class="n">pseudopotentials</span><span class="o">.</span><span class="n">set_pseudos_from_files_file</span><span class="p">(</span><span class="n">scf_task</span><span class="o">.</span><span class="n">files_file</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                                                                           <span class="nb">len</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">composition</span><span class="o">.</span><span class="n">elements</span><span class="p">))</span>

        <span class="n">document</span><span class="o">.</span><span class="n">created_on</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">document</span><span class="o">.</span><span class="n">modified_on</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="n">document</span><span class="o">.</span><span class="n">set_dir_names_from_fws_wf</span><span class="p">(</span><span class="n">wf</span><span class="p">)</span>

        <span class="c1"># read in binary for py3k compatibility with mongoengine</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">mrgddb_task</span><span class="o">.</span><span class="n">merged_ddb_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">document</span><span class="o">.</span><span class="n">abinit_output</span><span class="o">.</span><span class="n">ddb</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ph_index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ph_task</span> <span class="o">=</span> <span class="n">ph_fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">document</span><span class="o">.</span><span class="n">abinit_input</span><span class="o">.</span><span class="n">phonon_input</span> <span class="o">=</span> <span class="n">ph_task</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>

        <span class="n">ddk_task</span> <span class="o">=</span> <span class="n">ddk_fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">document</span><span class="o">.</span><span class="n">abinit_input</span><span class="o">.</span><span class="n">ddk_input</span> <span class="o">=</span> <span class="n">ddk_task</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>

        <span class="n">dde_task</span> <span class="o">=</span> <span class="n">dde_fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">document</span><span class="o">.</span><span class="n">abinit_input</span><span class="o">.</span><span class="n">dde_input</span> <span class="o">=</span> <span class="n">dde_task</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>

        <span class="n">dte_task</span> <span class="o">=</span> <span class="n">dte_fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">document</span><span class="o">.</span><span class="n">abinit_input</span><span class="o">.</span><span class="n">dte_input</span> <span class="o">=</span> <span class="n">dte_task</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">anaddb_task</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">anaddb_task</span><span class="o">.</span><span class="n">anaddb_nc_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">document</span><span class="o">.</span><span class="n">abinit_output</span><span class="o">.</span><span class="n">anaddb_nc</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">anc</span> <span class="o">=</span> <span class="n">AnaddbNcFile</span><span class="p">(</span><span class="n">anaddb_task</span><span class="o">.</span><span class="n">anaddb_nc_path</span><span class="p">)</span>
            <span class="c1"># the result is None if missing from the anaddb.nc</span>
            <span class="n">epsinf</span> <span class="o">=</span> <span class="n">anc</span><span class="o">.</span><span class="n">epsinf</span>
            <span class="k">if</span> <span class="n">epsinf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">document</span><span class="o">.</span><span class="n">abinit_output</span><span class="o">.</span><span class="n">epsinf</span> <span class="o">=</span> <span class="n">epsinf</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="n">eps0</span> <span class="o">=</span> <span class="n">anc</span><span class="o">.</span><span class="n">eps0</span>
            <span class="k">if</span> <span class="n">eps0</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">document</span><span class="o">.</span><span class="n">abinit_output</span><span class="o">.</span><span class="n">eps0</span> <span class="o">=</span> <span class="n">eps0</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

            <span class="n">dchide</span> <span class="o">=</span> <span class="n">anc</span><span class="o">.</span><span class="n">dchide</span>
            <span class="k">if</span> <span class="n">dchide</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">document</span><span class="o">.</span><span class="n">abinit_output</span><span class="o">.</span><span class="n">dchide</span> <span class="o">=</span> <span class="n">dchide</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

            <span class="n">dchidt</span> <span class="o">=</span> <span class="n">anc</span><span class="o">.</span><span class="n">dchidt</span>
            <span class="k">if</span> <span class="n">dchidt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dchidt_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">dchidt</span><span class="p">:</span>
                    <span class="n">dd</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>
                        <span class="n">dd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                    <span class="n">dchidt_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span>
                <span class="n">document</span><span class="o">.</span><span class="n">abinit_output</span><span class="o">.</span><span class="n">dchidt</span> <span class="o">=</span> <span class="n">dchidt_list</span>

        <span class="n">document</span><span class="o">.</span><span class="n">fw_id</span> <span class="o">=</span> <span class="n">scf_fw</span><span class="o">.</span><span class="n">fw_id</span>

        <span class="n">document</span><span class="o">.</span><span class="n">time_report</span> <span class="o">=</span> <span class="n">get_time_report_for_wf</span><span class="p">(</span><span class="n">wf</span><span class="p">)</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">scf_task</span><span class="o">.</span><span class="n">gsr_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">document</span><span class="o">.</span><span class="n">abinit_output</span><span class="o">.</span><span class="n">gs_gsr</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="c1"># read in binary for py3k compatibility with mongoengine</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">scf_task</span><span class="o">.</span><span class="n">output_file</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">document</span><span class="o">.</span><span class="n">abinit_output</span><span class="o">.</span><span class="n">gs_outfile</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">document</span></div></div>


<div class="viewcode-block" id="PiezoElasticFWWorkflow"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.PiezoElasticFWWorkflow">[docs]</a><span class="k">class</span> <span class="nc">PiezoElasticFWWorkflow</span><span class="p">(</span><span class="n">AbstractFWWorkflow</span><span class="p">):</span>
    <span class="n">workflow_class</span> <span class="o">=</span> <span class="s1">&#39;PiezoElasticFWWorkflow&#39;</span>
    <span class="n">workflow_module</span> <span class="o">=</span> <span class="s1">&#39;abiflows.fireworks.workflows.abinit_workflows&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scf_inp</span><span class="p">,</span> <span class="n">ddk_inp</span><span class="p">,</span> <span class="n">rf_inp</span><span class="p">,</span> <span class="n">autoparal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initialization_info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">initialization_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">initialization_info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">rf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_reduced_formula</span><span class="p">(</span><span class="n">scf_inp</span><span class="p">)</span>

        <span class="n">scf_task</span> <span class="o">=</span> <span class="n">ScfFWTask</span><span class="p">(</span><span class="n">scf_inp</span><span class="p">,</span> <span class="n">is_autoparal</span><span class="o">=</span><span class="n">autoparal</span><span class="p">)</span>

        <span class="n">spec</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;initialization_info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initialization_info</span>
        <span class="k">if</span> <span class="n">autoparal</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_short_single_core_to_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scf_fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">(</span><span class="n">scf_task</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">rf</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">scf_task</span><span class="o">.</span><span class="n">task_type</span><span class="p">)</span>

        <span class="n">ddk_task</span> <span class="o">=</span> <span class="n">DdkTask</span><span class="p">(</span><span class="n">ddk_inp</span><span class="p">,</span> <span class="n">is_autoparal</span><span class="o">=</span><span class="n">autoparal</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="p">{</span><span class="n">scf_task</span><span class="o">.</span><span class="n">task_type</span><span class="p">:</span> <span class="s1">&#39;WFK&#39;</span><span class="p">})</span>

        <span class="n">ddk_fw_name</span> <span class="o">=</span> <span class="n">rf</span><span class="o">+</span><span class="n">ddk_task</span><span class="o">.</span><span class="n">task_type</span>
        <span class="n">ddk_fw_name</span> <span class="o">=</span> <span class="n">ddk_fw_name</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddk_fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">(</span><span class="n">ddk_task</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">ddk_fw_name</span><span class="p">)</span>

        <span class="n">rf_task</span> <span class="o">=</span> <span class="n">StrainPertTask</span><span class="p">(</span><span class="n">rf_inp</span><span class="p">,</span> <span class="n">is_autoparal</span><span class="o">=</span><span class="n">autoparal</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="p">{</span><span class="n">scf_task</span><span class="o">.</span><span class="n">task_type</span><span class="p">:</span> <span class="s1">&#39;WFK&#39;</span><span class="p">,</span> <span class="n">ddk_task</span><span class="o">.</span><span class="n">task_type</span><span class="p">:</span> <span class="s1">&#39;DDK&#39;</span><span class="p">})</span>

        <span class="n">rf_fw_name</span> <span class="o">=</span> <span class="n">rf</span><span class="o">+</span><span class="n">rf_task</span><span class="o">.</span><span class="n">task_type</span>
        <span class="n">rf_fw_name</span> <span class="o">=</span> <span class="n">rf_fw_name</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rf_fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">(</span><span class="n">rf_task</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">rf_fw_name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wf</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">fireworks</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scf_fw</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddk_fw</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rf_fw</span><span class="p">],</span>
                           <span class="n">links_dict</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scf_fw</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddk_fw</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddk_fw</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">rf_fw</span><span class="p">},</span>
                           <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;workflow_class&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow_class</span><span class="p">,</span>
                                     <span class="s1">&#39;workflow_module&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow_module</span><span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_anaddb_task</span><span class="p">(</span><span class="n">scf_inp</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span>

<div class="viewcode-block" id="PiezoElasticFWWorkflow.add_anaddb_task"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.PiezoElasticFWWorkflow.add_anaddb_task">[docs]</a>    <span class="k">def</span> <span class="nf">add_anaddb_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">):</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_short_single_core_to_spec</span><span class="p">()</span>
        <span class="n">anaddb_task</span> <span class="o">=</span> <span class="n">AnaDdbAbinitTask</span><span class="p">(</span><span class="n">AnaddbInput</span><span class="o">.</span><span class="n">piezo_elastic</span><span class="p">(</span><span class="n">structure</span><span class="p">))</span>
        <span class="n">anaddb_fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">([</span><span class="n">anaddb_task</span><span class="p">],</span>
                             <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span>
                             <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anaddb&#39;</span><span class="p">)</span>
        <span class="n">append_fw_to_wf</span><span class="p">(</span><span class="n">anaddb_fw</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wf</span><span class="p">)</span></div>

<div class="viewcode-block" id="PiezoElasticFWWorkflow.add_mrgddb_task"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.PiezoElasticFWWorkflow.add_mrgddb_task">[docs]</a>    <span class="k">def</span> <span class="nf">add_mrgddb_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">):</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_short_single_core_to_spec</span><span class="p">()</span>
        <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;ddb_files_task_types&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;scf&#39;</span><span class="p">,</span> <span class="s1">&#39;strain_pert&#39;</span><span class="p">]</span>
        <span class="n">mrgddb_task</span> <span class="o">=</span> <span class="n">MergeDdbAbinitTask</span><span class="p">()</span>
        <span class="n">mrgddb_fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">([</span><span class="n">mrgddb_task</span><span class="p">],</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;mrgddb&#39;</span><span class="p">)</span>
        <span class="n">append_fw_to_wf</span><span class="p">(</span><span class="n">mrgddb_fw</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wf</span><span class="p">)</span></div>

<div class="viewcode-block" id="PiezoElasticFWWorkflow.get_elastic_tensor_and_history"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.PiezoElasticFWWorkflow.get_elastic_tensor_and_history">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_elastic_tensor_and_history</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">wf</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">wf</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;workflow_class&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">workflow_class</span>
        <span class="k">assert</span> <span class="n">wf</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;workflow_module&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">workflow_module</span>

        <span class="n">final_fw_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">fw_id</span><span class="p">,</span> <span class="n">fw</span> <span class="ow">in</span> <span class="n">wf</span><span class="o">.</span><span class="n">id_fw</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">fw</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;anaddb&#39;</span><span class="p">:</span>
                <span class="n">final_fw_id</span> <span class="o">=</span> <span class="n">fw_id</span>
        <span class="k">if</span> <span class="n">final_fw_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Final anaddb task not found ...&#39;</span><span class="p">)</span>
        <span class="n">myfw</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">id_fw</span><span class="p">[</span><span class="n">final_fw_id</span><span class="p">]</span>
        <span class="c1">#TODO add a check on the state of the launches</span>
        <span class="n">last_launch</span> <span class="o">=</span> <span class="p">(</span><span class="n">myfw</span><span class="o">.</span><span class="n">archived_launches</span> <span class="o">+</span> <span class="n">myfw</span><span class="o">.</span><span class="n">launches</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1">#TODO add a cycle to find the instance of AbiFireTask?</span>
        <span class="n">myfw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_workdir</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">last_launch</span><span class="o">.</span><span class="n">launch_dir</span><span class="p">)</span>
        <span class="n">elastic_tensor</span> <span class="o">=</span> <span class="n">myfw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_elastic_tensor</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">last_launch</span><span class="o">.</span><span class="n">launch_dir</span><span class="p">,</span> <span class="s1">&#39;history.json&#39;</span><span class="p">),</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">history</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">MontyDecoder</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;elastic_properties&#39;</span><span class="p">:</span> <span class="n">elastic_tensor</span><span class="o">.</span><span class="n">extended_dict</span><span class="p">(),</span> <span class="s1">&#39;history&#39;</span><span class="p">:</span> <span class="n">history</span><span class="p">}</span></div>

<div class="viewcode-block" id="PiezoElasticFWWorkflow.get_all_elastic_tensors"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.PiezoElasticFWWorkflow.get_all_elastic_tensors">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_all_elastic_tensors</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">wf</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">wf</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;workflow_class&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">workflow_class</span>
        <span class="k">assert</span> <span class="n">wf</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;workflow_module&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">workflow_module</span>

        <span class="n">final_fw_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">fw_id</span><span class="p">,</span> <span class="n">fw</span> <span class="ow">in</span> <span class="n">wf</span><span class="o">.</span><span class="n">id_fw</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">fw</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;anaddb&#39;</span><span class="p">:</span>
                <span class="n">final_fw_id</span> <span class="o">=</span> <span class="n">fw_id</span>
        <span class="k">if</span> <span class="n">final_fw_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Final anaddb task not found ...&#39;</span><span class="p">)</span>
        <span class="n">myfw</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">id_fw</span><span class="p">[</span><span class="n">final_fw_id</span><span class="p">]</span>
        <span class="c1">#TODO add a check on the state of the launches</span>
        <span class="n">last_launch</span> <span class="o">=</span> <span class="p">(</span><span class="n">myfw</span><span class="o">.</span><span class="n">archived_launches</span> <span class="o">+</span> <span class="n">myfw</span><span class="o">.</span><span class="n">launches</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1">#TODO add a cycle to find the instance of AbiFireTask?</span>
        <span class="n">myfw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_workdir</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">last_launch</span><span class="o">.</span><span class="n">launch_dir</span><span class="p">)</span>
        <span class="n">elastic_tensor</span> <span class="o">=</span> <span class="n">myfw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_elastic_tensor</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">last_launch</span><span class="o">.</span><span class="n">launch_dir</span><span class="p">,</span> <span class="s1">&#39;history.json&#39;</span><span class="p">),</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">history</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">MontyDecoder</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;elastic_properties&#39;</span><span class="p">:</span> <span class="n">elastic_tensor</span><span class="o">.</span><span class="n">extended_dict</span><span class="p">(),</span> <span class="s1">&#39;history&#39;</span><span class="p">:</span> <span class="n">history</span><span class="p">}</span></div>

<div class="viewcode-block" id="PiezoElasticFWWorkflow.from_factory"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.PiezoElasticFWWorkflow.from_factory">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_factory</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;from factory method not yet implemented for piezoelasticworkflow&#39;</span><span class="p">)</span></div></div>


<span class="c1"># TODO old version based on GeneratePiezoElasticFlowFWAbinitTask with SRC. Should be removed after adapting.</span>
<span class="c1"># class PiezoElasticFWWorkflowSRCOld(AbstractFWWorkflow):</span>
<span class="c1">#     workflow_class = &#39;PiezoElasticFWWorkflowSRC&#39;</span>
<span class="c1">#     workflow_module = &#39;abiflows.fireworks.workflows.abinit_workflows&#39;</span>
<span class="c1">#</span>
<span class="c1">#     STANDARD_HANDLERS = {&#39;_all&#39;: [MemoryHandler(), WalltimeHandler()]}</span>
<span class="c1">#     STANDARD_VALIDATORS = {&#39;_all&#39;: []}</span>
<span class="c1">#</span>
<span class="c1">#     def __init__(self, scf_inp_ibz, ddk_inp, rf_inp, spec=None, initialization_info=None,</span>
<span class="c1">#                  handlers=None, validators=None, ddk_split=False, rf_split=False):</span>
<span class="c1">#         if spec is None:</span>
<span class="c1">#             spec = {}</span>
<span class="c1">#         if initialization_info is None:</span>
<span class="c1">#             initialization_info = {}</span>
<span class="c1">#         if handlers is None:</span>
<span class="c1">#             handlers = self.STANDARD_HANDLERS</span>
<span class="c1">#         if validators is None:</span>
<span class="c1">#             validators = self.STANDARD_VALIDATORS</span>
<span class="c1">#</span>
<span class="c1">#         fws = []</span>
<span class="c1">#         links_dict = {}</span>
<span class="c1">#</span>
<span class="c1">#         if &#39;queue_adapter_update&#39; in initialization_info:</span>
<span class="c1">#             queue_adapter_update = initialization_info[&#39;queue_adapter_update&#39;]</span>
<span class="c1">#         else:</span>
<span class="c1">#             queue_adapter_update = None</span>
<span class="c1">#</span>
<span class="c1">#         # If handlers are passed as a list, they should be applied on all task_types</span>
<span class="c1">#         if isinstance(handlers, (list, tuple)):</span>
<span class="c1">#             handlers = {&#39;_all&#39;: handlers}</span>
<span class="c1">#         # If validators are passed as a list, they should be applied on all task_types</span>
<span class="c1">#         if isinstance(validators, (list, tuple)):</span>
<span class="c1">#             validators = {&#39;_all&#39;: validators}</span>
<span class="c1">#</span>
<span class="c1">#         #1. First SCF run in the irreducible Brillouin Zone</span>
<span class="c1">#         SRC_scf_ibz_fws = createSRCFireworksOld(task_class=ScfFWTask, task_input=scf_inp_ibz, SRC_spec=spec,</span>
<span class="c1">#                                                 initialization_info=initialization_info,</span>
<span class="c1">#                                                 wf_task_index_prefix=&#39;scfibz&#39;, task_type=&#39;scfibz&#39;,</span>
<span class="c1">#                                                 handlers=handlers[&#39;_all&#39;], validators=validators[&#39;_all&#39;],</span>
<span class="c1">#                                                 queue_adapter_update=queue_adapter_update)</span>
<span class="c1">#         fws.extend(SRC_scf_ibz_fws[&#39;fws&#39;])</span>
<span class="c1">#         links_dict_update(links_dict=links_dict, links_update=SRC_scf_ibz_fws[&#39;links_dict&#39;])</span>
<span class="c1">#</span>
<span class="c1">#         #2. Second SCF run in the full Brillouin Zone with kptopt 3 in order to allow merging 1st derivative DDB&#39;s with</span>
<span class="c1">#         #2nd derivative DDB&#39;s from the DFPT RF run</span>
<span class="c1">#         scf_inp_fbz = scf_inp_ibz.deepcopy()</span>
<span class="c1">#         scf_inp_fbz[&#39;kptopt&#39;] = 2</span>
<span class="c1">#         SRC_scf_fbz_fws = createSRCFireworksOld(task_class=ScfFWTask, task_input=scf_inp_fbz, SRC_spec=spec,</span>
<span class="c1">#                                                 initialization_info=initialization_info,</span>
<span class="c1">#                                                 wf_task_index_prefix=&#39;scffbz&#39;, task_type=&#39;scffbz&#39;,</span>
<span class="c1">#                                                 handlers=handlers[&#39;_all&#39;], validators=validators[&#39;_all&#39;],</span>
<span class="c1">#                                                 deps={SRC_scf_ibz_fws[&#39;run_fw&#39;].tasks[0].task_type: [&#39;DEN&#39;, &#39;WFK&#39;]},</span>
<span class="c1">#                                                 queue_adapter_update=queue_adapter_update)</span>
<span class="c1">#         fws.extend(SRC_scf_fbz_fws[&#39;fws&#39;])</span>
<span class="c1">#         links_dict_update(links_dict=links_dict, links_update=SRC_scf_fbz_fws[&#39;links_dict&#39;])</span>
<span class="c1">#         #Link with previous SCF</span>
<span class="c1">#         links_dict_update(links_dict=links_dict,</span>
<span class="c1">#                           links_update={SRC_scf_ibz_fws[&#39;check_fw&#39;].fw_id: SRC_scf_fbz_fws[&#39;setup_fw&#39;].fw_id})</span>
<span class="c1">#</span>
<span class="c1">#         #3. DDK calculation</span>
<span class="c1">#         if ddk_split:</span>
<span class="c1">#             raise NotImplementedError(&#39;Split Ddk to be implemented in PiezoElasticWorkflow ...&#39;)</span>
<span class="c1">#         else:</span>
<span class="c1">#             SRC_ddk_fws = createSRCFireworksOld(task_class=DdkTask, task_input=ddk_inp, SRC_spec=spec,</span>
<span class="c1">#                                                 initialization_info=initialization_info,</span>
<span class="c1">#                                                 wf_task_index_prefix=&#39;ddk&#39;,</span>
<span class="c1">#                                                 handlers=handlers[&#39;_all&#39;], validators=validators[&#39;_all&#39;],</span>
<span class="c1">#                                                 deps={SRC_scf_ibz_fws[&#39;run_fw&#39;].tasks[0].task_type: &#39;WFK&#39;},</span>
<span class="c1">#                                                 queue_adapter_update=queue_adapter_update)</span>
<span class="c1">#             fws.extend(SRC_ddk_fws[&#39;fws&#39;])</span>
<span class="c1">#             links_dict_update(links_dict=links_dict, links_update=SRC_ddk_fws[&#39;links_dict&#39;])</span>
<span class="c1">#             #Link with the IBZ SCF run</span>
<span class="c1">#             links_dict_update(links_dict=links_dict,</span>
<span class="c1">#                               links_update={SRC_scf_ibz_fws[&#39;check_fw&#39;].fw_id: SRC_ddk_fws[&#39;setup_fw&#39;].fw_id})</span>
<span class="c1">#</span>
<span class="c1">#         #4. Response-Function calculation(s) of the elastic constants</span>
<span class="c1">#         if rf_split:</span>
<span class="c1">#             rf_ddb_source_task_type = &#39;mrgddb-strains&#39;</span>
<span class="c1">#             scf_task_type = SRC_scf_ibz_fws[&#39;run_fw&#39;].tasks[0].task_type</span>
<span class="c1">#             ddk_task_type = SRC_ddk_fws[&#39;run_fw&#39;].tasks[0].task_type</span>
<span class="c1">#             gen_task = GeneratePiezoElasticFlowFWAbinitTask(previous_scf_task_type=scf_task_type,</span>
<span class="c1">#                                                             previous_ddk_task_type=ddk_task_type,</span>
<span class="c1">#                                                             handlers=handlers, validators=validators,</span>
<span class="c1">#                                                             mrgddb_task_type=rf_ddb_source_task_type)</span>
<span class="c1">#             genrfstrains_spec = set_short_single_core_to_spec(spec)</span>
<span class="c1">#             gen_fw = Firework([gen_task], spec=genrfstrains_spec, name=&#39;gen-piezo-elast&#39;)</span>
<span class="c1">#             fws.append(gen_fw)</span>
<span class="c1">#             links_dict_update(links_dict=links_dict,</span>
<span class="c1">#                               links_update={SRC_scf_ibz_fws[&#39;check_fw&#39;].fw_id: gen_fw.fw_id,</span>
<span class="c1">#                                             SRC_ddk_fws[&#39;check_fw&#39;].fw_id: gen_fw.fw_id})</span>
<span class="c1">#             rf_ddb_src_fw = gen_fw</span>
<span class="c1">#         else:</span>
<span class="c1">#             SRC_rf_fws = createSRCFireworksOld(task_class=StrainPertTask, task_input=rf_inp, SRC_spec=spec,</span>
<span class="c1">#                                                initialization_info=initialization_info,</span>
<span class="c1">#                                                wf_task_index_prefix=&#39;rf&#39;,</span>
<span class="c1">#                                                handlers=handlers[&#39;_all&#39;], validators=validators[&#39;_all&#39;],</span>
<span class="c1">#                                                deps={SRC_scf_ibz_fws[&#39;run_fw&#39;].tasks[0].task_type: &#39;WFK&#39;,</span>
<span class="c1">#                                                      SRC_ddk_fws[&#39;run_fw&#39;].tasks[0].task_type: &#39;DDK&#39;},</span>
<span class="c1">#                                                queue_adapter_update=queue_adapter_update)</span>
<span class="c1">#             fws.extend(SRC_rf_fws[&#39;fws&#39;])</span>
<span class="c1">#             links_dict_update(links_dict=links_dict, links_update=SRC_rf_fws[&#39;links_dict&#39;])</span>
<span class="c1">#             #Link with the IBZ SCF run and the DDK run</span>
<span class="c1">#             links_dict_update(links_dict=links_dict,</span>
<span class="c1">#                               links_update={SRC_scf_ibz_fws[&#39;check_fw&#39;].fw_id: SRC_rf_fws[&#39;setup_fw&#39;].fw_id,</span>
<span class="c1">#                                             SRC_ddk_fws[&#39;check_fw&#39;].fw_id: SRC_rf_fws[&#39;setup_fw&#39;].fw_id})</span>
<span class="c1">#             rf_ddb_source_task_type = SRC_rf_fws[&#39;run_fw&#39;].tasks[0].task_type</span>
<span class="c1">#             rf_ddb_src_fw = SRC_rf_fws[&#39;check_fw&#39;]</span>
<span class="c1">#</span>
<span class="c1">#         #5. Merge DDB files from response function (second derivatives for the elastic constants) and from the</span>
<span class="c1">#         # SCF run on the full Brillouin zone (first derivatives for the stress tensor, to be used for the</span>
<span class="c1">#         # stress-corrected elastic constants)</span>
<span class="c1">#         mrgddb_task = MergeDdbAbinitTask(ddb_source_task_types=[rf_ddb_source_task_type,</span>
<span class="c1">#                                                                 SRC_scf_fbz_fws[&#39;run_fw&#39;].tasks[0].task_type],</span>
<span class="c1">#                                          delete_source_ddbs=False, num_ddbs=2)</span>
<span class="c1">#         mrgddb_spec = set_short_single_core_to_spec(spec)</span>
<span class="c1">#         mrgddb_fw = Firework(tasks=[mrgddb_task], spec=mrgddb_spec, name=&#39;mrgddb&#39;)</span>
<span class="c1">#         fws.append(mrgddb_fw)</span>
<span class="c1">#         links_dict_update(links_dict=links_dict,</span>
<span class="c1">#                           links_update={rf_ddb_src_fw.fw_id: mrgddb_fw.fw_id,</span>
<span class="c1">#                                         SRC_scf_fbz_fws[&#39;check_fw&#39;].fw_id: mrgddb_fw.fw_id})</span>
<span class="c1">#</span>
<span class="c1">#         #6. Anaddb task to get elastic constants based on the RF run (no stress correction)</span>
<span class="c1">#         anaddb_tag = &#39;anaddb-piezo-elast&#39;</span>
<span class="c1">#         spec = set_short_single_core_to_spec(spec)</span>
<span class="c1">#         anaddb_task = AnaDdbAbinitTask(AnaddbInput.piezo_elastic(structure=scf_inp_ibz.structure,</span>
<span class="c1">#                                                                  stress_correction=False),</span>
<span class="c1">#                                        deps={rf_ddb_source_task_type: [&#39;DDB&#39;]},</span>
<span class="c1">#                                        task_type=anaddb_tag)</span>
<span class="c1">#         anaddb_fw = Firework([anaddb_task],</span>
<span class="c1">#                              spec=spec,</span>
<span class="c1">#                              name=anaddb_tag)</span>
<span class="c1">#         fws.append(anaddb_fw)</span>
<span class="c1">#         links_dict_update(links_dict=links_dict,</span>
<span class="c1">#                           links_update={rf_ddb_src_fw.fw_id: anaddb_fw.fw_id})</span>
<span class="c1">#</span>
<span class="c1">#         #7. Anaddb task to get elastic constants based on the RF run and the SCF run (with stress correction)</span>
<span class="c1">#         anaddb_tag = &#39;anaddb-piezo-elast-stress-corrected&#39;</span>
<span class="c1">#         spec = set_short_single_core_to_spec(spec)</span>
<span class="c1">#         anaddb_stress_task = AnaDdbAbinitTask(AnaddbInput.piezo_elastic(structure=scf_inp_ibz.structure,</span>
<span class="c1">#                                                                         stress_correction=True),</span>
<span class="c1">#                                               deps={mrgddb_task.task_type: [&#39;DDB&#39;]},</span>
<span class="c1">#                                               task_type=anaddb_tag)</span>
<span class="c1">#         anaddb_stress_fw = Firework([anaddb_stress_task],</span>
<span class="c1">#                                     spec=spec,</span>
<span class="c1">#                                     name=anaddb_tag)</span>
<span class="c1">#         fws.append(anaddb_stress_fw)</span>
<span class="c1">#         links_dict_update(links_dict=links_dict,</span>
<span class="c1">#                           links_update={mrgddb_fw.fw_id: anaddb_stress_fw.fw_id})</span>
<span class="c1">#</span>
<span class="c1">#         self.wf = Workflow(fireworks=fws,</span>
<span class="c1">#                            links_dict=links_dict,</span>
<span class="c1">#                            metadata={&#39;workflow_class&#39;: self.workflow_class,</span>
<span class="c1">#                                      &#39;workflow_module&#39;: self.workflow_module})</span>
<span class="c1">#</span>
<span class="c1">#     @classmethod</span>
<span class="c1">#     def get_all_elastic_tensors(cls, wf):</span>
<span class="c1">#         assert wf.metadata[&#39;workflow_class&#39;] == cls.workflow_class</span>
<span class="c1">#         assert wf.metadata[&#39;workflow_module&#39;] == cls.workflow_module</span>
<span class="c1">#</span>
<span class="c1">#         anaddb_no_stress_id = None</span>
<span class="c1">#         anaddb_stress_id = None</span>
<span class="c1">#         for fw_id, fw in wf.id_fw.items():</span>
<span class="c1">#             if fw.name == &#39;anaddb-piezo-elast&#39;:</span>
<span class="c1">#                 anaddb_no_stress_id = fw_id</span>
<span class="c1">#             if fw.name == &#39;anaddb-piezo-elast-stress-corrected&#39;:</span>
<span class="c1">#                 anaddb_stress_id = fw_id</span>
<span class="c1">#         if anaddb_no_stress_id is None or anaddb_stress_id is None:</span>
<span class="c1">#             raise RuntimeError(&#39;Final anaddb tasks not found ...&#39;)</span>
<span class="c1">#         myfw_nostress = wf.id_fw[anaddb_no_stress_id]</span>
<span class="c1">#         last_launch_nostress = (myfw_nostress.archived_launches + myfw_nostress.launches)[-1]</span>
<span class="c1">#         myfw_nostress.tasks[-1].set_workdir(workdir=last_launch_nostress.launch_dir)</span>
<span class="c1">#</span>
<span class="c1">#         myfw_stress = wf.id_fw[anaddb_stress_id]</span>
<span class="c1">#         last_launch_stress = (myfw_stress.archived_launches + myfw_stress.launches)[-1]</span>
<span class="c1">#         myfw_stress.tasks[-1].set_workdir(workdir=last_launch_stress.launch_dir)</span>
<span class="c1">#</span>
<span class="c1">#         ec_nostress_clamped = myfw_nostress.tasks[-1].get_elastic_tensor(tensor_type=&#39;clamped_ion&#39;)</span>
<span class="c1">#         ec_nostress_relaxed = myfw_nostress.tasks[-1].get_elastic_tensor(tensor_type=&#39;relaxed_ion&#39;)</span>
<span class="c1">#         ec_stress_relaxed = myfw_stress.tasks[-1].get_elastic_tensor(tensor_type=&#39;relaxed_ion_stress_corrected&#39;)</span>
<span class="c1">#</span>
<span class="c1">#         ec_dicts = {&#39;clamped_ion&#39;: ec_nostress_clamped.extended_dict(),</span>
<span class="c1">#                     &#39;relaxed_ion&#39;: ec_nostress_relaxed.extended_dict(),</span>
<span class="c1">#                     &#39;relaxed_ion_stress_corrected&#39;: ec_stress_relaxed.extended_dict()}</span>
<span class="c1">#</span>
<span class="c1">#         return {&#39;elastic_properties&#39;: ec_dicts}</span>
<span class="c1">#</span>
<span class="c1">#     @classmethod</span>
<span class="c1">#     def from_factory(cls):</span>
<span class="c1">#         raise NotImplementedError(&#39;from factory method not yet implemented for piezoelasticworkflow&#39;)</span>


<div class="viewcode-block" id="PiezoElasticFWWorkflowSRC"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.PiezoElasticFWWorkflowSRC">[docs]</a><span class="k">class</span> <span class="nc">PiezoElasticFWWorkflowSRC</span><span class="p">(</span><span class="n">AbstractFWWorkflow</span><span class="p">):</span>
    <span class="n">workflow_class</span> <span class="o">=</span> <span class="s1">&#39;PiezoElasticFWWorkflowSRC&#39;</span>
    <span class="n">workflow_module</span> <span class="o">=</span> <span class="s1">&#39;abiflows.fireworks.workflows.abinit_workflows&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scf_inp_ibz</span><span class="p">,</span> <span class="n">ddk_inp</span><span class="p">,</span> <span class="n">rf_inp</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initialization_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">ddk_split</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rf_split</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">additional_controllers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">additional_input_vars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">allow_parallel_perturbations</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">do_ddk</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">do_phonons</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">initialization_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">initialization_info</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">fws</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">links_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">additional_controllers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">additional_controllers</span> <span class="o">=</span> <span class="p">[</span><span class="n">WalltimeController</span><span class="p">(),</span> <span class="n">MemoryController</span><span class="p">()]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">additional_controllers</span> <span class="o">=</span> <span class="n">additional_controllers</span>

        <span class="k">if</span> <span class="n">additional_input_vars</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">additional_input_vars</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Dependencies for the ngfft grid (for some reason, the fft grid can change between SCF and nSCF runs</span>
        <span class="c1"># even when all other parameters are the same ...)</span>
        <span class="n">ngfft_deps</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#outnc.ngfft&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">scf_inp_ibz</span><span class="o">.</span><span class="n">ispaw</span><span class="p">:</span>
            <span class="n">ngfft_deps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;#outnc.ngfftdg&#39;</span><span class="p">)</span>

        <span class="n">scf_inp_ibz</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">additional_input_vars</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">do_ddk</span><span class="p">:</span>
            <span class="n">ddk_inp</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">additional_input_vars</span><span class="p">)</span>
        <span class="n">rf_inp</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">additional_input_vars</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">do_ddk</span><span class="p">:</span>
            <span class="n">rf_inp</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">irdddk</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1">#1. SCF run in the irreducible Brillouin Zone</span>
        <span class="n">scf_helper</span> <span class="o">=</span> <span class="n">ScfTaskHelper</span><span class="p">()</span>
        <span class="n">scf_controllers</span> <span class="o">=</span> <span class="p">[</span><span class="n">AbinitController</span><span class="o">.</span><span class="n">from_helper</span><span class="p">(</span><span class="n">scf_helper</span><span class="p">)]</span>
        <span class="n">scf_controllers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">additional_controllers</span><span class="p">)</span>
        <span class="n">scf_control_procedure</span> <span class="o">=</span> <span class="n">ControlProcedure</span><span class="p">(</span><span class="n">controllers</span><span class="o">=</span><span class="n">scf_controllers</span><span class="p">)</span>
        <span class="n">setup_scf_task</span> <span class="o">=</span> <span class="n">AbinitSetupTask</span><span class="p">(</span><span class="n">abiinput</span><span class="o">=</span><span class="n">scf_inp_ibz</span><span class="p">,</span> <span class="n">task_helper</span><span class="o">=</span><span class="n">scf_helper</span><span class="p">,</span> <span class="n">pass_input</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">run_scf_task</span> <span class="o">=</span> <span class="n">AbinitRunTask</span><span class="p">(</span><span class="n">control_procedure</span><span class="o">=</span><span class="n">scf_control_procedure</span><span class="p">,</span> <span class="n">task_helper</span><span class="o">=</span><span class="n">scf_helper</span><span class="p">,</span>
                                     <span class="n">task_type</span><span class="o">=</span><span class="s1">&#39;scfibz&#39;</span><span class="p">)</span>
        <span class="n">control_scf_task</span> <span class="o">=</span> <span class="n">AbinitControlTask</span><span class="p">(</span><span class="n">control_procedure</span><span class="o">=</span><span class="n">scf_control_procedure</span><span class="p">,</span> <span class="n">task_helper</span><span class="o">=</span><span class="n">scf_helper</span><span class="p">)</span>

        <span class="n">scf_fws</span> <span class="o">=</span> <span class="n">createSRCFireworks</span><span class="p">(</span><span class="n">setup_task</span><span class="o">=</span><span class="n">setup_scf_task</span><span class="p">,</span> <span class="n">run_task</span><span class="o">=</span><span class="n">run_scf_task</span><span class="p">,</span> <span class="n">control_task</span><span class="o">=</span><span class="n">control_scf_task</span><span class="p">,</span>
                                     <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">initialization_info</span><span class="o">=</span><span class="n">initialization_info</span><span class="p">)</span>

        <span class="n">fws</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">scf_fws</span><span class="p">[</span><span class="s1">&#39;fws&#39;</span><span class="p">])</span>
        <span class="n">links_dict_update</span><span class="p">(</span><span class="n">links_dict</span><span class="o">=</span><span class="n">links_dict</span><span class="p">,</span> <span class="n">links_update</span><span class="o">=</span><span class="n">scf_fws</span><span class="p">[</span><span class="s1">&#39;links_dict&#39;</span><span class="p">])</span>

        <span class="c1">#2. nSCF run in the full Brillouin Zone with kptopt 2</span>
        <span class="n">nscf_helper</span> <span class="o">=</span> <span class="n">NscfTaskHelper</span><span class="p">()</span>
        <span class="n">nscf_controllers</span> <span class="o">=</span> <span class="p">[</span><span class="n">AbinitController</span><span class="o">.</span><span class="n">from_helper</span><span class="p">(</span><span class="n">nscf_helper</span><span class="p">)]</span>
        <span class="n">nscf_controllers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">additional_controllers</span><span class="p">)</span>
        <span class="n">nscf_control_procedure</span> <span class="o">=</span> <span class="n">ControlProcedure</span><span class="p">(</span><span class="n">controllers</span><span class="o">=</span><span class="n">nscf_controllers</span><span class="p">)</span>
        <span class="n">nscf_inp_fbz</span> <span class="o">=</span> <span class="n">scf_inp_ibz</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
        <span class="n">nscf_inp_fbz</span><span class="o">.</span><span class="n">set_vars</span><span class="p">({</span><span class="s1">&#39;tolwfr&#39;</span><span class="p">:</span> <span class="mf">1.0e-20</span><span class="p">,</span>
                               <span class="s1">&#39;kptopt&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                               <span class="s1">&#39;iscf&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span>
                               <span class="s1">&#39;istwfk&#39;</span><span class="p">:</span> <span class="s1">&#39;*1&#39;</span><span class="p">})</span>
        <span class="c1"># Adding buffer to help convergence ...</span>
        <span class="k">if</span> <span class="s1">&#39;nbdbuf&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nscf_inp_fbz</span><span class="p">:</span>
            <span class="n">nbdbuf</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mf">0.1</span><span class="o">*</span><span class="n">nscf_inp_fbz</span><span class="p">[</span><span class="s1">&#39;nband&#39;</span><span class="p">]),</span> <span class="mi">4</span><span class="p">)</span>
            <span class="n">nscf_inp_fbz</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">nband</span><span class="o">=</span><span class="n">nscf_inp_fbz</span><span class="p">[</span><span class="s1">&#39;nband&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">nbdbuf</span><span class="p">,</span> <span class="n">nbdbuf</span><span class="o">=</span><span class="n">nbdbuf</span><span class="p">)</span>
        <span class="n">nscffbz_deps</span> <span class="o">=</span> <span class="p">{</span><span class="n">run_scf_task</span><span class="o">.</span><span class="n">task_type</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;DEN&#39;</span><span class="p">]}</span>
        <span class="n">nscffbz_deps</span><span class="p">[</span><span class="n">run_scf_task</span><span class="o">.</span><span class="n">task_type</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ngfft_deps</span><span class="p">)</span>
        <span class="n">nscf_inp_fbz</span><span class="p">[</span><span class="s1">&#39;prtvol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">setup_nscffbz_task</span> <span class="o">=</span> <span class="n">AbinitSetupTask</span><span class="p">(</span><span class="n">abiinput</span><span class="o">=</span><span class="n">nscf_inp_fbz</span><span class="p">,</span> <span class="n">task_helper</span><span class="o">=</span><span class="n">nscf_helper</span><span class="p">,</span>
                                             <span class="n">deps</span><span class="o">=</span><span class="n">nscffbz_deps</span><span class="p">,</span> <span class="n">pass_input</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">run_nscffbz_task</span> <span class="o">=</span> <span class="n">AbinitRunTask</span><span class="p">(</span><span class="n">control_procedure</span><span class="o">=</span><span class="n">nscf_control_procedure</span><span class="p">,</span> <span class="n">task_helper</span><span class="o">=</span><span class="n">nscf_helper</span><span class="p">,</span>
                                         <span class="n">task_type</span><span class="o">=</span><span class="s1">&#39;nscffbz&#39;</span><span class="p">)</span>
        <span class="n">control_nscffbz_task</span> <span class="o">=</span> <span class="n">AbinitControlTask</span><span class="p">(</span><span class="n">control_procedure</span><span class="o">=</span><span class="n">nscf_control_procedure</span><span class="p">,</span> <span class="n">task_helper</span><span class="o">=</span><span class="n">nscf_helper</span><span class="p">)</span>

        <span class="n">nscffbz_fws</span> <span class="o">=</span> <span class="n">createSRCFireworks</span><span class="p">(</span><span class="n">setup_task</span><span class="o">=</span><span class="n">setup_nscffbz_task</span><span class="p">,</span> <span class="n">run_task</span><span class="o">=</span><span class="n">run_nscffbz_task</span><span class="p">,</span>
                                         <span class="n">control_task</span><span class="o">=</span><span class="n">control_nscffbz_task</span><span class="p">,</span>
                                         <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">initialization_info</span><span class="o">=</span><span class="n">initialization_info</span><span class="p">)</span>

        <span class="n">fws</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">nscffbz_fws</span><span class="p">[</span><span class="s1">&#39;fws&#39;</span><span class="p">])</span>
        <span class="n">links_dict_update</span><span class="p">(</span><span class="n">links_dict</span><span class="o">=</span><span class="n">links_dict</span><span class="p">,</span> <span class="n">links_update</span><span class="o">=</span><span class="n">nscffbz_fws</span><span class="p">[</span><span class="s1">&#39;links_dict&#39;</span><span class="p">])</span>
        <span class="c1">#Link with the IBZ SCF run</span>
        <span class="n">links_dict_update</span><span class="p">(</span><span class="n">links_dict</span><span class="o">=</span><span class="n">links_dict</span><span class="p">,</span>
                          <span class="n">links_update</span><span class="o">=</span><span class="p">{</span><span class="n">scf_fws</span><span class="p">[</span><span class="s1">&#39;control_fw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fw_id</span><span class="p">:</span> <span class="n">nscffbz_fws</span><span class="p">[</span><span class="s1">&#39;setup_fw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fw_id</span><span class="p">})</span>

        <span class="c1">#3. DDK calculation</span>
        <span class="k">if</span> <span class="n">do_ddk</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ddk_split</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Split Ddk to be implemented in PiezoElasticWorkflow ...&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ddk_helper</span> <span class="o">=</span> <span class="n">DdkTaskHelper</span><span class="p">()</span>
                <span class="n">ddk_controllers</span> <span class="o">=</span> <span class="p">[</span><span class="n">AbinitController</span><span class="o">.</span><span class="n">from_helper</span><span class="p">(</span><span class="n">ddk_helper</span><span class="p">)]</span>
                <span class="n">ddk_controllers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">additional_controllers</span><span class="p">)</span>
                <span class="n">ddk_control_procedure</span> <span class="o">=</span> <span class="n">ControlProcedure</span><span class="p">(</span><span class="n">controllers</span><span class="o">=</span><span class="n">ddk_controllers</span><span class="p">)</span>
                <span class="n">ddk_inp</span><span class="o">.</span><span class="n">set_vars</span><span class="p">({</span><span class="s1">&#39;kptopt&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">})</span>
                <span class="n">ddk_deps</span> <span class="o">=</span> <span class="p">{</span><span class="n">run_nscffbz_task</span><span class="o">.</span><span class="n">task_type</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;WFK&#39;</span><span class="p">]}</span>
                <span class="n">ddk_deps</span><span class="p">[</span><span class="n">run_nscffbz_task</span><span class="o">.</span><span class="n">task_type</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ngfft_deps</span><span class="p">)</span>
                <span class="n">setup_ddk_task</span> <span class="o">=</span> <span class="n">AbinitSetupTask</span><span class="p">(</span><span class="n">abiinput</span><span class="o">=</span><span class="n">ddk_inp</span><span class="p">,</span> <span class="n">task_helper</span><span class="o">=</span><span class="n">ddk_helper</span><span class="p">,</span>
                                                 <span class="n">deps</span><span class="o">=</span><span class="n">ddk_deps</span><span class="p">)</span>
                <span class="n">run_ddk_task</span> <span class="o">=</span> <span class="n">AbinitRunTask</span><span class="p">(</span><span class="n">control_procedure</span><span class="o">=</span><span class="n">ddk_control_procedure</span><span class="p">,</span> <span class="n">task_helper</span><span class="o">=</span><span class="n">ddk_helper</span><span class="p">,</span>
                                             <span class="n">task_type</span><span class="o">=</span><span class="s1">&#39;ddk&#39;</span><span class="p">)</span>
                <span class="n">control_ddk_task</span> <span class="o">=</span> <span class="n">AbinitControlTask</span><span class="p">(</span><span class="n">control_procedure</span><span class="o">=</span><span class="n">ddk_control_procedure</span><span class="p">,</span> <span class="n">task_helper</span><span class="o">=</span><span class="n">ddk_helper</span><span class="p">)</span>

                <span class="n">ddk_fws</span> <span class="o">=</span> <span class="n">createSRCFireworks</span><span class="p">(</span><span class="n">setup_task</span><span class="o">=</span><span class="n">setup_ddk_task</span><span class="p">,</span> <span class="n">run_task</span><span class="o">=</span><span class="n">run_ddk_task</span><span class="p">,</span>
                                             <span class="n">control_task</span><span class="o">=</span><span class="n">control_ddk_task</span><span class="p">,</span>
                                             <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">initialization_info</span><span class="o">=</span><span class="n">initialization_info</span><span class="p">)</span>

                <span class="n">fws</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ddk_fws</span><span class="p">[</span><span class="s1">&#39;fws&#39;</span><span class="p">])</span>
                <span class="n">links_dict_update</span><span class="p">(</span><span class="n">links_dict</span><span class="o">=</span><span class="n">links_dict</span><span class="p">,</span> <span class="n">links_update</span><span class="o">=</span><span class="n">ddk_fws</span><span class="p">[</span><span class="s1">&#39;links_dict&#39;</span><span class="p">])</span>
                <span class="c1">#Link with the FBZ nSCF run</span>
                <span class="n">links_dict_update</span><span class="p">(</span><span class="n">links_dict</span><span class="o">=</span><span class="n">links_dict</span><span class="p">,</span>
                                  <span class="n">links_update</span><span class="o">=</span><span class="p">{</span><span class="n">nscffbz_fws</span><span class="p">[</span><span class="s1">&#39;control_fw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fw_id</span><span class="p">:</span> <span class="n">ddk_fws</span><span class="p">[</span><span class="s1">&#39;setup_fw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fw_id</span><span class="p">})</span>

        <span class="c1">#4. Response-Function calculation(s) of the elastic constants</span>
        <span class="n">rf_ddb_source_task_type</span> <span class="o">=</span> <span class="s1">&#39;mrgddb-strains&#39;</span>
        <span class="n">rf_tolvar</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="n">rf_inp</span><span class="o">.</span><span class="n">scf_tolvar</span>
        <span class="n">rf_tol</span> <span class="o">=</span> <span class="p">{</span><span class="n">rf_tolvar</span><span class="p">:</span> <span class="n">value</span><span class="p">}</span>
        <span class="n">rf_deps</span> <span class="o">=</span> <span class="p">{</span><span class="n">run_nscffbz_task</span><span class="o">.</span><span class="n">task_type</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;WFK&#39;</span><span class="p">]}</span>
        <span class="k">if</span> <span class="n">do_ddk</span><span class="p">:</span>
            <span class="n">rf_deps</span><span class="p">[</span><span class="n">run_ddk_task</span><span class="o">.</span><span class="n">task_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;DDK&#39;</span><span class="p">]</span>
            <span class="n">previous_ddk_task_type</span> <span class="o">=</span> <span class="n">run_ddk_task</span><span class="o">.</span><span class="n">task_type</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">previous_ddk_task_type</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">rf_deps</span><span class="p">[</span><span class="n">run_nscffbz_task</span><span class="o">.</span><span class="n">task_type</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ngfft_deps</span><span class="p">)</span>
        <span class="n">gen_task</span> <span class="o">=</span> <span class="n">GeneratePiezoElasticFlowFWSRCAbinitTask</span><span class="p">(</span><span class="n">previous_scf_task_type</span><span class="o">=</span><span class="n">run_nscffbz_task</span><span class="o">.</span><span class="n">task_type</span><span class="p">,</span>
                                                           <span class="n">previous_ddk_task_type</span><span class="o">=</span><span class="n">previous_ddk_task_type</span><span class="p">,</span>
                                                           <span class="n">mrgddb_task_type</span><span class="o">=</span><span class="n">rf_ddb_source_task_type</span><span class="p">,</span>
                                                           <span class="n">additional_controllers</span><span class="o">=</span><span class="n">additional_controllers</span><span class="p">,</span>
                                                           <span class="n">rf_tol</span><span class="o">=</span><span class="n">rf_tol</span><span class="p">,</span> <span class="n">additional_input_vars</span><span class="o">=</span><span class="n">additional_input_vars</span><span class="p">,</span>
                                                           <span class="n">rf_deps</span><span class="o">=</span><span class="n">rf_deps</span><span class="p">,</span>
                                                           <span class="n">allow_parallel_perturbations</span><span class="o">=</span><span class="n">allow_parallel_perturbations</span><span class="p">,</span>
                                                           <span class="n">do_phonons</span><span class="o">=</span><span class="n">do_phonons</span><span class="p">)</span>
        <span class="n">genrfstrains_spec</span> <span class="o">=</span> <span class="n">set_short_single_core_to_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">gen_fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">([</span><span class="n">gen_task</span><span class="p">],</span> <span class="n">spec</span><span class="o">=</span><span class="n">genrfstrains_spec</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;gen-piezo-elast&#39;</span><span class="p">)</span>
        <span class="n">fws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gen_fw</span><span class="p">)</span>
        <span class="n">linkupdate</span> <span class="o">=</span> <span class="p">{</span><span class="n">nscffbz_fws</span><span class="p">[</span><span class="s1">&#39;control_fw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fw_id</span><span class="p">:</span> <span class="n">gen_fw</span><span class="o">.</span><span class="n">fw_id</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">do_ddk</span><span class="p">:</span>
            <span class="n">linkupdate</span><span class="p">[</span><span class="n">ddk_fws</span><span class="p">[</span><span class="s1">&#39;control_fw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fw_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">gen_fw</span><span class="o">.</span><span class="n">fw_id</span>
        <span class="n">links_dict_update</span><span class="p">(</span><span class="n">links_dict</span><span class="o">=</span><span class="n">links_dict</span><span class="p">,</span>
                          <span class="n">links_update</span><span class="o">=</span><span class="n">linkupdate</span><span class="p">)</span>

        <span class="n">rf_ddb_src_fw</span> <span class="o">=</span> <span class="n">gen_fw</span>

        <span class="c1">#5. Merge DDB files from response function (second derivatives for the elastic constants) and from the</span>
        <span class="c1"># SCF run on the full Brillouin zone (first derivatives for the stress tensor, to be used for the</span>
        <span class="c1"># stress-corrected elastic constants)</span>
        <span class="n">mrgddb_task</span> <span class="o">=</span> <span class="n">MergeDdbAbinitTask</span><span class="p">(</span><span class="n">ddb_source_task_types</span><span class="o">=</span><span class="p">[</span><span class="n">rf_ddb_source_task_type</span><span class="p">,</span>
                                                                <span class="n">run_scf_task</span><span class="o">.</span><span class="n">task_type</span><span class="p">],</span>
                                         <span class="n">delete_source_ddbs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_ddbs</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">mrgddb_spec</span> <span class="o">=</span> <span class="n">set_short_single_core_to_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scf_inp_ibz</span><span class="o">.</span><span class="n">ispaw</span><span class="p">:</span>
            <span class="n">mrgddb_spec</span><span class="p">[</span><span class="s1">&#39;PAW_datasets_description_correction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;yes&#39;</span>
        <span class="n">mrgddb_fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">(</span><span class="n">tasks</span><span class="o">=</span><span class="p">[</span><span class="n">mrgddb_task</span><span class="p">],</span> <span class="n">spec</span><span class="o">=</span><span class="n">mrgddb_spec</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;mrgddb&#39;</span><span class="p">)</span>
        <span class="n">fws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mrgddb_fw</span><span class="p">)</span>
        <span class="n">links_dict_update</span><span class="p">(</span><span class="n">links_dict</span><span class="o">=</span><span class="n">links_dict</span><span class="p">,</span>
                          <span class="n">links_update</span><span class="o">=</span><span class="p">{</span><span class="n">rf_ddb_src_fw</span><span class="o">.</span><span class="n">fw_id</span><span class="p">:</span> <span class="n">mrgddb_fw</span><span class="o">.</span><span class="n">fw_id</span><span class="p">,</span>
                                        <span class="n">scf_fws</span><span class="p">[</span><span class="s1">&#39;control_fw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fw_id</span><span class="p">:</span> <span class="n">mrgddb_fw</span><span class="o">.</span><span class="n">fw_id</span><span class="p">})</span>

        <span class="c1">#6. Anaddb task to get elastic constants based on the RF run (no stress correction)</span>
        <span class="n">anaddb_tag</span> <span class="o">=</span> <span class="s1">&#39;anaddb-piezo-elast&#39;</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">set_short_single_core_to_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">anaddb_task</span> <span class="o">=</span> <span class="n">AnaDdbAbinitTask</span><span class="p">(</span><span class="n">AnaddbInput</span><span class="o">.</span><span class="n">piezo_elastic</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="n">scf_inp_ibz</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span>
                                                                 <span class="n">stress_correction</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                                       <span class="n">deps</span><span class="o">=</span><span class="p">{</span><span class="n">rf_ddb_source_task_type</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;DDB&#39;</span><span class="p">]},</span>
                                       <span class="n">task_type</span><span class="o">=</span><span class="n">anaddb_tag</span><span class="p">)</span>
        <span class="n">anaddb_fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">([</span><span class="n">anaddb_task</span><span class="p">],</span>
                             <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span>
                             <span class="n">name</span><span class="o">=</span><span class="n">anaddb_tag</span><span class="p">)</span>
        <span class="n">fws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">anaddb_fw</span><span class="p">)</span>
        <span class="n">links_dict_update</span><span class="p">(</span><span class="n">links_dict</span><span class="o">=</span><span class="n">links_dict</span><span class="p">,</span>
                          <span class="n">links_update</span><span class="o">=</span><span class="p">{</span><span class="n">rf_ddb_src_fw</span><span class="o">.</span><span class="n">fw_id</span><span class="p">:</span> <span class="n">anaddb_fw</span><span class="o">.</span><span class="n">fw_id</span><span class="p">})</span>

        <span class="c1">#7. Anaddb task to get elastic constants based on the RF run and the SCF run (with stress correction)</span>
        <span class="n">anaddb_tag</span> <span class="o">=</span> <span class="s1">&#39;anaddb-piezo-elast-stress-corrected&#39;</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">set_short_single_core_to_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">anaddb_stress_task</span> <span class="o">=</span> <span class="n">AnaDdbAbinitTask</span><span class="p">(</span><span class="n">AnaddbInput</span><span class="o">.</span><span class="n">piezo_elastic</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="n">scf_inp_ibz</span><span class="o">.</span><span class="n">structure</span><span class="p">,</span>
                                                                        <span class="n">stress_correction</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                                              <span class="n">deps</span><span class="o">=</span><span class="p">{</span><span class="n">mrgddb_task</span><span class="o">.</span><span class="n">task_type</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;DDB&#39;</span><span class="p">]},</span>
                                              <span class="n">task_type</span><span class="o">=</span><span class="n">anaddb_tag</span><span class="p">)</span>
        <span class="n">anaddb_stress_fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">([</span><span class="n">anaddb_stress_task</span><span class="p">],</span>
                                    <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span>
                                    <span class="n">name</span><span class="o">=</span><span class="n">anaddb_tag</span><span class="p">)</span>
        <span class="n">fws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">anaddb_stress_fw</span><span class="p">)</span>
        <span class="n">links_dict_update</span><span class="p">(</span><span class="n">links_dict</span><span class="o">=</span><span class="n">links_dict</span><span class="p">,</span>
                          <span class="n">links_update</span><span class="o">=</span><span class="p">{</span><span class="n">mrgddb_fw</span><span class="o">.</span><span class="n">fw_id</span><span class="p">:</span> <span class="n">anaddb_stress_fw</span><span class="o">.</span><span class="n">fw_id</span><span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wf</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">fireworks</span><span class="o">=</span><span class="n">fws</span><span class="p">,</span>
                           <span class="n">links_dict</span><span class="o">=</span><span class="n">links_dict</span><span class="p">,</span>
                           <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;workflow_class&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow_class</span><span class="p">,</span>
                                     <span class="s1">&#39;workflow_module&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow_module</span><span class="p">})</span>

<div class="viewcode-block" id="PiezoElasticFWWorkflowSRC.add_anaddb_task"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.PiezoElasticFWWorkflowSRC.add_anaddb_task">[docs]</a>    <span class="k">def</span> <span class="nf">add_anaddb_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">):</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_short_single_core_to_spec</span><span class="p">()</span>
        <span class="n">anaddb_task</span> <span class="o">=</span> <span class="n">AnaDdbAbinitTask</span><span class="p">(</span><span class="n">AnaddbInput</span><span class="o">.</span><span class="n">piezo_elastic</span><span class="p">(</span><span class="n">structure</span><span class="p">))</span>
        <span class="n">anaddb_fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">([</span><span class="n">anaddb_task</span><span class="p">],</span>
                             <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span>
                             <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anaddb&#39;</span><span class="p">)</span>
        <span class="n">append_fw_to_wf</span><span class="p">(</span><span class="n">anaddb_fw</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wf</span><span class="p">)</span></div>

<div class="viewcode-block" id="PiezoElasticFWWorkflowSRC.get_all_elastic_tensors"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.PiezoElasticFWWorkflowSRC.get_all_elastic_tensors">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_all_elastic_tensors</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">wf</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">wf</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;workflow_class&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">workflow_class</span>
        <span class="k">assert</span> <span class="n">wf</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;workflow_module&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">workflow_module</span>

        <span class="n">anaddb_no_stress_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">anaddb_stress_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">fw_id</span><span class="p">,</span> <span class="n">fw</span> <span class="ow">in</span> <span class="n">wf</span><span class="o">.</span><span class="n">id_fw</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">fw</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;anaddb-piezo-elast&#39;</span><span class="p">:</span>
                <span class="n">anaddb_no_stress_id</span> <span class="o">=</span> <span class="n">fw_id</span>
            <span class="k">if</span> <span class="n">fw</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;anaddb-piezo-elast-stress-corrected&#39;</span><span class="p">:</span>
                <span class="n">anaddb_stress_id</span> <span class="o">=</span> <span class="n">fw_id</span>
        <span class="k">if</span> <span class="n">anaddb_no_stress_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">anaddb_stress_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Final anaddb tasks not found ...&#39;</span><span class="p">)</span>
        <span class="n">myfw_nostress</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">id_fw</span><span class="p">[</span><span class="n">anaddb_no_stress_id</span><span class="p">]</span>
        <span class="n">last_launch_nostress</span> <span class="o">=</span> <span class="p">(</span><span class="n">myfw_nostress</span><span class="o">.</span><span class="n">archived_launches</span> <span class="o">+</span> <span class="n">myfw_nostress</span><span class="o">.</span><span class="n">launches</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">myfw_nostress</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_workdir</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">last_launch_nostress</span><span class="o">.</span><span class="n">launch_dir</span><span class="p">)</span>

        <span class="n">myfw_stress</span> <span class="o">=</span> <span class="n">wf</span><span class="o">.</span><span class="n">id_fw</span><span class="p">[</span><span class="n">anaddb_stress_id</span><span class="p">]</span>
        <span class="n">last_launch_stress</span> <span class="o">=</span> <span class="p">(</span><span class="n">myfw_stress</span><span class="o">.</span><span class="n">archived_launches</span> <span class="o">+</span> <span class="n">myfw_stress</span><span class="o">.</span><span class="n">launches</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">myfw_stress</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_workdir</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">last_launch_stress</span><span class="o">.</span><span class="n">launch_dir</span><span class="p">)</span>

        <span class="n">ec_nostress_clamped</span> <span class="o">=</span> <span class="n">myfw_nostress</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_elastic_tensor</span><span class="p">(</span><span class="n">tensor_type</span><span class="o">=</span><span class="s1">&#39;clamped_ion&#39;</span><span class="p">)</span>
        <span class="n">ec_nostress_relaxed</span> <span class="o">=</span> <span class="n">myfw_nostress</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_elastic_tensor</span><span class="p">(</span><span class="n">tensor_type</span><span class="o">=</span><span class="s1">&#39;relaxed_ion&#39;</span><span class="p">)</span>
        <span class="n">ec_stress_relaxed</span> <span class="o">=</span> <span class="n">myfw_stress</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">get_elastic_tensor</span><span class="p">(</span><span class="n">tensor_type</span><span class="o">=</span><span class="s1">&#39;relaxed_ion_stress_corrected&#39;</span><span class="p">)</span>

        <span class="n">ec_dicts</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;clamped_ion&#39;</span><span class="p">:</span> <span class="n">ec_nostress_clamped</span><span class="o">.</span><span class="n">extended_dict</span><span class="p">(),</span>
                    <span class="s1">&#39;relaxed_ion&#39;</span><span class="p">:</span> <span class="n">ec_nostress_relaxed</span><span class="o">.</span><span class="n">extended_dict</span><span class="p">(),</span>
                    <span class="s1">&#39;relaxed_ion_stress_corrected&#39;</span><span class="p">:</span> <span class="n">ec_stress_relaxed</span><span class="o">.</span><span class="n">extended_dict</span><span class="p">()}</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;elastic_properties&#39;</span><span class="p">:</span> <span class="n">ec_dicts</span><span class="p">}</span></div>

<div class="viewcode-block" id="PiezoElasticFWWorkflowSRC.from_factory"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.PiezoElasticFWWorkflowSRC.from_factory">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_factory</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;from factory method not yet implemented for piezoelasticworkflow&#39;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="DfptFWWorkflow"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.DfptFWWorkflow">[docs]</a><span class="k">class</span> <span class="nc">DfptFWWorkflow</span><span class="p">(</span><span class="n">AbstractFWWorkflow</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generator of a fireworks workflow for the calculation of various properties with DFPT.</span>
<span class="sd">    Parallelization over all the perturbations.</span>
<span class="sd">    N.B. Currently (version 8.8.3) anaddb does not support a DDB containing both 2nd order derivatives with qpoints</span>
<span class="sd">    different from gamma AND 3rd order derivatives. The calculations could be run, but the global DDB will not</span>
<span class="sd">    be directly usable as is in anaddb.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">workflow_class</span> <span class="o">=</span> <span class="s1">&#39;DfptFWWorkflow&#39;</span>
    <span class="n">workflow_module</span> <span class="o">=</span> <span class="s1">&#39;abiflows.fireworks.workflows.abinit_workflows&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scf_inp</span><span class="p">,</span> <span class="n">ph_inp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nscf_inp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ddk_inp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dde_inp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">strain_inp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dte_inp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">autoparal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initialization_info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            scf_inp: an |AbinitInput| for the SCF calculation.</span>
<span class="sd">            ph_inp: a |MultiDataset| with the phonon inputs</span>
<span class="sd">            nscf_inp: a |MultiDataset| with the wfq nscf inputs</span>
<span class="sd">            ddk_inp: a |MultiDataset| with the ddk inputs</span>
<span class="sd">            dde_inp: a |MultiDataset| with the dde inputs</span>
<span class="sd">            strain_inp: a |MultiDataset| with the strain inputs</span>
<span class="sd">            dte_inp: a |MultiDataset| with the non-linear inputs</span>
<span class="sd">            autoparal: if True autoparal will be used at runtime to optimize the number of processes.</span>
<span class="sd">            spec: a dict with additional spec for the Firework.</span>
<span class="sd">            initialization_info: a dict defining additional information about the initialization of the workflow.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">dte_inp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dde_inp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;non-linear calculations require at least the DDE&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dde_inp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ddk_inp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;DDE calculations require the DDK&quot;</span><span class="p">)</span>

        <span class="n">spec</span> <span class="o">=</span> <span class="n">spec</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">initialization_info</span> <span class="o">=</span> <span class="n">initialization_info</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">start_task_index</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">rf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_reduced_formula</span><span class="p">(</span><span class="n">scf_inp</span><span class="p">)</span>
        <span class="n">scf_task</span> <span class="o">=</span> <span class="n">ScfFWTask</span><span class="p">(</span><span class="n">scf_inp</span><span class="p">,</span> <span class="n">is_autoparal</span><span class="o">=</span><span class="n">autoparal</span><span class="p">)</span>

        <span class="n">spec</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;initialization_info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initialization_info</span>
        <span class="k">if</span> <span class="n">autoparal</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_short_single_core_to_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
            <span class="n">start_task_index</span> <span class="o">=</span> <span class="s1">&#39;autoparal&#39;</span>

        <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;wf_task_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;scf_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">start_task_index</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scf_fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">(</span><span class="n">scf_task</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">rf</span><span class="o">+</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="n">scf_task</span><span class="o">.</span><span class="n">task_type</span><span class="p">)</span>

        <span class="n">previous_task_type</span> <span class="o">=</span> <span class="n">scf_task</span><span class="o">.</span><span class="n">task_type</span>

        <span class="n">nscf_fws</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">nscf_inp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nscf_fws</span><span class="p">,</span> <span class="n">nscf_fw_deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fws</span><span class="p">(</span><span class="n">nscf_inp</span><span class="p">,</span> <span class="n">NscfWfqFWTask</span><span class="p">,</span>
                                                  <span class="p">{</span><span class="n">previous_task_type</span><span class="p">:</span> <span class="s2">&quot;DEN&quot;</span><span class="p">},</span> <span class="n">spec</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">has_gamma</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">ph_fws</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">ph_fw_deps</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">ph_inp</span><span class="p">:</span>
            <span class="n">ph_inp</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">prtwf</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1"># 1WF files from gamma are need for non linear perturbations</span>
            <span class="k">if</span> <span class="n">dte_inp</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">inp</span> <span class="ow">in</span> <span class="n">ph_inp</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">inp</span><span class="p">[</span><span class="s2">&quot;qpt&quot;</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]):</span>
                        <span class="n">inp</span><span class="p">[</span><span class="s1">&#39;prtwf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">ph_fws</span><span class="p">,</span> <span class="n">ph_fw_deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fws</span><span class="p">(</span><span class="n">ph_inp</span><span class="p">,</span> <span class="n">PhononTask</span><span class="p">,</span> <span class="p">{</span><span class="n">previous_task_type</span><span class="p">:</span> <span class="s2">&quot;WFK&quot;</span><span class="p">},</span> <span class="n">spec</span><span class="p">,</span> <span class="n">nscf_fws</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">ph_fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">abiinput</span><span class="p">[</span><span class="s2">&quot;qpt&quot;</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">ph_fw</span> <span class="ow">in</span> <span class="n">ph_fws</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">has_gamma</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">ddk_fws</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">ddk_inp</span><span class="p">:</span>
            <span class="n">ddk_fws</span><span class="p">,</span> <span class="n">ddk_fw_deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fws</span><span class="p">(</span><span class="n">ddk_inp</span><span class="p">,</span> <span class="n">DdkTask</span><span class="p">,</span> <span class="p">{</span><span class="n">previous_task_type</span><span class="p">:</span> <span class="s2">&quot;WFK&quot;</span><span class="p">},</span> <span class="n">spec</span><span class="p">)</span>

        <span class="n">dde_fws</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">dde_inp</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">dte_inp</span><span class="p">:</span>
                <span class="n">dde_inp</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">prtwf</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dde_fws</span><span class="p">,</span> <span class="n">dde_fw_deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fws</span><span class="p">(</span><span class="n">dde_inp</span><span class="p">,</span> <span class="n">DdeTask</span><span class="p">,</span>
                                                <span class="p">{</span><span class="n">previous_task_type</span><span class="p">:</span> <span class="s2">&quot;WFK&quot;</span><span class="p">,</span> <span class="n">DdkTask</span><span class="o">.</span><span class="n">task_type</span><span class="p">:</span> <span class="s2">&quot;DDK&quot;</span><span class="p">},</span> <span class="n">spec</span><span class="p">)</span>

        <span class="n">strain_fws</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">strain_inp</span><span class="p">:</span>
            <span class="n">strain_inp</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">prtwf</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">strain_file_deps</span> <span class="o">=</span> <span class="p">{</span><span class="n">previous_task_type</span><span class="p">:</span> <span class="s2">&quot;WFK&quot;</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">ddk_inp</span><span class="p">:</span>
                <span class="n">strain_file_deps</span><span class="p">[</span><span class="n">DdkTask</span><span class="o">.</span><span class="n">task_type</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;DDK&quot;</span>
            <span class="n">strain_fws</span><span class="p">,</span> <span class="n">strain_fw_deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fws</span><span class="p">(</span><span class="n">strain_inp</span><span class="p">,</span> <span class="n">StrainPertTask</span><span class="p">,</span>
                                                      <span class="n">strain_file_deps</span><span class="p">,</span> <span class="n">spec</span><span class="p">)</span>

        <span class="n">dte_fws</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">dte_inp</span><span class="p">:</span>
            <span class="n">dte_deps</span> <span class="o">=</span> <span class="p">{</span><span class="n">ScfFWTask</span><span class="o">.</span><span class="n">task_type</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;WFK&quot;</span><span class="p">,</span> <span class="s2">&quot;DEN&quot;</span><span class="p">],</span> <span class="n">DdeTask</span><span class="o">.</span><span class="n">task_type</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;1WF&quot;</span><span class="p">,</span> <span class="s2">&quot;1DEN&quot;</span><span class="p">]}</span>
            <span class="k">if</span> <span class="n">ph_inp</span><span class="p">:</span>
                <span class="n">dte_deps</span><span class="p">[</span><span class="n">PhononTask</span><span class="o">.</span><span class="n">task_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;1WF&quot;</span><span class="p">,</span> <span class="s2">&quot;1DEN&quot;</span><span class="p">]</span>
            <span class="n">dte_fws</span><span class="p">,</span> <span class="n">dte_fw_deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fws</span><span class="p">(</span><span class="n">dte_inp</span><span class="p">,</span> <span class="n">DteTask</span><span class="p">,</span> <span class="n">dte_deps</span><span class="p">,</span> <span class="n">spec</span><span class="p">)</span>

        <span class="n">mrgddb_spec</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">mrgddb_spec</span><span class="p">[</span><span class="s1">&#39;wf_task_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;mrgddb&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_short_single_core_to_spec</span><span class="p">(</span><span class="n">mrgddb_spec</span><span class="p">)</span>
        <span class="n">mrgddb_spec</span><span class="p">[</span><span class="s1">&#39;mpi_ncpus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># Set a higher priority to favour the end of the WF</span>
        <span class="n">mrgddb_spec</span><span class="p">[</span><span class="s1">&#39;_priority&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">num_ddbs_to_be_merged</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ph_fws</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">dde_fws</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">strain_fws</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">dte_fws</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">mrgddb_fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">(</span><span class="n">MergeDdbAbinitTask</span><span class="p">(</span><span class="n">num_ddbs</span><span class="o">=</span><span class="n">num_ddbs_to_be_merged</span><span class="p">,</span> <span class="n">delete_source_ddbs</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">spec</span><span class="o">=</span><span class="n">mrgddb_spec</span><span class="p">,</span>
                             <span class="n">name</span><span class="o">=</span><span class="n">scf_inp</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">composition</span><span class="o">.</span><span class="n">reduced_formula</span><span class="o">+</span><span class="s1">&#39;_mergeddb&#39;</span><span class="p">)</span>

        <span class="n">fws_deps</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

        <span class="n">autoparal_fws</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">autoparal</span><span class="p">:</span>
            <span class="c1"># add an AutoparalTask for each type and relative dependencies</span>
            <span class="n">ref_inp</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">inp</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ph_inp</span><span class="p">,</span> <span class="n">ddk_inp</span><span class="p">,</span> <span class="n">dde_inp</span><span class="p">,</span> <span class="n">strain_inp</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">inp</span><span class="p">:</span>
                    <span class="n">ref_inp</span> <span class="o">=</span> <span class="n">inp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">break</span>
            <span class="n">dfpt_autoparal_fw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_autoparal_fw</span><span class="p">(</span><span class="n">ref_inp</span><span class="p">,</span> <span class="s1">&#39;dfpt&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">previous_task_type</span><span class="p">:</span> <span class="s2">&quot;WFK&quot;</span><span class="p">},</span> <span class="n">spec</span><span class="p">,</span>
                                                      <span class="n">nscf_fws</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">autoparal_fws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dfpt_autoparal_fw</span><span class="p">)</span>

            <span class="n">fws_deps</span><span class="p">[</span><span class="n">dfpt_autoparal_fw</span><span class="p">]</span> <span class="o">=</span> <span class="n">ph_fws</span> <span class="o">+</span> <span class="n">ddk_fws</span> <span class="o">+</span> <span class="n">dde_fws</span> <span class="o">+</span> <span class="n">strain_fws</span>
            <span class="n">fws_deps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scf_fw</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dfpt_autoparal_fw</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">dte_fws</span><span class="p">:</span>
                <span class="c1"># being a fake autoparal it doesn&#39;t need to follow the dde tasks. No other dependencies are enforced.</span>
                <span class="n">dte_autoparal_fw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_autoparal_fw</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;dte&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span>
                                                         <span class="n">formula</span><span class="o">=</span><span class="n">dte_inp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">composition</span><span class="o">.</span><span class="n">reduced_formula</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">autoparal_fws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dte_autoparal_fw</span><span class="p">)</span>

                <span class="n">fws_deps</span><span class="p">[</span><span class="n">dte_autoparal_fw</span><span class="p">]</span> <span class="o">=</span> <span class="n">dte_fws</span>

            <span class="k">if</span> <span class="n">nscf_fws</span><span class="p">:</span>
                <span class="n">nscf_autoparal_fw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_autoparal_fw</span><span class="p">(</span><span class="n">nscf_inp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;nscf&#39;</span><span class="p">,</span>
                                                          <span class="p">{</span><span class="n">previous_task_type</span><span class="p">:</span> <span class="s2">&quot;DEN&quot;</span><span class="p">},</span> <span class="n">spec</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">fws_deps</span><span class="p">[</span><span class="n">nscf_autoparal_fw</span><span class="p">]</span> <span class="o">=</span> <span class="n">nscf_fws</span>
                <span class="n">autoparal_fws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nscf_autoparal_fw</span><span class="p">)</span>
                <span class="n">fws_deps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scf_fw</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nscf_autoparal_fw</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ddk_fws</span> <span class="ow">and</span> <span class="p">(</span><span class="n">dde_fws</span> <span class="ow">or</span> <span class="n">strain_fws</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ddk_fw</span> <span class="ow">in</span> <span class="n">ddk_fws</span><span class="p">:</span>
                <span class="n">fws_deps</span><span class="p">[</span><span class="n">ddk_fw</span><span class="p">]</span> <span class="o">=</span> <span class="n">dde_fws</span> <span class="o">+</span> <span class="n">strain_fws</span>

        <span class="k">if</span> <span class="n">dte_fws</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dde_fw</span> <span class="ow">in</span> <span class="n">dde_fws</span><span class="p">:</span>
                <span class="n">fws_deps</span><span class="p">[</span><span class="n">dde_fw</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dte_fws</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ph_fws</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ph_fw</span> <span class="ow">in</span> <span class="n">ph_fws</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">ph_fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">abiinput</span><span class="p">[</span><span class="s2">&quot;qpt&quot;</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]):</span>
                        <span class="n">fws_deps</span><span class="p">[</span><span class="n">ph_fw</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dte_fws</span><span class="p">)</span>

        <span class="c1"># all the abinit related FWs should depend on the scf calculation for the WFK</span>
        <span class="n">abinit_fws</span> <span class="o">=</span> <span class="n">nscf_fws</span> <span class="o">+</span> <span class="n">ddk_fws</span> <span class="o">+</span> <span class="n">dde_fws</span> <span class="o">+</span> <span class="n">ph_fws</span> <span class="o">+</span> <span class="n">strain_fws</span> <span class="o">+</span> <span class="n">dte_fws</span>
        <span class="n">fws_deps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scf_fw</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">abinit_fws</span><span class="p">)</span>

        <span class="n">ddb_fws</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scf_fw</span><span class="p">]</span> <span class="o">+</span> <span class="n">dde_fws</span> <span class="o">+</span> <span class="n">ph_fws</span> <span class="o">+</span> <span class="n">strain_fws</span> <span class="o">+</span> <span class="n">dte_fws</span>
        <span class="c1">#TODO pass all the tasks to the MergeDdbTask for logging or easier retrieve of the DDK?</span>
        <span class="k">for</span> <span class="n">ddb_fw</span> <span class="ow">in</span> <span class="n">ddb_fws</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ddb_fw</span> <span class="ow">in</span> <span class="n">fws_deps</span><span class="p">:</span>
                <span class="n">fws_deps</span><span class="p">[</span><span class="n">ddb_fw</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mrgddb_fw</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fws_deps</span><span class="p">[</span><span class="n">ddb_fw</span><span class="p">]</span> <span class="o">=</span> <span class="n">mrgddb_fw</span>

        <span class="n">total_list_fws</span> <span class="o">=</span> <span class="n">ddb_fws</span><span class="o">+</span><span class="n">ddk_fws</span><span class="o">+</span><span class="p">[</span><span class="n">mrgddb_fw</span><span class="p">]</span> <span class="o">+</span> <span class="n">nscf_fws</span> <span class="o">+</span> <span class="n">autoparal_fws</span>

        <span class="n">fws_deps</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ph_fw_deps</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ph_fws</span> <span class="o">=</span> <span class="n">ph_fws</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddk_fws</span> <span class="o">=</span> <span class="n">ddk_fws</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dde_fws</span> <span class="o">=</span> <span class="n">dde_fws</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strain_fws</span> <span class="o">=</span> <span class="n">strain_fws</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dte_fws</span> <span class="o">=</span> <span class="n">dte_fws</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mrgddb_fw</span> <span class="o">=</span> <span class="n">mrgddb_fw</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wf</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">total_list_fws</span><span class="p">,</span> <span class="n">links_dict</span><span class="o">=</span><span class="n">fws_deps</span><span class="p">,</span>
                           <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;workflow_class&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow_class</span><span class="p">,</span>
                                     <span class="s1">&#39;workflow_module&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">workflow_module</span><span class="p">})</span>

<div class="viewcode-block" id="DfptFWWorkflow.get_fws"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.DfptFWWorkflow.get_fws">[docs]</a>    <span class="k">def</span> <span class="nf">get_fws</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multi_inp</span><span class="p">,</span> <span class="n">task_class</span><span class="p">,</span> <span class="n">deps</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">nscf_fws</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepares the fireworks for a specific type of calculation</span>

<span class="sd">        Args:</span>
<span class="sd">            multi_inp: |MultiDataset| with the inputs that should be run</span>
<span class="sd">            task_class: class of the tasks that should be generated</span>
<span class="sd">            deps: dict with the dependencies already set for this type of task</span>
<span class="sd">            spec: spec for the new Fireworks that will be created</span>
<span class="sd">            nscf_fws: list of NSCF fws for the calculation of WFQ files, in case they are present.</span>
<span class="sd">                Will be linked if needed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (tuple): tuple containing:</span>

<span class="sd">                - fws (list): The list of new Fireworks.</span>
<span class="sd">                - fw_deps (dict): The dependencies related to these fireworks.</span>
<span class="sd">                    Should be used when generating the workflow.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">formula</span> <span class="o">=</span> <span class="n">multi_inp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">composition</span><span class="o">.</span><span class="n">reduced_formula</span>
        <span class="n">fws</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fw_deps</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">inp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">multi_inp</span><span class="p">):</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
            <span class="n">start_task_index</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="n">current_deps</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">deps</span><span class="p">)</span>
            <span class="n">parent_fw</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">nscf_fws</span><span class="p">:</span>
                <span class="n">qpt</span> <span class="o">=</span> <span class="n">inp</span><span class="p">[</span><span class="s1">&#39;qpt&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">nscf_fw</span> <span class="ow">in</span> <span class="n">nscf_fws</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">nscf_fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">abiinput</span><span class="p">[</span><span class="s1">&#39;qpt&#39;</span><span class="p">],</span> <span class="n">qpt</span><span class="p">):</span>
                        <span class="n">parent_fw</span> <span class="o">=</span> <span class="n">nscf_fw</span>
                        <span class="n">current_deps</span><span class="p">[</span><span class="n">nscf_fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">task_type</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;WFQ&quot;</span>
                        <span class="k">break</span>

            <span class="n">task</span> <span class="o">=</span> <span class="n">task_class</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="n">current_deps</span><span class="p">,</span> <span class="n">is_autoparal</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># this index is for the different task, each performing a different perturbation</span>
            <span class="n">indexed_task_type</span> <span class="o">=</span> <span class="n">task_class</span><span class="o">.</span><span class="n">task_type</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="c1"># this index is to index the restarts of the single task</span>
            <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;wf_task_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">indexed_task_type</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">start_task_index</span><span class="p">)</span>
            <span class="n">fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="n">formula</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">indexed_task_type</span><span class="p">)[:</span><span class="mi">15</span><span class="p">])</span>
            <span class="n">fws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fw</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">parent_fw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fw_deps</span><span class="p">[</span><span class="n">parent_fw</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fw</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fws</span><span class="p">,</span> <span class="n">fw_deps</span></div>

<div class="viewcode-block" id="DfptFWWorkflow.get_autoparal_fw"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.DfptFWWorkflow.get_autoparal_fw">[docs]</a>    <span class="k">def</span> <span class="nf">get_autoparal_fw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inp</span><span class="p">,</span> <span class="n">task_type</span><span class="p">,</span> <span class="n">deps</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">nscf_fws</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">formula</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepares a single Firework containing an AutoparalTask to perform the autoparal for each group of calculations.</span>

<span class="sd">        Args:</span>
<span class="sd">            inp: one of the inputs for which the autoparal should be run</span>
<span class="sd">            task_type: task_type of the class for the current type of calculation</span>
<span class="sd">            deps: dict with the dependencies already set for this type of task</span>
<span class="sd">            spec: spec for the new Fireworks that will be created</span>
<span class="sd">            nscf_fws: list of NSCF fws for the calculation of WFQ files, in case they are present.</span>
<span class="sd">                Will be linked if needed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (tuple): tuple containing:</span>

<span class="sd">                - fws (list): The new Firework.</span>
<span class="sd">                - fw_deps (dict): The dependencies between related to this firework.</span>
<span class="sd">                    Should be used when generating the workflow.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">formula</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">formula</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">composition</span><span class="o">.</span><span class="n">reduced_formula</span>
        <span class="k">if</span> <span class="n">deps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">fw_deps</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>

        <span class="n">current_deps</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">deps</span><span class="p">)</span>
        <span class="n">parent_fw</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">nscf_fws</span><span class="p">:</span>
            <span class="n">qpt</span> <span class="o">=</span> <span class="n">inp</span><span class="p">[</span><span class="s1">&#39;qpt&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">nscf_fw</span> <span class="ow">in</span> <span class="n">nscf_fws</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">nscf_fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">abiinput</span><span class="p">[</span><span class="s1">&#39;qpt&#39;</span><span class="p">],</span> <span class="n">qpt</span><span class="p">):</span>
                    <span class="n">parent_fw</span> <span class="o">=</span> <span class="n">nscf_fw</span>
                    <span class="n">current_deps</span><span class="p">[</span><span class="n">nscf_fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">task_type</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;WFQ&quot;</span>
                    <span class="k">break</span>

        <span class="n">task</span> <span class="o">=</span> <span class="n">AutoparalTask</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="n">current_deps</span><span class="p">,</span> <span class="n">forward_spec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># this index is for the different task, each performing a different perturbation</span>
        <span class="n">indexed_task_type</span> <span class="o">=</span> <span class="n">AutoparalTask</span><span class="o">.</span><span class="n">task_type</span>
        <span class="c1"># this index is to index the restarts of the single task</span>
        <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;wf_task_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">indexed_task_type</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">task_type</span>
        <span class="n">fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="n">formula</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">indexed_task_type</span><span class="p">)[:</span><span class="mi">15</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">parent_fw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fw_deps</span><span class="p">[</span><span class="n">parent_fw</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fw</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fw</span><span class="p">,</span> <span class="n">fw_deps</span></div>

<div class="viewcode-block" id="DfptFWWorkflow.from_factory"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.DfptFWWorkflow.from_factory">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_factory</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">pseudos</span><span class="p">,</span> <span class="n">kppa</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ecut</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pawecutdg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nband</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">accuracy</span><span class="o">=</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span>
                     <span class="n">spin_mode</span><span class="o">=</span><span class="s2">&quot;polarized&quot;</span><span class="p">,</span> <span class="n">smearing</span><span class="o">=</span><span class="s2">&quot;fermi_dirac:0.1 eV&quot;</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">scf_algorithm</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">shift_mode</span><span class="o">=</span><span class="s2">&quot;Symmetric&quot;</span><span class="p">,</span> <span class="n">ph_ngqpt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">qpoints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">qppa</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">do_ddk</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">do_dde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">do_strain</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">do_dte</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">scf_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ph_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ddk_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dde_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">wfq_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">strain_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip_dte_permutations</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">extra_abivars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">decorators</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">autoparal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initialization_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates an instance of DfptFWWorkflow using the scf_for_phonons and dfpt_from_gsinput factory functions.</span>
<span class="sd">        See the description of the factories for the definition of the arguments.</span>
<span class="sd">        The manager can be a TaskManager or a FWTaskManager.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">initialization_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">initialization_info</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="s1">&#39;kppa&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">initialization_info</span><span class="p">:</span>
            <span class="n">initialization_info</span><span class="p">[</span><span class="s1">&#39;kppa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kppa</span>

        <span class="n">scf_inp</span> <span class="o">=</span> <span class="n">scf_for_phonons</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="n">structure</span><span class="p">,</span> <span class="n">pseudos</span><span class="o">=</span><span class="n">pseudos</span><span class="p">,</span> <span class="n">kppa</span><span class="o">=</span><span class="n">kppa</span><span class="p">,</span> <span class="n">ecut</span><span class="o">=</span><span class="n">ecut</span><span class="p">,</span> <span class="n">pawecutdg</span><span class="o">=</span><span class="n">pawecutdg</span><span class="p">,</span>
                                  <span class="n">nband</span><span class="o">=</span><span class="n">nband</span><span class="p">,</span> <span class="n">accuracy</span><span class="o">=</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">spin_mode</span><span class="o">=</span><span class="n">spin_mode</span><span class="p">,</span> <span class="n">smearing</span><span class="o">=</span><span class="n">smearing</span><span class="p">,</span>
                                  <span class="n">charge</span><span class="o">=</span><span class="n">charge</span><span class="p">,</span> <span class="n">scf_algorithm</span><span class="o">=</span><span class="n">scf_algorithm</span><span class="p">,</span> <span class="n">shift_mode</span><span class="o">=</span><span class="n">shift_mode</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_gs_input</span><span class="p">(</span><span class="n">scf_inp</span><span class="p">,</span> <span class="n">ph_ngqpt</span><span class="o">=</span><span class="n">ph_ngqpt</span><span class="p">,</span> <span class="n">qpoints</span><span class="o">=</span><span class="n">qpoints</span><span class="p">,</span> <span class="n">qppa</span><span class="o">=</span><span class="n">qppa</span><span class="p">,</span> <span class="n">do_ddk</span><span class="o">=</span><span class="n">do_ddk</span><span class="p">,</span> <span class="n">do_dde</span><span class="o">=</span><span class="n">do_dde</span><span class="p">,</span>
                                 <span class="n">do_strain</span><span class="o">=</span><span class="n">do_strain</span><span class="p">,</span> <span class="n">do_dte</span><span class="o">=</span><span class="n">do_dte</span><span class="p">,</span> <span class="n">scf_tol</span><span class="o">=</span><span class="n">scf_tol</span><span class="p">,</span> <span class="n">ph_tol</span><span class="o">=</span><span class="n">ph_tol</span><span class="p">,</span> <span class="n">ddk_tol</span><span class="o">=</span><span class="n">ddk_tol</span><span class="p">,</span>
                                 <span class="n">dde_tol</span><span class="o">=</span><span class="n">dde_tol</span><span class="p">,</span> <span class="n">strain_tol</span><span class="o">=</span><span class="n">strain_tol</span><span class="p">,</span> <span class="n">skip_dte_permutations</span><span class="o">=</span><span class="n">skip_dte_permutations</span><span class="p">,</span>
                                 <span class="n">extra_abivars</span><span class="o">=</span><span class="n">extra_abivars</span><span class="p">,</span> <span class="n">decorators</span><span class="o">=</span><span class="n">decorators</span><span class="p">,</span> <span class="n">autoparal</span><span class="o">=</span><span class="n">autoparal</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span>
                                 <span class="n">initialization_info</span><span class="o">=</span><span class="n">initialization_info</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">)</span></div>

<div class="viewcode-block" id="DfptFWWorkflow.from_gs_input"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.DfptFWWorkflow.from_gs_input">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_gs_input</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">gs_input</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ph_ngqpt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">qpoints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">qppa</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">do_ddk</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">do_dde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">do_strain</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">do_dte</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">scf_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ph_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ddk_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dde_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">wfq_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">strain_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">skip_dte_permutations</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">extra_abivars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">decorators</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">autoparal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initialization_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates an instance of DfptFWWorkflow using a custom |AbinitInput| for a ground state calculation and the</span>
<span class="sd">        dfpt_from_gsinput factory function. Tolerances for the scf will be set accordingly to scf_tol (with</span>
<span class="sd">        default 1e-22) and keys relative to relaxation and parallelization will be removed from gs_input.</span>
<span class="sd">        See the description of the dfpt_from_gsinput factory for the definition of the arguments.</span>
<span class="sd">        The manager can be a TaskManager or a FWTaskManager.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">extra_abivars</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">extra_abivars</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">decorators</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">decorators</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">initialization_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">initialization_info</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="n">FWTaskManager</span><span class="p">):</span>
            <span class="n">manager</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">task_manager</span>
            <span class="k">if</span> <span class="n">manager</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;A TaskManager is required in the FWTaskManager.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">qppa</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ph_ngqpt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">qpoints</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;qppa is incompatible with ph_ngqpt and qpoints&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">qppa</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">structure</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">structure</span> <span class="o">=</span> <span class="n">gs_input</span><span class="o">.</span><span class="n">structure</span>
            <span class="n">initialization_info</span><span class="p">[</span><span class="s1">&#39;qppa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qppa</span>
            <span class="n">ph_ngqpt</span> <span class="o">=</span> <span class="n">KSampling</span><span class="o">.</span><span class="n">automatic_density</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">qppa</span><span class="p">,</span> <span class="n">chksymbreak</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">kpts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">initialization_info</span><span class="p">[</span><span class="s1">&#39;ngqpt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ph_ngqpt</span>
        <span class="n">initialization_info</span><span class="p">[</span><span class="s1">&#39;qpoints&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qpoints</span>
        <span class="n">initialization_info</span><span class="p">[</span><span class="s1">&#39;do_strain&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">do_strain</span>
        <span class="n">initialization_info</span><span class="p">[</span><span class="s1">&#39;do_dte&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">do_dte</span>

        <span class="n">scf_inp</span> <span class="o">=</span> <span class="n">gs_input</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">structure</span><span class="p">:</span>
            <span class="n">scf_inp</span><span class="o">.</span><span class="n">set_structure</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scf_tol</span><span class="p">:</span>
            <span class="n">scf_inp</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">scf_tol</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scf_inp</span><span class="p">[</span><span class="s1">&#39;tolwfr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.e-22</span>
        <span class="n">scf_inp</span><span class="p">[</span><span class="s1">&#39;chksymbreak&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">scf_inp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;nbdbuf&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">scf_inp</span><span class="p">[</span><span class="s1">&#39;nbdbuf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">scf_inp</span><span class="p">[</span><span class="s1">&#39;nband&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scf_inp</span><span class="p">[</span><span class="s1">&#39;nband&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span>
        <span class="n">abi_vars</span> <span class="o">=</span> <span class="n">get_abinit_variables</span><span class="p">()</span>
        <span class="c1"># remove relaxation variables in case gs_input is a relaxation</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">abi_vars</span><span class="o">.</span><span class="n">vars_with_varset</span><span class="p">(</span><span class="s1">&#39;rlx&#39;</span><span class="p">):</span>
            <span class="n">scf_inp</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># remove parallelization variables in case gs_input is coming from a previous run with parallelization</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">abi_vars</span><span class="o">.</span><span class="n">vars_with_varset</span><span class="p">(</span><span class="s1">&#39;paral&#39;</span><span class="p">):</span>
            <span class="n">scf_inp</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">scf_inp</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">extra_abivars</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">decorators</span><span class="p">:</span>
            <span class="n">d</span><span class="p">(</span><span class="n">scf_inp</span><span class="p">)</span>

        <span class="n">multi</span> <span class="o">=</span> <span class="n">dfpt_from_gsinput</span><span class="p">(</span><span class="n">scf_inp</span><span class="p">,</span> <span class="n">ph_ngqpt</span><span class="o">=</span><span class="n">ph_ngqpt</span><span class="p">,</span> <span class="n">qpoints</span><span class="o">=</span><span class="n">qpoints</span><span class="p">,</span> <span class="n">do_ddk</span><span class="o">=</span><span class="n">do_ddk</span><span class="p">,</span> <span class="n">do_dde</span><span class="o">=</span><span class="n">do_dde</span><span class="p">,</span>
                                  <span class="n">do_strain</span><span class="o">=</span><span class="n">do_strain</span><span class="p">,</span> <span class="n">do_dte</span><span class="o">=</span><span class="n">do_dte</span><span class="p">,</span> <span class="n">ph_tol</span><span class="o">=</span><span class="n">ph_tol</span><span class="p">,</span> <span class="n">ddk_tol</span><span class="o">=</span><span class="n">ddk_tol</span><span class="p">,</span> <span class="n">dde_tol</span><span class="o">=</span><span class="n">dde_tol</span><span class="p">,</span>
                                  <span class="n">wfq_tol</span><span class="o">=</span><span class="n">wfq_tol</span><span class="p">,</span> <span class="n">strain_tol</span><span class="o">=</span><span class="n">strain_tol</span><span class="p">,</span> <span class="n">skip_dte_permutations</span><span class="o">=</span><span class="n">skip_dte_permutations</span><span class="p">,</span>
                                  <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">)</span>

        <span class="n">ph_inp</span> <span class="o">=</span> <span class="n">multi</span><span class="o">.</span><span class="n">filter_by_tags</span><span class="p">(</span><span class="n">atags</span><span class="o">.</span><span class="n">PH_Q_PERT</span><span class="p">)</span>
        <span class="n">nscf_inp</span> <span class="o">=</span> <span class="n">multi</span><span class="o">.</span><span class="n">filter_by_tags</span><span class="p">(</span><span class="n">atags</span><span class="o">.</span><span class="n">NSCF</span><span class="p">)</span>
        <span class="n">ddk_inp</span> <span class="o">=</span> <span class="n">multi</span><span class="o">.</span><span class="n">filter_by_tags</span><span class="p">(</span><span class="n">atags</span><span class="o">.</span><span class="n">DDK</span><span class="p">)</span>
        <span class="n">dde_inp</span> <span class="o">=</span> <span class="n">multi</span><span class="o">.</span><span class="n">filter_by_tags</span><span class="p">(</span><span class="n">atags</span><span class="o">.</span><span class="n">DDE</span><span class="p">)</span>
        <span class="n">strain_inp</span> <span class="o">=</span> <span class="n">multi</span><span class="o">.</span><span class="n">filter_by_tags</span><span class="p">(</span><span class="n">atags</span><span class="o">.</span><span class="n">STRAIN</span><span class="p">)</span>
        <span class="n">dte_inp</span> <span class="o">=</span> <span class="n">multi</span><span class="o">.</span><span class="n">filter_by_tags</span><span class="p">(</span><span class="n">atags</span><span class="o">.</span><span class="n">DTE</span><span class="p">)</span>

        <span class="n">dfpt_wf</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">scf_inp</span><span class="p">,</span> <span class="n">ph_inp</span><span class="p">,</span> <span class="n">nscf_inp</span><span class="p">,</span> <span class="n">ddk_inp</span><span class="p">,</span> <span class="n">dde_inp</span><span class="p">,</span> <span class="n">strain_inp</span><span class="p">,</span> <span class="n">dte_inp</span><span class="p">,</span> <span class="n">autoparal</span><span class="o">=</span><span class="n">autoparal</span><span class="p">,</span>
                      <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">initialization_info</span><span class="o">=</span><span class="n">initialization_info</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dfpt_wf</span></div>

<div class="viewcode-block" id="DfptFWWorkflow.get_mongoengine_results"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.DfptFWWorkflow.get_mongoengine_results">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_mongoengine_results</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">wf</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates the PhononResult mongoengine document containing the results of the calculation.</span>
<span class="sd">        The workflow should have been generated from this class and requires an open connection to the</span>
<span class="sd">        fireworks database and access to the file system containing the calculations.</span>

<span class="sd">        Args:</span>
<span class="sd">            wf: the fireworks Workflow instance of the workflow.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A PhononResult document.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="n">wf</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;workflow_class&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">workflow_class</span>
        <span class="k">assert</span> <span class="n">wf</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;workflow_module&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">workflow_module</span>

        <span class="n">scf_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ph_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ddk_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">dde_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">wfq_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">strain_index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">dte_index</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">scf_fw</span><span class="p">,</span> <span class="n">ph_fw</span><span class="p">,</span> <span class="n">wfq_fw</span><span class="p">,</span> <span class="n">ddk_fw</span><span class="p">,</span> <span class="n">dde_fw</span><span class="p">,</span> <span class="n">strain_fw</span><span class="p">,</span> <span class="n">dte_fw</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="n">anaddb_task</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">fw</span> <span class="ow">in</span> <span class="n">wf</span><span class="o">.</span><span class="n">fws</span><span class="p">:</span>
            <span class="n">task_index</span> <span class="o">=</span> <span class="n">fw</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;wf_task_index&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">task_index</span> <span class="o">==</span> <span class="s1">&#39;anaddb&#39;</span><span class="p">:</span>
                <span class="n">anaddb_launch</span> <span class="o">=</span> <span class="n">get_last_completed_launch</span><span class="p">(</span><span class="n">fw</span><span class="p">)</span>
                <span class="n">anaddb_task</span> <span class="o">=</span> <span class="n">fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">anaddb_task</span><span class="o">.</span><span class="n">set_workdir</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">anaddb_launch</span><span class="o">.</span><span class="n">launch_dir</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">task_index</span> <span class="o">==</span> <span class="s1">&#39;mrgddb&#39;</span><span class="p">:</span>
                <span class="n">mrgddb_launch</span> <span class="o">=</span> <span class="n">get_last_completed_launch</span><span class="p">(</span><span class="n">fw</span><span class="p">)</span>
                <span class="n">mrgddb_task</span> <span class="o">=</span> <span class="n">fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">mrgddb_task</span><span class="o">.</span><span class="n">set_workdir</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">mrgddb_launch</span><span class="o">.</span><span class="n">launch_dir</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">task_index</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;scf_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">task_index</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;autoparal&#39;</span><span class="p">):</span>
                <span class="n">current_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">task_index</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">current_index</span> <span class="o">&gt;</span> <span class="n">scf_index</span><span class="p">:</span>
                    <span class="n">scf_index</span> <span class="o">=</span> <span class="n">current_index</span>
                    <span class="n">scf_fw</span> <span class="o">=</span> <span class="n">fw</span>
            <span class="k">elif</span> <span class="n">task_index</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;phonon_0&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">task_index</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;autoparal&#39;</span><span class="p">):</span>
                <span class="n">current_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">task_index</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">current_index</span> <span class="o">&gt;</span> <span class="n">ph_index</span><span class="p">:</span>
                    <span class="n">ph_index</span> <span class="o">=</span> <span class="n">current_index</span>
                    <span class="n">ph_fw</span> <span class="o">=</span> <span class="n">fw</span>
            <span class="k">elif</span> <span class="n">task_index</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;ddk_0&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">task_index</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;autoparal&#39;</span><span class="p">):</span>
                <span class="n">current_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">task_index</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">current_index</span> <span class="o">&gt;</span> <span class="n">ddk_index</span><span class="p">:</span>
                    <span class="n">ddk_index</span> <span class="o">=</span> <span class="n">current_index</span>
                    <span class="n">ddk_fw</span> <span class="o">=</span> <span class="n">fw</span>
            <span class="k">elif</span> <span class="n">task_index</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;dde_0&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">task_index</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;autoparal&#39;</span><span class="p">):</span>
                <span class="n">current_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">task_index</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">current_index</span> <span class="o">&gt;</span> <span class="n">dde_index</span><span class="p">:</span>
                    <span class="n">dde_index</span> <span class="o">=</span> <span class="n">current_index</span>
                    <span class="n">dde_fw</span> <span class="o">=</span> <span class="n">fw</span>
            <span class="k">elif</span> <span class="n">task_index</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;nscf_wfq_0&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">task_index</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;autoparal&#39;</span><span class="p">):</span>
                <span class="n">current_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">task_index</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">current_index</span> <span class="o">&gt;</span> <span class="n">wfq_index</span><span class="p">:</span>
                    <span class="n">wfq_index</span> <span class="o">=</span> <span class="n">current_index</span>
                    <span class="n">wfq_fw</span> <span class="o">=</span> <span class="n">fw</span>
            <span class="k">elif</span> <span class="n">task_index</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;strain_pert_0&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">task_index</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;autoparal&#39;</span><span class="p">):</span>
                <span class="n">current_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">task_index</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">current_index</span> <span class="o">&gt;</span> <span class="n">strain_index</span><span class="p">:</span>
                    <span class="n">strain_index</span> <span class="o">=</span> <span class="n">current_index</span>
                    <span class="n">strain_fw</span> <span class="o">=</span> <span class="n">fw</span>
            <span class="k">elif</span> <span class="n">task_index</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;dte_0&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">task_index</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;autoparal&#39;</span><span class="p">):</span>
                <span class="n">current_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">task_index</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">current_index</span> <span class="o">&gt;</span> <span class="n">dte_index</span><span class="p">:</span>
                    <span class="n">dte_index</span> <span class="o">=</span> <span class="n">current_index</span>
                    <span class="n">dte_fw</span> <span class="o">=</span> <span class="n">fw</span>

        <span class="n">scf_launch</span> <span class="o">=</span> <span class="n">get_last_completed_launch</span><span class="p">(</span><span class="n">scf_fw</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">scf_launch</span><span class="o">.</span><span class="n">launch_dir</span><span class="p">,</span> <span class="s1">&#39;history.json&#39;</span><span class="p">),</span> <span class="s2">&quot;rt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">scf_history</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">MontyDecoder</span><span class="p">)</span>
        <span class="n">scf_task</span> <span class="o">=</span> <span class="n">scf_fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">scf_task</span><span class="o">.</span><span class="n">set_workdir</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">scf_launch</span><span class="o">.</span><span class="n">launch_dir</span><span class="p">)</span>

        <span class="n">document</span> <span class="o">=</span> <span class="n">DfptResult</span><span class="p">()</span>

        <span class="n">document</span><span class="o">.</span><span class="n">has_phonons</span> <span class="o">=</span> <span class="n">ph_fw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">document</span><span class="o">.</span><span class="n">has_ddk</span> <span class="o">=</span> <span class="n">ddk_fw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">document</span><span class="o">.</span><span class="n">has_dde</span> <span class="o">=</span> <span class="n">dde_fw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">document</span><span class="o">.</span><span class="n">has_strain</span> <span class="o">=</span> <span class="n">strain_fw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">document</span><span class="o">.</span><span class="n">has_dte</span> <span class="o">=</span> <span class="n">dte_fw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="n">gs_input</span> <span class="o">=</span> <span class="n">scf_history</span><span class="o">.</span><span class="n">get_events_by_types</span><span class="p">(</span><span class="n">TaskEvent</span><span class="o">.</span><span class="n">FINALIZED</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">details</span><span class="p">[</span><span class="s1">&#39;final_input&#39;</span><span class="p">]</span>

        <span class="n">document</span><span class="o">.</span><span class="n">abinit_input</span><span class="o">.</span><span class="n">gs_input</span> <span class="o">=</span> <span class="n">gs_input</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
        <span class="n">document</span><span class="o">.</span><span class="n">abinit_input</span><span class="o">.</span><span class="n">set_abinit_basic_from_abinit_input</span><span class="p">(</span><span class="n">gs_input</span><span class="p">)</span>

        <span class="n">structure</span> <span class="o">=</span> <span class="n">gs_input</span><span class="o">.</span><span class="n">structure</span>
        <span class="n">document</span><span class="o">.</span><span class="n">abinit_output</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
        <span class="n">document</span><span class="o">.</span><span class="n">set_material_data_from_structure</span><span class="p">(</span><span class="n">structure</span><span class="p">)</span>

        <span class="n">initialization_info</span> <span class="o">=</span> <span class="n">scf_history</span><span class="o">.</span><span class="n">get_events_by_types</span><span class="p">(</span><span class="n">TaskEvent</span><span class="o">.</span><span class="n">INITIALIZED</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">details</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;initialization_info&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">document</span><span class="o">.</span><span class="n">mp_id</span> <span class="o">=</span> <span class="n">initialization_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mp_id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">document</span><span class="o">.</span><span class="n">custom</span> <span class="o">=</span> <span class="n">initialization_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;custom&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">document</span><span class="o">.</span><span class="n">relax_db</span> <span class="o">=</span> <span class="n">initialization_info</span><span class="p">[</span><span class="s1">&#39;relax_db&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;relax_db&#39;</span> <span class="ow">in</span> <span class="n">initialization_info</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">document</span><span class="o">.</span><span class="n">relax_id</span> <span class="o">=</span> <span class="n">initialization_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;relax_id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">document</span><span class="o">.</span><span class="n">abinit_input</span><span class="o">.</span><span class="n">ngqpt</span> <span class="o">=</span> <span class="n">initialization_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ngqpt&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">document</span><span class="o">.</span><span class="n">abinit_input</span><span class="o">.</span><span class="n">qpoints</span> <span class="o">=</span> <span class="n">initialization_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;qpoints&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">document</span><span class="o">.</span><span class="n">abinit_input</span><span class="o">.</span><span class="n">qppa</span> <span class="o">=</span> <span class="n">initialization_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;qppa&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">document</span><span class="o">.</span><span class="n">abinit_input</span><span class="o">.</span><span class="n">kppa</span> <span class="o">=</span> <span class="n">initialization_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;kppa&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">document</span><span class="o">.</span><span class="n">abinit_input</span><span class="o">.</span><span class="n">pseudopotentials</span><span class="o">.</span><span class="n">set_pseudos_from_files_file</span><span class="p">(</span><span class="n">scf_task</span><span class="o">.</span><span class="n">files_file</span><span class="o">.</span><span class="n">path</span><span class="p">,</span>
                                                                           <span class="nb">len</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">composition</span><span class="o">.</span><span class="n">elements</span><span class="p">))</span>

        <span class="n">document</span><span class="o">.</span><span class="n">created_on</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">document</span><span class="o">.</span><span class="n">modified_on</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="n">document</span><span class="o">.</span><span class="n">set_dir_names_from_fws_wf</span><span class="p">(</span><span class="n">wf</span><span class="p">)</span>

        <span class="c1"># read in binary for py3k compatibility with mongoengine</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">mrgddb_task</span><span class="o">.</span><span class="n">merged_ddb_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">document</span><span class="o">.</span><span class="n">abinit_output</span><span class="o">.</span><span class="n">ddb</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ph_index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ph_task</span> <span class="o">=</span> <span class="n">ph_fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">document</span><span class="o">.</span><span class="n">abinit_input</span><span class="o">.</span><span class="n">phonon_input</span> <span class="o">=</span> <span class="n">ph_task</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">ddk_index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ddk_task</span> <span class="o">=</span> <span class="n">ddk_fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">document</span><span class="o">.</span><span class="n">abinit_input</span><span class="o">.</span><span class="n">ddk_input</span> <span class="o">=</span> <span class="n">ddk_task</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">dde_index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dde_task</span> <span class="o">=</span> <span class="n">dde_fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">document</span><span class="o">.</span><span class="n">abinit_input</span><span class="o">.</span><span class="n">dde_input</span> <span class="o">=</span> <span class="n">dde_task</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">wfq_index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">wfq_task</span> <span class="o">=</span> <span class="n">wfq_fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">document</span><span class="o">.</span><span class="n">abinit_input</span><span class="o">.</span><span class="n">wfq_input</span> <span class="o">=</span> <span class="n">wfq_task</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">strain_index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">strain_task</span> <span class="o">=</span> <span class="n">strain_fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">document</span><span class="o">.</span><span class="n">abinit_input</span><span class="o">.</span><span class="n">strain_input</span> <span class="o">=</span> <span class="n">strain_task</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">dte_index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dte_task</span> <span class="o">=</span> <span class="n">dte_fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">document</span><span class="o">.</span><span class="n">abinit_input</span><span class="o">.</span><span class="n">dte_input</span> <span class="o">=</span> <span class="n">dte_task</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">anaddb_task</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">anaddb_task</span><span class="o">.</span><span class="n">anaddb_nc_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">document</span><span class="o">.</span><span class="n">abinit_output</span><span class="o">.</span><span class="n">anaddb_nc</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">anaddb_task</span><span class="o">.</span><span class="n">phbst_path</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">anaddb_task</span><span class="o">.</span><span class="n">phbst_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">document</span><span class="o">.</span><span class="n">abinit_output</span><span class="o">.</span><span class="n">phonon_bs</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">anaddb_task</span><span class="o">.</span><span class="n">phdos_path</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">anaddb_task</span><span class="o">.</span><span class="n">phdos_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">document</span><span class="o">.</span><span class="n">abinit_output</span><span class="o">.</span><span class="n">phonon_dos</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="n">document</span><span class="o">.</span><span class="n">fw_id</span> <span class="o">=</span> <span class="n">scf_fw</span><span class="o">.</span><span class="n">fw_id</span>

        <span class="n">document</span><span class="o">.</span><span class="n">time_report</span> <span class="o">=</span> <span class="n">get_time_report_for_wf</span><span class="p">(</span><span class="n">wf</span><span class="p">)</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">scf_task</span><span class="o">.</span><span class="n">gsr_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">document</span><span class="o">.</span><span class="n">abinit_output</span><span class="o">.</span><span class="n">gs_gsr</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="c1"># read in binary for py3k compatibility with mongoengine</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">scf_task</span><span class="o">.</span><span class="n">output_file</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">document</span><span class="o">.</span><span class="n">abinit_output</span><span class="o">.</span><span class="n">gs_outfile</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">document</span></div>

<div class="viewcode-block" id="DfptFWWorkflow.add_anaddb_dfpt_fw"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.workflows.html#abiflows.fireworks.workflows.abinit_workflows.DfptFWWorkflow.add_anaddb_dfpt_fw">[docs]</a>    <span class="k">def</span> <span class="nf">add_anaddb_dfpt_fw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">ph_ngqpt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ndivsm</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">nqsmall</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">qppa</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">line_density</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Appends a Firework with a task for the calculation of various properties with anaddb.</span>

<span class="sd">        Notice that in the current abinit version, the presence of the third order derivatives is incompatible with</span>
<span class="sd">        the presence q-points different from gamma in the DDB and first order derivative. Anaddb calculation can</span>
<span class="sd">        either fail or produce meaningless results.</span>

<span class="sd">        Args:</span>
<span class="sd">            structure: the input structure</span>
<span class="sd">            ngqpt: Monkhorst-Pack divisions for the phonon Q-mesh (coarse one)</span>
<span class="sd">            nqsmall: Used to generate the (dense) mesh for the DOS.</span>
<span class="sd">                It defines the number of q-points used to sample the smallest lattice vector.</span>
<span class="sd">            ndivsm: Used to generate a normalized path for the phonon bands.</span>
<span class="sd">                If gives the number of divisions for the smallest segment of the path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">anaddb_input</span> <span class="o">=</span> <span class="n">AnaddbInput</span><span class="o">.</span><span class="n">dfpt</span><span class="p">(</span><span class="n">structure</span><span class="p">,</span> <span class="n">ngqpt</span><span class="o">=</span><span class="n">ph_ngqpt</span><span class="p">,</span> <span class="n">relaxed_ion</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">has_gamma</span><span class="p">,</span>
                                        <span class="n">piezo</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strain_fws</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dde_fws</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                        <span class="n">dde</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dde_fws</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">strain</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">strain_fws</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                        <span class="n">dte</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dte_fws</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">stress_correction</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                        <span class="n">nqsmall</span><span class="o">=</span><span class="n">nqsmall</span><span class="p">,</span> <span class="n">qppa</span><span class="o">=</span><span class="n">qppa</span><span class="p">,</span> <span class="n">ndivsm</span><span class="o">=</span><span class="n">ndivsm</span><span class="p">,</span> <span class="n">line_density</span><span class="o">=</span><span class="n">line_density</span><span class="p">,</span>
                                        <span class="n">q1shft</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">asr</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">chneut</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dipdip</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">dos_method</span><span class="o">=</span><span class="s2">&quot;tetra&quot;</span><span class="p">)</span>
        <span class="n">anaddb_task</span> <span class="o">=</span> <span class="n">AnaDdbAbinitTask</span><span class="p">(</span><span class="n">anaddb_input</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="p">{</span><span class="n">MergeDdbAbinitTask</span><span class="o">.</span><span class="n">task_type</span><span class="p">:</span> <span class="s2">&quot;DDB&quot;</span><span class="p">})</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scf_fw</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;wf_task_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;anaddb&#39;</span>

        <span class="n">anaddb_fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">(</span><span class="n">anaddb_task</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">spec</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;anaddb&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">append_fw</span><span class="p">(</span><span class="n">anaddb_fw</span><span class="p">,</span> <span class="n">short_single_spec</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div></div>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2017, The Abinit group.<br/>
      Last updated on May 29, 2020.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.2.0.<br/>
    </p>
  </div>
</footer>
  </body>
</html>