<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>abiflows.fireworks.tasks.src_tasks_abc &#8212; abiflows 0.6 documentation</title>
    <link rel="stylesheet" href="../../../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/my_style.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../../../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../../../../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../../../../_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../../../../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../../index.html">
          abiflows</a>
        <span class="navbar-text navbar-version pull-left"><b>0.6</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation.html">Getting AbiFlows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../setup.html">Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../workflows.html">Abinit Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../results_db.html">Results database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../failures.html">Errors and failures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../changelog.html">Changelog</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../useful_links.html">Useful links</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../zzbiblio.html">Bibliography</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/modules.html">abiflows</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
              
                
              
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <h1>Source code for abiflows.fireworks.tasks.src_tasks_abc</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">six</span>

<span class="kn">from</span> <span class="nn">fireworks.core.firework</span> <span class="kn">import</span> <span class="n">FireTaskBase</span>
<span class="kn">from</span> <span class="nn">fireworks.core.firework</span> <span class="kn">import</span> <span class="n">FWAction</span>
<span class="kn">from</span> <span class="nn">fireworks.core.firework</span> <span class="kn">import</span> <span class="n">Workflow</span>
<span class="kn">from</span> <span class="nn">fireworks.core.firework</span> <span class="kn">import</span> <span class="n">Firework</span>
<span class="kn">from</span> <span class="nn">fireworks.core.launchpad</span> <span class="kn">import</span> <span class="n">LaunchPad</span>
<span class="kn">from</span> <span class="nn">fireworks.utilities.fw_utilities</span> <span class="kn">import</span> <span class="n">explicit_serialize</span>
<span class="kn">from</span> <span class="nn">fireworks.utilities.fw_serializers</span> <span class="kn">import</span> <span class="n">serialize_fw</span>

<span class="kn">from</span> <span class="nn">monty.json</span> <span class="kn">import</span> <span class="n">MontyDecoder</span> <span class="c1">#, MontyEncoder</span>
<span class="kn">from</span> <span class="nn">monty.json</span> <span class="kn">import</span> <span class="n">MSONable</span>
<span class="kn">from</span> <span class="nn">monty.serialization</span> <span class="kn">import</span> <span class="n">loadfn</span>
<span class="kn">from</span> <span class="nn">monty.subprocess</span> <span class="kn">import</span> <span class="n">Command</span>

<span class="kn">from</span> <span class="nn">abiflows.core.mastermind_abc</span> <span class="kn">import</span> <span class="n">ControlProcedure</span><span class="p">,</span> <span class="n">ControlledItemType</span>
<span class="kn">from</span> <span class="nn">abiflows.core.mastermind_abc</span> <span class="kn">import</span> <span class="n">ControllerNote</span>
<span class="kn">from</span> <span class="nn">abiflows.core.mastermind_abc</span> <span class="kn">import</span> <span class="n">Cleaner</span>
<span class="kn">from</span> <span class="nn">abiflows.fireworks.utils.fw_utils</span> <span class="kn">import</span> <span class="n">set_short_single_core_to_spec</span><span class="p">,</span> <span class="n">get_short_single_core_spec</span>

<span class="n">RESTART_FROM_SCRATCH</span> <span class="o">=</span> <span class="n">ControllerNote</span><span class="o">.</span><span class="n">RESTART_FROM_SCRATCH</span>
<span class="n">RESET_RESTART</span> <span class="o">=</span> <span class="n">ControllerNote</span><span class="o">.</span><span class="n">RESET_RESTART</span>
<span class="n">SIMPLE_RESTART</span> <span class="o">=</span> <span class="n">ControllerNote</span><span class="o">.</span><span class="n">SIMPLE_RESTART</span>


<div class="viewcode-block" id="SRCTaskMixin"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.SRCTaskMixin">[docs]</a><span class="k">class</span> <span class="nc">SRCTaskMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="n">src_type</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="nd">@serialize_fw</span>
    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">arg</span> <span class="o">!=</span> <span class="s2">&quot;self&quot;</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s2">&quot;as_dict&quot;</span><span class="p">):</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s2">&quot;as_dict&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span><span class="p">]</span>
                <span class="n">d</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

        <span class="k">return</span> <span class="n">d</span>

<div class="viewcode-block" id="SRCTaskMixin.from_dict"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.SRCTaskMixin.from_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="n">MontyDecoder</span><span class="p">()</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">dec</span><span class="o">.</span><span class="n">process_decoded</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                  <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)</span><span class="o">.</span><span class="n">args</span><span class="p">}</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="SRCTaskMixin.setup_directories"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.SRCTaskMixin.setup_directories">[docs]</a>    <span class="k">def</span> <span class="nf">setup_directories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">,</span> <span class="n">create_dirs</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_type</span> <span class="o">==</span> <span class="s1">&#39;setup&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">src_root_dir</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_launch_dir&#39;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
        <span class="k">elif</span> <span class="s1">&#39;src_directories&#39;</span> <span class="ow">in</span> <span class="n">fw_spec</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">src_root_dir</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="p">[</span><span class="s1">&#39;src_directories&#39;</span><span class="p">][</span><span class="s1">&#39;src_root_dir&#39;</span><span class="p">]</span>
        <span class="c1"># elif self.src_type in [&#39;run&#39;, &#39;control&#39;]:</span>
        <span class="c1">#     self.src_root_dir = os.path.split(os.path.abspath(fw_spec[&#39;_launch_dir&#39;]))[0]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot setup directories for &quot;src_type&quot; = &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_type</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_root_dir</span><span class="p">,</span> <span class="s1">&#39;setup&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_root_dir</span><span class="p">,</span> <span class="s1">&#39;run&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_root_dir</span><span class="p">,</span> <span class="s1">&#39;control&#39;</span><span class="p">)</span>
        <span class="c1"># if &#39;src_directories&#39; in fw_spec:</span>
        <span class="c1">#     if (self.src_root_dir != fw_spec[&#39;src_directories&#39;][&#39;src_root_dir&#39;] or</span>
        <span class="c1">#         self.setup_dir != fw_spec[&#39;src_directories&#39;][&#39;setup_dir&#39;] or</span>
        <span class="c1">#         self.run_dir != fw_spec[&#39;src_directories&#39;][&#39;run_dir&#39;] or</span>
        <span class="c1">#         self.control_dir != fw_spec[&#39;src_directories&#39;][&#39;control_dir&#39;]):</span>
        <span class="c1">#         raise ValueError(&#39;src_directories in fw_spec do not match actual SRC directories ...&#39;)</span>
        <span class="k">if</span> <span class="n">create_dirs</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup_dir</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">control_dir</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">src_directories</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;src_root_dir&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_root_dir</span><span class="p">,</span>
                <span class="s1">&#39;setup_dir&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_dir</span><span class="p">,</span>
                <span class="s1">&#39;run_dir&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="p">,</span>
                <span class="s1">&#39;control_dir&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">control_dir</span>
                <span class="p">}</span></div>


<div class="viewcode-block" id="SetupTask"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.SetupTask">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">SetupTask</span><span class="p">(</span><span class="n">SRCTaskMixin</span><span class="p">,</span> <span class="n">FireTaskBase</span><span class="p">):</span>

    <span class="n">src_type</span> <span class="o">=</span> <span class="s1">&#39;setup&#39;</span>
    <span class="n">task_type</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span>

    <span class="n">RUN_PARAMETERS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_queueadapter&#39;</span><span class="p">,</span> <span class="s1">&#39;mpi_ncpus&#39;</span><span class="p">,</span> <span class="s1">&#39;qtk_queueadapter&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">restart_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">task_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="c1"># TODO: if at some point, this is not enough (as for the ddk, or for the structure, or for anything else,</span>
        <span class="c1">#       we could thing of an object ?</span>
        <span class="c1"># deps are transformed to be a list or a dict of lists</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">deps</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">deps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                    <span class="n">deps</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">deps</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="p">[</span><span class="n">deps</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deps</span> <span class="o">=</span> <span class="n">deps</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">restart_info</span> <span class="o">=</span> <span class="n">restart_info</span>

        <span class="k">if</span> <span class="n">task_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task_type</span> <span class="o">=</span> <span class="n">task_type</span>

<div class="viewcode-block" id="SetupTask.set_restart_info"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.SetupTask.set_restart_info">[docs]</a>    <span class="k">def</span> <span class="nf">set_restart_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">restart_info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restart_info</span> <span class="o">=</span> <span class="n">restart_info</span></div>

<div class="viewcode-block" id="SetupTask.run_task"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.SetupTask.run_task">[docs]</a>    <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="c1"># Set up and create the directory tree of the Setup/Run/Control trio,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_directories</span><span class="p">(</span><span class="n">fw_spec</span><span class="o">=</span><span class="n">fw_spec</span><span class="p">,</span> <span class="n">create_dirs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1">#  Forward directory information to run and control fireworks #HACK in _setup_run_and_control_dirs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_run_and_control_dirs_and_fworker</span><span class="p">(</span><span class="n">fw_spec</span><span class="o">=</span><span class="n">fw_spec</span><span class="p">)</span>
        <span class="c1"># Move to the setup directory</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">setup_dir</span><span class="p">)</span>
        <span class="c1"># Make the file transfers from another worker if needed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_transfers</span><span class="p">(</span><span class="n">fw_spec</span><span class="o">=</span><span class="n">fw_spec</span><span class="p">)</span>
        <span class="c1"># Get back information from the previous runs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fetch_previous_info</span><span class="p">(</span><span class="n">fw_spec</span><span class="o">=</span><span class="n">fw_spec</span><span class="p">)</span>
        <span class="c1"># Setup the parameters for the run (number of cpus, time, memory, openmp, ...)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">RUN_PARAMETERS</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;src_modified_objects&#39;</span> <span class="ow">in</span> <span class="n">fw_spec</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">target</span><span class="p">,</span> <span class="n">modified_object</span> <span class="ow">in</span> <span class="n">fw_spec</span><span class="p">[</span><span class="s1">&#39;src_modified_objects&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">params</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
        <span class="n">run_parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_setup_run_parameters</span><span class="p">(</span><span class="n">fw_spec</span><span class="o">=</span><span class="n">fw_spec</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
        <span class="c1"># Prepare run (make links to output files from previous tasks, write input files, create the directory</span>
        <span class="c1"># tree of the program, ...)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepare_run</span><span class="p">(</span><span class="n">fw_spec</span><span class="o">=</span><span class="n">fw_spec</span><span class="p">)</span>

        <span class="c1"># Update the spec of the Run Firework with the directory tree, the run_parameters obtained from</span>
        <span class="c1">#  setup_run_parameters and the modified_objects transferred directly from the Control Firework</span>
        <span class="n">update_spec</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;src_directories&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_directories</span><span class="p">}</span>
        <span class="n">update_spec</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">run_parameters</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;src_modified_objects&#39;</span> <span class="ow">in</span> <span class="n">fw_spec</span><span class="p">:</span>
            <span class="n">update_spec</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">[</span><span class="s1">&#39;src_modified_objects&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;previous_fws&#39;</span> <span class="ow">in</span> <span class="n">fw_spec</span><span class="p">:</span>
            <span class="n">update_spec</span><span class="p">[</span><span class="s1">&#39;previous_fws&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="p">[</span><span class="s1">&#39;previous_fws&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">FWAction</span><span class="p">(</span><span class="n">update_spec</span><span class="o">=</span><span class="n">update_spec</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_setup_run_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
        <span class="n">qadapter_spec</span><span class="p">,</span> <span class="n">qtk_queueadapter</span> <span class="o">=</span> <span class="n">get_short_single_core_spec</span><span class="p">(</span><span class="n">return_qtk</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;_queueadapter&#39;</span><span class="p">:</span> <span class="n">qadapter_spec</span><span class="p">,</span> <span class="s1">&#39;mpi_ncpus&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;qtk_queueadapter&#39;</span><span class="p">:</span> <span class="n">qtk_queueadapter</span><span class="p">}</span>
        <span class="n">setup_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_run_parameters</span><span class="p">(</span><span class="n">fw_spec</span><span class="o">=</span><span class="n">fw_spec</span><span class="p">)</span>
        <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">setup_params</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;initial_parameters&#39;</span> <span class="ow">in</span> <span class="n">fw_spec</span> <span class="ow">and</span> <span class="n">fw_spec</span><span class="p">[</span><span class="s1">&#39;SRC_task_index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">qtk_queueadapter</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;qtk_queueadapter&#39;</span><span class="p">]</span>
            <span class="n">initial_parameters</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="p">[</span><span class="s1">&#39;initial_parameters&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s1">&#39;run_timelimit&#39;</span> <span class="ow">in</span> <span class="n">initial_parameters</span><span class="p">:</span>
                <span class="n">qtk_queueadapter</span><span class="o">.</span><span class="n">set_timelimit</span><span class="p">(</span><span class="n">timelimit</span><span class="o">=</span><span class="n">initial_parameters</span><span class="p">[</span><span class="s1">&#39;run_timelimit&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s1">&#39;run_mem_per_proc&#39;</span> <span class="ow">in</span> <span class="n">initial_parameters</span><span class="p">:</span>
                <span class="n">qtk_queueadapter</span><span class="o">.</span><span class="n">set_mem_per_proc</span><span class="p">(</span><span class="n">mem_mb</span><span class="o">=</span><span class="n">initial_parameters</span><span class="p">[</span><span class="s1">&#39;run_mem_per_proc&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s1">&#39;run_mpi_ncpus&#39;</span> <span class="ow">in</span> <span class="n">initial_parameters</span><span class="p">:</span>
                <span class="n">qtk_queueadapter</span><span class="o">.</span><span class="n">set_mpi_procs</span><span class="p">(</span><span class="n">mpi_procs</span><span class="o">=</span><span class="n">initial_parameters</span><span class="p">[</span><span class="s1">&#39;run_mpi_ncpus&#39;</span><span class="p">])</span>
            <span class="n">qadapter_spec</span> <span class="o">=</span> <span class="n">qtk_queueadapter</span><span class="o">.</span><span class="n">get_subs_dict</span><span class="p">()</span>
            <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;qtk_queueadapter&#39;</span><span class="p">:</span> <span class="n">qtk_queueadapter</span><span class="p">,</span> <span class="s1">&#39;_queueadapter&#39;</span><span class="p">:</span> <span class="n">qadapter_spec</span><span class="p">})</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">param</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">}</span>

<div class="viewcode-block" id="SetupTask.setup_run_parameters"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.SetupTask.setup_run_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">setup_run_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="SetupTask.file_transfers"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.SetupTask.file_transfers">[docs]</a>    <span class="k">def</span> <span class="nf">file_transfers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="SetupTask.fetch_previous_info"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.SetupTask.fetch_previous_info">[docs]</a>    <span class="k">def</span> <span class="nf">fetch_previous_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="SetupTask.prepare_run"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.SetupTask.prepare_run">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="k">pass</span></div>

    <span class="k">def</span> <span class="nf">_setup_run_and_control_dirs_and_fworker</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is used to update the spec of the run and control fireworks with the src_directories as well as</span>
<span class="sd">        set the _launch_dir of the run and control fireworks to be the run_dir and control_dir respectively.</span>
<span class="sd">        WARNING: This is a bit hackish! Do not change this unless you know exactly what you are doing!</span>
<span class="sd">        :param fw_spec: Firework&#39;s spec</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the launchpad</span>
        <span class="k">if</span> <span class="s1">&#39;_add_launchpad_and_fw_id&#39;</span> <span class="ow">in</span> <span class="n">fw_spec</span><span class="p">:</span>
            <span class="n">lp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">launchpad</span>
            <span class="n">setup_fw_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fw_id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fw_dict</span> <span class="o">=</span> <span class="n">loadfn</span><span class="p">(</span><span class="s1">&#39;FW.json&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fw_dict</span> <span class="o">=</span> <span class="n">loadfn</span><span class="p">(</span><span class="s1">&#39;FW.yaml&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Launchpad/fw_id not present in spec and No FW.json nor FW.yaml file present: &quot;</span>
                                       <span class="s2">&quot;impossible to determine fw_id&quot;</span><span class="p">)</span>
            <span class="n">lp</span> <span class="o">=</span> <span class="n">LaunchPad</span><span class="o">.</span><span class="n">auto_load</span><span class="p">()</span>
            <span class="n">setup_fw_id</span> <span class="o">=</span> <span class="n">fw_dict</span><span class="p">[</span><span class="s1">&#39;fw_id&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;_add_fworker&#39;</span> <span class="ow">in</span> <span class="n">fw_spec</span><span class="p">:</span>
            <span class="n">fworker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fworker</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Should have access to the fworker in SetupTask ...&#39;</span><span class="p">)</span>
        <span class="n">this_lzy_wf</span> <span class="o">=</span> <span class="n">lp</span><span class="o">.</span><span class="n">get_wf_by_fw_id_lzyfw</span><span class="p">(</span><span class="n">setup_fw_id</span><span class="p">)</span>
        <span class="c1"># Check that SetupTask and RunTask have only one child firework</span>
        <span class="n">child_fw_ids</span> <span class="o">=</span> <span class="n">this_lzy_wf</span><span class="o">.</span><span class="n">links</span><span class="p">[</span><span class="n">setup_fw_id</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">child_fw_ids</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;SetupTask</span><span class="se">\&#39;</span><span class="s1">s Firework should have exactly one child firework&#39;</span><span class="p">)</span>
        <span class="n">run_fw_id</span> <span class="o">=</span> <span class="n">child_fw_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">child_run_fw_ids</span> <span class="o">=</span> <span class="n">this_lzy_wf</span><span class="o">.</span><span class="n">links</span><span class="p">[</span><span class="n">run_fw_id</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">child_run_fw_ids</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;RunTask</span><span class="se">\&#39;</span><span class="s1">s Firework should have exactly one child firework&#39;</span><span class="p">)</span>
        <span class="n">control_fw_id</span> <span class="o">=</span> <span class="n">child_run_fw_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">spec_update</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;_launch_dir&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="p">,</span>
                       <span class="s1">&#39;src_directories&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_directories</span><span class="p">,</span>
                       <span class="s1">&#39;_fworker&#39;</span><span class="p">:</span> <span class="n">fworker</span><span class="o">.</span><span class="n">name</span><span class="p">}</span>
        <span class="n">lp</span><span class="o">.</span><span class="n">update_spec</span><span class="p">(</span><span class="n">fw_ids</span><span class="o">=</span><span class="p">[</span><span class="n">run_fw_id</span><span class="p">],</span>
                       <span class="n">spec_document</span><span class="o">=</span><span class="n">spec_update</span><span class="p">)</span>
        <span class="n">spec_update</span><span class="p">[</span><span class="s1">&#39;_launch_dir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">control_dir</span>
        <span class="n">lp</span><span class="o">.</span><span class="n">update_spec</span><span class="p">(</span><span class="n">fw_ids</span><span class="o">=</span><span class="p">[</span><span class="n">control_fw_id</span><span class="p">],</span>
                       <span class="n">spec_document</span><span class="o">=</span><span class="n">spec_update</span><span class="p">)</span>

<div class="viewcode-block" id="SetupTask.additional_task_info"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.SetupTask.additional_task_info">[docs]</a>    <span class="k">def</span> <span class="nf">additional_task_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{}</span></div></div>


<div class="viewcode-block" id="RunTask"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.RunTask">[docs]</a><span class="k">class</span> <span class="nc">RunTask</span><span class="p">(</span><span class="n">SRCTaskMixin</span><span class="p">,</span> <span class="n">FireTaskBase</span><span class="p">):</span>

    <span class="n">src_type</span> <span class="o">=</span> <span class="s1">&#39;run&#39;</span>
    <span class="n">task_type</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">control_procedure</span><span class="p">,</span> <span class="n">task_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_control_procedure</span><span class="p">(</span><span class="n">control_procedure</span><span class="o">=</span><span class="n">control_procedure</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">task_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task_type</span> <span class="o">=</span> <span class="n">task_type</span>

<div class="viewcode-block" id="RunTask.set_control_procedure"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.RunTask.set_control_procedure">[docs]</a>    <span class="k">def</span> <span class="nf">set_control_procedure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">control_procedure</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control_procedure</span> <span class="o">=</span> <span class="n">control_procedure</span></div>
        <span class="c1">#TODO: check something here with the monitors ?</span>

<div class="viewcode-block" id="RunTask.run_task"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.RunTask.run_task">[docs]</a>    <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_directories</span><span class="p">(</span><span class="n">fw_spec</span><span class="o">=</span><span class="n">fw_spec</span><span class="p">,</span> <span class="n">create_dirs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">launch_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="c1"># Move to the run directory</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="p">,</span> <span class="s1">&#39;fw_info.txt&#39;</span><span class="p">),</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;FW launch_directory :</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">launch_dir</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1"># The Run and Control tasks have to run on the same worker</span>

        <span class="c1">#TODO: do something here with the monitoring controllers ...</span>
        <span class="c1">#      should stop the RunTask but the correction should be applied in control !</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">fw_spec</span><span class="o">=</span><span class="n">fw_spec</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">fw_spec</span><span class="o">=</span><span class="n">fw_spec</span><span class="p">)</span>
        <span class="n">update_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">postrun</span><span class="p">(</span><span class="n">fw_spec</span><span class="o">=</span><span class="n">fw_spec</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">update_spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">update_spec</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="s1">&#39;previous_fws&#39;</span> <span class="ow">in</span> <span class="n">fw_spec</span><span class="p">:</span>
            <span class="n">update_spec</span><span class="p">[</span><span class="s1">&#39;previous_fws&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="p">[</span><span class="s1">&#39;previous_fws&#39;</span><span class="p">]</span>

        <span class="c1">#TODO: the directory is passed thanks to _pass_job_info. Should we pass anything else ?</span>
        <span class="k">return</span> <span class="n">FWAction</span><span class="p">(</span><span class="n">stored_data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">update_spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mod_spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">additions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">detours</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">defuse_children</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="RunTask.config"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.RunTask.config">[docs]</a>    <span class="k">def</span> <span class="nf">config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="RunTask.run"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.RunTask.run">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="RunTask.postrun"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.RunTask.postrun">[docs]</a>    <span class="k">def</span> <span class="nf">postrun</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="RunTask.additional_task_info"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.RunTask.additional_task_info">[docs]</a>    <span class="k">def</span> <span class="nf">additional_task_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{}</span></div></div>


<div class="viewcode-block" id="ScriptRunTask"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.ScriptRunTask">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">ScriptRunTask</span><span class="p">(</span><span class="n">RunTask</span><span class="p">):</span>

    <span class="n">task_type</span> <span class="o">=</span> <span class="s1">&#39;script&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">script_str</span><span class="p">,</span> <span class="n">control_procedure</span><span class="p">):</span>
        <span class="n">RunTask</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">control_procedure</span><span class="o">=</span><span class="n">control_procedure</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">script_str</span> <span class="o">=</span> <span class="n">script_str</span>

<div class="viewcode-block" id="ScriptRunTask.run"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.ScriptRunTask.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;script_run.log&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">cmds_strs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">script_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cmd_str</span> <span class="ow">in</span> <span class="n">cmds_strs</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">Command</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">)</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">cmd</span><span class="o">.</span><span class="n">retcode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Command &quot;</span><span class="si">{}</span><span class="s1">&quot; returned exit code </span><span class="si">{:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cmd_str</span><span class="p">,</span> <span class="n">cmd</span><span class="o">.</span><span class="n">retcode</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">cmd</span><span class="o">.</span><span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">cmd</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cmd</span><span class="p">)))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    <span class="nd">@serialize_fw</span>
    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;script_str&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">script_str</span><span class="p">,</span>
                <span class="s1">&#39;control_procedure&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">control_procedure</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()}</span>

<div class="viewcode-block" id="ScriptRunTask.from_dict"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.ScriptRunTask.from_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="n">control_procedure</span> <span class="o">=</span> <span class="n">ControlProcedure</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;control_procedure&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">script_str</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;script_str&#39;</span><span class="p">],</span> <span class="n">control_procedure</span><span class="o">=</span><span class="n">control_procedure</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ControlTask"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.ControlTask">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">ControlTask</span><span class="p">(</span><span class="n">SRCTaskMixin</span><span class="p">,</span> <span class="n">FireTaskBase</span><span class="p">):</span>
    <span class="n">src_type</span> <span class="o">=</span> <span class="s1">&#39;control&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">control_procedure</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_restarts</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">src_cleaning</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control_procedure</span> <span class="o">=</span> <span class="n">control_procedure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span> <span class="o">=</span> <span class="n">manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_restarts</span> <span class="o">=</span> <span class="n">max_restarts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src_cleaning</span> <span class="o">=</span> <span class="n">src_cleaning</span>

<div class="viewcode-block" id="ControlTask.run_task"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.ControlTask.run_task">[docs]</a>    <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_directories</span><span class="p">(</span><span class="n">fw_spec</span><span class="o">=</span><span class="n">fw_spec</span><span class="p">,</span> <span class="n">create_dirs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">launch_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="c1"># Move to the control directory</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">control_dir</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">control_dir</span><span class="p">,</span> <span class="s1">&#39;fw_info.txt&#39;</span><span class="p">),</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;FW launch_directory :</span><span class="se">\n</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">launch_dir</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1"># Get the task index</span>
        <span class="n">task_index</span> <span class="o">=</span> <span class="n">SRCTaskIndex</span><span class="o">.</span><span class="n">from_any</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">[</span><span class="s1">&#39;SRC_task_index&#39;</span><span class="p">])</span>
        <span class="c1"># Get the setup and run fireworks</span>
        <span class="n">setup_and_run_fws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_setup_and_run_fw</span><span class="p">(</span><span class="n">fw_spec</span><span class="o">=</span><span class="n">fw_spec</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_fw</span> <span class="o">=</span> <span class="n">setup_and_run_fws</span><span class="p">[</span><span class="s1">&#39;setup_fw&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_fw</span> <span class="o">=</span> <span class="n">setup_and_run_fws</span><span class="p">[</span><span class="s1">&#39;run_fw&#39;</span><span class="p">]</span>

        <span class="c1"># Specify the type of the task that is controlled:</span>
        <span class="c1">#  - aborted : the task has been aborted due to a monitoring controller during the Run Task, the FW state</span>
        <span class="c1">#              is COMPLETED</span>
        <span class="c1">#  - completed : the task has completed, the FW state is COMPLETE</span>
        <span class="c1">#  - failed : the task has failed, the FW state is FIZZLED</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_fw</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;COMPLETED&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;src_run_task_aborted&#39;</span> <span class="ow">in</span> <span class="n">fw_spec</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">control_procedure</span><span class="o">.</span><span class="n">set_controlled_item_type</span><span class="p">(</span><span class="n">ControlledItemType</span><span class="o">.</span><span class="n">task_aborted</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">control_procedure</span><span class="o">.</span><span class="n">set_controlled_item_type</span><span class="p">(</span><span class="n">ControlledItemType</span><span class="o">.</span><span class="n">task_completed</span><span class="p">())</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_fw</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;FIZZLED&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control_procedure</span><span class="o">.</span><span class="n">set_controlled_item_type</span><span class="p">(</span><span class="n">ControlledItemType</span><span class="o">.</span><span class="n">task_failed</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;The state of the Run Firework is &quot;</span><span class="si">{}</span><span class="s1">&quot; &#39;</span>
                               <span class="s1">&#39;while it should be COMPLETED or FIZZLED&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_fw</span><span class="o">.</span><span class="n">state</span><span class="p">))</span>

        <span class="c1"># Get the keyword_arguments to be passed to the process method of the control_procedure</span>
        <span class="c1">#TODO: how to do that kind of automatically ??</span>
        <span class="c1"># each key should have : how to get it from the run_fw/(setup_fw)</span>
        <span class="c1">#                        how to force/apply it to the next SRC (e.g. how do we say to setup that)</span>
        <span class="c1"># Actually, the object, can come from : the setup_fw or from the run_fw (from the setup_spec, from the run_spec,</span>
        <span class="c1"># from the setup_task or the run_task (or in general one of the tasks ...</span>
        <span class="c1"># even multiple tasks is not yet supported ... should it be ? or should we stay with only one task allways ?)</span>
        <span class="c1"># If it is modified, it should update the corresponding bit (setup_spec and/or run_spec and/or</span>
        <span class="c1"># setup_task and/or run_task)</span>
        <span class="n">initial_objects_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_initial_objects_info</span><span class="p">(</span><span class="n">setup_fw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">setup_fw</span><span class="p">,</span> <span class="n">run_fw</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run_fw</span><span class="p">,</span>
                                                             <span class="n">src_directories</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">src_directories</span><span class="p">)</span>
        <span class="n">qerr_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_fw</span><span class="o">.</span><span class="n">launches</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">launch_dir</span><span class="p">,</span> <span class="s1">&#39;queue.qerr&#39;</span><span class="p">)</span>
        <span class="n">qout_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_fw</span><span class="o">.</span><span class="n">launches</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">launch_dir</span><span class="p">,</span> <span class="s1">&#39;queue.qout&#39;</span><span class="p">)</span>
        <span class="n">initial_objects_info</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;queue_adapter&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;object&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_fw</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;qtk_queueadapter&#39;</span><span class="p">],</span>
                                                       <span class="s1">&#39;updates&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="s1">&#39;fw_spec&#39;</span><span class="p">,</span>
                                                                    <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s1">&#39;qtk_queueadapter&#39;</span><span class="p">},</span>
                                                                   <span class="p">{</span><span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="s1">&#39;fw_spec&#39;</span><span class="p">,</span>
                                                                    <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="s1">&#39;_queueadapter&#39;</span><span class="p">,</span>
                                                                    <span class="s1">&#39;mod&#39;</span><span class="p">:</span> <span class="s1">&#39;get_subs_dict&#39;</span><span class="p">}]},</span>
                                     <span class="s1">&#39;qerr_filepath&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;object&#39;</span><span class="p">:</span> <span class="n">qerr_filepath</span><span class="p">},</span>
                                     <span class="s1">&#39;qout_filepath&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;object&#39;</span><span class="p">:</span> <span class="n">qout_filepath</span><span class="p">}})</span>
        <span class="n">initial_objects</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">obj_info</span><span class="p">[</span><span class="s1">&#39;object&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj_info</span> <span class="ow">in</span> <span class="n">initial_objects_info</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">control_report</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">control_procedure</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="o">**</span><span class="n">initial_objects</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">control_report</span><span class="o">.</span><span class="n">unrecoverable</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">control_dir</span><span class="p">,</span> <span class="s1">&#39;control_report.json&#39;</span><span class="p">),</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">control_report</span><span class="o">.</span><span class="n">as_dict</span><span class="p">(),</span> <span class="n">f</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="c1">#TODO: apply the cleaning here</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_cleaning</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Errors are unrecoverable. Control report written in &quot;control_report.json&quot;&#39;</span><span class="p">)</span>

        <span class="c1"># If everything is ok, update the spec of the children</span>
        <span class="k">if</span> <span class="n">control_report</span><span class="o">.</span><span class="n">finalized</span><span class="p">:</span>
            <span class="n">stored_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;control_report&#39;</span><span class="p">:</span> <span class="n">control_report</span><span class="p">,</span> <span class="s1">&#39;finalized&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>
            <span class="n">update_spec</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">mod_spec</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">run_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">setup_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">task_type</span> <span class="o">=</span> <span class="n">run_task</span><span class="o">.</span><span class="n">task_type</span>
            <span class="c1">#TODO: should we also add here the cluster in which the calculation was performed so that if the next</span>
            <span class="c1">#      SRC trio starts on another cluster, it should fetch the needed files from the run_dir of this cluster</span>
            <span class="n">task_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dir&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="p">}</span>
            <span class="n">task_info</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">run_task</span><span class="o">.</span><span class="n">additional_task_info</span><span class="p">())</span>
            <span class="n">task_info</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">setup_task</span><span class="o">.</span><span class="n">additional_task_info</span><span class="p">())</span>
            <span class="n">mod_spec</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;_push&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;previous_fws-&gt;&#39;</span><span class="o">+</span><span class="n">task_type</span><span class="p">:</span> <span class="n">task_info</span><span class="p">}})</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_cleaning</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">return</span> <span class="n">FWAction</span><span class="p">(</span><span class="n">stored_data</span><span class="o">=</span><span class="n">stored_data</span><span class="p">,</span> <span class="n">exit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">update_spec</span><span class="o">=</span><span class="n">update_spec</span><span class="p">,</span> <span class="n">mod_spec</span><span class="o">=</span><span class="n">mod_spec</span><span class="p">,</span>
                            <span class="n">additions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">detours</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">defuse_children</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Check the maximum number of restarts</span>
        <span class="k">if</span> <span class="n">task_index</span><span class="o">.</span><span class="n">index</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_restarts</span><span class="p">:</span>
            <span class="c1"># TODO: decide when to apply cleaning here ?</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_cleaning</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Maximum number of restarts (</span><span class="si">{:d}</span><span class="s1">) reached&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_restarts</span><span class="p">))</span>

        <span class="c1"># Increase the task_index</span>
        <span class="n">task_index</span><span class="o">.</span><span class="n">increase_index</span><span class="p">()</span>

        <span class="c1"># Apply the actions on the objects to get the modified objects (to be passed to SetupTask)</span>
        <span class="c1"># modified_objects = {}</span>
        <span class="c1"># for target, action in control_report.actions.items():</span>
        <span class="c1">#     # Special case right now for the queue adapter ...</span>
        <span class="c1">#     if target == &#39;queue_adapter&#39;:</span>
        <span class="c1">#         qtk_qadapter = initial_objects[target]</span>
        <span class="c1">#         action.apply(qtk_qadapter)</span>
        <span class="c1">#         modified_objects[&#39;qtk_queueadapter&#39;] = qtk_qadapter</span>
        <span class="c1">#         modified_objects[&#39;_queueadapter&#39;] = qtk_qadapter.get_subs_dict()</span>
        <span class="c1">#     else:</span>
        <span class="c1">#         modified_objects[target] = action.apply(initial_objects[target])</span>

        <span class="c1"># New spec</span>
        <span class="c1"># remove &quot;_tasks&quot; which is present in spec for recent fireworks versions. Remove it here to avoid</span>
        <span class="c1"># problems with deepcopy.</span>
        <span class="n">new_spec</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_fw</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">new_spec</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;_tasks&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">new_spec</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">new_spec</span><span class="p">)</span>

        <span class="c1"># New tasks</span>
        <span class="n">setup_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">setup_fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">run_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">control_task</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="k">if</span> <span class="s1">&#39;src_modified_objects&#39;</span> <span class="ow">in</span> <span class="n">fw_spec</span><span class="p">:</span>
            <span class="n">modified_objects</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="p">[</span><span class="s1">&#39;src_modified_objects&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">modified_objects</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">setup_spec_update</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">run_spec_update</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">target</span><span class="p">,</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">control_report</span><span class="o">.</span><span class="n">actions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">target_object</span> <span class="o">=</span> <span class="n">initial_objects</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>
            <span class="n">action</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">target_object</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">target</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">initial_objects_info</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Object &quot;</span><span class="si">{}</span><span class="s1">&quot; to be modified was not in the initial_objects&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
            <span class="k">if</span> <span class="s1">&#39;updates&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">initial_objects_info</span><span class="p">[</span><span class="n">target</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Update information not present for object &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">update</span> <span class="ow">in</span> <span class="n">initial_objects_info</span><span class="p">[</span><span class="n">target</span><span class="p">][</span><span class="s1">&#39;updates&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">update</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fw_spec&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;mod&#39;</span> <span class="ow">in</span> <span class="n">update</span><span class="p">:</span>
                        <span class="n">mod</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">target_object</span><span class="p">,</span> <span class="n">update</span><span class="p">[</span><span class="s1">&#39;mod&#39;</span><span class="p">])()</span>
                        <span class="n">new_spec</span><span class="p">[</span><span class="n">update</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">mod</span>
                        <span class="n">modified_objects</span><span class="p">[</span><span class="n">update</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">mod</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">new_spec</span><span class="p">[</span><span class="n">update</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">target_object</span>
                        <span class="n">modified_objects</span><span class="p">[</span><span class="n">update</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">target_object</span>
                <span class="k">elif</span> <span class="n">update</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;setup_fw_spec&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;mod&#39;</span> <span class="ow">in</span> <span class="n">update</span><span class="p">:</span>
                        <span class="n">mod</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">target_object</span><span class="p">,</span> <span class="n">update</span><span class="p">[</span><span class="s1">&#39;mod&#39;</span><span class="p">])()</span>
                        <span class="n">setup_spec_update</span><span class="p">[</span><span class="n">update</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">mod</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">setup_spec_update</span><span class="p">[</span><span class="n">update</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">target_object</span>
                <span class="k">elif</span> <span class="n">update</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;run_fw_spec&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s1">&#39;mod&#39;</span> <span class="ow">in</span> <span class="n">update</span><span class="p">:</span>
                        <span class="n">mod</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">target_object</span><span class="p">,</span> <span class="n">update</span><span class="p">[</span><span class="s1">&#39;mod&#39;</span><span class="p">])()</span>
                        <span class="n">run_spec_update</span><span class="p">[</span><span class="n">update</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">mod</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">run_spec_update</span><span class="p">[</span><span class="n">update</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">target_object</span>
                <span class="k">elif</span> <span class="n">update</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;setup_task&#39;</span><span class="p">,</span> <span class="s1">&#39;run_task&#39;</span><span class="p">]:</span>
                    <span class="n">task</span> <span class="o">=</span> <span class="n">setup_task</span> <span class="k">if</span> <span class="n">update</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;setup_task&#39;</span> <span class="k">else</span> <span class="n">run_task</span>
                    <span class="n">attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">update</span><span class="p">[</span><span class="s1">&#39;attribute&#39;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="s1">&#39;mod&#39;</span> <span class="ow">in</span> <span class="n">update</span><span class="p">:</span>
                        <span class="n">mod</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">target_object</span><span class="p">,</span> <span class="n">update</span><span class="p">[</span><span class="s1">&#39;mod&#39;</span><span class="p">])()</span>
                        <span class="n">attr</span> <span class="o">=</span> <span class="n">mod</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">attr</span> <span class="o">=</span> <span class="n">target_object</span>
                <span class="k">elif</span> <span class="s1">&#39;setup_task&#39;</span> <span class="ow">in</span> <span class="n">update</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]:</span>
                    <span class="n">sp</span> <span class="o">=</span> <span class="n">update</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;target is &quot;</span><span class="si">{}</span><span class="s1">&quot; and contains more than 1 &quot;.&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">update</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">]))</span>
                    <span class="k">if</span> <span class="n">sp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;setup_task&#39;</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;target does not start with &quot;setup_task&quot; ...&#39;</span><span class="p">)</span>
                    <span class="n">task</span> <span class="o">=</span> <span class="n">setup_task</span>
                    <span class="n">task_attribute</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">sp</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">if</span> <span class="s1">&#39;attribute&#39;</span> <span class="ow">in</span> <span class="n">update</span><span class="p">:</span>
                        <span class="n">attr</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">task_attribute</span><span class="p">,</span> <span class="n">update</span><span class="p">[</span><span class="s1">&#39;attribute&#39;</span><span class="p">])</span>
                        <span class="k">if</span> <span class="s1">&#39;mod&#39;</span> <span class="ow">in</span> <span class="n">update</span><span class="p">:</span>
                            <span class="n">mod</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">target_object</span><span class="p">,</span> <span class="n">update</span><span class="p">[</span><span class="s1">&#39;mod&#39;</span><span class="p">])()</span>
                            <span class="n">attr</span> <span class="o">=</span> <span class="n">mod</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">attr</span> <span class="o">=</span> <span class="n">target_object</span>
                    <span class="k">elif</span> <span class="s1">&#39;setter&#39;</span> <span class="ow">in</span> <span class="n">update</span><span class="p">:</span>
                        <span class="n">setter</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">task_attribute</span><span class="p">,</span> <span class="n">update</span><span class="p">[</span><span class="s1">&#39;setter&#39;</span><span class="p">])</span>
                        <span class="k">if</span> <span class="s1">&#39;mod&#39;</span> <span class="ow">in</span> <span class="n">update</span><span class="p">:</span>
                            <span class="n">mod</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">target_object</span><span class="p">,</span> <span class="n">update</span><span class="p">[</span><span class="s1">&#39;mod&#39;</span><span class="p">])()</span>
                            <span class="n">setter</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">setter</span><span class="p">(</span><span class="n">target_object</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Only changes to fw_spec, setup_task and run_task are allowed right now ...&#39;</span><span class="p">)</span>

        <span class="c1"># Set the restart_info</span>
        <span class="n">setup_task</span><span class="o">.</span><span class="n">set_restart_info</span><span class="p">(</span><span class="n">control_report</span><span class="o">.</span><span class="n">restart_info</span><span class="p">)</span>

        <span class="c1"># Pass the modified objects to the next SetupTask</span>
        <span class="n">new_spec</span><span class="p">[</span><span class="s1">&#39;src_modified_objects&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">modified_objects</span>
        <span class="n">new_spec</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;_launch_dir&#39;</span><span class="p">)</span>
        <span class="n">new_spec</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;src_directories&#39;</span><span class="p">)</span>
        <span class="n">new_spec</span><span class="p">[</span><span class="s1">&#39;previous_src&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;src_directories&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_directories</span><span class="p">}</span>
        <span class="k">if</span> <span class="s1">&#39;all_src_directories&#39;</span> <span class="ow">in</span> <span class="n">new_spec</span><span class="p">:</span>
            <span class="n">new_spec</span><span class="p">[</span><span class="s1">&#39;all_src_directories&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;src_directories&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_directories</span><span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_spec</span><span class="p">[</span><span class="s1">&#39;all_src_directories&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;src_directories&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_directories</span><span class="p">}]</span>
        <span class="c1"># if &#39;_queueadapter&#39; in modified_objects:</span>
        <span class="c1">#     new_spec[&#39;_queueadapter&#39;] = modified_objects[&#39;_queueadapter&#39;]</span>
        <span class="c1">#TODO: what to do here ? Right now this should work, just transfer information from the run_fw to the</span>
        <span class="c1"># next SRC group</span>
        <span class="k">if</span> <span class="s1">&#39;previous_fws&#39;</span> <span class="ow">in</span> <span class="n">fw_spec</span><span class="p">:</span>
            <span class="n">new_spec</span><span class="p">[</span><span class="s1">&#39;previous_fws&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="p">[</span><span class="s1">&#39;previous_fws&#39;</span><span class="p">]</span>
        <span class="c1"># Create the new SRC trio</span>
        <span class="c1"># TODO: check initialization info, deps, ... previous_fws, ... src_previous_fws ? ...</span>
        <span class="n">new_SRC_fws</span> <span class="o">=</span> <span class="n">createSRCFireworks</span><span class="p">(</span><span class="n">setup_task</span><span class="o">=</span><span class="n">setup_task</span><span class="p">,</span> <span class="n">run_task</span><span class="o">=</span><span class="n">run_task</span><span class="p">,</span> <span class="n">control_task</span><span class="o">=</span><span class="n">control_task</span><span class="p">,</span>
                                         <span class="n">spec</span><span class="o">=</span><span class="n">new_spec</span><span class="p">,</span> <span class="n">initialization_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">task_index</span><span class="o">=</span><span class="n">task_index</span><span class="p">,</span>
                                         <span class="n">run_spec_update</span><span class="o">=</span><span class="n">run_spec_update</span><span class="p">,</span> <span class="n">setup_spec_update</span><span class="o">=</span><span class="n">setup_spec_update</span><span class="p">)</span>
        <span class="n">wf</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">fireworks</span><span class="o">=</span><span class="n">new_SRC_fws</span><span class="p">[</span><span class="s1">&#39;fws&#39;</span><span class="p">],</span> <span class="n">links_dict</span><span class="o">=</span><span class="n">new_SRC_fws</span><span class="p">[</span><span class="s1">&#39;links_dict&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">FWAction</span><span class="p">(</span><span class="n">stored_data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;control_report&#39;</span><span class="p">:</span> <span class="n">control_report</span><span class="p">},</span> <span class="n">detours</span><span class="o">=</span><span class="p">[</span><span class="n">wf</span><span class="p">])</span></div>

<div class="viewcode-block" id="ControlTask.get_setup_and_run_fw"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.ControlTask.get_setup_and_run_fw">[docs]</a>    <span class="k">def</span> <span class="nf">get_setup_and_run_fw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="c1"># Get the launchpad</span>
        <span class="k">if</span> <span class="s1">&#39;_add_launchpad_and_fw_id&#39;</span> <span class="ow">in</span> <span class="n">fw_spec</span><span class="p">:</span>
            <span class="n">lp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">launchpad</span>
            <span class="n">control_fw_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fw_id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fw_dict</span> <span class="o">=</span> <span class="n">loadfn</span><span class="p">(</span><span class="s1">&#39;FW.json&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fw_dict</span> <span class="o">=</span> <span class="n">loadfn</span><span class="p">(</span><span class="s1">&#39;FW.yaml&#39;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Launchpad/fw_id not present in spec and No FW.json nor FW.yaml file present: &quot;</span>
                                       <span class="s2">&quot;impossible to determine fw_id&quot;</span><span class="p">)</span>
            <span class="n">lp</span> <span class="o">=</span> <span class="n">LaunchPad</span><span class="o">.</span><span class="n">auto_load</span><span class="p">()</span>
            <span class="n">control_fw_id</span> <span class="o">=</span> <span class="n">fw_dict</span><span class="p">[</span><span class="s1">&#39;fw_id&#39;</span><span class="p">]</span>
        <span class="c1"># Check that this ControlTask has only one parent firework</span>
        <span class="n">this_lzy_wf</span> <span class="o">=</span> <span class="n">lp</span><span class="o">.</span><span class="n">get_wf_by_fw_id_lzyfw</span><span class="p">(</span><span class="n">control_fw_id</span><span class="p">)</span>
        <span class="n">parents_fw_ids</span> <span class="o">=</span> <span class="n">this_lzy_wf</span><span class="o">.</span><span class="n">links</span><span class="o">.</span><span class="n">parent_links</span><span class="p">[</span><span class="n">control_fw_id</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parents_fw_ids</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ControlTask</span><span class="se">\&#39;</span><span class="s1">s Firework should have exactly one parent firework&#39;</span><span class="p">)</span>
        <span class="n">run_fw_id</span> <span class="o">=</span> <span class="n">parents_fw_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># Get the Run Firework and its state</span>
        <span class="n">run_fw</span> <span class="o">=</span> <span class="n">lp</span><span class="o">.</span><span class="n">get_fw_by_id</span><span class="p">(</span><span class="n">fw_id</span><span class="o">=</span><span class="n">run_fw_id</span><span class="p">)</span>
        <span class="n">run_is_fizzled</span> <span class="o">=</span> <span class="s1">&#39;_fizzled_parents&#39;</span> <span class="ow">in</span> <span class="n">fw_spec</span>
        <span class="k">if</span> <span class="n">run_is_fizzled</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">run_fw</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;FIZZLED&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ControlTask has &quot;_fizzled_parents&quot; key but parent Run firework is not fizzled ...&#39;</span><span class="p">)</span>
        <span class="n">run_is_completed</span> <span class="o">=</span> <span class="n">run_fw</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;COMPLETED&#39;</span>
        <span class="k">if</span> <span class="n">run_is_completed</span> <span class="ow">and</span> <span class="n">run_is_fizzled</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Run firework is FIZZLED and COMPLETED ...&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">run_is_completed</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">run_is_fizzled</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Run firework is neither FIZZLED nor COMPLETED ...&#39;</span><span class="p">)</span>
        <span class="c1"># Get the Setup Firework</span>
        <span class="n">setup_job_info</span> <span class="o">=</span> <span class="n">run_fw</span><span class="o">.</span><span class="n">spec</span><span class="p">[</span><span class="s1">&#39;_job_info&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">setup_fw_id</span> <span class="o">=</span> <span class="n">setup_job_info</span><span class="p">[</span><span class="s1">&#39;fw_id&#39;</span><span class="p">]</span>
        <span class="n">setup_fw</span> <span class="o">=</span> <span class="n">lp</span><span class="o">.</span><span class="n">get_fw_by_id</span><span class="p">(</span><span class="n">fw_id</span><span class="o">=</span><span class="n">setup_fw_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;setup_fw&#39;</span><span class="p">:</span> <span class="n">setup_fw</span><span class="p">,</span> <span class="s1">&#39;run_fw&#39;</span><span class="p">:</span> <span class="n">run_fw</span><span class="p">}</span></div>

<div class="viewcode-block" id="ControlTask.get_initial_objects_info"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.ControlTask.get_initial_objects_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_initial_objects_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">setup_fw</span><span class="p">,</span> <span class="n">run_fw</span><span class="p">,</span> <span class="n">src_directories</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="ControlTask.from_controllers"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.ControlTask.from_controllers">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_controllers</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">controllers</span><span class="p">,</span> <span class="n">max_restarts</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">cp</span> <span class="o">=</span> <span class="n">ControlProcedure</span><span class="p">(</span><span class="n">controllers</span><span class="o">=</span><span class="n">controllers</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">control_procedure</span><span class="o">=</span><span class="n">cp</span><span class="p">,</span> <span class="n">max_restarts</span><span class="o">=</span><span class="n">max_restarts</span><span class="p">)</span></div>

    <span class="nd">@serialize_fw</span>
    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;control_procedure&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">control_procedure</span><span class="o">.</span><span class="n">as_dict</span><span class="p">(),</span>
                <span class="s1">&#39;manager&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;max_restarts&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_restarts</span><span class="p">,</span>
                <span class="s1">&#39;src_cleaning&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_cleaning</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_cleaning</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">}</span>

<div class="viewcode-block" id="ControlTask.from_dict"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.ControlTask.from_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="n">control_procedure</span> <span class="o">=</span> <span class="n">ControlProcedure</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;control_procedure&#39;</span><span class="p">])</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="n">MontyDecoder</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;manager&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">manager</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">manager</span> <span class="o">=</span> <span class="n">dec</span><span class="o">.</span><span class="n">process_decoded</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;manager&#39;</span><span class="p">]),</span>
        <span class="k">if</span> <span class="s1">&#39;src_cleaning&#39;</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
            <span class="n">src_cleaning</span> <span class="o">=</span> <span class="n">SRCCleaning</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;src_cleaning&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;src_cleaning&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">src_cleaning</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">control_procedure</span><span class="o">=</span><span class="n">control_procedure</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">,</span> <span class="n">max_restarts</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;max_restarts&#39;</span><span class="p">],</span>
                   <span class="n">src_cleaning</span><span class="o">=</span><span class="n">src_cleaning</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="SRCCleanerOptions"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.SRCCleanerOptions">[docs]</a><span class="k">class</span> <span class="nc">SRCCleanerOptions</span><span class="p">(</span><span class="n">MSONable</span><span class="p">):</span>

    <span class="n">WHEN_TO_CLEAN</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;EACH_STEP&#39;</span><span class="p">,</span> <span class="s1">&#39;LAST_STEP&#39;</span><span class="p">,</span> <span class="s1">&#39;EACH_STEP_EXCEPT_LAST&#39;</span><span class="p">]</span>
    <span class="n">CURRENT_SRC_STATES_ALLOWED</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RECOVERABLE&#39;</span><span class="p">,</span> <span class="s1">&#39;UNRECOVERABLE&#39;</span><span class="p">,</span> <span class="s1">&#39;MAXRESTARTS&#39;</span><span class="p">,</span> <span class="s1">&#39;FINALIZED&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">when_to_clean</span><span class="p">,</span> <span class="n">current_src_states_allowed</span><span class="p">,</span> <span class="n">which_src_steps_to_clean</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">when_to_clean</span> <span class="o">=</span> <span class="n">when_to_clean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_src_states_allowed</span> <span class="o">=</span> <span class="n">current_src_states_allowed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">which_src_steps_to_clean</span> <span class="o">=</span> <span class="n">which_src_steps_to_clean</span>

<div class="viewcode-block" id="SRCCleanerOptions.clean_all"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.SRCCleanerOptions.clean_all">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">clean_all</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">when_to_clean</span><span class="o">=</span><span class="s1">&#39;EACH_STEP&#39;</span><span class="p">,</span> <span class="n">current_src_states_allowed</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">CURRENT_SRC_STATES_ALLOWED</span><span class="p">,</span>
                   <span class="n">which_src_steps_to_clean</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SRCCleanerOptions.clean_all_except_last"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.SRCCleanerOptions.clean_all_except_last">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">clean_all_except_last</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">when_to_clean</span><span class="o">=</span><span class="s1">&#39;EACH_STEP&#39;</span><span class="p">,</span> <span class="n">current_src_states_allowed</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="n">CURRENT_SRC_STATES_ALLOWED</span><span class="p">,</span>
                   <span class="n">which_src_steps_to_clean</span><span class="o">=</span><span class="s1">&#39;all_before_this_one&#39;</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">when_to_clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_when_to_clean</span>

    <span class="nd">@when_to_clean</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">when_to_clean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">when_to_clean</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">when_to_clean</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">WHEN_TO_CLEAN</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Argument &quot;when_to_clean&quot; is &quot;</span><span class="si">{}</span><span class="s1">&quot; while it should be one of the following : &#39;</span>
                             <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">when_to_clean</span><span class="p">,</span>
                                         <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">WHEN_TO_CLEAN</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_when_to_clean</span> <span class="o">=</span> <span class="n">when_to_clean</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">current_src_states_allowed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_src_states_allowed</span>

    <span class="nd">@current_src_states_allowed</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">current_src_states_allowed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">current_src_states_allowed</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">current_src_state_allowed</span> <span class="ow">in</span> <span class="n">current_src_states_allowed</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">current_src_state_allowed</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">CURRENT_SRC_STATES_ALLOWED</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;One of the items in  &quot;current_src_states_allowed&quot; is &quot;</span><span class="si">{}</span><span class="s1">&quot; while it should be one of &#39;</span>
                                 <span class="s1">&#39;the following : </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">current_src_state_allowed</span><span class="p">,</span>
                                                             <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CURRENT_SRC_STATES_ALLOWED</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_current_src_states_allowed</span> <span class="o">=</span> <span class="n">current_src_states_allowed</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">which_src_steps_to_clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_which_src_steps_to_clean</span>

    <span class="nd">@which_src_steps_to_clean</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">which_src_steps_to_clean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">which_src_steps_to_clean</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">which_src_steps_to_clean</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;this_one&#39;</span><span class="p">,</span> <span class="s1">&#39;all_before_this_one&#39;</span><span class="p">,</span> <span class="s1">&#39;all_before_the_previous_one&#39;</span><span class="p">,</span>
                                        <span class="s1">&#39;the_one_before_this_one&#39;</span><span class="p">,</span> <span class="s1">&#39;the_one_before_the_previous_one&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_which_src_steps_to_clean</span> <span class="o">=</span> <span class="n">which_src_steps_to_clean</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_which_src_steps_to_clean_pattern</span> <span class="o">=</span> <span class="n">which_src_steps_to_clean</span>
        <span class="k">elif</span> <span class="n">which_src_steps_to_clean</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;single_&#39;</span><span class="p">:</span>
            <span class="n">sp</span> <span class="o">=</span> <span class="n">which_src_steps_to_clean</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Argument &quot;which_src_steps_to_clean&quot; is &quot;</span><span class="si">{}</span><span class="s1">&quot;. It starts with &quot;single_&quot; but has more &#39;</span>
                                 <span class="s1">&#39;than one underscore ... &#39;</span>
                                 <span class="s1">&#39;Impossible to identify the step to clean.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">which_src_steps_to_clean</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">istep</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sp</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Argument &quot;which_src_steps_to_clean&quot; is &quot;</span><span class="si">{}</span><span class="s1">&quot;. It starts with &quot;single_&quot; but the &#39;</span>
                                 <span class="s1">&#39;remaining part is not an integer ... &#39;</span>
                                 <span class="s1">&#39;Impossible to identify the step to clean.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">which_src_steps_to_clean</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">istep</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Argument &quot;which_src_steps_to_clean&quot; is &quot;</span><span class="si">{}</span><span class="s1">&quot;. It starts with &quot;single_&quot; but the &#39;</span>
                                 <span class="s1">&#39;remaining part is an integer &lt; 1 ... &#39;</span>
                                 <span class="s1">&#39;Impossible to identify the step to clean.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">which_src_steps_to_clean</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_which_src_steps_to_clean</span> <span class="o">=</span> <span class="n">which_src_steps_to_clean</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_which_src_steps_to_clean_pattern</span> <span class="o">=</span> <span class="s1">&#39;single_N&#39;</span>
        <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">which_src_steps_to_clean</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">29</span> <span class="ow">and</span> <span class="n">which_src_steps_to_clean</span><span class="p">[:</span><span class="mi">15</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;all_before_the_&#39;</span> <span class="ow">and</span>
              <span class="n">which_src_steps_to_clean</span><span class="p">[</span><span class="o">-</span><span class="mi">14</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;_previous_ones&#39;</span><span class="p">):</span>
            <span class="n">sp</span> <span class="o">=</span> <span class="n">which_src_steps_to_clean</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Argument &quot;which_src_steps_to_clean&quot; is &quot;</span><span class="si">{}</span><span class="s1">&quot;. It starts with &quot;all_before_the_&quot;, &#39;</span>
                                 <span class="s1">&#39;ends with &quot;_previous_ones&quot; but has more than 5 underscores ... Impossible to &#39;</span>
                                 <span class="s1">&#39;identify the steps to clean.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">which_src_steps_to_clean</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">istep</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sp</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Argument &quot;which_src_steps_to_clean&quot; is &quot;</span><span class="si">{}</span><span class="s1">&quot;. It starts with &quot;all_before_the_&quot;, &#39;</span>
                                 <span class="s1">&#39;ends with &quot;_previous_ones&quot; but the remaining part is not an integer ... &#39;</span>
                                 <span class="s1">&#39;Impossible to identify the steps to clean.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">which_src_steps_to_clean</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">istep</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Argument &quot;which_src_steps_to_clean&quot; is &quot;</span><span class="si">{}</span><span class="s1">&quot;. It starts with &quot;all_before_the_&quot;, &#39;</span>
                                 <span class="s1">&#39;ends with &quot;_previous_ones&quot; but the remaining part an integer less than 2 ... &#39;</span>
                                 <span class="s1">&#39;Impossible to identify the steps to clean.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">which_src_steps_to_clean</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_which_src_steps_to_clean</span> <span class="o">=</span> <span class="n">which_src_steps_to_clean</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_which_src_steps_to_clean_pattern</span> <span class="o">=</span> <span class="s1">&#39;all_before_the_N_previous_ones&#39;</span>
        <span class="k">elif</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">which_src_steps_to_clean</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">33</span> <span class="ow">and</span> <span class="n">which_src_steps_to_clean</span><span class="p">[:</span><span class="mi">19</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;the_one_before_the_&#39;</span> <span class="ow">and</span>
              <span class="n">which_src_steps_to_clean</span><span class="p">[</span><span class="o">-</span><span class="mi">14</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;_previous_ones&#39;</span><span class="p">):</span>
            <span class="n">sp</span> <span class="o">=</span> <span class="n">which_src_steps_to_clean</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">7</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Argument &quot;which_src_steps_to_clean&quot; is &quot;</span><span class="si">{}</span><span class="s1">&quot;. It starts with &quot;the_one_before_the_&quot;, &#39;</span>
                                 <span class="s1">&#39;ends with &quot;_previous_ones&quot; but has more than 6 underscores ... Impossible to &#39;</span>
                                 <span class="s1">&#39;identify the steps to clean.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">which_src_steps_to_clean</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">istep</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sp</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Argument &quot;which_src_steps_to_clean&quot; is &quot;</span><span class="si">{}</span><span class="s1">&quot;. It starts with &quot;the_one_before_the_&quot;, &#39;</span>
                                 <span class="s1">&#39;ends with &quot;_previous_ones&quot; but the remaining part is not an integer ... &#39;</span>
                                 <span class="s1">&#39;Impossible to identify the steps to clean.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">which_src_steps_to_clean</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">istep</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Argument &quot;which_src_steps_to_clean&quot; is &quot;</span><span class="si">{}</span><span class="s1">&quot;. It starts with &quot;the_one_before_the_&quot;, &#39;</span>
                                 <span class="s1">&#39;ends with &quot;_previous_ones&quot; but the remaining part an integer less than 2 ... &#39;</span>
                                 <span class="s1">&#39;Impossible to identify the steps to clean.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">which_src_steps_to_clean</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_which_src_steps_to_clean</span> <span class="o">=</span> <span class="n">which_src_steps_to_clean</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_which_src_steps_to_clean_pattern</span> <span class="o">=</span> <span class="s1">&#39;the_one_before_the_N_previous_ones&#39;</span>
        <span class="c1">#TODO: implement &quot;the_M_before_the_N_previous_ones&quot; if needed ...</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Argument &quot;which_src_steps_to_clean&quot; is &quot;</span><span class="si">{}</span><span class="s1">&quot;. This is not allowed. See documentation for &#39;</span>
                             <span class="s1">&#39;the allowed options.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">which_src_steps_to_clean</span><span class="p">))</span>

<div class="viewcode-block" id="SRCCleanerOptions.steps_to_clean"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.SRCCleanerOptions.steps_to_clean">[docs]</a>    <span class="k">def</span> <span class="nf">steps_to_clean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">this_step_index</span><span class="p">,</span> <span class="n">this_step_state</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">this_step_state</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_src_states_allowed</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_which_src_steps_to_clean_pattern</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">this_step_index</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_which_src_steps_to_clean_pattern</span> <span class="o">==</span> <span class="s1">&#39;this_one&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">this_step_index</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_which_src_steps_to_clean_pattern</span> <span class="o">==</span> <span class="s1">&#39;the_one_before_this_one&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">this_step_index</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[]</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">this_step_index</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_which_src_steps_to_clean_pattern</span> <span class="o">==</span> <span class="s1">&#39;the_one_before_the_previous_one&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">this_step_index</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[]</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">this_step_index</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_which_src_steps_to_clean_pattern</span> <span class="o">==</span> <span class="s1">&#39;the_one_before_the_N_previous_ones&#39;</span><span class="p">:</span>
            <span class="n">iprev</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">which_src_steps_to_clean</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">istep</span> <span class="o">=</span> <span class="n">this_step_index</span><span class="o">-</span><span class="n">iprev</span><span class="o">-</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">istep</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[]</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">istep</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_which_src_steps_to_clean_pattern</span> <span class="o">==</span> <span class="s1">&#39;all_before_this_one&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">this_step_index</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_which_src_steps_to_clean_pattern</span> <span class="o">==</span> <span class="s1">&#39;all_before_the_previous_one&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">this_step_index</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_which_src_steps_to_clean_pattern</span> <span class="o">==</span> <span class="s1">&#39;all_before_the_N_previous_ones&#39;</span><span class="p">:</span>
            <span class="n">iprev</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">which_src_steps_to_clean</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">3</span><span class="p">])</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">this_step_index</span><span class="o">-</span><span class="n">iprev</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_which_src_steps_to_clean_pattern</span> <span class="o">==</span> <span class="s1">&#39;single_N&#39;</span><span class="p">:</span>
            <span class="n">istep</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">which_src_steps_to_clean</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">istep</span> <span class="o">&gt;</span> <span class="n">this_step_index</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[]</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">istep</span><span class="p">]</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Should not reach this point in &quot;steps_to_clean&quot; of &quot;SRCCleanerOptions&quot;&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SRCCleanerOptions.as_dict"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.SRCCleanerOptions.as_dict">[docs]</a>    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;@class&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="s1">&#39;@module&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
                <span class="s1">&#39;when_to_clean&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">when_to_clean</span><span class="p">,</span>
                <span class="s1">&#39;current_src_states_allowed&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_src_states_allowed</span><span class="p">,</span>
                <span class="s1">&#39;which_src_steps_to_clean&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">which_src_steps_to_clean</span><span class="p">}</span></div>

<div class="viewcode-block" id="SRCCleanerOptions.from_dict"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.SRCCleanerOptions.from_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">when_to_clean</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;when_to_clean&#39;</span><span class="p">],</span>
                   <span class="n">current_src_states_allowed</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;current_src_states_allowed&#39;</span><span class="p">],</span>
                   <span class="n">which_src_steps_to_clean</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;which_src_steps_to_clean&#39;</span><span class="p">])</span></div></div>


<div class="viewcode-block" id="SRCCleaner"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.SRCCleaner">[docs]</a><span class="k">class</span> <span class="nc">SRCCleaner</span><span class="p">(</span><span class="n">MSONable</span><span class="p">):</span>

    <span class="c1"># RECURRENCE_TYPES = [&#39;END&#39;, &#39;STEP&#39;, &#39;STEP_EXCEPT_END&#39;]</span>
    <span class="c1"># STATE_TYPES = {&#39;END&#39;: [&#39;FINALIZED&#39;, &#39;UNRECOVERABLE&#39;, &#39;MAXRESTARTS&#39;],</span>
    <span class="c1">#                &#39;STEP&#39;: [&#39;RECOVERABLE&#39;, &#39;UNRECOVERABLE&#39;, &#39;MAXRESTARTS&#39;, &#39;FINALIZED&#39;],</span>
    <span class="c1">#                &#39;STEP_EXCEPT_END&#39;: [&#39;RECOVERABLE&#39;]}</span>
    <span class="c1"># CLEANING_TYPES = [&#39;ALL&#39;, &#39;ALL_EXCEPT_LAST&#39;, &#39;LAST&#39;]</span>
    <span class="n">SRC_TYPES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;setup&#39;</span><span class="p">,</span> <span class="s1">&#39;run&#39;</span><span class="p">,</span> <span class="s1">&#39;control&#39;</span><span class="p">,</span> <span class="s1">&#39;src_root&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cleaners</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">src_type</span><span class="o">=</span><span class="s1">&#39;run&#39;</span><span class="p">,</span> <span class="n">cleaner_options</span><span class="o">=</span><span class="n">SRCCleanerOptions</span><span class="o">.</span><span class="n">clean_all</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">cleaners</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cleaners</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cleaners</span> <span class="o">=</span> <span class="n">cleaners</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src_type</span> <span class="o">=</span> <span class="n">src_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleaner_options</span> <span class="o">=</span> <span class="n">cleaner_options</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">cleaners</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cleaners</span>

    <span class="nd">@cleaners</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">cleaners</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cleaners</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cleaners</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cleaners</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cleaners</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">cl</span> <span class="ow">in</span> <span class="n">cleaners</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">Cleaner</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;One of the items in cleaners is not a Cleaner instance but is an instance &#39;</span>
                                     <span class="s1">&#39;of </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cl</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cleaners</span> <span class="o">=</span> <span class="n">cleaners</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The variable &quot;cleaners&quot; should be either None or a list of Cleaner objects&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">src_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_type</span>

    <span class="nd">@src_type</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">src_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_type</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">src_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">SRC_TYPES</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Argument &quot;src_type&quot; should be one of the following : &#39;</span>
                             <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">SRC_TYPES</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_src_type</span> <span class="o">=</span> <span class="n">src_type</span>

<div class="viewcode-block" id="SRCCleaner.src_dir_to_clean"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.SRCCleaner.src_dir_to_clean">[docs]</a>    <span class="k">def</span> <span class="nf">src_dir_to_clean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_directories</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">src_directories</span><span class="p">[</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_dir&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_type</span><span class="p">)]</span></div>

<div class="viewcode-block" id="SRCCleaner.check_recurrence"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.SRCCleaner.check_recurrence">[docs]</a>    <span class="k">def</span> <span class="nf">check_recurrence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_task_index</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">recurrence</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="SRCCleaner.clean"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.SRCCleaner.clean">[docs]</a>    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">last_src_directories</span><span class="p">,</span> <span class="n">previous_src_dirs</span><span class="p">,</span> <span class="n">src_task_index</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="n">dirs_to_clean</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaning</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ALL&#39;</span><span class="p">,</span> <span class="s1">&#39;LAST&#39;</span><span class="p">]:</span>
            <span class="n">dirs_to_clean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_dir_to_clean</span><span class="p">(</span><span class="n">last_src_directories</span><span class="p">))</span>
            <span class="k">pass</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaning</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ALL&#39;</span><span class="p">,</span> <span class="s1">&#39;ALL_EXCEPT_LAST&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">src_directories</span> <span class="ow">in</span> <span class="n">previous_src_dirs</span><span class="p">:</span>
                <span class="n">dirs_to_clean</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">src_dir_to_clean</span><span class="p">(</span><span class="n">src_directories</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">dir_to_clean</span> <span class="ow">in</span> <span class="n">dirs_to_clean</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cleaner</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaners</span><span class="p">:</span>
                <span class="n">cleaner</span><span class="o">.</span><span class="n">clean</span><span class="p">(</span><span class="n">root_directory</span><span class="o">=</span><span class="n">dir_to_clean</span><span class="p">)</span></div>

<div class="viewcode-block" id="SRCCleaner.as_dict"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.SRCCleaner.as_dict">[docs]</a>    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;@class&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="s1">&#39;@module&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
                <span class="s1">&#39;cleaners&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaners</span><span class="p">],</span>
                <span class="s1">&#39;src_types&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_type</span><span class="p">,</span>
                <span class="s1">&#39;cleaner_options&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaner_options</span><span class="p">}</span></div>

<div class="viewcode-block" id="SRCCleaner.from_dict"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.SRCCleaner.from_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">recurrence</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;recurrence&#39;</span><span class="p">],</span>
                   <span class="n">cleaners</span><span class="o">=</span><span class="p">[</span><span class="n">Cleaner</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">d_c</span><span class="p">)</span> <span class="k">for</span> <span class="n">d_c</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;cleaners&#39;</span><span class="p">]],</span>
                   <span class="n">src_type</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;src_type&#39;</span><span class="p">])</span></div></div>


<div class="viewcode-block" id="SRCCleaning"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.SRCCleaning">[docs]</a><span class="k">class</span> <span class="nc">SRCCleaning</span><span class="p">(</span><span class="n">MSONable</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_cleaners</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">src_cleaners</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">src_cleaners</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">src_cleaners</span> <span class="o">=</span> <span class="n">src_cleaners</span>

<div class="viewcode-block" id="SRCCleaning.clean"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.SRCCleaning.clean">[docs]</a>    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src_directories</span><span class="p">,</span> <span class="n">previous_src_dirs</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="SRCCleaning.as_dict"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.SRCCleaning.as_dict">[docs]</a>    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;@class&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="s1">&#39;@module&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
                <span class="s1">&#39;src_cleaners&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">src_c</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">src_c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">src_cleaners</span><span class="p">]}</span></div>

<div class="viewcode-block" id="SRCCleaning.from_dict"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.SRCCleaning.from_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">src_cleaners</span><span class="o">=</span><span class="p">[</span><span class="n">SRCCleaner</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">d_src_c</span><span class="p">)</span> <span class="k">for</span> <span class="n">d_src_c</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;src_cleaners&#39;</span><span class="p">]])</span></div></div>


<div class="viewcode-block" id="createSRCFireworks"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.createSRCFireworks">[docs]</a><span class="k">def</span> <span class="nf">createSRCFireworks</span><span class="p">(</span><span class="n">setup_task</span><span class="p">,</span> <span class="n">run_task</span><span class="p">,</span> <span class="n">control_task</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">initialization_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">task_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">setup_spec_update</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">run_spec_update</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Make a full copy of the spec</span>
    <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">initialization_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">initialization_info</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">spec</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
    <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;_add_launchpad_and_fw_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;_add_fworker&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># Initialize the SRC task_index</span>
    <span class="k">if</span> <span class="n">task_index</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">src_task_index</span> <span class="o">=</span> <span class="n">SRCTaskIndex</span><span class="o">.</span><span class="n">from_any</span><span class="p">(</span><span class="n">task_index</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># src_task_index = SRCTaskIndex.from_any(&#39;unknown-task&#39;)</span>
        <span class="n">src_task_index</span> <span class="o">=</span> <span class="n">SRCTaskIndex</span><span class="o">.</span><span class="n">from_task</span><span class="p">(</span><span class="n">run_task</span><span class="p">)</span>
    <span class="n">spec</span><span class="p">[</span><span class="s1">&#39;SRC_task_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">src_task_index</span>

    <span class="c1"># SetupTask</span>
    <span class="n">setup_spec</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
    <span class="c1"># Remove any initial queue_adapter_update from the spec</span>
    <span class="n">setup_spec</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;queue_adapter_update&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">setup_spec</span> <span class="o">=</span> <span class="n">set_short_single_core_to_spec</span><span class="p">(</span><span class="n">setup_spec</span><span class="p">)</span>
    <span class="n">setup_spec</span><span class="p">[</span><span class="s1">&#39;_preserve_fworker&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">setup_spec</span><span class="p">[</span><span class="s1">&#39;_pass_job_info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">setup_spec</span><span class="p">[</span><span class="s1">&#39;initialization_info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initialization_info</span>
    <span class="n">setup_spec</span><span class="o">.</span><span class="n">update</span><span class="p">({}</span> <span class="k">if</span> <span class="n">setup_spec_update</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">setup_spec_update</span><span class="p">)</span>
    <span class="n">setup_fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">(</span><span class="n">setup_task</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">setup_spec</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">src_task_index</span><span class="o">.</span><span class="n">setup_str</span><span class="p">)</span>

    <span class="c1"># RunTask</span>
    <span class="n">run_spec</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
    <span class="n">run_spec</span><span class="p">[</span><span class="s1">&#39;SRC_task_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">src_task_index</span>
    <span class="n">run_spec</span><span class="p">[</span><span class="s1">&#39;_preserve_fworker&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">run_spec</span><span class="p">[</span><span class="s1">&#39;_pass_job_info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">run_spec</span><span class="o">.</span><span class="n">update</span><span class="p">({}</span> <span class="k">if</span> <span class="n">run_spec_update</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">run_spec_update</span><span class="p">)</span>
    <span class="n">run_fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">(</span><span class="n">run_task</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">run_spec</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">src_task_index</span><span class="o">.</span><span class="n">run_str</span><span class="p">)</span>

    <span class="c1"># ControlTask</span>
    <span class="n">control_spec</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
    <span class="n">control_spec</span> <span class="o">=</span> <span class="n">set_short_single_core_to_spec</span><span class="p">(</span><span class="n">control_spec</span><span class="p">)</span>
    <span class="n">control_spec</span><span class="p">[</span><span class="s1">&#39;SRC_task_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">src_task_index</span>
    <span class="n">control_spec</span><span class="p">[</span><span class="s1">&#39;_allow_fizzled_parents&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">control_fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">(</span><span class="n">control_task</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">control_spec</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">src_task_index</span><span class="o">.</span><span class="n">control_str</span><span class="p">)</span>

    <span class="n">links_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">setup_fw</span><span class="o">.</span><span class="n">fw_id</span><span class="p">:</span> <span class="p">[</span><span class="n">run_fw</span><span class="o">.</span><span class="n">fw_id</span><span class="p">],</span>
                  <span class="n">run_fw</span><span class="o">.</span><span class="n">fw_id</span><span class="p">:</span> <span class="p">[</span><span class="n">control_fw</span><span class="o">.</span><span class="n">fw_id</span><span class="p">]}</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;setup_fw&#39;</span><span class="p">:</span> <span class="n">setup_fw</span><span class="p">,</span> <span class="s1">&#39;run_fw&#39;</span><span class="p">:</span> <span class="n">run_fw</span><span class="p">,</span> <span class="s1">&#39;control_fw&#39;</span><span class="p">:</span> <span class="n">control_fw</span><span class="p">,</span> <span class="s1">&#39;links_dict&#39;</span><span class="p">:</span> <span class="n">links_dict</span><span class="p">,</span>
            <span class="s1">&#39;fws&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">setup_fw</span><span class="p">,</span> <span class="n">run_fw</span><span class="p">,</span> <span class="n">control_fw</span><span class="p">]}</span></div>


<div class="viewcode-block" id="SRCTaskIndex"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.SRCTaskIndex">[docs]</a><span class="k">class</span> <span class="nc">SRCTaskIndex</span><span class="p">(</span><span class="n">MSONable</span><span class="p">):</span>

    <span class="n">ALLOWED_CHARS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;-&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_type</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_task_type</span><span class="p">(</span><span class="n">task_type</span><span class="o">=</span><span class="n">task_type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span>

<div class="viewcode-block" id="SRCTaskIndex.set_task_type"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.SRCTaskIndex.set_task_type">[docs]</a>    <span class="k">def</span> <span class="nf">set_task_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_type</span><span class="p">):</span>
        <span class="n">prefix_test_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">task_type</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">allowed_char</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ALLOWED_CHARS</span><span class="p">:</span>
            <span class="n">prefix_test_string</span> <span class="o">=</span> <span class="n">prefix_test_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">allowed_char</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">prefix_test_string</span><span class="o">.</span><span class="n">isalnum</span><span class="p">():</span>
            <span class="n">ac_str</span> <span class="o">=</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;&quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ac</span><span class="p">)</span> <span class="k">for</span> <span class="n">ac</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ALLOWED_CHARS</span><span class="p">])</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;task_type should only contain letters &#39;</span>
                             <span class="s1">&#39;and the following characters : </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ac_str</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_type</span> <span class="o">=</span> <span class="n">task_type</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_index</span>

    <span class="nd">@index</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">=</span> <span class="n">index</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">myindex</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_index</span> <span class="o">=</span> <span class="n">myindex</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Index in SRCTaskIndex should be an integer or a string &#39;</span>
                                 <span class="s1">&#39;that can be cast into an integer&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Index in SRCTaskIndex should be an integer or a string &#39;</span>
                             <span class="s1">&#39;that can be cast into an integer&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="SRCTaskIndex.increase_index"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.SRCTaskIndex.increase_index">[docs]</a>    <span class="k">def</span> <span class="nf">increase_index</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span></div>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The __add__ method in SRCTaskIndex should be an integer&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">+=</span> <span class="n">other</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">task_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">)])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">setup_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;setup&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">run_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;run&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">control_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;control&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()])</span>

<div class="viewcode-block" id="SRCTaskIndex.from_string"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.SRCTaskIndex.from_string">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_string</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">SRC_task_index_string</span><span class="p">):</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="n">SRC_task_index_string</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
        <span class="c1"># if len(sp) not in [2, 3]:</span>
        <span class="c1">#     raise ValueError(&#39;SRC_task_index_string should contain 1 or 2 underscores (&quot;_&quot;) &#39;</span>
        <span class="c1">#                      &#39;while it contains {:d}&#39;.format(len(sp)-1))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">task_type</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">part</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">sp</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;SRC_task_index_string has an empty part when separated by underscores ...&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">task_type</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">sp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;setup&#39;</span><span class="p">,</span> <span class="s1">&#39;run&#39;</span><span class="p">,</span> <span class="s1">&#39;control&#39;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;SRC_task_index_string should start with &quot;setup&quot;, &quot;run&quot; or &quot;control&quot; when 3 parts are &#39;</span>
                                 <span class="s1">&#39;identified&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">task_type</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">sp</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span></div>

<div class="viewcode-block" id="SRCTaskIndex.from_any"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.SRCTaskIndex.from_any">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_any</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">SRC_task_index</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">SRC_task_index</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_string</span><span class="p">(</span><span class="n">SRC_task_index</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">SRC_task_index</span><span class="p">,</span> <span class="n">SRCTaskIndex</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">task_type</span><span class="o">=</span><span class="n">SRC_task_index</span><span class="o">.</span><span class="n">task_type</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">SRC_task_index</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;SRC_task_index should be an instance of &quot;str&quot; or &quot;SRCTaskIndex&quot; &#39;</span>
                             <span class="s1">&#39;in &quot;from_any&quot; class method&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SRCTaskIndex.from_task"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.SRCTaskIndex.from_task">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_task</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">task_type</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">task_type</span><span class="p">)</span></div>

<div class="viewcode-block" id="SRCTaskIndex.from_dict"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.SRCTaskIndex.from_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">task_type</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;task_type&#39;</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="SRCTaskIndex.as_dict"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.SRCTaskIndex.as_dict">[docs]</a>    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;@class&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                <span class="s1">&#39;@module&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
                <span class="s1">&#39;task_type&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_type</span><span class="p">,</span>
                <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">}</span></div></div>


<div class="viewcode-block" id="get_queue_adapter_update"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.get_queue_adapter_update">[docs]</a><span class="k">def</span> <span class="nf">get_queue_adapter_update</span><span class="p">(</span><span class="n">qtk_queueadapter</span><span class="p">,</span> <span class="n">corrections</span><span class="p">,</span> <span class="n">qa_params</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">qa_params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">qa_params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;timelimit&#39;</span><span class="p">,</span> <span class="s1">&#39;mem_per_proc&#39;</span><span class="p">,</span> <span class="s1">&#39;master_mem_overhead&#39;</span><span class="p">]</span>
    <span class="n">queue_adapter_update</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">qa_param</span> <span class="ow">in</span> <span class="n">qa_params</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">qa_param</span> <span class="o">==</span> <span class="s1">&#39;timelimit&#39;</span><span class="p">:</span>
            <span class="n">queue_adapter_update</span><span class="p">[</span><span class="n">qa_param</span><span class="p">]</span> <span class="o">=</span> <span class="n">qtk_queueadapter</span><span class="o">.</span><span class="n">timelimit</span>
        <span class="k">elif</span> <span class="n">qa_param</span> <span class="o">==</span> <span class="s1">&#39;mem_per_proc&#39;</span><span class="p">:</span>
            <span class="n">queue_adapter_update</span><span class="p">[</span><span class="n">qa_param</span><span class="p">]</span> <span class="o">=</span> <span class="n">qtk_queueadapter</span><span class="o">.</span><span class="n">mem_per_proc</span>
        <span class="k">elif</span> <span class="n">qa_param</span> <span class="o">==</span> <span class="s1">&#39;master_mem_overhead&#39;</span><span class="p">:</span>
            <span class="n">queue_adapter_update</span><span class="p">[</span><span class="n">qa_param</span><span class="p">]</span> <span class="o">=</span> <span class="n">qtk_queueadapter</span><span class="o">.</span><span class="n">master_mem_overhead</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Wrong queue adapter parameter for update&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">correction</span> <span class="ow">in</span> <span class="n">corrections</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">correction</span><span class="p">[</span><span class="s1">&#39;actions&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">action</span><span class="p">[</span><span class="s1">&#39;object&#39;</span><span class="p">][</span><span class="s1">&#39;key&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;qtk_queueadapter&#39;</span><span class="p">:</span>
                <span class="n">qa_update</span> <span class="o">=</span> <span class="n">action</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">][</span><span class="s1">&#39;_set&#39;</span><span class="p">]</span>
                <span class="n">queue_adapter_update</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">qa_update</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">queue_adapter_update</span></div>


<span class="c1">################</span>
<span class="c1"># Exceptions</span>
<span class="c1">################</span>

<div class="viewcode-block" id="SRCError"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.SRCError">[docs]</a><span class="k">class</span> <span class="nc">SRCError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="SetupError"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.SetupError">[docs]</a><span class="k">class</span> <span class="nc">SetupError</span><span class="p">(</span><span class="n">SRCError</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="RunError"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.RunError">[docs]</a><span class="k">class</span> <span class="nc">RunError</span><span class="p">(</span><span class="n">SRCError</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="ControlError"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.ControlError">[docs]</a><span class="k">class</span> <span class="nc">ControlError</span><span class="p">(</span><span class="n">SRCError</span><span class="p">):</span>
    <span class="k">pass</span></div>


<span class="c1">################</span>
<span class="c1"># Timings</span>
<span class="c1">################</span>


<div class="viewcode-block" id="FWTime"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.FWTime">[docs]</a><span class="k">class</span> <span class="nc">FWTime</span><span class="p">(</span><span class="n">MSONable</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">,</span> <span class="n">fw_id</span><span class="p">,</span> <span class="n">ncpus</span><span class="p">,</span> <span class="n">fwtime_secs</span><span class="p">,</span> <span class="n">clustertime_secs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fw_name</span> <span class="o">=</span> <span class="n">fw_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fw_id</span> <span class="o">=</span> <span class="n">fw_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ncpus</span> <span class="o">=</span> <span class="n">ncpus</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fwtime_secs</span> <span class="o">=</span> <span class="n">fwtime_secs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clustertime_secs</span> <span class="o">=</span> <span class="n">clustertime_secs</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">time_per_cpu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustertime_secs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">clustertime_secs</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwtime_secs</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">total_time</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncpus</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">time_per_cpu</span>

<div class="viewcode-block" id="FWTime.as_dict"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.FWTime.as_dict">[docs]</a>    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">fw_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fw_name</span><span class="p">,</span> <span class="n">fw_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fw_id</span><span class="p">,</span>
                  <span class="n">ncpus</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ncpus</span><span class="p">,</span> <span class="n">fwtime_secs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fwtime_secs</span><span class="p">,</span>
                  <span class="n">clustertime_secs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clustertime_secs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dd</span></div>

<div class="viewcode-block" id="FWTime.from_dict"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.FWTime.from_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">fw_name</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;fw_name&#39;</span><span class="p">],</span> <span class="n">fw_id</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;fw_id&#39;</span><span class="p">],</span>
                   <span class="n">ncpus</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;ncpus&#39;</span><span class="p">],</span> <span class="n">fwtime_secs</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;fwtime_secs&#39;</span><span class="p">],</span> <span class="n">clustertime_secs</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;clustertime_secs&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="FWTime.from_fw_id"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.FWTime.from_fw_id">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_fw_id</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">fw_id</span><span class="p">,</span> <span class="n">lpad</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">lpad</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lpad</span> <span class="o">=</span> <span class="n">LaunchPad</span><span class="o">.</span><span class="n">auto_load</span><span class="p">()</span>
        <span class="n">fw_dict</span> <span class="o">=</span> <span class="n">lpad</span><span class="o">.</span><span class="n">get_fw_dict_by_id</span><span class="p">(</span><span class="n">fw_id</span><span class="o">=</span><span class="n">fw_id</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">fw_dict</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="c1"># TODO: find a way to know the number of cpus here ? Or should we always assume it is 1 ?</span>
        <span class="n">ncpus</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">fwtime_secs</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="c1"># TODO: get the runtime from the cluster (taking the reservation_id and things like that ?)</span>
        <span class="n">clustertime_secs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">fw_name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">fw_id</span><span class="o">=</span><span class="n">fw_id</span><span class="p">,</span>
                   <span class="n">ncpus</span><span class="o">=</span><span class="n">ncpus</span><span class="p">,</span> <span class="n">fwtime_secs</span><span class="o">=</span><span class="n">fwtime_secs</span><span class="p">,</span> <span class="n">clustertime_secs</span><span class="o">=</span><span class="n">clustertime_secs</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="SRCFWTime"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.SRCFWTime">[docs]</a><span class="k">class</span> <span class="nc">SRCFWTime</span><span class="p">(</span><span class="n">FWTime</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">,</span> <span class="n">fw_id</span><span class="p">,</span> <span class="n">ncpus</span><span class="p">,</span> <span class="n">fwtime_secs</span><span class="p">,</span> <span class="n">clustertime_secs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">src_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">task_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">task_index</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">fw_name</span><span class="o">=</span><span class="n">fw_name</span><span class="p">,</span> <span class="n">fw_id</span><span class="o">=</span><span class="n">fw_id</span><span class="p">,</span> <span class="n">ncpus</span><span class="o">=</span><span class="n">ncpus</span><span class="p">,</span>
                         <span class="n">fwtime_secs</span><span class="o">=</span><span class="n">fwtime_secs</span><span class="p">,</span> <span class="n">clustertime_secs</span><span class="o">=</span><span class="n">clustertime_secs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">src_type</span> <span class="o">=</span> <span class="n">src_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_type</span> <span class="o">=</span> <span class="n">task_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_index</span> <span class="o">=</span> <span class="n">task_index</span>

<div class="viewcode-block" id="SRCFWTime.as_dict"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.SRCFWTime.as_dict">[docs]</a>    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">src_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">src_type</span><span class="p">,</span> <span class="n">task_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">task_type</span><span class="p">,</span> <span class="n">task_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">task_index</span><span class="o">.</span><span class="n">as_dict</span><span class="p">(),</span>
                  <span class="n">ncpus</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ncpus</span><span class="p">,</span> <span class="n">fwtime_secs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fwtime_secs</span><span class="p">,</span>
                  <span class="n">clustertime_secs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">clustertime_secs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dd</span></div>

<div class="viewcode-block" id="SRCFWTime.from_dict"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.SRCFWTime.from_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">src_type</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;src_type&#39;</span><span class="p">],</span> <span class="n">task_type</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;task_type&#39;</span><span class="p">],</span> <span class="n">task_index</span><span class="o">=</span><span class="n">SRCTaskIndex</span><span class="o">.</span><span class="n">from_any</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;task_index&#39;</span><span class="p">]),</span>
                   <span class="n">ncpus</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;ncpus&#39;</span><span class="p">],</span> <span class="n">fwtime_secs</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;fwtime_secs&#39;</span><span class="p">],</span> <span class="n">clustertime_secs</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;clustertime_secs&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="SRCFWTime.from_fw_id"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.src_tasks_abc.SRCFWTime.from_fw_id">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_fw_id</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">fw_id</span><span class="p">,</span> <span class="n">lpad</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">lpad</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lpad</span> <span class="o">=</span> <span class="n">LaunchPad</span><span class="o">.</span><span class="n">auto_load</span><span class="p">()</span>
        <span class="n">fw_dict</span> <span class="o">=</span> <span class="n">lpad</span><span class="o">.</span><span class="n">get_fw_dict_by_id</span><span class="p">(</span><span class="n">fw_id</span><span class="o">=</span><span class="n">fw_id</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">fw_dict</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="c1"># TODO: find a way to know the number of cpus here ? Or should we always assume it is 1 ?</span>
        <span class="n">ncpus</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">fwtime_secs</span> <span class="o">=</span> <span class="mf">0.0</span></div></div>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2017, The Abinit group.<br/>
      Last updated on May 29, 2020.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.2.0.<br/>
    </p>
  </div>
</footer>
  </body>
</html>