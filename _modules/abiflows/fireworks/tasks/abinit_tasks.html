<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>abiflows.fireworks.tasks.abinit_tasks &#8212; abiflows 0.4 documentation</title>
    <link rel="stylesheet" href="../../../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/my_style.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '0.4',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../../../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../../../_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../../index.html">
          abiflows</a>
        <span class="navbar-text navbar-version pull-left"><b>0.4</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../features.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation.html">Getting AbiFlows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../zzbiblio.html">Bibliography</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/modules.html">abiflows</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
              
                
              
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  <h1>Source code for abiflows.fireworks.tasks.abinit_tasks</h1><div class="highlight"><pre>
<span></span><span class="c1"># coding: utf-8</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Abinit Task classes for Fireworks.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">unicode_literals</span><span class="p">,</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">namedtuple</span><span class="p">,</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">monty.json</span> <span class="k">import</span> <span class="n">MontyEncoder</span><span class="p">,</span> <span class="n">MontyDecoder</span><span class="p">,</span> <span class="n">MSONable</span>
<span class="kn">from</span> <span class="nn">pymatgen.util.serialization</span> <span class="k">import</span> <span class="n">json_pretty_dump</span><span class="p">,</span> <span class="n">pmg_serialize</span>
<span class="kn">from</span> <span class="nn">pymatgen.analysis.elasticity</span> <span class="k">import</span> <span class="n">ElasticTensor</span>
<span class="kn">from</span> <span class="nn">abipy.flowtk.utils</span> <span class="k">import</span> <span class="n">Directory</span><span class="p">,</span> <span class="n">File</span>
<span class="kn">from</span> <span class="nn">abipy.flowtk</span> <span class="k">import</span> <span class="n">events</span><span class="p">,</span> <span class="n">tasks</span>
<span class="kn">from</span> <span class="nn">abipy.flowtk.netcdf</span> <span class="k">import</span> <span class="n">NetcdfReader</span><span class="p">,</span> <span class="n">NO_DEFAULT</span>
<span class="kn">from</span> <span class="nn">abipy.flowtk.utils</span> <span class="k">import</span> <span class="n">irdvars_for_ext</span>
<span class="kn">from</span> <span class="nn">abipy.flowtk.wrappers</span> <span class="k">import</span> <span class="n">Mrgddb</span>
<span class="kn">from</span> <span class="nn">abipy.flowtk.qutils</span> <span class="k">import</span> <span class="n">time2slurm</span>
<span class="kn">from</span> <span class="nn">abipy.abio.factories</span> <span class="k">import</span> <span class="n">InputFactory</span><span class="p">,</span> <span class="n">PiezoElasticFromGsFactory</span>
<span class="kn">from</span> <span class="nn">abipy.abio.inputs</span> <span class="k">import</span> <span class="n">AbinitInput</span>
<span class="kn">from</span> <span class="nn">abipy.abio.input_tags</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">abipy.abio.outputs</span> <span class="k">import</span> <span class="n">OutNcFile</span>
<span class="kn">from</span> <span class="nn">abipy.core.mixins</span> <span class="k">import</span> <span class="n">Has_Structure</span>
<span class="kn">from</span> <span class="nn">abipy.core</span> <span class="k">import</span> <span class="n">Structure</span>
<span class="kn">from</span> <span class="nn">fireworks.core.firework</span> <span class="k">import</span> <span class="n">Firework</span><span class="p">,</span> <span class="n">FireTaskBase</span><span class="p">,</span> <span class="n">FWAction</span><span class="p">,</span> <span class="n">Workflow</span>
<span class="kn">from</span> <span class="nn">fireworks.utilities.fw_utilities</span> <span class="k">import</span> <span class="n">explicit_serialize</span>
<span class="kn">from</span> <span class="nn">fireworks.utilities.fw_serializers</span> <span class="k">import</span> <span class="n">serialize_fw</span>
<span class="kn">from</span> <span class="nn">abiflows.fireworks.utils.task_history</span> <span class="k">import</span> <span class="n">TaskHistory</span>
<span class="kn">from</span> <span class="nn">abiflows.fireworks.utils.fw_utils</span> <span class="k">import</span> <span class="n">links_dict_update</span>
<span class="kn">from</span> <span class="nn">abiflows.fireworks.utils.fw_utils</span> <span class="k">import</span> <span class="n">set_short_single_core_to_spec</span>
<span class="kn">from</span> <span class="nn">abiflows.fireworks.tasks.abinit_common</span> <span class="k">import</span> <span class="n">TMPDIR_NAME</span><span class="p">,</span> <span class="n">OUTDIR_NAME</span><span class="p">,</span> <span class="n">INDIR_NAME</span><span class="p">,</span> <span class="n">STDERR_FILE_NAME</span><span class="p">,</span> \
    <span class="n">LOG_FILE_NAME</span><span class="p">,</span> <span class="n">FILES_FILE_NAME</span><span class="p">,</span> <span class="n">OUTPUT_FILE_NAME</span><span class="p">,</span> <span class="n">INPUT_FILE_NAME</span><span class="p">,</span> <span class="n">MPIABORTFILE</span><span class="p">,</span> <span class="n">DUMMY_FILENAME</span><span class="p">,</span> \
    <span class="n">ELPHON_OUTPUT_FILE_NAME</span><span class="p">,</span> <span class="n">DDK_FILES_FILE_NAME</span><span class="p">,</span> <span class="n">HISTORY_JSON</span>
<span class="kn">from</span> <span class="nn">abiflows.fireworks.utils.fw_utils</span> <span class="k">import</span> <span class="n">FWTaskManager</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="c1"># files and folders names</span>


<div class="viewcode-block" id="BasicAbinitTaskMixin"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.BasicAbinitTaskMixin">[docs]</a><span class="k">class</span> <span class="nc">BasicAbinitTaskMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">task_type</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="nd">@serialize_fw</span>
    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">arg</span> <span class="o">!=</span> <span class="s2">&quot;self&quot;</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s2">&quot;as_dict&quot;</span><span class="p">):</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s2">&quot;as_dict&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span><span class="p">]</span>
                <span class="n">d</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

        <span class="k">return</span> <span class="n">d</span>

<div class="viewcode-block" id="BasicAbinitTaskMixin.from_dict"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.BasicAbinitTaskMixin.from_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="n">MontyDecoder</span><span class="p">()</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">dec</span><span class="o">.</span><span class="n">process_decoded</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                  <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)</span><span class="o">.</span><span class="n">args</span><span class="p">}</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="BasicAbinitTaskMixin.get_fw_task_manager"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.BasicAbinitTaskMixin.get_fw_task_manager">[docs]</a>    <span class="k">def</span> <span class="nf">get_fw_task_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates an instance of FWTaskManager. First looks for a &#39;ftm_file&#39; key in the spec, otherwise generates it</span>
<span class="sd">        with FWTaskManager.from_user_config. The configuration is updated with the keywords defined in &#39;fw_policy&#39;</span>
<span class="sd">        in the spec.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s1">&#39;ftm_file&#39;</span> <span class="ow">in</span> <span class="n">fw_spec</span><span class="p">:</span>
            <span class="n">ftm</span> <span class="o">=</span> <span class="n">FWTaskManager</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">[</span><span class="s1">&#39;ftm_file&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ftm</span> <span class="o">=</span> <span class="n">FWTaskManager</span><span class="o">.</span><span class="n">from_user_config</span><span class="p">()</span>
        <span class="n">ftm</span><span class="o">.</span><span class="n">update_fw_policy</span><span class="p">(</span><span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fw_policy&#39;</span><span class="p">,</span> <span class="p">{}))</span>
        <span class="k">return</span> <span class="n">ftm</span></div>

<div class="viewcode-block" id="BasicAbinitTaskMixin.run_autoparal"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.BasicAbinitTaskMixin.run_autoparal">[docs]</a>    <span class="k">def</span> <span class="nf">run_autoparal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">abiinput</span><span class="p">,</span> <span class="n">autoparal_dir</span><span class="p">,</span> <span class="n">ftm</span><span class="p">,</span> <span class="n">clean_up</span><span class="o">=</span><span class="s1">&#39;move&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs the autoparal using AbinitInput abiget_autoparal_pconfs method.</span>
<span class="sd">        The information are retrieved from the FWTaskManager that should be present and contain the standard</span>
<span class="sd">        AbiPy |TaskManager|, that provides information about the queue adapters.</span>
<span class="sd">        No check is performed on the autoparal_dir. If there is a possibility of overwriting output data due to</span>
<span class="sd">        reuse of the same folder, it should be handled by the caller.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">manager</span> <span class="o">=</span> <span class="n">ftm</span><span class="o">.</span><span class="n">task_manager</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">manager</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;No task manager available: autoparal could not be performed.&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">InitializationError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">pconfs</span> <span class="o">=</span> <span class="n">abiinput</span><span class="o">.</span><span class="n">abiget_autoparal_pconfs</span><span class="p">(</span><span class="n">max_ncpus</span><span class="o">=</span><span class="n">manager</span><span class="o">.</span><span class="n">max_cores</span><span class="p">,</span> <span class="n">workdir</span><span class="o">=</span><span class="n">autoparal_dir</span><span class="p">,</span>
                                                       <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">)</span>
        <span class="n">optconf</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">select_qadapter</span><span class="p">(</span><span class="n">pconfs</span><span class="p">)</span>
        <span class="n">qadapter_spec</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">qadapter</span><span class="o">.</span><span class="n">get_subs_dict</span><span class="p">()</span>

        <span class="n">d</span> <span class="o">=</span> <span class="n">pconfs</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;optimal_conf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optconf</span>
        <span class="n">json_pretty_dump</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">autoparal_dir</span><span class="p">,</span> <span class="s2">&quot;autoparal.json&quot;</span><span class="p">))</span>

        <span class="c1"># Method to clean the output files</span>
        <span class="k">def</span> <span class="nf">safe_rm</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">autoparal_dir</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># Method to rename the output files</span>
        <span class="k">def</span> <span class="nf">safe_mv</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">autoparal_backup_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">autoparal_dir</span><span class="p">,</span> <span class="s1">&#39;autoparal_backup&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">autoparal_backup_dir</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">autoparal_backup_dir</span><span class="p">)</span>
                <span class="n">current_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">autoparal_dir</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="n">newpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">autoparal_backup_dir</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">newpath</span><span class="p">):</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">current_path</span><span class="p">,</span> <span class="n">newpath</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Autoparal backup file already exists for the file &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># clean up useless files. The output files should removed also to avoid abinit renaming the out file in</span>
        <span class="c1"># case the main run will be performed in the same dir</span>

        <span class="k">if</span> <span class="n">clean_up</span> <span class="o">==</span> <span class="s1">&#39;move&#39;</span><span class="p">:</span>
            <span class="n">to_be_moved</span> <span class="o">=</span> <span class="p">[</span><span class="n">OUTPUT_FILE_NAME</span><span class="p">,</span> <span class="n">LOG_FILE_NAME</span><span class="p">,</span> <span class="n">STDERR_FILE_NAME</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">to_be_moved</span><span class="p">:</span>
                <span class="n">safe_mv</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="n">to_be_removed</span> <span class="o">=</span> <span class="p">[</span><span class="n">TMPDIR_NAME</span><span class="p">,</span> <span class="n">OUTDIR_NAME</span><span class="p">,</span> <span class="n">INDIR_NAME</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">to_be_removed</span><span class="p">:</span>
                <span class="n">safe_rm</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">clean_up</span> <span class="o">==</span> <span class="s1">&#39;remove&#39;</span><span class="p">:</span>
            <span class="n">to_be_removed</span> <span class="o">=</span> <span class="p">[</span><span class="n">OUTPUT_FILE_NAME</span><span class="p">,</span> <span class="n">LOG_FILE_NAME</span><span class="p">,</span> <span class="n">STDERR_FILE_NAME</span><span class="p">,</span> <span class="n">TMPDIR_NAME</span><span class="p">,</span> <span class="n">OUTDIR_NAME</span><span class="p">,</span> <span class="n">INDIR_NAME</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">to_be_removed</span><span class="p">:</span>
                <span class="n">safe_rm</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">optconf</span><span class="p">,</span> <span class="n">qadapter_spec</span><span class="p">,</span> <span class="n">manager</span><span class="o">.</span><span class="n">qadapter</span></div>

<div class="viewcode-block" id="BasicAbinitTaskMixin.run_fake_autoparal"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.BasicAbinitTaskMixin.run_fake_autoparal">[docs]</a>    <span class="k">def</span> <span class="nf">run_fake_autoparal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ftm</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        In cases where the autoparal is not supported a fake run autoparal can be used to set the queueadapter.</span>
<span class="sd">        Takes the number of processors suggested by the manager given that the paral hints contain all the</span>
<span class="sd">        number of processors up tu max_cores and they all have the same efficiency.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">manager</span> <span class="o">=</span> <span class="n">ftm</span><span class="o">.</span><span class="n">task_manager</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">manager</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;No task manager available: autoparal could not be performed.&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">InitializationError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># all the options have the same priority, let the qadapter decide which is preferred.</span>
        <span class="n">fake_conf_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">({</span><span class="s1">&#39;tot_ncpus&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;mpi_ncpus&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s1">&#39;efficiency&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">manager</span><span class="o">.</span><span class="n">max_cores</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="kn">from</span> <span class="nn">pymatgen.io.abinit.tasks</span> <span class="k">import</span> <span class="n">ParalHints</span>
        <span class="n">pconfs</span> <span class="o">=</span> <span class="n">ParalHints</span><span class="p">({},</span> <span class="n">fake_conf_list</span><span class="p">)</span>

        <span class="n">optconf</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">select_qadapter</span><span class="p">(</span><span class="n">pconfs</span><span class="p">)</span>
        <span class="n">qadapter_spec</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">qadapter</span><span class="o">.</span><span class="n">get_subs_dict</span><span class="p">()</span>

        <span class="n">d</span> <span class="o">=</span> <span class="n">pconfs</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;optimal_conf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optconf</span>
        <span class="n">json_pretty_dump</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="s2">&quot;autoparal.json&quot;</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">optconf</span><span class="p">,</span> <span class="n">qadapter_spec</span><span class="p">,</span> <span class="n">manager</span><span class="o">.</span><span class="n">qadapter</span></div>

<div class="viewcode-block" id="BasicAbinitTaskMixin.get_final_mod_spec"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.BasicAbinitTaskMixin.get_final_mod_spec">[docs]</a>    <span class="k">def</span> <span class="nf">get_final_mod_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generates the standard mod_spec dict for the FWAction. Pushes the information of the current task to</span>
<span class="sd">        the list associated with self.task_type. Requires a &quot;current_task_info&quot; method.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">[{</span><span class="s1">&#39;_push&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;previous_fws-&gt;&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">task_type</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_task_info</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">)}}]</span></div>
        <span class="c1"># if &#39;previous_fws&#39; in fw_spec:</span>
        <span class="c1">#     prev_fws = fw_spec[&#39;previous_fws&#39;].copy()</span>
        <span class="c1"># else:</span>
        <span class="c1">#     prev_fws = {}</span>
        <span class="c1"># prev_fws[self.task_type] = [self.current_task_info(fw_spec)]</span>
        <span class="c1"># return [{&#39;_set&#39;: {&#39;previous_fws&#39;: prev_fws}}]</span>

<div class="viewcode-block" id="BasicAbinitTaskMixin.set_logger"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.BasicAbinitTaskMixin.set_logger">[docs]</a>    <span class="k">def</span> <span class="nf">set_logger</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set a logger for pymatgen.io.abinit and abipy</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">log_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="s1">&#39;abipy.log&#39;</span><span class="p">)</span>
        <span class="n">log_handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">BASIC_FORMAT</span><span class="p">))</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;pymatgen.io.abinit&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">log_handler</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;abipy&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">log_handler</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;abiflows&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">log_handler</span><span class="p">)</span></div>

<div class="viewcode-block" id="BasicAbinitTaskMixin.link_ext"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.BasicAbinitTaskMixin.link_ext">[docs]</a>    <span class="k">def</span> <span class="nf">link_ext</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">source_dir</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Links the required files from previous runs in the indata folder.</span>
<span class="sd">        It will first try to link the fortran file and then the Netcdf file, if the first is not found.</span>

<span class="sd">        Args:</span>
<span class="sd">            ext: extension that should be linked</span>
<span class="sd">            source_dir: path to the source directory</span>
<span class="sd">            strict: if True an exception is raised if the file is missing.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The path to the generated link. None if strict=False and the file could not be found.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">source</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">odata</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">ext</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Need path </span><span class="si">{}</span><span class="s2"> with ext </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">ext</span><span class="p">))</span>
        <span class="n">dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">idata</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">ext</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
            <span class="c1"># Try netcdf file. TODO: this case should be treated in a cleaner way.</span>
            <span class="n">source</span> <span class="o">+=</span> <span class="s2">&quot;.nc&quot;</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">source</span><span class="p">):</span> <span class="n">dest</span> <span class="o">+=</span> <span class="s2">&quot;.nc&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">strict</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> is needed by this task but it does not exist&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">InitializationError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Link path to dest if dest link does not exist.</span>
        <span class="c1"># else check that it points to the expected file.</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Linking path </span><span class="si">{}</span><span class="s2"> --&gt; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">strict</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="o">.</span><span class="n">fw_policy</span><span class="o">.</span><span class="n">copy_deps</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dest</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># check links but only if we haven&#39;t performed the restart.</span>
            <span class="c1"># in this case, indeed we may have replaced the file pointer with the</span>
            <span class="c1"># previous output file of the present task.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="o">.</span><span class="n">fw_policy</span><span class="o">.</span><span class="n">copy_deps</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span> <span class="o">!=</span> <span class="n">source</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_info</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;dest </span><span class="si">{}</span><span class="s2"> does not point to path </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">InitializationError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>

<div class="viewcode-block" id="BasicAbinitTaskMixin.link_ddk"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.BasicAbinitTaskMixin.link_ddk">[docs]</a>    <span class="k">def</span> <span class="nf">link_ddk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_dir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Links the DDK files rom previous runs in the indata folder.</span>
<span class="sd">        Accepts more than one DDK file in the source_dir: multiple perturbations are allowed in a single calculation.</span>
<span class="sd">        Note that the DDK extension is not generated by abinit, but should be created from the appropriate 1WF file.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">outdata_dir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source_dir</span><span class="p">,</span> <span class="n">OUTDIR_NAME</span><span class="p">))</span>
        <span class="n">ddks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">outdata_dir</span><span class="o">.</span><span class="n">list_filepaths</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_DDK&#39;</span><span class="p">):</span>
                <span class="n">ddks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ddks</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;DDK is needed by this task but it does not exist&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">InitializationError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">exts</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">ddk</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">ddk</span> <span class="ow">in</span> <span class="n">ddks</span><span class="p">]</span>
        <span class="n">ddk_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">exts</span><span class="p">:</span>
            <span class="n">ddk_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">link_ext</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="n">source_dir</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">ddk_files</span></div>

    <span class="c1">#TODO to avoid any regression this function will only be used to link 1WF and 1DEN files.</span>
    <span class="c1"># This method should be more general than link_ext, but currently fails in passing all the tests.</span>
    <span class="c1"># After fixing the problems the more general methods should replace link_ext.</span>
<div class="viewcode-block" id="BasicAbinitTaskMixin.link_1ext"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.BasicAbinitTaskMixin.link_1ext">[docs]</a>    <span class="k">def</span> <span class="nf">link_1ext</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">source_dir</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Links the 1DEN and 1WF files in the indata folder.</span>
<span class="sd">        It will first try to link the fortran file and then the Netcdf file, if the first is not found.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># 1DEN is used as a general reference and to trigger the correct ird variable,</span>
        <span class="c1"># but the real extension in DEN.</span>
        <span class="k">if</span> <span class="s2">&quot;1DEN&quot;</span> <span class="ow">in</span> <span class="n">ext</span><span class="p">:</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="s2">&quot;DEN&quot;</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source_dir</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">odata</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">has_abiext</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">source</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">strict</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;output file with extension </span><span class="si">{}</span><span class="s2"> is needed from </span><span class="si">{}</span><span class="s2"> dir, &quot;</span> \
                      <span class="s2">&quot;but it does not exist&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="n">source_dir</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">InitializationError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Need path </span><span class="si">{}</span><span class="s2"> with ext </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">ext</span><span class="p">))</span>
        <span class="c1"># determine the correct extension</span>
        <span class="c1">#TODO check if this is correct for all the possible extensions, apart from 1WF</span>
        <span class="n">ext_full</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">idata</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">ext_full</span><span class="p">)</span>

        <span class="c1"># Link path to dest if dest link does not exist.</span>
        <span class="c1"># else check that it points to the expected file.</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Linking path </span><span class="si">{}</span><span class="s2"> --&gt; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">strict</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="o">.</span><span class="n">fw_policy</span><span class="o">.</span><span class="n">copy_deps</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dest</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># check links but only if we haven&#39;t performed the restart.</span>
            <span class="c1"># in this case, indeed we may have replaced the file pointer with the</span>
            <span class="c1"># previous output file of the present task.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="o">.</span><span class="n">fw_policy</span><span class="o">.</span><span class="n">copy_deps</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span> <span class="o">!=</span> <span class="n">source</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_info</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;dest </span><span class="si">{}</span><span class="s2"> does not point to path </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">InitializationError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>

    <span class="c1">#from Task</span>
    <span class="c1"># Prefixes for Abinit (input, output, temporary) files.</span>
    <span class="n">Prefix</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;Prefix&quot;</span><span class="p">,</span> <span class="s2">&quot;idata odata tdata&quot;</span><span class="p">)</span>
    <span class="n">pj</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span>

    <span class="n">prefix</span> <span class="o">=</span> <span class="n">Prefix</span><span class="p">(</span><span class="n">pj</span><span class="p">(</span><span class="s2">&quot;indata&quot;</span><span class="p">,</span> <span class="s2">&quot;in&quot;</span><span class="p">),</span> <span class="n">pj</span><span class="p">(</span><span class="s2">&quot;outdata&quot;</span><span class="p">,</span> <span class="s2">&quot;out&quot;</span><span class="p">),</span> <span class="n">pj</span><span class="p">(</span><span class="s2">&quot;tmpdata&quot;</span><span class="p">,</span> <span class="s2">&quot;tmp&quot;</span><span class="p">))</span>
    <span class="k">del</span> <span class="n">Prefix</span><span class="p">,</span> <span class="n">pj</span></div>


<div class="viewcode-block" id="AbiFireTask"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.AbiFireTask">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">AbiFireTask</span><span class="p">(</span><span class="n">BasicAbinitTaskMixin</span><span class="p">,</span> <span class="n">FireTaskBase</span><span class="p">):</span>

    <span class="c1"># List of `AbinitEvent` subclasses that are tested in the check_status method.</span>
    <span class="c1"># Subclasses should provide their own list if they need to check the converge status.</span>
    <span class="n">CRITICAL_EVENTS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">abiinput</span><span class="p">,</span> <span class="n">restart_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">handlers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_autoparal</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">history</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">task_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Basic __init__, subclasses are supposed to define the same input parameters, add their own and call super for</span>
<span class="sd">        the basic ones. The input parameter should be stored as attributes of the instance for serialization and</span>
<span class="sd">        for inspection.</span>

<span class="sd">        Args:</span>
<span class="sd">            abiinput: an |AbinitInput| or an InputFactory. Defines the input used in the run</span>
<span class="sd">            restart_info: an instance of RestartInfo. This should be present in case the current task is a restart.</span>
<span class="sd">                Contains information useful to proceed with the restart.</span>
<span class="sd">            handlers: list of ErrorHandlers that should be used in case of error. If None all the error handlers</span>
<span class="sd">                available from abipy will be used.</span>
<span class="sd">            is_autoparal: whether the current task is just an autoparal job or not.</span>
<span class="sd">            deps: the required file dependencies from previous tasks (e.g. DEN, WFK, ...). Can be a single string,</span>
<span class="sd">                a list or a dict of the form {task_type: list of dependecies}. The dependencies will be retrieved</span>
<span class="sd">                from the &#39;previous_tasks&#39; key in spec.</span>
<span class="sd">            history: a TaskHistory or a list of items that will be stored in a TaskHistory instance.</span>
<span class="sd">            task_type: a string that, if not None, overrides the task_type defined in the class.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">handlers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">handlers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">history</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span> <span class="o">=</span> <span class="n">abiinput</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restart_info</span> <span class="o">=</span> <span class="n">restart_info</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="n">handlers</span> <span class="ow">or</span> <span class="p">[</span><span class="bp">cls</span><span class="p">()</span> <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">events</span><span class="o">.</span><span class="n">get_event_handler_classes</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_autoparal</span> <span class="o">=</span> <span class="n">is_autoparal</span>

        <span class="c1">#TODO: rationalize this and check whether this might create problems due to the fact that if task_type is None,</span>
        <span class="c1">#      self.task_type is the class variable (actually self.task_type refers to self.__class__.task_type) while</span>
        <span class="c1">#      if task_type is specified, self.task_type is an instance variable and is potentially different from</span>
        <span class="c1">#      self.__class__.task_type !</span>
        <span class="k">if</span> <span class="n">task_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task_type</span> <span class="o">=</span> <span class="n">task_type</span>

        <span class="c1"># deps are transformed to be a list or a dict of lists</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">deps</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">deps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                    <span class="n">deps</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">deps</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="p">[</span><span class="n">deps</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deps</span> <span class="o">=</span> <span class="n">deps</span>

        <span class="c1"># create a copy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">TaskHistory</span><span class="p">(</span><span class="n">history</span><span class="p">)</span>

    <span class="c1">#from Task</span>
<div class="viewcode-block" id="AbiFireTask.set_workdir"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.AbiFireTask.set_workdir">[docs]</a>    <span class="k">def</span> <span class="nf">set_workdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workdir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets up the working directory: adds attributes for all the files and directories.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">workdir</span><span class="p">)</span>

        <span class="c1"># Files required for the execution.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">INPUT_FILE_NAME</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">OUTPUT_FILE_NAME</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">FILES_FILE_NAME</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">LOG_FILE_NAME</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stderr_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">STDERR_FILE_NAME</span><span class="p">))</span>

        <span class="c1"># This file is produce by Abinit if nprocs &gt; 1 and MPI_ABORT.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mpiabort_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">MPIABORTFILE</span><span class="p">))</span>

        <span class="c1"># Directories with input|output|temporary data.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">INDIR_NAME</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">OUTDIR_NAME</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">TMPDIR_NAME</span><span class="p">))</span></div>

    <span class="c1">#from abitask</span>
<div class="viewcode-block" id="AbiFireTask.rename_outputs"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.AbiFireTask.rename_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">rename_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If rerunning in the same folder, we rename the outputs according to the abipy convention:</span>
<span class="sd">        Abinit has the very *bad* habit of changing the file extension by appending the characters in [A,B ..., Z]</span>
<span class="sd">        to the output file, and this breaks a lot of code that relies of the use of a unique file extension.</span>
<span class="sd">        Here we fix this issue by renaming run.abo to run.abo_[number] if the output file &quot;run.abo&quot; already</span>
<span class="sd">        exists.</span>
<span class="sd">        This is applied both if the calculation is rerun from scratch or with a restart in the same folder.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">files_to_rename</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">output_file</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span><span class="o">.</span><span class="n">path</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files_to_rename</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="n">file_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">files_to_rename</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">file_path</span><span class="o">+</span><span class="s1">&#39;*&#39;</span><span class="p">)]</span>
        <span class="n">nums</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">file_paths</span><span class="p">]</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">isdigit</span><span class="p">()]</span>
        <span class="n">new_index</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span> <span class="k">if</span> <span class="n">nums</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span><span class="mi">1</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files_to_rename</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">new_path</span> <span class="o">=</span> <span class="n">f</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_index</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">new_path</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Renamed </span><span class="si">%s</span><span class="s2"> to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">new_path</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;couldn&#39;t rename </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2"> : </span><span class="si">{}</span><span class="s2"> &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">new_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)))</span></div>

    <span class="c1">#from AbintTask</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">filesfile_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String with the list of files and prefixes needed to execute ABINIT.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>
        <span class="n">pj</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span>

        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_file</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>                 <span class="c1"># Path to the input file</span>
        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_file</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>                <span class="c1"># Path to the output file</span>
        <span class="n">app</span><span class="p">(</span><span class="n">pj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">idata</span><span class="p">))</span>  <span class="c1"># Prefix for input data</span>
        <span class="n">app</span><span class="p">(</span><span class="n">pj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">odata</span><span class="p">))</span>  <span class="c1"># Prefix for output data</span>
        <span class="n">app</span><span class="p">(</span><span class="n">pj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">tdata</span><span class="p">))</span>  <span class="c1"># Prefix for temporary data</span>

        <span class="c1"># Paths to the pseudopotential files.</span>
        <span class="c1"># Note that here the pseudos **must** be sorted according to znucl.</span>
        <span class="c1"># Here we reorder the pseudos if the order is wrong.</span>
        <span class="n">ord_pseudos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">znucl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">()[</span><span class="s2">&quot;znucl&quot;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">znucl</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">pseudos</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">Z</span> <span class="o">==</span> <span class="n">z</span><span class="p">:</span>
                    <span class="n">ord_pseudos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot find pseudo with znucl </span><span class="si">%s</span><span class="s2"> in pseudos:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pseudos</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">pseudo</span> <span class="ow">in</span> <span class="n">ord_pseudos</span><span class="p">:</span>
            <span class="n">app</span><span class="p">(</span><span class="n">pseudo</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

<div class="viewcode-block" id="AbiFireTask.config_run"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.AbiFireTask.config_run">[docs]</a>    <span class="k">def</span> <span class="nf">config_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Configure the job for the run:</span>

<span class="sd">            - set up logging system</span>
<span class="sd">            - sets and creates the directories and the input files needed to run the task.</span>
<span class="sd">            - sets dependencies and data from previous run (both the case of a restart in the same folder as the previous</span>
<span class="sd">              FW and the case of a creation of a new folder).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># rename outputs if rerunning in the same dir</span>
        <span class="c1"># self.rename_outputs()</span>

        <span class="c1"># Copy the appropriate dependencies in the in dir</span>
        <span class="c1">#TODO it should be clarified if this should stay here or in setup_task().</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resolve_deps</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">)</span>

        <span class="c1"># if it&#39;s the restart of a previous task, perform specific task updates.</span>
        <span class="c1"># perform these updates before writing the input, but after creating the dirs.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_info</span><span class="p">:</span>
            <span class="c1">#TODO add if it is a local restart or not</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">log_restart</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">restart_info</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">restart</span><span class="p">()</span>

        <span class="c1"># Write files file and input file.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">files_file</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">files_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filesfile_string</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">input_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="p">))</span></div>

<div class="viewcode-block" id="AbiFireTask.run_abinit"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.AbiFireTask.run_abinit">[docs]</a>    <span class="k">def</span> <span class="nf">run_abinit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes abinit and waits for the end of the process.</span>
<span class="sd">        The mpirun and abinit commands are retrived from the mpirun_cmd and abinit_cmd keys in the fw_policy</span>
<span class="sd">        of the FWTaskManager, that can be overridden by the values in the spec.</span>
<span class="sd">        Note that in case of missing definition of these parameters, the values fall back to the default</span>
<span class="sd">        values of  mpirun_cmd and abinit_cmd: &#39;mpirun&#39; and &#39;abinit&#39;, assuming that these are properly retrieved</span>
<span class="sd">        from the $PATH.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">abinit_process</span><span class="p">():</span>
            <span class="n">command</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1">#consider the case of serial execution</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="o">.</span><span class="n">fw_policy</span><span class="o">.</span><span class="n">mpirun_cmd</span><span class="p">:</span>
                <span class="n">command</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="o">.</span><span class="n">fw_policy</span><span class="o">.</span><span class="n">mpirun_cmd</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
                <span class="k">if</span> <span class="s1">&#39;mpi_ncpus&#39;</span> <span class="ow">in</span> <span class="n">fw_spec</span><span class="p">:</span>
                    <span class="n">command</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;-n&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">[</span><span class="s1">&#39;mpi_ncpus&#39;</span><span class="p">])])</span>
            <span class="n">command</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="o">.</span><span class="n">fw_policy</span><span class="o">.</span><span class="n">abinit_cmd</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">walltime</span><span class="p">:</span>
                <span class="n">mytimelimit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">walltime</span>
                <span class="k">if</span> <span class="n">mytimelimit</span> <span class="o">&gt;</span> <span class="mi">240</span><span class="p">:</span>
                    <span class="n">mytimelimit</span> <span class="o">-=</span> <span class="mi">120</span>
                <span class="n">command</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;--timelimit&#39;</span><span class="p">,</span> <span class="n">time2slurm</span><span class="p">(</span><span class="n">mytimelimit</span><span class="p">)])</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files_file</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stdin</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_file</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stdout</span><span class="p">,</span> \
                    <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stderr_file</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stderr</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">stderr</span><span class="p">)</span>

            <span class="p">(</span><span class="n">stdoutdata</span><span class="p">,</span> <span class="n">stderrdata</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">returncode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">returncode</span>

        <span class="c1"># initialize returncode to avoid missing references in case of exception in the other thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returncode</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">abinit_process</span><span class="p">)</span>
        <span class="c1"># the amount of time left plus a buffer of 2 minutes</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">walltime</span> <span class="o">-</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span> <span class="o">-</span> <span class="mi">120</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">walltime</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">start_abinit_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">log_abinit_stop</span><span class="p">(</span><span class="n">run_time</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_abinit_time</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">WalltimeError</span><span class="p">(</span><span class="s2">&quot;The task couldn&#39;t be terminated within the time limit. Killed.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbiFireTask.get_event_report"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.AbiFireTask.get_event_report">[docs]</a>    <span class="k">def</span> <span class="nf">get_event_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyzes the main output file for possible Errors or Warnings. Will check the presence of an MPIABORTFILE</span>
<span class="sd">        if not output file is found.</span>

<span class="sd">        Args:</span>
<span class="sd">            source: &quot;output&quot; or &quot;log&quot;. Determine which file will be parsed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :class:`EventReport` instance or None if none of the output files exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ofile</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_file</span><span class="p">,</span>
            <span class="s2">&quot;log&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span><span class="p">}[</span><span class="n">source</span><span class="p">]</span>

        <span class="n">parser</span> <span class="o">=</span> <span class="n">events</span><span class="o">.</span><span class="n">EventsParser</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ofile</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpiabort_file</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># ABINIT abort file without log!</span>
                <span class="n">abort_report</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mpiabort_file</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">abort_report</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">report</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">ofile</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

            <span class="c1"># Add events found in the ABI_MPIABORTFILE.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mpiabort_file</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Found ABI_MPIABORTFILE!&quot;</span><span class="p">)</span>
                <span class="n">abort_report</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mpiabort_file</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">abort_report</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;ABI_MPIABORTFILE but empty&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">abort_report</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Found more than one event in ABI_MPIABORTFILE&quot;</span><span class="p">)</span>

                    <span class="c1"># Add it to the initial report only if it differs</span>
                    <span class="c1"># from the last one found in the main log file.</span>
                    <span class="n">last_abort_event</span> <span class="o">=</span> <span class="n">abort_report</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">report</span> <span class="ow">and</span> <span class="n">last_abort_event</span> <span class="o">!=</span> <span class="n">report</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">last_abort_event</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">report</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">last_abort_event</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">report</span>

        <span class="c1">#except parser.Error as exc:</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="c1"># Return a report with an error entry with info on the exception.</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: Exception while parsing ABINIT events:</span><span class="se">\n</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ofile</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)))</span>
            <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">report_exception</span><span class="p">(</span><span class="n">ofile</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbiFireTask.task_analysis"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.AbiFireTask.task_analysis">[docs]</a>    <span class="k">def</span> <span class="nf">task_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function checks final status of the calculation, inspecting the output and error files.</span>
<span class="sd">        Sets up the restart in case of convergence not achieved (both from abinit or from the convergence of</span>
<span class="sd">        cofiguration parameters) or in case of errors fixable by a ErrorHandler.</span>
<span class="sd">        If the job is completed calls conclude_task and prepares the FWAction.</span>
<span class="sd">        Raises an AbinitRuntimeError if unfixable errors are encountered or if the number or restarts exceeds</span>
<span class="sd">        the number defined in the policy.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">report</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">report</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_event_report</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> exception while parsing event_report:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># If the calculation is ok, parse the outputs</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># the calculation finished without errors</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">run_completed</span><span class="p">:</span>
                <span class="c1"># Check if the calculation converged.</span>
                <span class="n">not_ok</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">filter_types</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">CRITICAL_EVENTS</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">not_ok</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">log_unconverged</span><span class="p">()</span>
                    <span class="n">local_restart</span><span class="p">,</span> <span class="n">restart_fw</span><span class="p">,</span> <span class="n">stored_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_restart</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">)</span>
                    <span class="n">num_restarts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_info</span><span class="o">.</span><span class="n">num_restarts</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_info</span> <span class="k">else</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="n">num_restarts</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="o">.</span><span class="n">fw_policy</span><span class="o">.</span><span class="n">max_restarts</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">local_restart</span><span class="p">:</span>
                            <span class="k">return</span> <span class="kc">None</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">stored_data</span><span class="p">[</span><span class="s1">&#39;final_state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Unconverged&#39;</span>
                            <span class="k">return</span> <span class="n">FWAction</span><span class="p">(</span><span class="n">detours</span><span class="o">=</span><span class="n">restart_fw</span><span class="p">,</span> <span class="n">stored_data</span><span class="o">=</span><span class="n">stored_data</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">UnconvergedError</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;Unconverged after </span><span class="si">{}</span><span class="s2"> restarts&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_restarts</span><span class="p">),</span>
                                               <span class="n">abiinput</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="p">,</span> <span class="n">restart_info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">restart_info</span><span class="p">,</span>
                                               <span class="n">history</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># calculation converged</span>
                    <span class="c1"># check if there are custom parameters that should be converged</span>
                    <span class="n">unconverged_params</span><span class="p">,</span> <span class="n">reset_restart</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_parameters_convergence</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">unconverged_params</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">log_converge_params</span><span class="p">(</span><span class="n">unconverged_params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="o">**</span><span class="n">unconverged_params</span><span class="p">)</span>

                        <span class="n">local_restart</span><span class="p">,</span> <span class="n">restart_fw</span><span class="p">,</span> <span class="n">stored_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_restart</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="n">reset_restart</span><span class="p">)</span>
                        <span class="n">num_restarts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_info</span><span class="o">.</span><span class="n">num_restarts</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_info</span> <span class="k">else</span> <span class="mi">0</span>
                        <span class="k">if</span> <span class="n">num_restarts</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="o">.</span><span class="n">fw_policy</span><span class="o">.</span><span class="n">max_restarts</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">local_restart</span><span class="p">:</span>
                                <span class="k">return</span> <span class="kc">None</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">stored_data</span><span class="p">[</span><span class="s1">&#39;final_state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Unconverged_parameters&#39;</span>
                                <span class="k">return</span> <span class="n">FWAction</span><span class="p">(</span><span class="n">detours</span><span class="o">=</span><span class="n">restart_fw</span><span class="p">,</span> <span class="n">stored_data</span><span class="o">=</span><span class="n">stored_data</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">UnconvergedParametersError</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">abiinput</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="p">,</span>
                                                             <span class="n">restart_info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">restart_info</span><span class="p">,</span> <span class="n">history</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># everything is ok. conclude the task</span>
                        <span class="c1"># hook</span>
                        <span class="n">update_spec</span><span class="p">,</span> <span class="n">mod_spec</span><span class="p">,</span> <span class="n">stored_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conclude_task</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">FWAction</span><span class="p">(</span><span class="n">stored_data</span><span class="o">=</span><span class="n">stored_data</span><span class="p">,</span> <span class="n">update_spec</span><span class="o">=</span><span class="n">update_spec</span><span class="p">,</span> <span class="n">mod_spec</span><span class="o">=</span><span class="n">mod_spec</span><span class="p">)</span>

            <span class="c1"># Abinit reported problems</span>
            <span class="c1"># Check if the errors could be handled</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">errors</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Found errors in report&#39;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">errors</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">abi_errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">abi_errors</span> <span class="o">=</span> <span class="p">[</span><span class="n">error</span><span class="p">]</span>

                <span class="c1"># ABINIT errors, try to handle them</span>
                <span class="n">fixed</span><span class="p">,</span> <span class="n">reset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix_abicritical</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">fixed</span><span class="p">:</span>
                    <span class="n">local_restart</span><span class="p">,</span> <span class="n">restart_fw</span><span class="p">,</span> <span class="n">stored_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_restart</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="n">reset</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">local_restart</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">None</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">FWAction</span><span class="p">(</span><span class="n">detours</span><span class="o">=</span><span class="n">restart_fw</span><span class="p">,</span> <span class="n">stored_data</span><span class="o">=</span><span class="n">stored_data</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Critical events couldn&#39;t be fixed by handlers. return code </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returncode</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">AbinitRuntimeError</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Critical events couldn&#39;t be fixed by handlers&quot;</span><span class="p">)</span>

        <span class="c1"># No errors from abinit. No fix could be applied at this stage.</span>
        <span class="c1"># The FW will be fizzled.</span>
        <span class="c1"># Try to save the stderr file for Fortran runtime errors.</span>
        <span class="c1">#TODO check if some cases could be handled here</span>
        <span class="n">err_msg</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stderr_file</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span>
            <span class="c1">#TODO length should always be enough, but maybe it&#39;s worth cutting the message if it&#39;s too long</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stderr_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="c1"># It happened that the text file contained non utf-8 characters.</span>
            <span class="c1"># sanitize the text to avoid problems during database insertion</span>
            <span class="c1"># remove decode as incompatible with python 3</span>
            <span class="c1"># err_msg.decode(&quot;utf-8&quot;, &quot;ignore&quot;)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;return code </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returncode</span><span class="p">))</span>
        <span class="k">raise</span> <span class="n">AbinitRuntimeError</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">err_msg</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbiFireTask.check_parameters_convergence"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.AbiFireTask.check_parameters_convergence">[docs]</a>    <span class="k">def</span> <span class="nf">check_parameters_convergence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Base method related to the iterative convergence of some configuration parameter.</span>
<span class="sd">        Specific task should overwrite this method and implement appropriate checks and updates of the</span>
<span class="sd">        specific parameters.</span>

<span class="sd">        Args:</span>
<span class="sd">            fw_spec: The spec</span>

<span class="sd">        Returns:</span>
<span class="sd">            (tuple): tuple containing:</span>

<span class="sd">                - unconverged_params(dict): The uncoverged input variables that should be updated as keys and their</span>
<span class="sd">                    corresponding new values as values.</span>
<span class="sd">                - reset (boolean): True if a reset is required in self.prepare_restart.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">{},</span> <span class="kc">False</span></div>

    <span class="k">def</span> <span class="nf">_get_init_args_and_vals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inspection method to extract variables and values of the arguments of __init__ that should be stored in self.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">init_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">arg</span> <span class="o">!=</span> <span class="s2">&quot;self&quot;</span><span class="p">:</span>
                <span class="n">init_dict</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">init_dict</span>

    <span class="k">def</span> <span class="nf">_exclude_from_spec_in_restart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List of keys that should not be forwarded to the newly created firework in case of restart.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;_tasks&#39;</span><span class="p">,</span> <span class="s1">&#39;_exception_details&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="AbiFireTask.prepare_restart"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.AbiFireTask.prepare_restart">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_restart</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines the required information for the restart. It will be called at the end of a task which requires</span>
<span class="sd">        a restart (both for an error or for the convergence of some configuration parameter).</span>
<span class="sd">        Sets self.restart_info with an instance of RestartInfo.</span>

<span class="sd">        Args:</span>
<span class="sd">            fw_spec: the spec</span>
<span class="sd">            reset: if True a reset will be set in the restart_info</span>

<span class="sd">        Returns:</span>
<span class="sd">            (tuple): tuple containing:</span>

<span class="sd">                - local_restart (boolean): True if the restart should be in the same folder</span>
<span class="sd">                - new_fw (Firework): The new firework that should be used for detour</span>
<span class="sd">                - stored_data (dict): Dict to be saved in the &quot;stored_data&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_info</span><span class="p">:</span>
            <span class="n">num_restarts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_info</span><span class="o">.</span><span class="n">num_restarts</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_restarts</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">restart_info</span> <span class="o">=</span> <span class="n">RestartInfo</span><span class="p">(</span><span class="n">previous_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="n">reset</span><span class="p">,</span> <span class="n">num_restarts</span><span class="o">=</span><span class="n">num_restarts</span><span class="p">)</span>

        <span class="c1"># forward all the specs of the task</span>
        <span class="n">new_spec</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exclude_from_spec_in_restart</span><span class="p">()}</span>

        <span class="n">local_restart</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># only restart if it is known that there is a reasonable amount of time left</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="o">.</span><span class="n">fw_policy</span><span class="o">.</span><span class="n">allow_local_restart</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">walltime</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">walltime</span><span class="o">/</span><span class="mi">2</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">):</span>
            <span class="n">local_restart</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># run here the autorun, otherwise it would need a separated FW</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="o">.</span><span class="n">fw_policy</span><span class="o">.</span><span class="n">autoparal</span><span class="p">:</span>
            <span class="c1"># in case of restarting from the same folder the autoparal subfolder can already exist</span>
            <span class="c1"># create a new one with increasing number</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s2">&quot;autoparal</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">))):</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">autoparal_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s2">&quot;autoparal</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
            <span class="n">optconf</span><span class="p">,</span> <span class="n">qadapter_spec</span><span class="p">,</span> <span class="n">qtk_qadapter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_autoparal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="p">,</span> <span class="n">autoparal_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">log_autoparal</span><span class="p">(</span><span class="n">optconf</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">optconf</span><span class="o">.</span><span class="n">vars</span><span class="p">)</span>
            <span class="c1"># set quadapter specification.</span>
            <span class="n">new_spec</span><span class="p">[</span><span class="s1">&#39;_queueadapter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qadapter_spec</span>
            <span class="n">new_spec</span><span class="p">[</span><span class="s1">&#39;mpi_ncpus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optconf</span><span class="p">[</span><span class="s1">&#39;mpi_ncpus&#39;</span><span class="p">]</span>

            <span class="c1"># if autoparal enabled, the number of processors should match the current number to restart in place</span>
            <span class="n">local_restart</span> <span class="o">=</span> <span class="n">local_restart</span> <span class="ow">and</span> <span class="n">qadapter_spec</span> <span class="o">==</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_queueadapter&#39;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="c1"># increase the index associated with the specific task in the workflow</span>
        <span class="k">if</span> <span class="s1">&#39;wf_task_index&#39;</span> <span class="ow">in</span> <span class="n">fw_spec</span><span class="p">:</span>
            <span class="n">split</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="p">[</span><span class="s1">&#39;wf_task_index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="n">new_spec</span><span class="p">[</span><span class="s1">&#39;wf_task_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">split</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">split</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># new task. Construct it from the actual values of the input parameters</span>
        <span class="n">restart_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_init_args_and_vals</span><span class="p">())</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="o">.</span><span class="n">fw_policy</span><span class="o">.</span><span class="n">rerun_same_dir</span><span class="p">:</span>
            <span class="n">new_spec</span><span class="p">[</span><span class="s1">&#39;_launch_dir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span>

        <span class="c1"># create the new FW</span>
        <span class="n">new_fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">([</span><span class="n">restart_task</span><span class="p">],</span> <span class="n">spec</span><span class="o">=</span><span class="n">new_spec</span><span class="p">)</span>

        <span class="c1"># At this point the event report should be present</span>
        <span class="n">stored_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">stored_data</span><span class="p">[</span><span class="s1">&#39;report&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
        <span class="n">stored_data</span><span class="p">[</span><span class="s1">&#39;finalized&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">stored_data</span><span class="p">[</span><span class="s1">&#39;restarted&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">local_restart</span><span class="p">,</span> <span class="n">new_fw</span><span class="p">,</span> <span class="n">stored_data</span></div>

<div class="viewcode-block" id="AbiFireTask.fix_abicritical"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.AbiFireTask.fix_abicritical">[docs]</a>    <span class="k">def</span> <span class="nf">fix_abicritical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        method to fix crashes/error caused by abinit</span>

<span class="sd">        Returns:</span>
<span class="sd">            (tuple): tuple containing:</span>
<span class="sd">                retcode (int): 1 if task has been fixed else 0.</span>
<span class="sd">                reset (boolean): True if at least one of the corrections applied requires a reset</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Empty list of event handlers. Cannot fix abi_critical errors&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="n">done</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">)</span> <span class="o">*</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">corrections</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">handler</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">handler</span><span class="o">.</span><span class="n">can_handle</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">done</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;handler </span><span class="si">{}</span><span class="s2"> will try to fix </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">event</span><span class="p">))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">c</span> <span class="o">=</span> <span class="n">handler</span><span class="o">.</span><span class="n">handle_input_event</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
                            <span class="n">done</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">corrections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">corrections</span><span class="p">:</span>
            <span class="n">reset</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">reset</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">corrections</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">log_corrections</span><span class="p">(</span><span class="n">corrections</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">1</span><span class="p">,</span> <span class="n">reset</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;We encountered AbiCritical events that could not be fixed&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="AbiFireTask.setup_task"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.AbiFireTask.setup_task">[docs]</a>    <span class="k">def</span> <span class="nf">setup_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets up the requirements for the task:</span>
<span class="sd">            - sets several attributes</span>
<span class="sd">            - generates the input in case self.abiinput is a factory</span>
<span class="sd">            - makes directories</span>
<span class="sd">            - handles information in &#39;_exception_details&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_logger</span><span class="p">()</span>

        <span class="c1"># load the FWTaskManager to get configuration parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ftm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fw_task_manager</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">)</span>

        <span class="c1"># set walltime, if possible</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">walltime</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="o">.</span><span class="n">fw_policy</span><span class="o">.</span><span class="n">walltime_command</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="o">.</span><span class="n">fw_policy</span><span class="o">.</span><span class="n">walltime_command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                     <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
                <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">returncode</span>
                <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">out</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">walltime</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Impossible to get the walltime: &quot;</span> <span class="o">+</span> <span class="n">err</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Impossible to get the walltime: &quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># read autoparal policy from config if not explicitly set</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_autoparal</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_autoparal</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="o">.</span><span class="n">fw_policy</span><span class="o">.</span><span class="n">autoparal</span>

        <span class="n">initialization_info</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;initialization_info&#39;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="c1"># if the input is a factory, dynamically create the abinit input. From now on the code will expect an</span>
        <span class="c1"># AbinitInput and not a factory. In this case there should be either a single input coming from the previous</span>
        <span class="c1"># fws or a deps specifying which input use</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="p">,</span> <span class="n">InputFactory</span><span class="p">):</span>
            <span class="n">initialization_info</span><span class="p">[</span><span class="s1">&#39;input_factory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span>
            <span class="n">previous_input</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">input_required</span><span class="p">:</span>
                <span class="n">previous_fws</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;previous_fws&#39;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="c1"># check if the input source is specified</span>
                <span class="n">task_type_source</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">task_type_source</span> <span class="o">=</span> <span class="p">[</span><span class="n">tt</span> <span class="k">for</span> <span class="n">tt</span><span class="p">,</span> <span class="n">deps</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;@input&#39;</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="c1"># if not there should be only one previous fw</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">task_type_source</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">previous_fws</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;The input source cannot be identified from depenencies </span><span class="si">{}</span><span class="s1">. &#39;</span> \
                              <span class="s1">&#39;required by factory </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="n">InitializationError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="n">task_type_source</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">previous_fws</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># the task_type_source should contain just one task and contain the &#39;input&#39; key</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">previous_fws</span><span class="p">[</span><span class="n">task_type_source</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">previous_fws</span><span class="p">[</span><span class="n">task_type_source</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;The factory </span><span class="si">{}</span><span class="s1"> requires the input from previous run in the spec&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">InitializationError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="c1"># a single input exists</span>
                <span class="n">previous_input</span> <span class="o">=</span> <span class="n">previous_fws</span><span class="p">[</span><span class="n">task_type_source</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;input&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">previous_input</span><span class="p">,</span> <span class="n">AbinitInput</span><span class="p">):</span>
                    <span class="n">previous_input</span> <span class="o">=</span> <span class="n">AbinitInput</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">previous_input</span><span class="p">)</span>
                <span class="n">initialization_info</span><span class="p">[</span><span class="s1">&#39;previous_input&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">previous_input</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">build_input</span><span class="p">(</span><span class="n">previous_input</span><span class="p">)</span>

        <span class="n">initialization_info</span><span class="p">[</span><span class="s1">&#39;initial_input&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span>

        <span class="c1"># if it&#39;s the first run log the initialization of the task</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">log_initialization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initialization_info</span><span class="p">)</span>

        <span class="c1"># update data from previous run if it is not a restart</span>
        <span class="k">if</span> <span class="s1">&#39;previous_fws&#39;</span> <span class="ow">in</span> <span class="n">fw_spec</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_info</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_previous_fws_data</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_workdir</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>

        <span class="c1"># Create dirs for input, output and tmp data.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indir</span><span class="o">.</span><span class="n">makedirs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">makedirs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="o">.</span><span class="n">makedirs</span><span class="p">()</span>

        <span class="c1"># check if there is a rerun of the FW with info on the exception.</span>
        <span class="c1"># if that&#39;s the case use the restart information stored there to continue the calculation</span>
        <span class="n">exception_details</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;_exception_details&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># assume that DECODE_MONTY=True so that a handeled exception has already been deserialized</span>
        <span class="k">if</span> <span class="n">exception_details</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exception_details</span><span class="p">,</span> <span class="n">AbinitRuntimeError</span><span class="p">):</span>
            <span class="n">error_code</span> <span class="o">=</span> <span class="n">exception_details</span><span class="o">.</span><span class="n">ERROR_CODE</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="o">.</span><span class="n">fw_policy</span><span class="o">.</span><span class="n">continue_unconverged_on_rerun</span> <span class="ow">and</span> <span class="n">error_code</span><span class="o">==</span><span class="n">ErrorCode</span><span class="o">.</span><span class="n">UNCONVERGED</span> <span class="ow">and</span>
                    <span class="n">exception_details</span><span class="o">.</span><span class="n">abiinput</span> <span class="ow">and</span> <span class="n">exception_details</span><span class="o">.</span><span class="n">restart_info</span> <span class="ow">and</span>
                    <span class="n">exception_details</span><span class="o">.</span><span class="n">history</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span> <span class="o">=</span> <span class="n">exception_details</span><span class="o">.</span><span class="n">abiinput</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">restart_info</span> <span class="o">=</span> <span class="n">exception_details</span><span class="o">.</span><span class="n">restart_info</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">exception_details</span><span class="o">.</span><span class="n">history</span></div>

<div class="viewcode-block" id="AbiFireTask.run_task"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.AbiFireTask.run_task">[docs]</a>    <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup_task</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_autoparal</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">autoparal</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># loop to allow local restart</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">config_run</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">)</span>
                    <span class="c1"># try to recover previous run</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="o">.</span><span class="n">fw_policy</span><span class="o">.</span><span class="n">recover_previous_job</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_file</span><span class="o">.</span><span class="n">path</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">run_abinit</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">)</span>
                    <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_analysis</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">action</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">action</span>
        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="c1"># log the error in history and reraise</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Always dump the history for automatic parsing of the folders</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">HISTORY_JSON</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">MontyEncoder</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbiFireTask.restart"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.AbiFireTask.restart">[docs]</a>    <span class="k">def</span> <span class="nf">restart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Restart method. Each subclass should implement its own restart. It is called at the beginning of a task</span>
<span class="sd">        that is the restart of a previous one. The base class should be called for common restarting operations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="AbiFireTask.conclude_task"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.AbiFireTask.conclude_task">[docs]</a>    <span class="k">def</span> <span class="nf">conclude_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs operations that should be handled at the end of the tasks in case of successful completion.</span>
<span class="sd">        Subclasses can overwrite to add additional operations, but the returns should be the same and</span>
<span class="sd">        it is suggested to call original method with super.</span>

<span class="sd">        Args:</span>
<span class="sd">            fw_spec: the spec</span>

<span class="sd">        Returns:</span>
<span class="sd">            (tuple): tuple containing:</span>
<span class="sd">                update_spec (dict): dictionary that should be passed to update_spec</span>
<span class="sd">                mod_spec (dict): dictionary that should be passed to mod_spec</span>
<span class="sd">                stored_data (dict): dictionary that should be passed to stored_data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stored_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">stored_data</span><span class="p">[</span><span class="s1">&#39;report&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
        <span class="n">stored_data</span><span class="p">[</span><span class="s1">&#39;finalized&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">log_finalized</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="p">)</span>
        <span class="n">stored_data</span><span class="p">[</span><span class="s1">&#39;history&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
        <span class="n">update_spec</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">mod_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_final_mod_spec</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">update_spec</span><span class="p">,</span> <span class="n">mod_spec</span><span class="p">,</span> <span class="n">stored_data</span></div>

<div class="viewcode-block" id="AbiFireTask.current_task_info"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.AbiFireTask.current_task_info">[docs]</a>    <span class="k">def</span> <span class="nf">current_task_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A dict containing information that should be passed to subsequent tasks.</span>
<span class="sd">        It should contain at least the current workdir and input. Subclasses can add specific additional information.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbiFireTask.autoparal"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.AbiFireTask.autoparal">[docs]</a>    <span class="k">def</span> <span class="nf">autoparal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs the task in autoparal and creates the new Firework with the optimized configuration.</span>

<span class="sd">        Args:</span>
<span class="sd">            fw_spec: the spec</span>

<span class="sd">        Returns:</span>
<span class="sd">            The FWAction containing the detour Firework.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Copy the appropriate dependencies in the in dir. needed in some cases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resolve_deps</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">)</span>

        <span class="n">optconf</span><span class="p">,</span> <span class="n">qadapter_spec</span><span class="p">,</span> <span class="n">qtk_qadapter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_autoparal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">log_autoparal</span><span class="p">(</span><span class="n">optconf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">optconf</span><span class="o">.</span><span class="n">vars</span><span class="p">)</span>

        <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_init_args_and_vals</span><span class="p">())</span>
        <span class="n">task</span><span class="o">.</span><span class="n">is_autoparal</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># forward all the specs of the task</span>
        <span class="n">new_spec</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;_tasks&#39;</span><span class="p">}</span>
        <span class="c1"># set quadapter specification. Note that mpi_ncpus may be different from ntasks</span>
        <span class="n">new_spec</span><span class="p">[</span><span class="s1">&#39;_queueadapter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qadapter_spec</span>
        <span class="n">new_spec</span><span class="p">[</span><span class="s1">&#39;mpi_ncpus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optconf</span><span class="p">[</span><span class="s1">&#39;mpi_ncpus&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;wf_task_index&#39;</span> <span class="ow">in</span> <span class="n">fw_spec</span><span class="p">:</span>
            <span class="n">split</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="p">[</span><span class="s1">&#39;wf_task_index&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="n">new_spec</span><span class="p">[</span><span class="s1">&#39;wf_task_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">split</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">new_fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">([</span><span class="n">task</span><span class="p">],</span> <span class="n">new_spec</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">FWAction</span><span class="p">(</span><span class="n">detours</span><span class="o">=</span><span class="n">new_fw</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbiFireTask.resolve_deps_per_task_type"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.AbiFireTask.resolve_deps_per_task_type">[docs]</a>    <span class="k">def</span> <span class="nf">resolve_deps_per_task_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">previous_tasks</span><span class="p">,</span> <span class="n">deps_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to link the required deps for the current FW for a specific task_type.</span>
<span class="sd">        Sets the ird variables corresponding to the linked dependecies.</span>

<span class="sd">        Args:</span>
<span class="sd">            previous_tasks: list of previous tasks from which the dependencies should be linked</span>
<span class="sd">            deps_list: list of dependencies that should be linked</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">previous_task</span> <span class="ow">in</span> <span class="n">previous_tasks</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">deps_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;@structure&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="s1">&#39;structure&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">previous_task</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;previous_fws does not contain the structure.&quot;</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="n">InitializationError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">set_structure</span><span class="p">(</span><span class="n">previous_task</span><span class="p">[</span><span class="s1">&#39;structure&#39;</span><span class="p">])</span>
                <span class="c1">#FIXME out.nc is not safe. Check if needed and move to other nc files in case.</span>
                <span class="c1"># elif d.startswith(&#39;@outnc&#39;):</span>
                <span class="c1">#     varname = d.split(&#39;.&#39;)[1]</span>
                <span class="c1">#     outnc_path = os.path.join(previous_task[&#39;dir&#39;], self.prefix.odata + &quot;_OUT.nc&quot;)</span>
                <span class="c1">#     outnc_file = OutNcFile(outnc_path)</span>
                <span class="c1">#     vars = {varname: outnc_file[varname]}</span>
                <span class="c1">#     self.abiinput.set_vars(vars)</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">d</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">):</span>
                    <span class="n">source_dir</span> <span class="o">=</span> <span class="n">previous_task</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">irdvars_for_ext</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="s2">&quot;DDK&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">link_ddk</span><span class="p">(</span><span class="n">source_dir</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">d</span> <span class="o">==</span> <span class="s2">&quot;1WF&quot;</span> <span class="ow">or</span> <span class="n">d</span> <span class="o">==</span> <span class="s2">&quot;1DEN&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">link_1ext</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">source_dir</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">link_ext</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">source_dir</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbiFireTask.resolve_deps"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.AbiFireTask.resolve_deps">[docs]</a>    <span class="k">def</span> <span class="nf">resolve_deps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to link the required deps for the current FW.</span>
<span class="sd">        Note that different cases are handled here depending whether the current FW is a restart or not and whether</span>
<span class="sd">        the rerun is performed in the same folder or not.</span>
<span class="sd">        In case of restart the safest choice is to link the deps of the previous FW, so that if they have been</span>
<span class="sd">        updated in the meanwhile we are taking the correct one.</span>
<span class="sd">        TODO: this last case sounds quite unlikely and should be tested</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># If no deps, nothing to do here</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_info</span><span class="p">:</span>
            <span class="c1"># If this is the first run of the task, the informations are taken from the &#39;previous_fws&#39;,</span>
            <span class="c1"># that should be present.</span>
            <span class="n">previous_fws</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;previous_fws&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">previous_fws</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No previous_fws data. Needed for dependecies </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">InitializationError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="c1"># check that there is only one previous_fws</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">previous_fws</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">previous_fws</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;previous_fws does not contain a single reference. &quot;</span> \
                          <span class="s2">&quot;Specify the dependency for </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">InitializationError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">resolve_deps_per_task_type</span><span class="p">(</span><span class="n">previous_fws</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># deps should be a dict</span>
                <span class="k">for</span> <span class="n">task_type</span><span class="p">,</span> <span class="n">deps_list</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">task_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">previous_fws</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No previous_fws data for task type </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_type</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="n">InitializationError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">previous_fws</span><span class="p">[</span><span class="n">task_type</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Previous_fws does not contain any reference for task type </span><span class="si">{}</span><span class="s2">, &quot;</span> \
                              <span class="s2">&quot;needed in reference </span><span class="si">{}</span><span class="s2">. &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="n">InitializationError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">previous_fws</span><span class="p">[</span><span class="n">task_type</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Previous_fws contains more than a single reference for task type </span><span class="si">{}</span><span class="s2">, &quot;</span> \
                              <span class="s2">&quot;needed in reference </span><span class="si">{}</span><span class="s2">. Risk of overwriting.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">resolve_deps_per_task_type</span><span class="p">(</span><span class="n">previous_fws</span><span class="p">[</span><span class="n">task_type</span><span class="p">],</span> <span class="n">deps_list</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If it is a restart, link the one from the previous task.</span>
            <span class="c1"># If it&#39;s in the same dir, it is assumed that the dependencies have been correctly resolved in the previous</span>
            <span class="c1"># run. So do nothing</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_info</span><span class="o">.</span><span class="n">previous_dir</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;rerunning in the same dir, no action on the deps&#39;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="c1">#just link everything from the indata folder of the previous run. files needed for restart will be overwritten</span>
            <span class="n">prev_indata</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">restart_info</span><span class="o">.</span><span class="n">previous_dir</span><span class="p">,</span> <span class="n">INDIR_NAME</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">prev_indata</span><span class="p">):</span>
                <span class="c1"># if the target is already a link, link to the source to avoid many nested levels of linking</span>
                <span class="n">source</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prev_indata</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
                    <span class="n">source</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">readlink</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">INDIR_NAME</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span></div>

<div class="viewcode-block" id="AbiFireTask.load_previous_fws_data"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.AbiFireTask.load_previous_fws_data">[docs]</a>    <span class="k">def</span> <span class="nf">load_previous_fws_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Called if a previous_fws key is in spec and the job is not a restart. Allows to load information from previous</span>
<span class="sd">        tasks if needed. Subclasses can overwrite to handle specific cases.</span>

<span class="sd">        Args:</span>
<span class="sd">            fw_spec: The spec</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="AbiFireTask.out_to_in"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.AbiFireTask.out_to_in">[docs]</a>    <span class="k">def</span> <span class="nf">out_to_in</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        links or copies, according to the fw_policy, the output file to the input data directory of this task</span>
<span class="sd">        and rename the file so that ABINIT will read it as an input data file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The absolute path of the new file in the indata directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">in_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">out_file</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;out&quot;</span><span class="p">,</span> <span class="s2">&quot;in&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indir</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">in_file</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">dest</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Will overwrite </span><span class="si">%s</span><span class="s2"> with </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">out_file</span><span class="p">))</span>

        <span class="c1"># if rerunning in the same folder the file should be moved anyway</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="o">.</span><span class="n">fw_policy</span><span class="o">.</span><span class="n">copy_deps</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_info</span><span class="o">.</span><span class="n">previous_dir</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># if dest already exists should be overwritten. see also resolve_deps and config_run</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">EEXIST</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>

        <span class="k">return</span> <span class="n">dest</span></div>

<div class="viewcode-block" id="AbiFireTask.in_to_in"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.AbiFireTask.in_to_in">[docs]</a>    <span class="k">def</span> <span class="nf">in_to_in</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Copies the input file to the input of a previous task to the data directory of this task</span>

<span class="sd">        Returns:</span>
<span class="sd">            The absolute path of the new file in the indata directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indir</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">in_file</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">dest</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Will overwrite </span><span class="si">%s</span><span class="s2"> with </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">in_file</span><span class="p">))</span>

        <span class="c1"># os.rename(out_file, dest)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">in_file</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dest</span></div>

<div class="viewcode-block" id="AbiFireTask.remove_restart_vars"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.AbiFireTask.remove_restart_vars">[docs]</a>    <span class="k">def</span> <span class="nf">remove_restart_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes from the current input the ird values associated with the extension.</span>
<span class="sd">        Useful in case of reset during a restart.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exts</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">exts</span> <span class="o">=</span> <span class="p">[</span><span class="n">exts</span><span class="p">]</span>

        <span class="n">remove_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">exts</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">irdvars_for_ext</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">remove_vars</span><span class="p">(</span><span class="n">remove_vars</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Removing variables </span><span class="si">{}</span><span class="s2"> from input&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">remove_vars</span><span class="p">))</span></div></div>


<span class="c1">##############################</span>
<span class="c1"># Specific tasks</span>
<span class="c1">##############################</span>


<div class="viewcode-block" id="GsFWTask"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.GsFWTask">[docs]</a><span class="k">class</span> <span class="nc">GsFWTask</span><span class="p">(</span><span class="n">AbiFireTask</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base Task to handle Ground state calculation.</span>

<span class="sd">    .. rubric:: Inheritance Diagram</span>
<span class="sd">    .. inheritance-diagram:: GsFWTask</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">gsr_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Absolute path of the GSR file. Empty string if file is not present.&quot;&quot;&quot;</span>
        <span class="c1"># Lazy property to avoid multiple calls to has_abiext.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gsr_path</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">has_abiext</span><span class="p">(</span><span class="s2">&quot;GSR&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">path</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gsr_path</span> <span class="o">=</span> <span class="n">path</span>
            <span class="k">return</span> <span class="n">path</span>

<div class="viewcode-block" id="GsFWTask.open_gsr"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.GsFWTask.open_gsr">[docs]</a>    <span class="k">def</span> <span class="nf">open_gsr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open the GSR.nc_ file located in the in self.outdir.</span>
<span class="sd">        Returns |GsrFile| object, raise a PostProcessError exception if file could not be found or file is not readable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gsr_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gsr_path</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">gsr_path</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No GSR file available for task </span><span class="si">{}</span><span class="s2"> in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">PostProcessError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Open the GSR file.</span>
        <span class="kn">from</span> <span class="nn">abipy.electrons.gsr</span> <span class="k">import</span> <span class="n">GsrFile</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">GsrFile</span><span class="p">(</span><span class="n">gsr_path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Exception while reading GSR file at </span><span class="si">%s</span><span class="s2">:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gsr_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">PostProcessError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ScfFWTask"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.ScfFWTask">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">ScfFWTask</span><span class="p">(</span><span class="n">GsFWTask</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Task to handle SCF calculations</span>

<span class="sd">    .. rubric:: Inheritance Diagram</span>
<span class="sd">    .. inheritance-diagram:: ScfFWTask</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">task_type</span> <span class="o">=</span> <span class="s2">&quot;scf&quot;</span>

    <span class="n">CRITICAL_EVENTS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">events</span><span class="o">.</span><span class="n">ScfConvergenceWarning</span><span class="p">,</span>
    <span class="p">]</span>

<div class="viewcode-block" id="ScfFWTask.restart"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.ScfFWTask.restart">[docs]</a>    <span class="k">def</span> <span class="nf">restart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;SCF calculations can be restarted if we have either the WFK file or the DEN file.&quot;&quot;&quot;</span>
        <span class="c1"># Prefer WFK over DEN files since we can reuse the wavefunctions.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_info</span><span class="o">.</span><span class="n">reset</span><span class="p">:</span>
            <span class="c1"># remove non reset keys that may have been added in a previous restart</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_restart_vars</span><span class="p">([</span><span class="s2">&quot;WFK&quot;</span><span class="p">,</span> <span class="s2">&quot;DEN&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;WFK&quot;</span><span class="p">,</span> <span class="s2">&quot;DEN&quot;</span><span class="p">):</span>
                <span class="n">restart_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_info</span><span class="o">.</span><span class="n">prev_outdir</span><span class="o">.</span><span class="n">has_abiext</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>
                <span class="n">irdvars</span> <span class="o">=</span> <span class="n">irdvars_for_ext</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">restart_file</span><span class="p">:</span> <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Cannot find WFK or DEN file to restart from.&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">RestartError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="c1"># Move out --&gt; in.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out_to_in</span><span class="p">(</span><span class="n">restart_file</span><span class="p">)</span>

            <span class="c1"># Add the appropriate variable for restarting.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">irdvars</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="NscfFWTask"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.NscfFWTask">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">NscfFWTask</span><span class="p">(</span><span class="n">GsFWTask</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Task to handle non SCF calculations</span>

<span class="sd">    .. rubric:: Inheritance Diagram</span>
<span class="sd">    .. inheritance-diagram:: NscfFWTask</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">task_type</span> <span class="o">=</span> <span class="s2">&quot;nscf&quot;</span>

    <span class="n">CRITICAL_EVENTS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">events</span><span class="o">.</span><span class="n">NscfConvergenceWarning</span><span class="p">,</span>
    <span class="p">]</span>

<div class="viewcode-block" id="NscfFWTask.restart"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.NscfFWTask.restart">[docs]</a>    <span class="k">def</span> <span class="nf">restart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;NSCF calculations can be restarted only if we have the WFK file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_info</span><span class="o">.</span><span class="n">reset</span><span class="p">:</span>
            <span class="c1"># remove non reset keys that may have been added in a previous restart</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_restart_vars</span><span class="p">([</span><span class="s2">&quot;WFK&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="s2">&quot;WFK&quot;</span>
            <span class="n">restart_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_info</span><span class="o">.</span><span class="n">prev_outdir</span><span class="o">.</span><span class="n">has_abiext</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">restart_file</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Cannot find the WFK file to restart from.&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">RestartError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="c1"># Move out --&gt; in.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out_to_in</span><span class="p">(</span><span class="n">restart_file</span><span class="p">)</span>

            <span class="c1"># Add the appropriate variable for restarting.</span>
            <span class="n">irdvars</span> <span class="o">=</span> <span class="n">irdvars_for_ext</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">irdvars</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="NscfWfqFWTask"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.NscfWfqFWTask">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">NscfWfqFWTask</span><span class="p">(</span><span class="n">NscfFWTask</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Task to handle non SCF calculations for the calculations of the WFQ.</span>
<span class="sd">    Differs from :class:`NscfFWTask` for the different restart requirements.</span>

<span class="sd">    .. rubric:: Inheritance Diagram</span>
<span class="sd">    .. inheritance-diagram:: NscfWfqFWTask</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">task_type</span> <span class="o">=</span> <span class="s2">&quot;nscf_wfq&quot;</span>

<div class="viewcode-block" id="NscfWfqFWTask.restart"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.NscfWfqFWTask.restart">[docs]</a>    <span class="k">def</span> <span class="nf">restart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        NSCF calculations can be restarted only if we have the WFK file.</span>
<span class="sd">        Wfq calculations require a WFK file for restart. The produced out_WFQ</span>
<span class="sd">        needs to be linked as a in_WFK with appropriate irdwfk=1.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_info</span><span class="o">.</span><span class="n">reset</span><span class="p">:</span>
            <span class="c1"># remove non reset keys that may have been added in a previous restart</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_restart_vars</span><span class="p">([</span><span class="s2">&quot;WFQ&quot;</span><span class="p">,</span> <span class="s2">&quot;WFK&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="s2">&quot;WFQ&quot;</span>
            <span class="n">restart_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_info</span><span class="o">.</span><span class="n">prev_outdir</span><span class="o">.</span><span class="n">has_abiext</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">restart_file</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Cannot find the WFK file to restart from.&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">RestartError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="c1"># Move out --&gt; in.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out_to_in</span><span class="p">(</span><span class="n">restart_file</span><span class="p">)</span>

            <span class="c1"># Add the appropriate variable for restarting.</span>
            <span class="n">irdvars</span> <span class="o">=</span> <span class="n">irdvars_for_ext</span><span class="p">(</span><span class="s2">&quot;WFK&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">irdvars</span><span class="p">)</span></div>

<div class="viewcode-block" id="NscfWfqFWTask.out_to_in"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.NscfWfqFWTask.out_to_in">[docs]</a>    <span class="k">def</span> <span class="nf">out_to_in</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        links or copies, according to the fw_policy, the output file to the input data directory of this task</span>
<span class="sd">        and rename the file so that ABINIT will read it as an input data file.</span>
<span class="sd">        In the case of Wfq calculations out_WFQ needs to be linked as a in_WFK</span>

<span class="sd">        Returns:</span>
<span class="sd">            The absolute path of the new file in the indata directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">in_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">out_file</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;out&quot;</span><span class="p">,</span> <span class="s2">&quot;in&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">in_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">in_file</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;WFQ&quot;</span><span class="p">,</span> <span class="s2">&quot;WFK&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indir</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">in_file</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">dest</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Will overwrite </span><span class="si">%s</span><span class="s2"> with </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">out_file</span><span class="p">))</span>

        <span class="c1"># if rerunning in the same folder the file should be moved anyway</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="o">.</span><span class="n">fw_policy</span><span class="o">.</span><span class="n">copy_deps</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_info</span><span class="o">.</span><span class="n">previous_dir</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># if dest already exists should be overwritten. see also resolve_deps and config_run</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">EEXIST</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>

        <span class="k">return</span> <span class="n">dest</span></div></div>

<div class="viewcode-block" id="RelaxFWTask"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.RelaxFWTask">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">RelaxFWTask</span><span class="p">(</span><span class="n">GsFWTask</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Task to handle relax calculations</span>

<span class="sd">    .. rubric:: Inheritance Diagram</span>
<span class="sd">    .. inheritance-diagram:: RelaxFWTask</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">task_type</span> <span class="o">=</span> <span class="s2">&quot;relax&quot;</span>

    <span class="n">CRITICAL_EVENTS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">events</span><span class="o">.</span><span class="n">RelaxConvergenceWarning</span><span class="p">,</span>
    <span class="p">]</span>

<div class="viewcode-block" id="RelaxFWTask.get_final_structure"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.RelaxFWTask.get_final_structure">[docs]</a>    <span class="k">def</span> <span class="nf">get_final_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read the final structure from the GSR.nc_ file.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_gsr</span><span class="p">()</span> <span class="k">as</span> <span class="n">gsr</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">gsr</span><span class="o">.</span><span class="n">structure</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Cannot find the GSR file with the final structure to restart from.&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">PostProcessError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>

<div class="viewcode-block" id="RelaxFWTask.prepare_restart"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.RelaxFWTask.prepare_restart">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_restart</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the final structure in abiinput, so that the relax can continue in the detour and calls the baseclass</span>
<span class="sd">        method.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">set_structure</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_final_structure</span><span class="p">())</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">RelaxFWTask</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">prepare_restart</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">,</span> <span class="n">reset</span><span class="p">)</span></div>

<div class="viewcode-block" id="RelaxFWTask.restart"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.RelaxFWTask.restart">[docs]</a>    <span class="k">def</span> <span class="nf">restart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Restart the structural relaxation.</span>

<span class="sd">        See original RelaxTask for more details</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_info</span><span class="o">.</span><span class="n">reset</span><span class="p">:</span>
            <span class="c1"># remove non reset keys that may have been added in a previous restart</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_restart_vars</span><span class="p">([</span><span class="s2">&quot;WFK&quot;</span><span class="p">,</span> <span class="s2">&quot;DEN&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># for optcell &gt; 0 it may fail to restart if paral_kgb == 0. Do not use DEN or WFK in this case</span>
            <span class="c1">#FIXME fix when Matteo makes the restart possible for paral_kgb == 0</span>
            <span class="n">paral_kgb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;paral_kgb&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">optcell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;optcell&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">optcell</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">paral_kgb</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">restart_file</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="c1"># Try to restart from the WFK file if possible.</span>
                <span class="c1"># FIXME: This part has been disabled because WFK=IO is a mess if paral_kgb == 1</span>
                <span class="c1"># This is also the reason why I wrote my own MPI-IO code for the GW part!</span>
                <span class="n">wfk_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_info</span><span class="o">.</span><span class="n">prev_outdir</span><span class="o">.</span><span class="n">has_abiext</span><span class="p">(</span><span class="s2">&quot;WFK&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">wfk_file</span><span class="p">:</span>
                    <span class="n">irdvars</span> <span class="o">=</span> <span class="n">irdvars_for_ext</span><span class="p">(</span><span class="s2">&quot;WFK&quot;</span><span class="p">)</span>
                    <span class="n">restart_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_to_in</span><span class="p">(</span><span class="n">wfk_file</span><span class="p">)</span>

                <span class="c1"># Fallback to DEN file. Note that here we look for out_DEN instead of out_TIM?_DEN</span>
                <span class="c1"># This happens when the previous run completed and task.on_done has been performed.</span>
                <span class="c1"># ********************************************************************************</span>
                <span class="c1"># Note that it&#39;s possible to have an undected error if we have multiple restarts</span>
                <span class="c1"># and the last relax died badly. In this case indeed out_DEN is the file produced</span>
                <span class="c1"># by the last run that has executed on_done.</span>
                <span class="c1"># ********************************************************************************</span>
                <span class="k">if</span> <span class="n">restart_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">out_den</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_info</span><span class="o">.</span><span class="n">prev_outdir</span><span class="o">.</span><span class="n">path_in</span><span class="p">(</span><span class="s2">&quot;out_DEN&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">out_den</span><span class="p">):</span>
                        <span class="n">irdvars</span> <span class="o">=</span> <span class="n">irdvars_for_ext</span><span class="p">(</span><span class="s2">&quot;DEN&quot;</span><span class="p">)</span>
                        <span class="n">restart_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_to_in</span><span class="p">(</span><span class="n">out_den</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">restart_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Try to restart from the last TIM?_DEN file.</span>
                    <span class="c1"># This should happen if the previous run didn&#39;t complete in clean way.</span>
                    <span class="c1"># Find the last TIM?_DEN file.</span>
                    <span class="n">last_timden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_info</span><span class="o">.</span><span class="n">prev_outdir</span><span class="o">.</span><span class="n">find_last_timden_file</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">last_timden</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">last_timden</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.nc&quot;</span><span class="p">):</span>
                            <span class="n">in_file_name</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;in_DEN.nc&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">in_file_name</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;in_DEN&quot;</span><span class="p">)</span>
                        <span class="n">restart_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_to_in_tim</span><span class="p">(</span><span class="n">last_timden</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">in_file_name</span><span class="p">)</span>
                        <span class="n">irdvars</span> <span class="o">=</span> <span class="n">irdvars_for_ext</span><span class="p">(</span><span class="s2">&quot;DEN&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">restart_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Don&#39;t raise RestartError as the structure has been updated</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Cannot find the WFK|DEN|TIM?_DEN file to restart from.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Add the appropriate variable for restarting.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">irdvars</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Will restart from </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">restart_file</span><span class="p">)</span></div>

<div class="viewcode-block" id="RelaxFWTask.current_task_info"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.RelaxFWTask.current_task_info">[docs]</a>    <span class="k">def</span> <span class="nf">current_task_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add the final structure to the basic current_task_info</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">d</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">RelaxFWTask</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">current_task_info</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">)</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;structure&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_final_structure</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">d</span></div>

    <span class="c1"># def conclude_task(self, fw_spec):</span>
    <span class="c1">#     update_spec, mod_spec, stored_data = super(RelaxFWTask, self).conclude_task(fw_spec)</span>
    <span class="c1">#     update_spec[&#39;previous_run&#39;][&#39;structure&#39;] = self.get_final_structure()</span>
    <span class="c1">#     return update_spec, mod_spec, stored_data</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hist_nc_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Absolute path of the HIST.nc_ file. Empty string if file is not present.&quot;&quot;&quot;</span>
        <span class="c1"># Lazy property to avoid multiple calls to has_abiext.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hist_nc_path</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">has_abiext</span><span class="p">(</span><span class="s2">&quot;HIST&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">path</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hist_nc_path</span> <span class="o">=</span> <span class="n">path</span>
            <span class="k">return</span> <span class="n">path</span>

<div class="viewcode-block" id="RelaxFWTask.out_to_in_tim"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.RelaxFWTask.out_to_in_tim">[docs]</a>    <span class="k">def</span> <span class="nf">out_to_in_tim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_file</span><span class="p">,</span> <span class="n">in_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        links or copies, according to the fw_policy, the output file to the input data directory of this task</span>
<span class="sd">        and rename the file so that ABINIT will read it as an input data file. for the TIM file the input needs to</span>
<span class="sd">        be specified as depends on the specific iteration.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The absolute path of the new file in the indata directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indir</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">in_file</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">dest</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Will overwrite </span><span class="si">%s</span><span class="s2"> with </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">out_file</span><span class="p">))</span>

        <span class="c1"># if rerunning in the same folder the file should be moved anyway</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="o">.</span><span class="n">fw_policy</span><span class="o">.</span><span class="n">copy_deps</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_info</span><span class="o">.</span><span class="n">previous_dir</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># if dest already exists should be overwritten. see also resolve_deps and config_run</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">EEXIST</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>

        <span class="k">return</span> <span class="n">dest</span></div></div>


<div class="viewcode-block" id="HybridFWTask"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.HybridFWTask">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">HybridFWTask</span><span class="p">(</span><span class="n">GsFWTask</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Task to handle hybrid functional calculations based on GW.</span>

<span class="sd">    .. rubric:: Inheritance Diagram</span>
<span class="sd">    .. inheritance-diagram:: HybridFWTask</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">task_type</span> <span class="o">=</span> <span class="s2">&quot;hybrid&quot;</span>

    <span class="n">CRITICAL_EVENTS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sigres_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Absolute path of the SIGRES.nc file. Empty string if file is not present.&quot;&quot;&quot;</span>
        <span class="c1"># Lazy property to avoid multiple calls to has_abiext.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sigres_path</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">has_abiext</span><span class="p">(</span><span class="s2">&quot;SIGRES&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">path</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sigres_path</span> <span class="o">=</span> <span class="n">path</span>
            <span class="k">return</span> <span class="n">path</span>

<div class="viewcode-block" id="HybridFWTask.open_sigres"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.HybridFWTask.open_sigres">[docs]</a>    <span class="k">def</span> <span class="nf">open_sigres</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open the SIGRES.nc_ file located in the in self.outdir.</span>
<span class="sd">        Returns |SigresFile| object, None if file could not be found or file is not readable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sigres_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigres_path</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">sigres_path</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> didn&#39;t produce a SIGRES file in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">PostProcessError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Open the SIGRES file and add its data to results.out</span>
        <span class="kn">from</span> <span class="nn">abipy.electrons.gw</span> <span class="k">import</span> <span class="n">SigresFile</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SigresFile</span><span class="p">(</span><span class="n">sigres_path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Exception while reading SIGRES file at </span><span class="si">%s</span><span class="s2">:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sigres_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">PostProcessError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="DfptTask"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.DfptTask">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">DfptTask</span><span class="p">(</span><span class="n">AbiFireTask</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base Task to handle DFPT calculations</span>

<span class="sd">    .. rubric:: Inheritance Diagram</span>
<span class="sd">    .. inheritance-diagram:: DfptTask</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">CRITICAL_EVENTS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">events</span><span class="o">.</span><span class="n">ScfConvergenceWarning</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">task_type</span> <span class="o">=</span> <span class="s2">&quot;dfpt&quot;</span>

<div class="viewcode-block" id="DfptTask.restart"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.DfptTask.restart">[docs]</a>    <span class="k">def</span> <span class="nf">restart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Phonon calculations can be restarted only if we have the 1WF file or the 1DEN file.</span>
<span class="sd">        from which we can read the first-order wavefunctions or the first order density.</span>
<span class="sd">        Prefer 1WF over 1DEN since we can reuse the wavefunctions.</span>
<span class="sd">        Try to handle an input with many perturbation calculated at the same time. link/copy all the 1WF or 1DEN files</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Abinit adds the idir-ipert index at the end of the file and this breaks the extension</span>
        <span class="c1"># e.g. out_1WF4, out_DEN4. find_1wf_files and find_1den_files returns the list of files found</span>
        <span class="c1">#TODO check for reset</span>
        <span class="n">restart_files</span><span class="p">,</span> <span class="n">irdvars</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

        <span class="c1"># Highest priority to the 1WF file because restart is more efficient.</span>
        <span class="n">wf_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_info</span><span class="o">.</span><span class="n">prev_outdir</span><span class="o">.</span><span class="n">find_1wf_files</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">wf_files</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">restart_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">path</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">wf_files</span><span class="p">]</span>
            <span class="n">irdvars</span> <span class="o">=</span> <span class="n">irdvars_for_ext</span><span class="p">(</span><span class="s2">&quot;1WF&quot;</span><span class="p">)</span>
            <span class="c1"># if len(wf_files) != 1:</span>
            <span class="c1">#     restart_files = None</span>
            <span class="c1">#     logger.critical(&quot;Found more than one 1WF file. Restart is ambiguous!&quot;)</span>

        <span class="k">if</span> <span class="n">restart_files</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">den_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_info</span><span class="o">.</span><span class="n">prev_outdir</span><span class="o">.</span><span class="n">find_1den_files</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">den_files</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">restart_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">path</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">den_files</span><span class="p">]</span>
                <span class="n">irdvars</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ird1den&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
                <span class="c1"># if len(den_files) != 1:</span>
                <span class="c1">#     restart_files = None</span>
                <span class="c1">#     logger.critical(&quot;Found more than one 1DEN file. Restart is ambiguous!&quot;)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">restart_files</span><span class="p">:</span>
            <span class="c1"># Raise because otherwise restart is equivalent to a run from scratch --&gt; infinite loop!</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Cannot find the 1WF|1DEN file to restart from.&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">RestartError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Move file.</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">restart_files</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">out_to_in</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="c1"># Add the appropriate variable for restarting.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">irdvars</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="DdkTask"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.DdkTask">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">DdkTask</span><span class="p">(</span><span class="n">DfptTask</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Task to handle DDK calculations</span>

<span class="sd">    .. rubric:: Inheritance Diagram</span>
<span class="sd">    .. inheritance-diagram:: DdkTask</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">task_type</span> <span class="o">=</span> <span class="s2">&quot;ddk&quot;</span>

<div class="viewcode-block" id="DdkTask.conclude_task"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.DdkTask.conclude_task">[docs]</a>    <span class="k">def</span> <span class="nf">conclude_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extends the base class method in order to create a _DDK file from the 1WF.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># make a link to _DDK of the 1WF file to ease the link in the dependencies</span>
        <span class="n">wf_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">find_1wf_files</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">wf_files</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PostProcessError</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t link 1WF files.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">wf_files</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">path</span><span class="o">+</span><span class="s1">&#39;_DDK&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">DdkTask</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">conclude_task</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="DdeTask"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.DdeTask">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">DdeTask</span><span class="p">(</span><span class="n">DfptTask</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Task to handle DDE calculations</span>

<span class="sd">    .. rubric:: Inheritance Diagram</span>
<span class="sd">    .. inheritance-diagram:: DdeTask</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">task_type</span> <span class="o">=</span> <span class="s2">&quot;dde&quot;</span></div>


<div class="viewcode-block" id="PhononTask"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.PhononTask">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">PhononTask</span><span class="p">(</span><span class="n">DfptTask</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Task to handle phonon calculations</span>

<span class="sd">    .. rubric:: Inheritance Diagram</span>
<span class="sd">    .. inheritance-diagram:: PhononTask</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">task_type</span> <span class="o">=</span> <span class="s2">&quot;phonon&quot;</span></div>


<div class="viewcode-block" id="BecTask"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.BecTask">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">BecTask</span><span class="p">(</span><span class="n">DfptTask</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Task to handle BEC calculations</span>

<span class="sd">    .. rubric:: Inheritance Diagram</span>
<span class="sd">    .. inheritance-diagram:: BecTask</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">task_type</span> <span class="o">=</span> <span class="s2">&quot;bec&quot;</span></div>


<div class="viewcode-block" id="StrainPertTask"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.StrainPertTask">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">StrainPertTask</span><span class="p">(</span><span class="n">DfptTask</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Task to handle strain calculations</span>

<span class="sd">    .. rubric:: Inheritance Diagram</span>
<span class="sd">    .. inheritance-diagram:: StrainPertTask</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">task_type</span> <span class="o">=</span> <span class="s2">&quot;strain_pert&quot;</span></div>


<div class="viewcode-block" id="DteTask"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.DteTask">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">DteTask</span><span class="p">(</span><span class="n">DfptTask</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Task to handle the third derivatives with respect to the electric field.</span>

<span class="sd">    .. rubric:: Inheritance Diagram</span>
<span class="sd">    .. inheritance-diagram:: DteTask</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">CRITICAL_EVENTS</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">task_type</span> <span class="o">=</span> <span class="s2">&quot;dte&quot;</span>

    <span class="c1"># non-linear does not support autoparal. Take the suggested number of processors.</span>
<div class="viewcode-block" id="DteTask.run_autoparal"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.DteTask.run_autoparal">[docs]</a>    <span class="k">def</span> <span class="nf">run_autoparal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">abiinput</span><span class="p">,</span> <span class="n">autoparal_dir</span><span class="p">,</span> <span class="n">ftm</span><span class="p">,</span> <span class="n">clean_up</span><span class="o">=</span><span class="s1">&#39;move&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Non-linear does not support autoparal, so this will provide a fake run of the autoparal.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_fake_autoparal</span><span class="p">(</span><span class="n">ftm</span><span class="p">)</span></div></div>


<span class="c1">##############################</span>
<span class="c1"># Convergence tasks</span>
<span class="c1">##############################</span>

<div class="viewcode-block" id="RelaxDilatmxFWTask"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.RelaxDilatmxFWTask">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">RelaxDilatmxFWTask</span><span class="p">(</span><span class="n">RelaxFWTask</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Task to handle relax calculations with iterative convergence of the dilatmx</span>

<span class="sd">    .. rubric:: Inheritance Diagram</span>
<span class="sd">    .. inheritance-diagram:: DteTask</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">abiinput</span><span class="p">,</span> <span class="n">restart_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">handlers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_autoparal</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">history</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">target_dilatmx</span><span class="o">=</span><span class="mf">1.01</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">handlers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">handlers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">history</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_dilatmx</span> <span class="o">=</span> <span class="n">target_dilatmx</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RelaxDilatmxFWTask</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">abiinput</span><span class="o">=</span><span class="n">abiinput</span><span class="p">,</span> <span class="n">restart_info</span><span class="o">=</span><span class="n">restart_info</span><span class="p">,</span> <span class="n">handlers</span><span class="o">=</span><span class="n">handlers</span><span class="p">,</span>
                                                 <span class="n">is_autoparal</span><span class="o">=</span><span class="n">is_autoparal</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="n">deps</span><span class="p">,</span> <span class="n">history</span><span class="o">=</span><span class="n">history</span><span class="p">)</span>

<div class="viewcode-block" id="RelaxDilatmxFWTask.check_parameters_convergence"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.RelaxDilatmxFWTask.check_parameters_convergence">[docs]</a>    <span class="k">def</span> <span class="nf">check_parameters_convergence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if the target value for the dilatmx has been reached. If not reduces the values for the dilatmx and</span>
<span class="sd">        signals that a restart is needed.</span>

<span class="sd">        Args:</span>
<span class="sd">            fw_spec: the spec of the Firework</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">actual_dilatmx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dilatmx&#39;</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>
        <span class="n">new_dilatmx</span> <span class="o">=</span> <span class="n">actual_dilatmx</span> <span class="o">-</span> <span class="nb">min</span><span class="p">((</span><span class="n">actual_dilatmx</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">target_dilatmx</span><span class="p">),</span> <span class="n">actual_dilatmx</span><span class="o">*</span><span class="mf">0.03</span><span class="p">)</span>
        <span class="c1">#FIXME reset can be False with paral_kgb==1</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;dilatmx&#39;</span><span class="p">:</span> <span class="n">new_dilatmx</span><span class="p">}</span> <span class="k">if</span> <span class="n">new_dilatmx</span> <span class="o">!=</span> <span class="n">actual_dilatmx</span> <span class="k">else</span> <span class="p">{},</span> <span class="kc">True</span></div></div>


<span class="c1">##############################</span>
<span class="c1"># Wrapper tasks</span>
<span class="c1">##############################</span>


<div class="viewcode-block" id="MergeDdbAbinitTask"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.MergeDdbAbinitTask">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">MergeDdbAbinitTask</span><span class="p">(</span><span class="n">BasicAbinitTaskMixin</span><span class="p">,</span> <span class="n">FireTaskBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Task to handle the merge of multiple DDB files with mrgddb</span>

<span class="sd">    .. rubric:: Inheritance Diagram</span>
<span class="sd">    .. inheritance-diagram:: MergeDdbAbinitTask</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">task_type</span> <span class="o">=</span> <span class="s2">&quot;mrgddb&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ddb_source_task_types</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">delete_source_ddbs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">num_ddbs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">task_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ddb_source_task_type: list of task types that will be used as source for the DDB to be merged.</span>
<span class="sd">        The default is [PhononTask.task_type, DdeTask.task_type, BecTask.task_type]</span>
<span class="sd">        delete_ddbs: delete the ddb files used after the merge</span>
<span class="sd">        num_ddbs: number of ddbs to be merged. If set will be used to check that the correct number of ddbs have been</span>
<span class="sd">         passed to the task. Tha task will fizzle if the numbers do not match</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">ddb_source_task_types</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ddb_source_task_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">ScfFWTask</span><span class="o">.</span><span class="n">task_type</span><span class="p">,</span> <span class="n">PhononTask</span><span class="o">.</span><span class="n">task_type</span><span class="p">,</span> <span class="n">DdeTask</span><span class="o">.</span><span class="n">task_type</span><span class="p">,</span> <span class="n">BecTask</span><span class="o">.</span><span class="n">task_type</span><span class="p">,</span>
                                     <span class="n">DteTask</span><span class="o">.</span><span class="n">task_type</span><span class="p">,</span> <span class="n">StrainPertTask</span><span class="o">.</span><span class="n">task_type</span><span class="p">]</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ddb_source_task_types</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">ddb_source_task_types</span> <span class="o">=</span> <span class="p">[</span><span class="n">ddb_source_task_types</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ddb_source_task_types</span> <span class="o">=</span> <span class="n">ddb_source_task_types</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delete_source_ddbs</span> <span class="o">=</span> <span class="n">delete_source_ddbs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_ddbs</span> <span class="o">=</span> <span class="n">num_ddbs</span>

        <span class="k">if</span> <span class="n">task_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task_type</span> <span class="o">=</span> <span class="n">task_type</span>

<div class="viewcode-block" id="MergeDdbAbinitTask.get_ddb_list"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.MergeDdbAbinitTask.get_ddb_list">[docs]</a>    <span class="k">def</span> <span class="nf">get_ddb_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">previous_fws</span><span class="p">,</span> <span class="n">task_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given a task_type that can produce DDB files and whole list of previous fireworks available here,</span>
<span class="sd">        gets the list of DDB files that should be merged.</span>

<span class="sd">        Args:</span>
<span class="sd">            previous_fws: list of previous fireworks</span>
<span class="sd">            task_type: string describing the task type</span>

<span class="sd">        Returns:</span>
<span class="sd">            The list of DDB files that should be linked</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ddb_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1">#Check that the same directory is not passed more than once (in principle it should not be needed.</span>
        <span class="c1"># kept from previous version to avoid regressions)</span>
        <span class="n">mydirs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">previous_fws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task_type</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="k">if</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">mydirs</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># filepaths = Directory(os.path.join(t[&#39;dir&#39;], OUTDIR_NAME)).list_filepaths()</span>
            <span class="c1"># a DDB.nc is usually produced along with the text DDB file. has_abiext handles the extraction of</span>
            <span class="c1"># the text one, ignoring the netCDF. If has_abiext is changed the problem should be handled here.</span>
            <span class="c1"># ddb = self.get_ddb_from_filepaths(filepaths=filepaths)</span>
            <span class="n">ddb</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">],</span> <span class="n">OUTDIR_NAME</span><span class="p">))</span><span class="o">.</span><span class="n">has_abiext</span><span class="p">(</span><span class="s1">&#39;DDB&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ddb</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;One of the task of type </span><span class="si">{}</span><span class="s2"> (folder: </span><span class="si">{}</span><span class="s2">) &quot;</span> \
                      <span class="s2">&quot;did not produce a DDB file!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_type</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">])</span>
                <span class="k">raise</span> <span class="n">InitializationError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">mydirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">])</span>
            <span class="n">ddb_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ddb</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ddb_files</span></div>

    <span class="c1"># def get_ddb_from_filepaths(self, filepaths):</span>
    <span class="c1">#     #TODO: temporary fix due to new DDB.nc in addition to DDB ... then has_abiext finds multiple multiple files ...</span>
    <span class="c1">#     ext = &#39;_DDB&#39;</span>
    <span class="c1">#</span>
    <span class="c1">#     files = []</span>
    <span class="c1">#     for f in filepaths:</span>
    <span class="c1">#         if f.endswith(ext):</span>
    <span class="c1">#             files.append(f)</span>
    <span class="c1">#</span>
    <span class="c1">#     if not files:</span>
    <span class="c1">#         return None</span>
    <span class="c1">#</span>
    <span class="c1">#     if len(files) &gt; 1:</span>
    <span class="c1">#         # ABINIT users must learn that multiple datasets are bad!</span>
    <span class="c1">#         err_msg = &quot;Found multiple files with the same extensions:\n %s\nPlease avoid the use of mutiple datasets!&quot; % files</span>
    <span class="c1">#         raise ValueError(err_msg)</span>
    <span class="c1">#</span>
    <span class="c1">#     return files[0]</span>

<div class="viewcode-block" id="MergeDdbAbinitTask.get_event_report"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.MergeDdbAbinitTask.get_event_report">[docs]</a>    <span class="k">def</span> <span class="nf">get_event_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ofile_name</span><span class="o">=</span><span class="s2">&quot;mrgddb.stdout&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyzes the main output file for possible Errors or Warnings.</span>

<span class="sd">        Args:</span>
<span class="sd">            ofile_name: Name of the outpu file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            :class:`EventReport` instance or None if the output file does not exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ofile</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">ofile_name</span><span class="p">))</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">events</span><span class="o">.</span><span class="n">EventsParser</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ofile</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">report</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">ofile</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">report</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="c1"># Return a report with an error entry with info on the exception.</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: Exception while parsing MRGDDB events:</span><span class="se">\n</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ofile</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)))</span>
                <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">report_exception</span><span class="p">(</span><span class="n">ofile</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span></div>

<div class="viewcode-block" id="MergeDdbAbinitTask.set_workdir"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.MergeDdbAbinitTask.set_workdir">[docs]</a>    <span class="k">def</span> <span class="nf">set_workdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workdir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets up the working directory: adds attributes for all the files and directories.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="o">=</span> <span class="n">workdir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">OUTDIR_NAME</span><span class="p">))</span></div>

<div class="viewcode-block" id="MergeDdbAbinitTask.run_task"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.MergeDdbAbinitTask.run_task">[docs]</a>    <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_workdir</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">makedirs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">TaskHistory</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ftm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fw_task_manager</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ftm</span><span class="o">.</span><span class="n">has_task_manager</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">InitializationError</span><span class="p">(</span><span class="s2">&quot;No task manager available: mrgddb could not be performed.&quot;</span><span class="p">)</span>
            <span class="n">mrgddb</span> <span class="o">=</span> <span class="n">Mrgddb</span><span class="p">(</span><span class="n">manager</span><span class="o">=</span><span class="n">ftm</span><span class="o">.</span><span class="n">task_manager</span><span class="p">,</span> <span class="n">executable</span><span class="o">=</span><span class="n">ftm</span><span class="o">.</span><span class="n">fw_policy</span><span class="o">.</span><span class="n">mrgddb_cmd</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="n">previous_fws</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="p">[</span><span class="s1">&#39;previous_fws&#39;</span><span class="p">]</span>
            <span class="n">ddb_files</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">source_task_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddb_source_task_types</span><span class="p">:</span>
                <span class="n">ddb_files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_ddb_list</span><span class="p">(</span><span class="n">previous_fws</span><span class="p">,</span> <span class="n">source_task_type</span><span class="p">))</span>

            <span class="n">initialization_info</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;initialization_info&#39;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">initialization_info</span><span class="p">[</span><span class="s1">&#39;ddb_files_list&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ddb_files</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">log_initialization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initialization_info</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">ddb_files</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InitializationError</span><span class="p">(</span><span class="s2">&quot;No DDB files to merge.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_ddbs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_ddbs</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ddb_files</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">InitializationError</span><span class="p">(</span><span class="s2">&quot;Wrong number of DDB files: </span><span class="si">{}</span><span class="s2"> DDB files have been requested, &quot;</span>
                                          <span class="s2">&quot;but </span><span class="si">{}</span><span class="s2"> have been linked&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_ddbs</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ddb_files</span><span class="p">)))</span>

            <span class="c1"># keep the output in the outdata dir for consistency</span>
            <span class="n">out_ddb</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">OUTDIR_NAME</span><span class="p">,</span> <span class="s2">&quot;out_DDB&quot;</span><span class="p">)</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="s2">&quot;DDB file merged by </span><span class="si">%s</span><span class="s2"> on </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">())</span>

            <span class="n">out_ddb</span> <span class="o">=</span> <span class="n">mrgddb</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">ddb_files</span><span class="p">,</span> <span class="n">out_ddb</span><span class="o">=</span><span class="n">out_ddb</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span>
                                   <span class="n">delete_source_ddbs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">delete_source_ddbs</span><span class="p">)</span>

            <span class="c1"># Temporary fix ... mrgddb doesnt seem to work when I merge the GS DDB file with the Strain DDB file</span>
            <span class="c1"># because the info on the pseudopotentials is not in the GS DDB file ...</span>
            <span class="c1">#  www.welcome2quickanddirty.com (DavidWaroquiers)</span>
            <span class="k">if</span> <span class="s1">&#39;PAW_datasets_description_correction&#39;</span> <span class="ow">in</span> <span class="n">fw_spec</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ddb_files</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Fix is temporary and only for a number of DDBs equal to 2&#39;</span><span class="p">)</span>
                <span class="n">fname_with_psp</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">psp_lines</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">ddb_files</span><span class="p">:</span>
                    <span class="n">in_psp_info</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                        <span class="n">dd</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                        <span class="k">for</span> <span class="n">iline</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dd</span><span class="p">):</span>
                            <span class="k">if</span> <span class="s1">&#39;No information on the potentials yet&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                                <span class="k">break</span>
                            <span class="k">if</span> <span class="s1">&#39;Description of the PAW dataset(s)&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                                <span class="n">in_psp_info</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="n">fname_with_psp</span> <span class="o">=</span> <span class="n">fname</span>
                            <span class="k">if</span> <span class="n">in_psp_info</span><span class="p">:</span>
                                <span class="k">if</span> <span class="s1">&#39;**** Database of total energy derivatives ****&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                                    <span class="k">break</span>
                                <span class="n">psp_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">fname_with_psp</span><span class="p">:</span>
                        <span class="k">break</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">fname_with_psp</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Should have at least one DDB with the psp info ...&#39;</span><span class="p">)</span>

                <span class="n">out_ddb_backup</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.backup&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_ddb</span><span class="p">)</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">out_ddb</span><span class="p">,</span> <span class="n">out_ddb_backup</span><span class="p">)</span>

                <span class="n">fw</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_ddb</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_ddb_backup</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                    <span class="n">dd</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                    <span class="n">just_copy</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">dd</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;Description of the PAW dataset(s)&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                            <span class="n">just_copy</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">for</span> <span class="n">pspline</span> <span class="ow">in</span> <span class="n">psp_lines</span><span class="p">:</span>
                                <span class="n">fw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pspline</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">just_copy</span><span class="p">:</span>
                            <span class="n">fw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                            <span class="k">continue</span>
                        <span class="k">if</span> <span class="s1">&#39;**** Database of total energy derivatives ****&#39;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                            <span class="n">just_copy</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">fw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                            <span class="k">continue</span>
                <span class="n">fw</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">report</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_event_report</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">out_ddb</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">report</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">errors</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">AbinitRuntimeError</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s2">&quot;Error during mrgddb.&quot;</span><span class="p">)</span>

            <span class="n">stored_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">finalized</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">mod_spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_final_mod_spec</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">log_finalized</span><span class="p">()</span>

            <span class="k">return</span> <span class="n">FWAction</span><span class="p">(</span><span class="n">stored_data</span><span class="o">=</span><span class="n">stored_data</span><span class="p">,</span> <span class="n">mod_spec</span><span class="o">=</span><span class="n">mod_spec</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="c1"># log the error in history and reraise</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">HISTORY_JSON</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">MontyEncoder</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span></div>

<div class="viewcode-block" id="MergeDdbAbinitTask.current_task_info"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.MergeDdbAbinitTask.current_task_info">[docs]</a>    <span class="k">def</span> <span class="nf">current_task_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A dict containing information that should be passed to subsequent tasks.</span>
<span class="sd">        In this case it contains the current workdir.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">merged_ddb_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Absolute path of the merged DDB file. Empty string if file is not present.&quot;&quot;&quot;</span>
        <span class="c1"># Lazy property to avoid multiple calls to has_abiext.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_merged_ddb_path</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">has_abiext</span><span class="p">(</span><span class="s2">&quot;DDB&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">path</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_merged_ddb_path</span> <span class="o">=</span> <span class="n">path</span>
            <span class="k">return</span> <span class="n">path</span></div>


<div class="viewcode-block" id="AnaDdbAbinitTask"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.AnaDdbAbinitTask">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">AnaDdbAbinitTask</span><span class="p">(</span><span class="n">BasicAbinitTaskMixin</span><span class="p">,</span> <span class="n">FireTaskBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Task that handles the run of anaddb based on a custom input</span>

<span class="sd">    .. rubric:: Inheritance Diagram</span>
<span class="sd">    .. inheritance-diagram:: AnaDdbAbinitTask</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">task_type</span> <span class="o">=</span> <span class="s2">&quot;anaddb&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">anaddb_input</span><span class="p">,</span> <span class="n">restart_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">handlers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_autoparal</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">history</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">task_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            anaddb_input: |AnaddbInput| object. Defines the input used in the run</span>
<span class="sd">            restart_info: an instance of RestartInfo. This should be present in case the current task is a restart.</span>
<span class="sd">                Contains information useful to proceed with the restart.</span>
<span class="sd">            handlers: list of ErrorHandlers that should be used in case of error. If None all the error handlers</span>
<span class="sd">                available from abipy will be used.</span>
<span class="sd">            is_autoparal: whether the current task is just an autoparal job or not.</span>
<span class="sd">            deps: the required file dependencies from previous tasks (e.g. DEN, WFK, ...). Can be a single string,</span>
<span class="sd">                a list or a dict of the form {task_type: list of dependecies}. The dependencies will be retrieved</span>
<span class="sd">                from the &#39;previous_tasks&#39; key in spec.</span>
<span class="sd">            history: a TaskHistory or a list of items that will be stored in a TaskHistory instance.</span>
<span class="sd">            task_type: a string that, if not None, overrides the task_type defined in the class.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">handlers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">handlers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">history</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">anaddb_input</span> <span class="o">=</span> <span class="n">anaddb_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restart_info</span> <span class="o">=</span> <span class="n">restart_info</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="n">handlers</span> <span class="ow">or</span> <span class="p">[</span><span class="bp">cls</span><span class="p">()</span> <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">events</span><span class="o">.</span><span class="n">get_event_handler_classes</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_autoparal</span> <span class="o">=</span> <span class="n">is_autoparal</span>

        <span class="c1">#TODO: rationalize this and check whether this might create problems due to the fact that if task_type is None,</span>
        <span class="c1">#      self.task_type is the class variable (actually self.task_type refers to self.__class__.task_type) while</span>
        <span class="c1">#      if task_type is specified, self.task_type is an instance variable and is potentially different from</span>
        <span class="c1">#      self.__class__.task_type !</span>
        <span class="k">if</span> <span class="n">task_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task_type</span> <span class="o">=</span> <span class="n">task_type</span>

        <span class="c1"># deps are transformed to be a list or a dict of lists</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">deps</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">deps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                    <span class="n">deps</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">deps</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="p">[</span><span class="n">deps</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deps</span> <span class="o">=</span> <span class="n">deps</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">TaskHistory</span><span class="p">(</span><span class="n">history</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ec_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Absolute path of the GSR.nc_ file. Empty string if file is not present.&quot;&quot;&quot;</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rundir</span><span class="o">.</span><span class="n">has_abiext</span><span class="p">(</span><span class="s2">&quot;EC&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ec_path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="k">return</span> <span class="n">path</span>

<div class="viewcode-block" id="AnaDdbAbinitTask.get_elastic_tensor"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.AnaDdbAbinitTask.get_elastic_tensor">[docs]</a>    <span class="k">def</span> <span class="nf">get_elastic_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tensor_type</span><span class="o">=</span><span class="s1">&#39;relaxed_ion&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open the EC file located in the in self.workdir.</span>
<span class="sd">        Returns :class:`ElasticConstant` object, None if file could not be found or file is not readable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ec_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ec_path</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ec_path</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> reached the conclusion but didn&#39;t produce a EC file in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">PostProcessError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">ec</span> <span class="o">=</span> <span class="n">ElasticComplianceTensor</span><span class="o">.</span><span class="n">from_ec_nc_file</span><span class="p">(</span><span class="n">ec_path</span><span class="p">,</span> <span class="n">tensor_type</span><span class="o">=</span><span class="n">tensor_type</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ec</span></div>

<div class="viewcode-block" id="AnaDdbAbinitTask.resolve_deps_per_task_type"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.AnaDdbAbinitTask.resolve_deps_per_task_type">[docs]</a>    <span class="k">def</span> <span class="nf">resolve_deps_per_task_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">previous_tasks</span><span class="p">,</span> <span class="n">deps_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to link the required deps for the current FW for a specific task_type.</span>

<span class="sd">        Args:</span>
<span class="sd">            previous_tasks: list of previous tasks from which the dependencies should be linked</span>
<span class="sd">            deps_list: list of dependencies that should be linked</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ddb_dirs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">previous_task</span> <span class="ow">in</span> <span class="n">previous_tasks</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">deps_list</span><span class="p">:</span>
                <span class="n">source_dir</span> <span class="o">=</span> <span class="n">previous_task</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="s2">&quot;DDB&quot;</span><span class="p">:</span>
                    <span class="c1"># Check that the same directory is not passed more than once (in principle it should not be needed.</span>
                    <span class="c1"># kept from previous version to avoid regressions)</span>
                    <span class="k">if</span> <span class="n">source_dir</span> <span class="ow">in</span> <span class="n">ddb_dirs</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">ddb_dirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">source_dir</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ddb_filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_ext</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">source_dir</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">d</span> <span class="o">==</span> <span class="s2">&quot;GKK&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">gkk_filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_ext</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">source_dir</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">d</span> <span class="o">==</span> <span class="s2">&quot;DDK&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ddk_filepaths</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">link_ddk</span><span class="p">(</span><span class="n">source_dir</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Extensions </span><span class="si">{}</span><span class="s2"> is not used in anaddb and will be ignored&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
                    <span class="k">continue</span></div>

<div class="viewcode-block" id="AnaDdbAbinitTask.resolve_deps"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.AnaDdbAbinitTask.resolve_deps">[docs]</a>    <span class="k">def</span> <span class="nf">resolve_deps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to link the required deps for the current FW.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#FIXME extract common method with AbinitTask</span>
        <span class="n">previous_fws</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;previous_fws&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">previous_fws</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No previous_fws data. Needed for dependecies </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">InitializationError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="c1"># check that there is only one previous_fws</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">previous_fws</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">previous_fws</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;previous_fws does not contain a single reference. &quot;</span> \
                      <span class="s2">&quot;Specify the dependency for </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">InitializationError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">resolve_deps_per_task_type</span><span class="p">(</span><span class="n">previous_fws</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># deps should be a dict</span>
            <span class="k">for</span> <span class="n">task_type</span><span class="p">,</span> <span class="n">deps_list</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">task_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">previous_fws</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No previous_fws data for task type </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_type</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">InitializationError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">previous_fws</span><span class="p">[</span><span class="n">task_type</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Previous_fws does not contain any reference for task type </span><span class="si">{}</span><span class="s2">, &quot;</span> \
                          <span class="s2">&quot;needed in reference </span><span class="si">{}</span><span class="s2">. &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">InitializationError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">previous_fws</span><span class="p">[</span><span class="n">task_type</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Previous_fws contains more than a single reference for task type </span><span class="si">{}</span><span class="s2">, &quot;</span> \
                          <span class="s2">&quot;needed in reference </span><span class="si">{}</span><span class="s2">. Risk of overwriting.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">resolve_deps_per_task_type</span><span class="p">(</span><span class="n">previous_fws</span><span class="p">[</span><span class="n">task_type</span><span class="p">],</span> <span class="n">deps_list</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnaDdbAbinitTask.run_anaddb"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.AnaDdbAbinitTask.run_anaddb">[docs]</a>    <span class="k">def</span> <span class="nf">run_anaddb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        executes anaddb and waits for the end of the process.</span>
<span class="sd">        TODO: make it general in the same way as &quot;run_abinit&quot;</span>
<span class="sd">        the mpirun command is retrived from the mpirun_cmd keys in the fw_polity</span>
<span class="sd">        of the FWTaskManager, that can be overridden by the values in the spec.</span>
<span class="sd">        Note that in case of missing definition of this parameter, the values fall back to the default</span>
<span class="sd">        value of  mpirun_cmd: &#39;mpirun&#39;, assuming that it is properly retrived</span>
<span class="sd">        from the $PATH. By default, anaddb is retrieved from the PATH.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">anaddb_process</span><span class="p">():</span>
            <span class="n">command</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1">#consider the case of serial execution</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="o">.</span><span class="n">fw_policy</span><span class="o">.</span><span class="n">mpirun_cmd</span><span class="p">:</span>
                <span class="n">command</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="o">.</span><span class="n">fw_policy</span><span class="o">.</span><span class="n">mpirun_cmd</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
                <span class="k">if</span> <span class="s1">&#39;mpi_ncpus&#39;</span> <span class="ow">in</span> <span class="n">fw_spec</span><span class="p">:</span>
                    <span class="n">command</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;-n&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">[</span><span class="s1">&#39;mpi_ncpus&#39;</span><span class="p">])])</span>
            <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="o">.</span><span class="n">fw_policy</span><span class="o">.</span><span class="n">anaddb_cmd</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files_file</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stdin</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_file</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stdout</span><span class="p">,</span> \
                    <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stderr_file</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stderr</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">stderr</span><span class="p">)</span>

            <span class="p">(</span><span class="n">stdoutdata</span><span class="p">,</span> <span class="n">stderrdata</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">returncode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">returncode</span>

        <span class="c1"># initialize returncode to avoid missing references in case of exception in the other thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returncode</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">anaddb_process</span><span class="p">)</span>
        <span class="c1"># the amount of time left plus a buffer of 2 minutes</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">walltime</span> <span class="o">-</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span> <span class="o">-</span> <span class="mi">120</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">walltime</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">WalltimeError</span><span class="p">(</span><span class="s2">&quot;The task couldn&#39;t be terminated within the time limit. Killed.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnaDdbAbinitTask.setup_task"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.AnaDdbAbinitTask.setup_task">[docs]</a>    <span class="k">def</span> <span class="nf">setup_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets up the requirements for the task:</span>
<span class="sd">            - sets several attributes</span>
<span class="sd">            - makes directories</span>
<span class="sd">            - writes input files</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_logger</span><span class="p">()</span>

        <span class="c1"># load the FWTaskManager to get configuration parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ftm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fw_task_manager</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">)</span>

        <span class="c1"># set walltime, if possible</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">walltime</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="o">.</span><span class="n">fw_policy</span><span class="o">.</span><span class="n">walltime_command</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="o">.</span><span class="n">fw_policy</span><span class="o">.</span><span class="n">walltime_command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                     <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
                <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">returncode</span>
                <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">walltime</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Impossible to get the walltime: &quot;</span> <span class="o">+</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Impossible to get the walltime: &quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># setting working directory and files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_workdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">indir</span><span class="o">.</span><span class="n">makedirs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">makedirs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="o">.</span><span class="n">makedirs</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ddb_filepath</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gkk_filepath</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddk_filepaths</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">resolve_deps</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">)</span>

        <span class="c1"># the DDB file is needed. If not set as a dependency, look for it in all the possible sources</span>
        <span class="c1">#FIXME check if we can remove this case and just rely on deps</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddb_filepath</span><span class="p">:</span>
            <span class="n">previous_fws</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="p">[</span><span class="s1">&#39;previous_fws&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">task_class</span> <span class="ow">in</span> <span class="n">DfptTask</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="n">DfptTask</span><span class="p">]:</span>
                <span class="n">task_type</span> <span class="o">=</span> <span class="n">task_class</span><span class="o">.</span><span class="n">task_type</span>
                <span class="n">ddb_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">previous_task</span> <span class="ow">in</span> <span class="n">previous_fws</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task_type</span><span class="p">,</span> <span class="p">[]):</span>
                    <span class="n">ddb_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">link_ext</span><span class="p">(</span><span class="s2">&quot;DDB&quot;</span><span class="p">,</span> <span class="n">previous_task</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">],</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ddb_list</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InitializationError</span><span class="p">(</span><span class="s2">&quot;Cannot find a single DDB to run...&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">ddb_filepath</span> <span class="o">=</span> <span class="n">ddb_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddk_filepaths</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ddk_files_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ddk_filepaths</span><span class="p">))</span>

        <span class="c1"># Write files file and input file.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">files_file</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">files_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filesfile_string</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">input_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">anaddb_input</span><span class="p">))</span></div>

<div class="viewcode-block" id="AnaDdbAbinitTask.run_task"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.AnaDdbAbinitTask.run_task">[docs]</a>    <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">setup_task</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_anaddb</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">)</span>
            <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_analysis</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="c1"># log the error in history and reraise</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">log_error</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Always dump the history for automatic parsing of the folders</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">HISTORY_JSON</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="bp">cls</span><span class="o">=</span><span class="n">MontyEncoder</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnaDdbAbinitTask.task_analysis"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.AnaDdbAbinitTask.task_analysis">[docs]</a>    <span class="k">def</span> <span class="nf">task_analysis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Return code different from 0: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">returncode</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">FWAction</span><span class="p">()</span></div>

<div class="viewcode-block" id="AnaDdbAbinitTask.set_workdir"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.AnaDdbAbinitTask.set_workdir">[docs]</a>    <span class="k">def</span> <span class="nf">set_workdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workdir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the working directory.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">workdir</span><span class="p">)</span>

        <span class="c1"># Files required for the execution.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">INPUT_FILE_NAME</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">OUTPUT_FILE_NAME</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">FILES_FILE_NAME</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">LOG_FILE_NAME</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stderr_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">STDERR_FILE_NAME</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elphon_out_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">ELPHON_OUTPUT_FILE_NAME</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddk_files_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">DDK_FILES_FILE_NAME</span><span class="p">))</span>

        <span class="c1"># This file is produce by Abinit if nprocs &gt; 1 and MPI_ABORT.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mpiabort_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">MPIABORTFILE</span><span class="p">))</span>

        <span class="c1"># Directories with input|output|temporary data.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rundir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">INDIR_NAME</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">OUTDIR_NAME</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">TMPDIR_NAME</span><span class="p">))</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">filesfile_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String with the list of files and prefixes needed to execute ABINIT.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>

        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_file</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>                     <span class="c1"># 1) Path of the input file</span>
        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_file</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>                    <span class="c1"># 2) Path of the output file</span>
        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ddb_filepath</span><span class="p">)</span>                        <span class="c1"># 3) Input derivative database e.g. t13.ddb.in</span>
        <span class="n">app</span><span class="p">(</span><span class="n">DUMMY_FILENAME</span><span class="p">)</span>                           <span class="c1"># 4) Ignored</span>
        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gkk_filepath</span> <span class="ow">or</span> <span class="n">DUMMY_FILENAME</span><span class="p">)</span>      <span class="c1"># 5) Input elphon matrix elements  (GKK file)</span>
        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elphon_out_file</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>                     <span class="c1"># 6) Base name for elphon output files e.g. t13</span>
        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ddk_files_file</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ddk_filepaths</span>
            <span class="k">else</span> <span class="n">DUMMY_FILENAME</span><span class="p">)</span>                      <span class="c1"># 7) File containing ddk filenames for elphon/transport.</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">phbst_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Absolute path of the run.abo_PHBST.nc file. Empty string if file is not present.&quot;&quot;&quot;</span>
        <span class="c1"># Lazy property to avoid multiple calls to has_abiext.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phbst_path</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s2">&quot;run.abo_PHBST.nc&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">path</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phbst_path</span> <span class="o">=</span> <span class="n">path</span>
            <span class="k">return</span> <span class="n">path</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">phdos_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Absolute path of the run.abo_PHDOS.nc file. Empty string if file is not present.&quot;&quot;&quot;</span>
        <span class="c1"># Lazy property to avoid multiple calls to has_abiext.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phdos_path</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s2">&quot;run.abo_PHDOS.nc&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">path</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phdos_path</span> <span class="o">=</span> <span class="n">path</span>
            <span class="k">return</span> <span class="n">path</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">anaddb_nc_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Absolute path of the anaddb.nc file. Empty string if file is not present.&quot;&quot;&quot;</span>
        <span class="c1"># Lazy property to avoid multiple calls to has_abiext.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_anaddbnc_path</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s2">&quot;anaddb.nc&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">path</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_anaddbnc_path</span> <span class="o">=</span> <span class="n">path</span>
            <span class="k">return</span> <span class="n">path</span>

<div class="viewcode-block" id="AnaDdbAbinitTask.open_phbst"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.AnaDdbAbinitTask.open_phbst">[docs]</a>    <span class="k">def</span> <span class="nf">open_phbst</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open PHBST file produced by Anaddb and returns |PhbstFile| object.</span>
<span class="sd">        Raise a PostProcessError exception if file could not be found or file is not readable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">abipy.dfpt.phonons</span> <span class="k">import</span> <span class="n">PhbstFile</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">phbst_path</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No PHBST file available for task </span><span class="si">{}</span><span class="s2"> in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">PostProcessError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PhbstFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phbst_path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Exception while reading PHBST file at </span><span class="si">%s</span><span class="s2">:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phbst_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">PostProcessError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnaDdbAbinitTask.open_phdos"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.AnaDdbAbinitTask.open_phdos">[docs]</a>    <span class="k">def</span> <span class="nf">open_phdos</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open PHDOS file produced by Anaddb and returns |PhdosFile| object.</span>
<span class="sd">        Raise a PostProcessError exception if file could not be found or file is not readable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">abipy.dfpt.phonons</span> <span class="k">import</span> <span class="n">PhdosFile</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">phdos_path</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No PHDOS file available for task </span><span class="si">{}</span><span class="s2"> in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">PostProcessError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PhdosFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phdos_path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Exception while reading PHDOS file at </span><span class="si">%s</span><span class="s2">:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">phdos_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">PostProcessError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnaDdbAbinitTask.open_anaddbnc"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.AnaDdbAbinitTask.open_anaddbnc">[docs]</a>    <span class="k">def</span> <span class="nf">open_anaddbnc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open anaddb.nc file produced by Anaddb and returns |AnaddbNcFile| object.</span>
<span class="sd">        Raise a PostProcessError exception if file could not be found or file is not readable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">abipy.dfpt.anaddbnc</span> <span class="k">import</span> <span class="n">AnaddbNcFile</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">anaddb_nc_path</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No anaddb.nc file available for task </span><span class="si">{}</span><span class="s2"> in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">PostProcessError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">AnaddbNcFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">anaddb_nc_path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Exception while reading anaddb.nc file at </span><span class="si">%s</span><span class="s2">:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">anaddb_nc_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">PostProcessError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="AutoparalTask"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.AutoparalTask">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">AutoparalTask</span><span class="p">(</span><span class="n">AbiFireTask</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Task to run the autoparal for many tasks of the same type already defined as children</span>

<span class="sd">    .. rubric:: Inheritance Diagram</span>
<span class="sd">    .. inheritance-diagram:: AutoparalTask</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">task_type</span> <span class="o">=</span> <span class="s2">&quot;autoparal&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">abiinput</span><span class="p">,</span> <span class="n">restart_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">handlers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">history</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_autoparal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">task_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">forward_spec</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">skip_spec_keys</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Note that the method still takes is_autoparal as input even if this is switched to True irrespectively of the</span>
<span class="sd">        provided value, as the point of the task is to run autoparal. This is done to preserve the API in cases where</span>
<span class="sd">        automatic generation of tasks is involved.</span>
<span class="sd">        skip_spec_keys allows to specify a list of keys to skip when forwarding the spec: &#39;wf_task_index&#39; will</span>
<span class="sd">        be always skipped. All the reserved keys starting with _ will always be skipped as well.</span>
<span class="sd">        If abiinput is None, autoparal will not run and the preferred configuration will be chosen based on</span>
<span class="sd">        the options set in the manager.</span>
<span class="sd">        #FIXME find a better solution if this model is preserved</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">handlers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">handlers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">history</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AutoparalTask</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">abiinput</span><span class="p">,</span> <span class="n">restart_info</span><span class="o">=</span><span class="n">restart_info</span><span class="p">,</span> <span class="n">handlers</span><span class="o">=</span><span class="n">handlers</span><span class="p">,</span> <span class="n">is_autoparal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                            <span class="n">deps</span><span class="o">=</span><span class="n">deps</span><span class="p">,</span> <span class="n">history</span><span class="o">=</span><span class="n">history</span><span class="p">,</span> <span class="n">task_type</span><span class="o">=</span><span class="n">task_type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forward_spec</span> <span class="o">=</span> <span class="n">forward_spec</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_spec_keys</span><span class="p">:</span>
            <span class="n">skip_spec_keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">skip_spec_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;wf_task_index&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">skip_spec_keys</span> <span class="o">=</span> <span class="n">skip_spec_keys</span>

<div class="viewcode-block" id="AutoparalTask.autoparal"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.AutoparalTask.autoparal">[docs]</a>    <span class="k">def</span> <span class="nf">autoparal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs the autoparal, if an input is available. Does not return a detour, updates the children fws instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Copy the appropriate dependencies in the in dir. needed in some cases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resolve_deps</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">optconf</span><span class="p">,</span> <span class="n">qadapter_spec</span><span class="p">,</span> <span class="n">qtk_qadapter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_fake_autoparal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">optconf</span><span class="p">,</span> <span class="n">qadapter_spec</span><span class="p">,</span> <span class="n">qtk_qadapter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_autoparal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">log_autoparal</span><span class="p">(</span><span class="n">optconf</span><span class="p">)</span>
        <span class="n">mod_spec</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;_push_all&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;spec-&gt;_tasks-&gt;0-&gt;abiinput-&gt;abi_args&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">optconf</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">items</span><span class="p">())}}]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">forward_spec</span><span class="p">:</span>
            <span class="c1"># forward all the specs of the task</span>
            <span class="n">new_spec</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_spec_keys</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_spec</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># set quadapter specification. Note that mpi_ncpus may be different from ntasks</span>
        <span class="n">new_spec</span><span class="p">[</span><span class="s1">&#39;_queueadapter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qadapter_spec</span>
        <span class="n">new_spec</span><span class="p">[</span><span class="s1">&#39;mpi_ncpus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optconf</span><span class="p">[</span><span class="s1">&#39;mpi_ncpus&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">FWAction</span><span class="p">(</span><span class="n">update_spec</span><span class="o">=</span><span class="n">new_spec</span><span class="p">,</span> <span class="n">mod_spec</span><span class="o">=</span><span class="n">mod_spec</span><span class="p">)</span></div></div>

<span class="c1">##############################</span>
<span class="c1"># Generation tasks</span>
<span class="c1">##############################</span>

<div class="viewcode-block" id="GeneratePhononFlowFWAbinitTask"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.GeneratePhononFlowFWAbinitTask">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">GeneratePhononFlowFWAbinitTask</span><span class="p">(</span><span class="n">BasicAbinitTaskMixin</span><span class="p">,</span> <span class="n">FireTaskBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Task that generates all the phonon perturbation based on the input of the previous ground state step</span>

<span class="sd">    .. rubric:: Inheritance Diagram</span>
<span class="sd">    .. inheritance-diagram:: GeneratePhononFlowFWAbinitTask</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">phonon_factory</span><span class="p">,</span> <span class="n">previous_task_type</span><span class="o">=</span><span class="n">ScfFWTask</span><span class="o">.</span><span class="n">task_type</span><span class="p">,</span> <span class="n">handlers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">with_autoparal</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ddb_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">handlers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">handlers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phonon_factory</span> <span class="o">=</span> <span class="n">phonon_factory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">previous_task_type</span> <span class="o">=</span> <span class="n">previous_task_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="n">handlers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">with_autoparal</span><span class="o">=</span><span class="n">with_autoparal</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ddb_file</span> <span class="o">=</span> <span class="n">ddb_file</span>

<div class="viewcode-block" id="GeneratePhononFlowFWAbinitTask.get_fws"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.GeneratePhononFlowFWAbinitTask.get_fws">[docs]</a>    <span class="k">def</span> <span class="nf">get_fws</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multi_inp</span><span class="p">,</span> <span class="n">task_class</span><span class="p">,</span> <span class="n">deps</span><span class="p">,</span> <span class="n">new_spec</span><span class="p">,</span> <span class="n">ftm</span><span class="p">,</span> <span class="n">nscf_fws</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepares the fireworks for a specific type of calculation</span>

<span class="sd">        Args:</span>
<span class="sd">            multi_inp: |MultiDataset| with the inputs that should be run</span>
<span class="sd">            task_class: class of the tasks that should be generated</span>
<span class="sd">            deps: dict with the dependencies already set for this type of task</span>
<span class="sd">            new_spec: spec for the new Fireworks that will be created</span>
<span class="sd">            ftm: a FWTaskManager</span>
<span class="sd">            nscf_fws: list of NSCF fws for the calculation of WFQ files, in case they are present.</span>
<span class="sd">                Will be linked if needed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (tuple): tuple containing:</span>

<span class="sd">                - fws (list): The list of new Fireworks.</span>
<span class="sd">                - fw_deps (dict): The dependencies related to these fireworks. Should be used when generating</span>
<span class="sd">                    the workflow.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">deps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">formula</span> <span class="o">=</span> <span class="n">multi_inp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">composition</span><span class="o">.</span><span class="n">reduced_formula</span>
        <span class="n">fws</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fw_deps</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">autoparal_spec</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">inp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">multi_inp</span><span class="p">):</span>
            <span class="n">new_spec</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">new_spec</span><span class="p">)</span>
            <span class="n">start_task_index</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_autoparal</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">autoparal_spec</span><span class="p">:</span>
                    <span class="n">autoparal_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">),</span> <span class="s2">&quot;autoparal_</span><span class="si">{}</span><span class="s2">_</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_class</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>
                    <span class="n">optconf</span><span class="p">,</span> <span class="n">qadapter_spec</span><span class="p">,</span> <span class="n">qadapter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_autoparal</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">autoparal_dir</span><span class="p">,</span> <span class="n">ftm</span><span class="p">)</span>
                    <span class="n">autoparal_spec</span><span class="p">[</span><span class="s1">&#39;_queueadapter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qadapter_spec</span>
                    <span class="n">autoparal_spec</span><span class="p">[</span><span class="s1">&#39;mpi_ncpus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optconf</span><span class="p">[</span><span class="s1">&#39;mpi_ncpus&#39;</span><span class="p">]</span>
                <span class="n">new_spec</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">autoparal_spec</span><span class="p">)</span>
                <span class="n">inp</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">optconf</span><span class="o">.</span><span class="n">vars</span><span class="p">)</span>

            <span class="n">current_deps</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">deps</span><span class="p">)</span>
            <span class="n">parent_fw</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">nscf_fws</span><span class="p">:</span>
                <span class="n">qpt</span> <span class="o">=</span> <span class="n">inp</span><span class="p">[</span><span class="s1">&#39;qpt&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">nscf_fw</span> <span class="ow">in</span> <span class="n">nscf_fws</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">nscf_fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">abiinput</span><span class="p">[</span><span class="s1">&#39;qpt&#39;</span><span class="p">],</span> <span class="n">qpt</span><span class="p">):</span>
                        <span class="n">parent_fw</span> <span class="o">=</span> <span class="n">nscf_fw</span>
                        <span class="n">current_deps</span><span class="p">[</span><span class="n">nscf_fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">task_type</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;WFQ&quot;</span>
                        <span class="k">break</span>


            <span class="n">task</span> <span class="o">=</span> <span class="n">task_class</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">handlers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="n">current_deps</span><span class="p">,</span> <span class="n">is_autoparal</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># this index is for the different task, each performing a different perturbation</span>
            <span class="n">indexed_task_type</span> <span class="o">=</span> <span class="n">task_class</span><span class="o">.</span><span class="n">task_type</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="c1"># this index is to index the restarts of the single task</span>
            <span class="n">new_spec</span><span class="p">[</span><span class="s1">&#39;wf_task_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">indexed_task_type</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">start_task_index</span><span class="p">)</span>
            <span class="n">fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">spec</span><span class="o">=</span><span class="n">new_spec</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="p">(</span><span class="n">formula</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">indexed_task_type</span><span class="p">)[:</span><span class="mi">15</span><span class="p">])</span>
            <span class="n">fws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fw</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">parent_fw</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fw_deps</span><span class="p">[</span><span class="n">parent_fw</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fw</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fws</span><span class="p">,</span> <span class="n">fw_deps</span></div>

<div class="viewcode-block" id="GeneratePhononFlowFWAbinitTask.run_task"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.GeneratePhononFlowFWAbinitTask.run_task">[docs]</a>    <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="n">previous_input</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;previous_fws&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_task_type</span><span class="p">,</span> <span class="p">[{}])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">previous_input</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InitializationError</span><span class="p">(</span><span class="s1">&#39;No input file available from task of type </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_task_type</span><span class="p">))</span>

        <span class="c1"># compatibility with old DECODE_MONTY=False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">previous_input</span><span class="p">,</span> <span class="n">AbinitInput</span><span class="p">):</span>
            <span class="n">previous_input</span> <span class="o">=</span> <span class="n">AbinitInput</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">previous_input</span><span class="p">)</span>

        <span class="n">ftm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fw_task_manager</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_autoparal</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">with_autoparal</span> <span class="o">=</span> <span class="n">ftm</span><span class="o">.</span><span class="n">fw_policy</span><span class="o">.</span><span class="n">autoparal</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">with_autoparal</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ftm</span><span class="o">.</span><span class="n">has_task_manager</span><span class="p">():</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;No task manager available: autoparal could not be performed.&#39;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">InitializationError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># inject task manager</span>
        <span class="n">tasks</span><span class="o">.</span><span class="n">set_user_config_taskmanager</span><span class="p">(</span><span class="n">ftm</span><span class="o">.</span><span class="n">task_manager</span><span class="p">)</span>

        <span class="n">ph_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phonon_factory</span><span class="o">.</span><span class="n">build_input</span><span class="p">(</span><span class="n">previous_input</span><span class="p">)</span>

        <span class="n">initialization_info</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;initialization_info&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">initialization_info</span><span class="p">[</span><span class="s1">&#39;input_factory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">phonon_factory</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
        <span class="n">new_spec</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">previous_fws</span><span class="o">=</span><span class="n">fw_spec</span><span class="p">[</span><span class="s1">&#39;previous_fws&#39;</span><span class="p">],</span> <span class="n">initialization_info</span><span class="o">=</span><span class="n">initialization_info</span><span class="p">,</span>
                        <span class="n">_preserve_fworker</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;_fworker&#39;</span> <span class="ow">in</span> <span class="n">fw_spec</span><span class="p">:</span>
            <span class="n">new_spec</span><span class="p">[</span><span class="s1">&#39;_fworker&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="p">[</span><span class="s1">&#39;_fworker&#39;</span><span class="p">]</span>

        <span class="n">ph_q_pert_inputs</span> <span class="o">=</span> <span class="n">ph_inputs</span><span class="o">.</span><span class="n">filter_by_tags</span><span class="p">(</span><span class="n">PH_Q_PERT</span><span class="p">)</span>
        <span class="n">ddk_inputs</span> <span class="o">=</span> <span class="n">ph_inputs</span><span class="o">.</span><span class="n">filter_by_tags</span><span class="p">(</span><span class="n">DDK</span><span class="p">)</span>
        <span class="n">dde_inputs</span> <span class="o">=</span> <span class="n">ph_inputs</span><span class="o">.</span><span class="n">filter_by_tags</span><span class="p">(</span><span class="n">DDE</span><span class="p">)</span>
        <span class="n">bec_inputs</span> <span class="o">=</span> <span class="n">ph_inputs</span><span class="o">.</span><span class="n">filter_by_tags</span><span class="p">(</span><span class="n">BEC</span><span class="p">)</span>

        <span class="n">nscf_inputs</span> <span class="o">=</span> <span class="n">ph_inputs</span><span class="o">.</span><span class="n">filter_by_tags</span><span class="p">(</span><span class="n">NSCF</span><span class="p">)</span>

        <span class="n">nscf_fws</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">nscf_inputs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nscf_fws</span><span class="p">,</span> <span class="n">nscf_fw_deps</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fws</span><span class="p">(</span><span class="n">nscf_inputs</span><span class="p">,</span> <span class="n">NscfWfqFWTask</span><span class="p">,</span>
                                                 <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_task_type</span><span class="p">:</span> <span class="s2">&quot;WFK&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">previous_task_type</span><span class="p">:</span> <span class="s2">&quot;DEN&quot;</span><span class="p">},</span> <span class="n">new_spec</span><span class="p">,</span> <span class="n">ftm</span><span class="p">)</span>

        <span class="n">ph_fws</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">ph_q_pert_inputs</span><span class="p">:</span>
            <span class="n">ph_q_pert_inputs</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">prtwf</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ph_fws</span><span class="p">,</span> <span class="n">ph_fw_deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fws</span><span class="p">(</span><span class="n">ph_q_pert_inputs</span><span class="p">,</span> <span class="n">PhononTask</span><span class="p">,</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_task_type</span><span class="p">:</span> <span class="s2">&quot;WFK&quot;</span><span class="p">},</span> <span class="n">new_spec</span><span class="p">,</span>
                                              <span class="n">ftm</span><span class="p">,</span> <span class="n">nscf_fws</span><span class="p">)</span>

        <span class="n">ddk_fws</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">ddk_inputs</span><span class="p">:</span>
            <span class="n">ddk_fws</span><span class="p">,</span> <span class="n">ddk_fw_deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fws</span><span class="p">(</span><span class="n">ddk_inputs</span><span class="p">,</span> <span class="n">DdkTask</span><span class="p">,</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_task_type</span><span class="p">:</span> <span class="s2">&quot;WFK&quot;</span><span class="p">},</span> <span class="n">new_spec</span><span class="p">,</span> <span class="n">ftm</span><span class="p">)</span>

        <span class="n">dde_fws</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">dde_inputs</span><span class="p">:</span>
            <span class="n">dde_inputs</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">prtwf</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dde_fws</span><span class="p">,</span> <span class="n">dde_fw_deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fws</span><span class="p">(</span><span class="n">dde_inputs</span><span class="p">,</span> <span class="n">DdeTask</span><span class="p">,</span>
                                                <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_task_type</span><span class="p">:</span> <span class="s2">&quot;WFK&quot;</span><span class="p">,</span> <span class="n">DdkTask</span><span class="o">.</span><span class="n">task_type</span><span class="p">:</span> <span class="s2">&quot;DDK&quot;</span><span class="p">},</span> <span class="n">new_spec</span><span class="p">,</span> <span class="n">ftm</span><span class="p">)</span>

        <span class="n">bec_fws</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">bec_inputs</span><span class="p">:</span>
            <span class="n">bec_inputs</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">prtwf</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">bec_fws</span><span class="p">,</span> <span class="n">bec_fw_deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fws</span><span class="p">(</span><span class="n">bec_inputs</span><span class="p">,</span> <span class="n">BecTask</span><span class="p">,</span>
                                                <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_task_type</span><span class="p">:</span> <span class="s2">&quot;WFK&quot;</span><span class="p">,</span> <span class="n">DdkTask</span><span class="o">.</span><span class="n">task_type</span><span class="p">:</span> <span class="s2">&quot;DDK&quot;</span><span class="p">},</span> <span class="n">new_spec</span><span class="p">,</span> <span class="n">ftm</span><span class="p">)</span>


        <span class="n">mrgddb_spec</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">new_spec</span><span class="p">)</span>
        <span class="n">mrgddb_spec</span><span class="p">[</span><span class="s1">&#39;wf_task_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;mrgddb&#39;</span>
        <span class="c1">#FIXME import here to avoid circular imports.</span>
        <span class="kn">from</span> <span class="nn">abiflows.fireworks.utils.fw_utils</span> <span class="k">import</span> <span class="n">get_short_single_core_spec</span>
        <span class="n">qadapter_spec</span> <span class="o">=</span> <span class="n">get_short_single_core_spec</span><span class="p">(</span><span class="n">ftm</span><span class="p">)</span>
        <span class="n">mrgddb_spec</span><span class="p">[</span><span class="s1">&#39;mpi_ncpus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">mrgddb_spec</span><span class="p">[</span><span class="s1">&#39;_queueadapter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qadapter_spec</span>
        <span class="c1"># Set a higher priority to favour the end of the WF</span>
        <span class="c1">#TODO improve the handling of the priorities</span>
        <span class="n">mrgddb_spec</span><span class="p">[</span><span class="s1">&#39;_priority&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="c1"># add one for the scf that is linked to the mrgddbtask and will be merged as well</span>
        <span class="n">num_ddbs_to_be_merged</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ph_fws</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">dde_fws</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">bec_fws</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">mrgddb_fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">(</span><span class="n">MergeDdbAbinitTask</span><span class="p">(</span><span class="n">num_ddbs</span><span class="o">=</span><span class="n">num_ddbs_to_be_merged</span><span class="p">,</span> <span class="n">delete_source_ddbs</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="n">spec</span><span class="o">=</span><span class="n">mrgddb_spec</span><span class="p">,</span>
                             <span class="n">name</span><span class="o">=</span><span class="n">ph_inputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">composition</span><span class="o">.</span><span class="n">reduced_formula</span><span class="o">+</span><span class="s1">&#39;_mergeddb&#39;</span><span class="p">)</span>

        <span class="n">fws_deps</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">ddk_fws</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ddk_fw</span> <span class="ow">in</span> <span class="n">ddk_fws</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">dde_fws</span><span class="p">:</span>
                    <span class="n">fws_deps</span><span class="p">[</span><span class="n">ddk_fw</span><span class="p">]</span> <span class="o">=</span> <span class="n">dde_fws</span>
                <span class="k">if</span> <span class="n">bec_fws</span><span class="p">:</span>
                    <span class="n">fws_deps</span><span class="p">[</span><span class="n">ddk_fw</span><span class="p">]</span> <span class="o">=</span> <span class="n">bec_fws</span>

        <span class="n">ddb_fws</span> <span class="o">=</span> <span class="n">dde_fws</span> <span class="o">+</span> <span class="n">ph_fws</span> <span class="o">+</span> <span class="n">bec_fws</span>
        <span class="c1">#TODO pass all the tasks to the MergeDdbTask for logging or easier retrieve of the DDK?</span>
        <span class="k">for</span> <span class="n">ddb_fw</span> <span class="ow">in</span> <span class="n">ddb_fws</span><span class="p">:</span>
            <span class="n">fws_deps</span><span class="p">[</span><span class="n">ddb_fw</span><span class="p">]</span> <span class="o">=</span> <span class="n">mrgddb_fw</span>

        <span class="n">total_list_fws</span> <span class="o">=</span> <span class="n">ddb_fws</span><span class="o">+</span><span class="n">ddk_fws</span><span class="o">+</span><span class="p">[</span><span class="n">mrgddb_fw</span><span class="p">]</span> <span class="o">+</span> <span class="n">nscf_fws</span>

        <span class="n">fws_deps</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ph_fw_deps</span><span class="p">)</span>

        <span class="n">ph_wf</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">total_list_fws</span><span class="p">,</span> <span class="n">fws_deps</span><span class="p">)</span>

        <span class="n">stored_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">finalized</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">FWAction</span><span class="p">(</span><span class="n">stored_data</span><span class="o">=</span><span class="n">stored_data</span><span class="p">,</span> <span class="n">detours</span><span class="o">=</span><span class="n">ph_wf</span><span class="p">)</span></div></div>


<span class="c1">#TODO old implementation of GeneratePiezoElasticFlowFWAbinitTask based on SRC. Needs to be rewritten.</span>
<span class="c1"># @explicit_serialize</span>
<span class="c1"># class GeneratePiezoElasticFlowFWAbinitTask(BasicAbinitTaskMixin, FireTaskBase):</span>
<span class="c1">#     def __init__(self, piezo_elastic_factory=None, previous_scf_task_type=ScfFWTask.task_type,</span>
<span class="c1">#                  previous_ddk_task_type=DdkTask.task_type,</span>
<span class="c1">#                  handlers=None, validators=None, mrgddb_task_type=&#39;mrgddb-strains&#39;, rf_tol=None):</span>
<span class="c1">#         if piezo_elastic_factory is None:</span>
<span class="c1">#             self.piezo_elastic_factory = PiezoElasticFromGsFactory(rf_tol=rf_tol, rf_split=True)</span>
<span class="c1">#         else:</span>
<span class="c1">#             self.piezo_elastic_factory = piezo_elastic_factory</span>
<span class="c1">#         self.previous_scf_task_type = previous_scf_task_type</span>
<span class="c1">#         self.previous_ddk_task_type = previous_ddk_task_type</span>
<span class="c1">#         self.handlers = handlers</span>
<span class="c1">#         self.validators = validators</span>
<span class="c1">#         self.mrgddb_task_type = mrgddb_task_type</span>
<span class="c1">#         self.rf_tol = rf_tol</span>
<span class="c1">#</span>
<span class="c1">#     def run_task(self, fw_spec):</span>
<span class="c1">#         # Get the previous SCF input</span>
<span class="c1">#         previous_scf_input = fw_spec.get(&#39;previous_fws&#39;, {}).get(self.previous_scf_task_type,</span>
<span class="c1">#                                                                  [{}])[0].get(&#39;input&#39;, None)</span>
<span class="c1">#         if not previous_scf_input:</span>
<span class="c1">#             raise InitializationError(&#39;No input file available &#39;</span>
<span class="c1">#                                       &#39;from task of type {}&#39;.format(self.previous_scf_task_type))</span>
<span class="c1">#         #previous_scf_input = AbinitInput.from_dict(previous_scf_input)</span>
<span class="c1">#</span>
<span class="c1">#         # # Get the previous DDK input</span>
<span class="c1">#         # previous_ddk_input = fw_spec.get(&#39;previous_fws&#39;, {}).get(self.previous_ddk_task_type,</span>
<span class="c1">#         #                                                          [{}])[0].get(&#39;input&#39;, None)</span>
<span class="c1">#         # if not previous_ddk_input:</span>
<span class="c1">#         #     raise InitializationError(&#39;No input file available &#39;</span>
<span class="c1">#         #                               &#39;from task of type {}&#39;.format(self.previous_ddk_task_type))</span>
<span class="c1">#         # previous_ddk_input = AbinitInput.from_dict(previous_ddk_input)</span>
<span class="c1">#</span>
<span class="c1">#         ftm = self.get_fw_task_manager(fw_spec)</span>
<span class="c1">#         tasks._USER_CONFIG_TASKMANAGER = ftm.task_manager</span>
<span class="c1">#         # if self.with_autoparal:</span>
<span class="c1">#         #     if not ftm.has_task_manager():</span>
<span class="c1">#         #         msg = &#39;No task manager available: autoparal could not be performed.&#39;</span>
<span class="c1">#         #         logger.error(msg)</span>
<span class="c1">#         #         raise InitializationError(msg)</span>
<span class="c1">#         #</span>
<span class="c1">#         #     # inject task manager</span>
<span class="c1">#         #     tasks._USER_CONFIG_TASKMANAGER = ftm.task_manager</span>
<span class="c1">#</span>
<span class="c1">#         # Get the strain RF inputs</span>
<span class="c1">#         piezo_elastic_inputs = self.piezo_elastic_factory.build_input(previous_scf_input)</span>
<span class="c1">#         rf_strain_inputs = piezo_elastic_inputs.filter_by_tags(STRAIN)</span>
<span class="c1">#</span>
<span class="c1">#         initialization_info = fw_spec.get(&#39;initialization_info&#39;, {})</span>
<span class="c1">#         initialization_info[&#39;input_factory&#39;] = self.piezo_elastic_factory.as_dict()</span>
<span class="c1">#         new_spec = dict(previous_fws=fw_spec[&#39;previous_fws&#39;], initialization_info=initialization_info)</span>
<span class="c1">#</span>
<span class="c1">#         # Get the initial queue_adapter_updates</span>
<span class="c1">#         queue_adapter_update = initialization_info.get(&#39;queue_adapter_update&#39;, None)</span>
<span class="c1">#</span>
<span class="c1">#         # Create the SRC fireworks for each perturbation</span>
<span class="c1">#         all_SRC_rf_fws = []</span>
<span class="c1">#         total_list_fws = []</span>
<span class="c1">#         fws_deps = {}</span>
<span class="c1">#         rf_strain_handlers = self.handlers[&#39;_all&#39;] if self.handlers is not None else []</span>
<span class="c1">#         rf_strain_validators = self.validators[&#39;_all&#39;] if self.validators is not None else []</span>
<span class="c1">#         for istrain_pert, rf_strain_input in enumerate(rf_strain_inputs):</span>
<span class="c1">#             SRC_rf_fws = createSRCFireworksOld(task_class=StrainPertTask, task_input=rf_strain_input, SRC_spec=new_spec,</span>
<span class="c1">#                                                initialization_info=initialization_info,</span>
<span class="c1">#                                                wf_task_index_prefix=&#39;rfstrains-pert-{:d}&#39;.format(istrain_pert+1),</span>
<span class="c1">#                                                handlers=rf_strain_handlers, validators=rf_strain_validators,</span>
<span class="c1">#                                                deps={self.previous_scf_task_type: &#39;WFK&#39;,</span>
<span class="c1">#                                                   self.previous_ddk_task_type: &#39;DDK&#39;},</span>
<span class="c1">#                                                queue_adapter_update=queue_adapter_update)</span>
<span class="c1">#             all_SRC_rf_fws.append(SRC_rf_fws)</span>
<span class="c1">#             total_list_fws.extend(SRC_rf_fws[&#39;fws&#39;])</span>
<span class="c1">#             links_dict_update(links_dict=fws_deps, links_update=SRC_rf_fws[&#39;links_dict&#39;])</span>
<span class="c1">#</span>
<span class="c1">#         # Adding the MrgDdb Firework</span>
<span class="c1">#         mrgddb_spec = dict(new_spec)</span>
<span class="c1">#         mrgddb_spec[&#39;wf_task_index_prefix&#39;] = &#39;mrgddb-rfstrains&#39;</span>
<span class="c1">#         mrgddb_spec[&#39;wf_task_index&#39;] = mrgddb_spec[&#39;wf_task_index_prefix&#39;]</span>
<span class="c1">#         mrgddb_spec = set_short_single_core_to_spec(mrgddb_spec)</span>
<span class="c1">#         mrgddb_spec[&#39;_priority&#39;] = 10</span>
<span class="c1">#         num_ddbs_to_be_merged = len(all_SRC_rf_fws)</span>
<span class="c1">#         mrgddb_fw = Firework(MergeDdbAbinitTask(num_ddbs=num_ddbs_to_be_merged, delete_source_ddbs=True,</span>
<span class="c1">#                                                 task_type= self.mrgddb_task_type),</span>
<span class="c1">#                              spec=mrgddb_spec,</span>
<span class="c1">#                              name=mrgddb_spec[&#39;wf_task_index&#39;])</span>
<span class="c1">#         total_list_fws.append(mrgddb_fw)</span>
<span class="c1">#         #Adding the dependencies</span>
<span class="c1">#         for src_fws in all_SRC_rf_fws:</span>
<span class="c1">#             links_dict_update(links_dict=fws_deps, links_update={src_fws[&#39;check_fw&#39;]: mrgddb_fw})</span>
<span class="c1">#</span>
<span class="c1">#         rf_strains_wf = Workflow(total_list_fws, fws_deps)</span>
<span class="c1">#</span>
<span class="c1">#         return FWAction(detours=rf_strains_wf)</span>

<span class="c1">##############################</span>
<span class="c1"># Exceptions</span>
<span class="c1">##############################</span>

<div class="viewcode-block" id="ErrorCode"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.ErrorCode">[docs]</a><span class="k">class</span> <span class="nc">ErrorCode</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Error code to classify the errors</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ERROR</span> <span class="o">=</span> <span class="s1">&#39;Error&#39;</span>
    <span class="n">UNRECOVERABLE</span> <span class="o">=</span> <span class="s1">&#39;Unrecoverable&#39;</span>
    <span class="n">UNCLASSIFIED</span> <span class="o">=</span> <span class="s1">&#39;Unclassified&#39;</span>
    <span class="n">UNCONVERGED</span> <span class="o">=</span> <span class="s1">&#39;Unconverged&#39;</span>
    <span class="n">UNCONVERGED_PARAMETERS</span> <span class="o">=</span> <span class="s1">&#39;Unconverged_parameters&#39;</span>
    <span class="n">INITIALIZATION</span> <span class="o">=</span> <span class="s1">&#39;Initialization&#39;</span>
    <span class="n">RESTART</span> <span class="o">=</span> <span class="s1">&#39;Restart&#39;</span>
    <span class="n">POSTPROCESS</span> <span class="o">=</span> <span class="s1">&#39;Postprocess&#39;</span>
    <span class="n">WALLTIME</span> <span class="o">=</span> <span class="s1">&#39;Walltime&#39;</span></div>


<div class="viewcode-block" id="AbiFWError"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.AbiFWError">[docs]</a><span class="k">class</span> <span class="nc">AbiFWError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for the errors in abiflows</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AbiFWError</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span>

<div class="viewcode-block" id="AbiFWError.to_dict"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.AbiFWError.to_dict">[docs]</a>    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">error_code</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ERROR_CODE</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="AbinitRuntimeError"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.AbinitRuntimeError">[docs]</a><span class="k">class</span> <span class="nc">AbinitRuntimeError</span><span class="p">(</span><span class="n">AbiFWError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exception raised for errors during Abinit calculation.</span>
<span class="sd">    Contains the information about the errors and warning extracted from the output files.</span>
<span class="sd">    Initialized with a task, uses it to prepare a suitable error message.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ERROR_CODE</span> <span class="o">=</span> <span class="n">ErrorCode</span><span class="o">.</span><span class="n">ERROR</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_errors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_warnings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">warnings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If the task has a report all the information will be extracted from it, otherwise the arguments will be used.</span>

<span class="sd">        Args:</span>
<span class="sd">            task: the abiflows Task</span>
<span class="sd">            msg: the error message</span>
<span class="sd">            num_errors: number of errors in the abinit execution. Only used if task doesn&#39;t have a report.</span>
<span class="sd">            num_warnings: number of warning in the abinit execution. Only used if task doesn&#39;t have a report.</span>
<span class="sd">            errors: list of errors in the abinit execution. Only used if task doesn&#39;t have a report.</span>
<span class="sd">            warnings: list of warnings in the abinit execution. Only used if task doesn&#39;t have a report.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># This can handle both the cases of DECODE_MONTY=True and False (Since it has a from_dict method).</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AbinitRuntimeError</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="n">task</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="p">,</span> <span class="s2">&quot;report&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">report</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">report</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">report</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_errors</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">num_errors</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_warnings</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">num_warnings</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">errors</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span> <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">warnings</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_errors</span> <span class="o">=</span> <span class="n">num_errors</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_warnings</span> <span class="o">=</span> <span class="n">num_warnings</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="n">errors</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span> <span class="o">=</span> <span class="n">warnings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span>

<div class="viewcode-block" id="AbinitRuntimeError.to_dict"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.AbinitRuntimeError.to_dict">[docs]</a>    <span class="nd">@pmg_serialize</span>
    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;num_errors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_errors</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;num_warnings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_warnings</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">:</span>
            <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">:</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">as_dict</span><span class="p">())</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">errors</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="p">:</span>
            <span class="n">warnings</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">warning</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">warning</span><span class="o">.</span><span class="n">as_dict</span><span class="p">())</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;warnings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">warnings</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;error_message&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg</span>

        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;error_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ERROR_CODE</span>

        <span class="k">return</span> <span class="n">d</span></div>

<div class="viewcode-block" id="AbinitRuntimeError.as_dict"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.AbinitRuntimeError.as_dict">[docs]</a>    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span></div>

<div class="viewcode-block" id="AbinitRuntimeError.from_dict"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.AbinitRuntimeError.from_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="n">MontyDecoder</span><span class="p">()</span>
        <span class="n">warnings</span> <span class="o">=</span> <span class="p">[</span><span class="n">dec</span><span class="o">.</span><span class="n">process_decoded</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;warnings&#39;</span><span class="p">]]</span> <span class="k">if</span> <span class="s1">&#39;warnings&#39;</span> <span class="ow">in</span> <span class="n">d</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[</span><span class="n">dec</span><span class="o">.</span><span class="n">process_decoded</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]]</span> <span class="k">if</span> <span class="s1">&#39;errors&#39;</span> <span class="ow">in</span> <span class="n">d</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;error_message&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;error_message&#39;</span> <span class="ow">in</span> <span class="n">d</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">warnings</span><span class="o">=</span><span class="n">warnings</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">,</span> <span class="n">num_errors</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;num_errors&#39;</span><span class="p">],</span> <span class="n">num_warnings</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;num_warnings&#39;</span><span class="p">],</span>
                   <span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="UnconvergedError"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.UnconvergedError">[docs]</a><span class="k">class</span> <span class="nc">UnconvergedError</span><span class="p">(</span><span class="n">AbinitRuntimeError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exception raised when a calculation didn&#39;t converge within the selected number of restarts.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ERROR_CODE</span> <span class="o">=</span> <span class="n">ErrorCode</span><span class="o">.</span><span class="n">UNCONVERGED</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_errors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_warnings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">warnings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">abiinput</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">restart_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">history</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If the task has a report all the information will be extracted from it, otherwise the arguments will be used.</span>
<span class="sd">        It contains information that can be used to further restart the job.</span>

<span class="sd">        Args:</span>
<span class="sd">            task: the abiflows Task</span>
<span class="sd">            msg: the error message</span>
<span class="sd">            num_errors: number of errors in the abinit execution. Only used if task doesn&#39;t have a report.</span>
<span class="sd">            num_warnings: number of warning in the abinit execution. Only used if task doesn&#39;t have a report.</span>
<span class="sd">            errors: list of errors in the abinit execution. Only used if task doesn&#39;t have a report.</span>
<span class="sd">            warnings: list of warnings in the abinit execution. Only used if task doesn&#39;t have a report.</span>
<span class="sd">            abiinput: the last AbinitInput used.</span>
<span class="sd">            restart_info: the RestartInfo required to restart the job.</span>
<span class="sd">            history: a TaskHistory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">UnconvergedError</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">num_errors</span><span class="p">,</span> <span class="n">num_warnings</span><span class="p">,</span> <span class="n">errors</span><span class="p">,</span> <span class="n">warnings</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span> <span class="o">=</span> <span class="n">abiinput</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restart_info</span> <span class="o">=</span> <span class="n">restart_info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="o">=</span> <span class="n">history</span>

<div class="viewcode-block" id="UnconvergedError.to_dict"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.UnconvergedError.to_dict">[docs]</a>    <span class="nd">@pmg_serialize</span>
    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">UnconvergedError</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;abiinput&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;restart_info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_info</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_info</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;history&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">history</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">d</span></div>

<div class="viewcode-block" id="UnconvergedError.from_dict"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.UnconvergedError.from_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="n">MontyDecoder</span><span class="p">()</span>
        <span class="n">warnings</span> <span class="o">=</span> <span class="p">[</span><span class="n">dec</span><span class="o">.</span><span class="n">process_decoded</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;warnings&#39;</span><span class="p">]]</span> <span class="k">if</span> <span class="s1">&#39;warnings&#39;</span> <span class="ow">in</span> <span class="n">d</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[</span><span class="n">dec</span><span class="o">.</span><span class="n">process_decoded</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">]]</span> <span class="k">if</span> <span class="s1">&#39;errors&#39;</span> <span class="ow">in</span> <span class="n">d</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s1">&#39;abiinput&#39;</span> <span class="ow">in</span> <span class="n">d</span> <span class="ow">and</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;abiinput&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">abiinput</span> <span class="o">=</span> <span class="n">dec</span><span class="o">.</span><span class="n">process_decoded</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;abiinput&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">abiinput</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;restart_info&#39;</span> <span class="ow">in</span> <span class="n">d</span> <span class="ow">and</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;restart_info&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">restart_info</span> <span class="o">=</span> <span class="n">dec</span><span class="o">.</span><span class="n">process_decoded</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;restart_info&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">restart_info</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;history&#39;</span> <span class="ow">in</span> <span class="n">d</span> <span class="ow">and</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;history&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">history</span> <span class="o">=</span> <span class="n">dec</span><span class="o">.</span><span class="n">process_decoded</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;history&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">history</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">warnings</span><span class="o">=</span><span class="n">warnings</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">,</span> <span class="n">num_errors</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;num_errors&#39;</span><span class="p">],</span> <span class="n">num_warnings</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;num_warnings&#39;</span><span class="p">],</span>
                   <span class="n">msg</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;error_message&#39;</span><span class="p">],</span> <span class="n">abiinput</span><span class="o">=</span><span class="n">abiinput</span><span class="p">,</span> <span class="n">restart_info</span><span class="o">=</span><span class="n">restart_info</span><span class="p">,</span> <span class="n">history</span><span class="o">=</span><span class="n">history</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="UnconvergedParametersError"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.UnconvergedParametersError">[docs]</a><span class="k">class</span> <span class="nc">UnconvergedParametersError</span><span class="p">(</span><span class="n">UnconvergedError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exception raised when the iteration to converge some parameter didn&#39;t converge within the selected number</span>
<span class="sd">    of restarts.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ERROR_CODE</span> <span class="o">=</span> <span class="n">ErrorCode</span><span class="o">.</span><span class="n">UNCONVERGED_PARAMETERS</span></div>


<div class="viewcode-block" id="WalltimeError"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.WalltimeError">[docs]</a><span class="k">class</span> <span class="nc">WalltimeError</span><span class="p">(</span><span class="n">AbiFWError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exception raised when the calculation didn&#39;t complete within the specified walltime.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ERROR_CODE</span> <span class="o">=</span> <span class="n">ErrorCode</span><span class="o">.</span><span class="n">WALLTIME</span></div>


<div class="viewcode-block" id="InitializationError"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.InitializationError">[docs]</a><span class="k">class</span> <span class="nc">InitializationError</span><span class="p">(</span><span class="n">AbiFWError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exception raised if errors are present during the initialization of the task, before abinit is started.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ERROR_CODE</span> <span class="o">=</span> <span class="n">ErrorCode</span><span class="o">.</span><span class="n">INITIALIZATION</span></div>


<div class="viewcode-block" id="RestartError"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.RestartError">[docs]</a><span class="k">class</span> <span class="nc">RestartError</span><span class="p">(</span><span class="n">InitializationError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exception raised if errors show up during the set up of the restart.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ERROR_CODE</span> <span class="o">=</span> <span class="n">ErrorCode</span><span class="o">.</span><span class="n">RESTART</span></div>


<div class="viewcode-block" id="PostProcessError"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.PostProcessError">[docs]</a><span class="k">class</span> <span class="nc">PostProcessError</span><span class="p">(</span><span class="n">AbiFWError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exception raised if problems are encountered during the post processing of the abinit calculation.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ERROR_CODE</span> <span class="o">=</span> <span class="n">ErrorCode</span><span class="o">.</span><span class="n">POSTPROCESS</span></div>

<span class="c1">##############################</span>
<span class="c1"># Other objects</span>
<span class="c1">##############################</span>


<div class="viewcode-block" id="RestartInfo"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.RestartInfo">[docs]</a><span class="k">class</span> <span class="nc">RestartInfo</span><span class="p">(</span><span class="n">MSONable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Object that contains the information about the restart of a task.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">previous_dir</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_restarts</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">previous_dir</span> <span class="o">=</span> <span class="n">previous_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span> <span class="o">=</span> <span class="n">reset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_restarts</span> <span class="o">=</span> <span class="n">num_restarts</span>

<div class="viewcode-block" id="RestartInfo.as_dict"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.RestartInfo.as_dict">[docs]</a>    <span class="nd">@pmg_serialize</span>
    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">previous_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_dir</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">,</span> <span class="n">num_restarts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_restarts</span><span class="p">)</span></div>

<div class="viewcode-block" id="RestartInfo.from_dict"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.RestartInfo.from_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">previous_dir</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;previous_dir&#39;</span><span class="p">],</span> <span class="n">reset</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;reset&#39;</span><span class="p">],</span> <span class="n">num_restarts</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;num_restarts&#39;</span><span class="p">])</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">prev_outdir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A Directory object pointing to the outdir of the previous step.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">Directory</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_dir</span><span class="p">,</span> <span class="n">OUTDIR_NAME</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">prev_indir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A Directory object pointing to the indir of the previous step.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">Directory</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_dir</span><span class="p">,</span> <span class="n">INDIR_NAME</span><span class="p">))</span></div>


<div class="viewcode-block" id="ElasticComplianceTensor"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.ElasticComplianceTensor">[docs]</a><span class="k">class</span> <span class="nc">ElasticComplianceTensor</span><span class="p">(</span><span class="n">Has_Structure</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This object is used to store the elastic and compliance tensors.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elastic_tensor</span><span class="p">,</span> <span class="n">compliance_tensor</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">additional_info</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            elastic_tensor: (6, 6) array with the elastic tensor in Cartesian coordinates</span>
<span class="sd">            compliance_tensor: (6, 6) array with the compliance tensor in Cartesian coordinates</span>
<span class="sd">            structure: |Structure| object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span> <span class="o">=</span> <span class="n">structure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elastic_tensor</span> <span class="o">=</span> <span class="n">elastic_tensor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compliance_tensor</span> <span class="o">=</span> <span class="n">compliance_tensor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">additional_info</span> <span class="o">=</span> <span class="n">additional_info</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;|Structure| object.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_structure</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_string</span><span class="p">()</span>

<div class="viewcode-block" id="ElasticComplianceTensor.from_ec_nc_file"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.ElasticComplianceTensor.from_ec_nc_file">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_ec_nc_file</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">ec_nc_file</span><span class="p">,</span> <span class="n">tensor_type</span><span class="o">=</span><span class="s1">&#39;relaxed_ion&#39;</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">NetcdfReader</span><span class="p">(</span><span class="n">ec_nc_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">nc_reader</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tensor_type</span> <span class="o">==</span> <span class="s1">&#39;relaxed_ion&#39;</span><span class="p">:</span>
                <span class="n">ec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nc_reader</span><span class="o">.</span><span class="n">read_variable</span><span class="p">(</span><span class="s1">&#39;elastic_constants_relaxed_ion&#39;</span><span class="p">))</span>
                <span class="n">compl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nc_reader</span><span class="o">.</span><span class="n">read_variable</span><span class="p">(</span><span class="s1">&#39;compliance_constants_relaxed_ion&#39;</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">tensor_type</span> <span class="o">==</span> <span class="s1">&#39;clamped_ion&#39;</span><span class="p">:</span>
                <span class="n">ec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nc_reader</span><span class="o">.</span><span class="n">read_variable</span><span class="p">(</span><span class="s1">&#39;elastic_constants_clamped_ion&#39;</span><span class="p">))</span>
                <span class="n">compl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nc_reader</span><span class="o">.</span><span class="n">read_variable</span><span class="p">(</span><span class="s1">&#39;compliance_constants_clamped_ion&#39;</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">tensor_type</span> <span class="o">==</span> <span class="s1">&#39;relaxed_ion_stress_corrected&#39;</span><span class="p">:</span>
                <span class="n">ec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nc_reader</span><span class="o">.</span><span class="n">read_variable</span><span class="p">(</span><span class="s1">&#39;elastic_constants_relaxed_ion_stress_corrected&#39;</span><span class="p">))</span>
                <span class="n">compl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nc_reader</span><span class="o">.</span><span class="n">read_variable</span><span class="p">(</span><span class="s1">&#39;compliance_constants_relaxed_ion_stress_corrected&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;tensor_type &quot;</span><span class="si">{0}</span><span class="s1">&quot; not allowed&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tensor_type</span><span class="p">))</span>
        <span class="c1">#TODO: add the structure object!</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">elastic_tensor</span><span class="o">=</span><span class="n">ec</span><span class="p">,</span> <span class="n">compliance_tensor</span><span class="o">=</span><span class="n">compl</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">additional_info</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;tensor_type&#39;</span><span class="p">:</span> <span class="n">tensor_type</span><span class="p">})</span></div>

<div class="viewcode-block" id="ElasticComplianceTensor.as_dict"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.ElasticComplianceTensor.as_dict">[docs]</a>    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;elastic_tensor&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">elastic_tensor</span><span class="p">,</span> <span class="s1">&#39;compliance_tensor&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">compliance_tensor</span><span class="p">,</span>
                <span class="s1">&#39;structure&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;additional_info&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">additional_info</span><span class="p">}</span></div>

<div class="viewcode-block" id="ElasticComplianceTensor.extended_dict"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.ElasticComplianceTensor.extended_dict">[docs]</a>    <span class="k">def</span> <span class="nf">extended_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">dd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
        <span class="n">K_Voigt</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elastic_tensor</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">elastic_tensor</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">elastic_tensor</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span>
                   <span class="mf">2.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">elastic_tensor</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">elastic_tensor</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">elastic_tensor</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="mf">9.0</span>
        <span class="n">K_Reuss</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">compliance_tensor</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">compliance_tensor</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">compliance_tensor</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span>
                         <span class="mf">2.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">compliance_tensor</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">compliance_tensor</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span>
                         <span class="mf">2.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">compliance_tensor</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">G_Voigt</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elastic_tensor</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">elastic_tensor</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">elastic_tensor</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">elastic_tensor</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">elastic_tensor</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">elastic_tensor</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span>
                   <span class="mf">3.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">elastic_tensor</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="mf">3.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">elastic_tensor</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="mf">3.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">elastic_tensor</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span> <span class="o">/</span> <span class="mf">15.0</span>
        <span class="n">G_Reuss</span> <span class="o">=</span> <span class="mf">15.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">4.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">compliance_tensor</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">4.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">compliance_tensor</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span>
                          <span class="mf">4.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">compliance_tensor</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mf">4.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">compliance_tensor</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span>
                          <span class="mf">4.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">compliance_tensor</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mf">4.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">compliance_tensor</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span>
                          <span class="mf">3.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">compliance_tensor</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="mf">3.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">compliance_tensor</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">+</span>
                          <span class="mf">3.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">compliance_tensor</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
        <span class="n">K_VRH</span> <span class="o">=</span> <span class="p">(</span><span class="n">K_Voigt</span> <span class="o">+</span> <span class="n">K_Reuss</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">G_VRH</span> <span class="o">=</span> <span class="p">(</span><span class="n">G_Voigt</span> <span class="o">+</span> <span class="n">G_Reuss</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">universal_elastic_anisotropy</span> <span class="o">=</span> <span class="mf">5.0</span><span class="o">*</span><span class="n">G_Voigt</span><span class="o">/</span><span class="n">G_Reuss</span> <span class="o">+</span> <span class="n">K_Voigt</span><span class="o">/</span><span class="n">K_Reuss</span> <span class="o">-</span> <span class="mf">6.0</span>
        <span class="n">isotropic_poisson_ratio</span> <span class="o">=</span> <span class="p">(</span><span class="mf">3.0</span><span class="o">*</span><span class="n">K_VRH</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">G_VRH</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">6.0</span><span class="o">*</span><span class="n">K_VRH</span> <span class="o">+</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">G_VRH</span><span class="p">)</span>
        <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;K_Voigt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">K_Voigt</span>
        <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;G_Voigt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">G_Voigt</span>
        <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;K_Reuss&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">K_Reuss</span>
        <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;G_Reuss&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">G_Reuss</span>
        <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;K_VRH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">K_VRH</span>
        <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;G_VRH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">G_VRH</span>
        <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;universal_elastic_anistropy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">universal_elastic_anisotropy</span>
        <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;isotropic_poisson_ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">isotropic_poisson_ratio</span>
        <span class="k">return</span> <span class="n">dd</span></div>

<div class="viewcode-block" id="ElasticComplianceTensor.from_dict"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.ElasticComplianceTensor.from_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">dd</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">elastic_tensor</span><span class="o">=</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;elastic_tensor&#39;</span><span class="p">],</span> <span class="n">compliance_tensor</span><span class="o">=</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;compliance_tensor&#39;</span><span class="p">],</span>
                   <span class="n">structure</span><span class="o">=</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;structure&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">dd</span><span class="p">[</span><span class="s1">&#39;structure&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="n">additional_info</span><span class="o">=</span><span class="n">dd</span><span class="p">[</span><span class="s1">&#39;additional_info&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="ElasticComplianceTensor.get_pmg_elastic_tensor"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks.ElasticComplianceTensor.get_pmg_elastic_tensor">[docs]</a>    <span class="k">def</span> <span class="nf">get_pmg_elastic_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts to a pymatgen :class:`ElasticTensor` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ElasticTensor</span><span class="o">.</span><span class="n">from_voigt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elastic_tensor</span><span class="p">)</span></div></div>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2017, The Abinit group.<br/>
      Last updated on Sep 05, 2018.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.5.<br/>
    </p>
  </div>
</footer>
  </body>
</html>