<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>abiflows.fireworks.tasks.abinit_tasks_src &#8212; abiflows 0.6 documentation</title>
    <link rel="stylesheet" href="../../../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/my_style.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../../../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../../../../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../../../../_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../../../../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../../index.html">
          abiflows</a>
        <span class="navbar-text navbar-version pull-left"><b>0.6</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../installation.html">Getting AbiFlows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../setup.html">Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../workflows.html">Abinit Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../results_db.html">Results database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../failures.html">Errors and failures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../changelog.html">Changelog</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../useful_links.html">Useful links</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../zzbiblio.html">Bibliography</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/modules.html">abiflows</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
              
                
              
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <h1>Source code for abiflows.fireworks.tasks.abinit_tasks_src</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">monty.json</span> <span class="kn">import</span> <span class="n">MSONable</span><span class="p">,</span> <span class="n">MontyDecoder</span>
<span class="kn">from</span> <span class="nn">monty.os.path</span> <span class="kn">import</span> <span class="n">which</span>
<span class="kn">from</span> <span class="nn">pymatgen.util.serialization</span> <span class="kn">import</span> <span class="n">json_pretty_dump</span><span class="p">,</span> <span class="n">pmg_serialize</span>
<span class="kn">from</span> <span class="nn">abipy.flowtk.utils</span> <span class="kn">import</span> <span class="n">Directory</span><span class="p">,</span> <span class="n">File</span><span class="p">,</span> <span class="n">irdvars_for_ext</span>
<span class="kn">from</span> <span class="nn">abipy.flowtk</span> <span class="kn">import</span> <span class="n">events</span>
<span class="kn">from</span> <span class="nn">abipy.flowtk.qutils</span> <span class="kn">import</span> <span class="n">time2slurm</span>
<span class="kn">from</span> <span class="nn">abipy.flowtk.events</span> <span class="kn">import</span> <span class="n">EventsParser</span>

<span class="kn">from</span> <span class="nn">abipy.abio.factories</span> <span class="kn">import</span> <span class="n">InputFactory</span>
<span class="kn">from</span> <span class="nn">abipy.abio.factories</span> <span class="kn">import</span> <span class="n">PiezoElasticFromGsFactory</span>
<span class="kn">from</span> <span class="nn">abipy.abio.inputs</span> <span class="kn">import</span> <span class="n">AbinitInput</span><span class="p">,</span> <span class="n">Cut3DInput</span>
<span class="kn">from</span> <span class="nn">abipy.abio.input_tags</span> <span class="kn">import</span> <span class="n">STRAIN</span><span class="p">,</span> <span class="n">GROUND_STATE</span><span class="p">,</span> <span class="n">NSCF</span><span class="p">,</span> <span class="n">PHONON</span>
<span class="kn">from</span> <span class="nn">abipy.electrons.gsr</span> <span class="kn">import</span> <span class="n">GsrFile</span>
<span class="kn">from</span> <span class="nn">abipy.electrons.charges</span> <span class="kn">import</span> <span class="n">HirshfeldCharges</span>
<span class="kn">from</span> <span class="nn">abipy.flowtk.netcdf</span> <span class="kn">import</span> <span class="n">NetcdfReader</span><span class="p">,</span> <span class="n">NO_DEFAULT</span>
<span class="kn">from</span> <span class="nn">fireworks</span> <span class="kn">import</span> <span class="n">explicit_serialize</span>
<span class="kn">from</span> <span class="nn">fireworks.utilities.fw_serializers</span> <span class="kn">import</span> <span class="n">serialize_fw</span>
<span class="kn">from</span> <span class="nn">fireworks.core.firework</span> <span class="kn">import</span> <span class="n">Firework</span><span class="p">,</span> <span class="n">FireTaskBase</span><span class="p">,</span> <span class="n">FWAction</span><span class="p">,</span> <span class="n">Workflow</span>
<span class="kn">from</span> <span class="nn">abiflows.fireworks.tasks.src_tasks_abc</span> <span class="kn">import</span> <span class="n">SetupTask</span><span class="p">,</span> <span class="n">RunTask</span><span class="p">,</span> <span class="n">ControlTask</span><span class="p">,</span> <span class="n">SetupError</span><span class="p">,</span> <span class="n">createSRCFireworks</span>
<span class="kn">from</span> <span class="nn">abiflows.core.mastermind_abc</span> <span class="kn">import</span> <span class="n">ControllerNote</span><span class="p">,</span> <span class="n">ControlProcedure</span>
<span class="kn">from</span> <span class="nn">abiflows.core.controllers</span> <span class="kn">import</span> <span class="n">AbinitController</span><span class="p">,</span> <span class="n">WalltimeController</span><span class="p">,</span> <span class="n">MemoryController</span>
<span class="kn">from</span> <span class="nn">abiflows.fireworks.utils.fw_utils</span> <span class="kn">import</span> <span class="n">FWTaskManager</span><span class="p">,</span> <span class="n">links_dict_update</span><span class="p">,</span> <span class="n">set_short_single_core_to_spec</span>
<span class="kn">from</span> <span class="nn">abiflows.fireworks.utils.math_utils</span> <span class="kn">import</span> <span class="n">divisors</span>
<span class="kn">from</span> <span class="nn">abiflows.fireworks.tasks.abinit_tasks</span> <span class="kn">import</span> <span class="n">MergeDdbAbinitTask</span>
<span class="kn">from</span> <span class="nn">abiflows.fireworks.tasks.abinit_common</span> <span class="kn">import</span> <span class="n">TMPDIR_NAME</span><span class="p">,</span> <span class="n">OUTDIR_NAME</span><span class="p">,</span> <span class="n">INDIR_NAME</span><span class="p">,</span> <span class="n">STDERR_FILE_NAME</span><span class="p">,</span> \
    <span class="n">LOG_FILE_NAME</span><span class="p">,</span> <span class="n">FILES_FILE_NAME</span><span class="p">,</span> <span class="n">OUTPUT_FILE_NAME</span><span class="p">,</span> <span class="n">INPUT_FILE_NAME</span><span class="p">,</span> <span class="n">MPIABORTFILE</span>


<span class="n">RESET_RESTART</span> <span class="o">=</span> <span class="n">ControllerNote</span><span class="o">.</span><span class="n">RESET_RESTART</span>
<span class="n">SIMPLE_RESTART</span> <span class="o">=</span> <span class="n">ControllerNote</span><span class="o">.</span><span class="n">SIMPLE_RESTART</span>
<span class="n">RESTART_FROM_SCRATCH</span> <span class="o">=</span> <span class="n">ControllerNote</span><span class="o">.</span><span class="n">RESTART_FROM_SCRATCH</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="AbinitSRCMixin"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.AbinitSRCMixin">[docs]</a><span class="k">class</span> <span class="nc">AbinitSRCMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="c1"># Prefixes for Abinit (input, output, temporary) files.</span>
    <span class="n">Prefix</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;Prefix&quot;</span><span class="p">,</span> <span class="s2">&quot;idata odata tdata&quot;</span><span class="p">)</span>
    <span class="n">pj</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span>

    <span class="n">prefix</span> <span class="o">=</span> <span class="n">Prefix</span><span class="p">(</span><span class="n">pj</span><span class="p">(</span><span class="s2">&quot;indata&quot;</span><span class="p">,</span> <span class="s2">&quot;in&quot;</span><span class="p">),</span> <span class="n">pj</span><span class="p">(</span><span class="s2">&quot;outdata&quot;</span><span class="p">,</span> <span class="s2">&quot;out&quot;</span><span class="p">),</span> <span class="n">pj</span><span class="p">(</span><span class="s2">&quot;tmpdata&quot;</span><span class="p">,</span> <span class="s2">&quot;tmp&quot;</span><span class="p">))</span>
    <span class="k">del</span> <span class="n">Prefix</span><span class="p">,</span> <span class="n">pj</span>

<div class="viewcode-block" id="AbinitSRCMixin.get_fw_task_manager"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.AbinitSRCMixin.get_fw_task_manager">[docs]</a>    <span class="k">def</span> <span class="nf">get_fw_task_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;ftm_file&#39;</span> <span class="ow">in</span> <span class="n">fw_spec</span><span class="p">:</span>
            <span class="n">ftm</span> <span class="o">=</span> <span class="n">FWTaskManager</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">[</span><span class="s1">&#39;ftm_file&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ftm</span> <span class="o">=</span> <span class="n">FWTaskManager</span><span class="o">.</span><span class="n">from_user_config</span><span class="p">()</span>
        <span class="n">ftm</span><span class="o">.</span><span class="n">update_fw_policy</span><span class="p">(</span><span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fw_policy&#39;</span><span class="p">,</span> <span class="p">{}))</span>
        <span class="k">return</span> <span class="n">ftm</span></div>

<div class="viewcode-block" id="AbinitSRCMixin.setup_rundir"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.AbinitSRCMixin.setup_rundir">[docs]</a>    <span class="k">def</span> <span class="nf">setup_rundir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rundir</span><span class="p">,</span> <span class="n">create_dirs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">directories_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the run directory.&quot;&quot;&quot;</span>

        <span class="c1"># Files required for the execution.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">directories_only</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">input_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rundir</span><span class="p">,</span> <span class="n">INPUT_FILE_NAME</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rundir</span><span class="p">,</span> <span class="n">OUTPUT_FILE_NAME</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">files_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rundir</span><span class="p">,</span> <span class="n">FILES_FILE_NAME</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rundir</span><span class="p">,</span> <span class="n">LOG_FILE_NAME</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stderr_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rundir</span><span class="p">,</span> <span class="n">STDERR_FILE_NAME</span><span class="p">))</span>

            <span class="c1"># This file is produce by Abinit if nprocs &gt; 1 and MPI_ABORT.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mpiabort_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rundir</span><span class="p">,</span> <span class="n">MPIABORTFILE</span><span class="p">))</span>

        <span class="c1"># Directories with input|output|temporary data.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rundir</span><span class="p">,</span> <span class="n">INDIR_NAME</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rundir</span><span class="p">,</span> <span class="n">OUTDIR_NAME</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rundir</span><span class="p">,</span> <span class="n">TMPDIR_NAME</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">create_dirs</span><span class="p">:</span>
            <span class="c1"># Create dirs for input, output and tmp data.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indir</span><span class="o">.</span><span class="n">makedirs</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">makedirs</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="o">.</span><span class="n">makedirs</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="AbinitSetupTask"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.AbinitSetupTask">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">AbinitSetupTask</span><span class="p">(</span><span class="n">AbinitSRCMixin</span><span class="p">,</span> <span class="n">SetupTask</span><span class="p">):</span>

    <span class="n">RUN_PARAMETERS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_queueadapter&#39;</span><span class="p">,</span> <span class="s1">&#39;qtk_queueadapter&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">abiinput</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">task_helper</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">task_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">restart_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pass_input</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">task_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">task_type</span> <span class="o">=</span> <span class="n">task_helper</span><span class="o">.</span><span class="n">task_type</span>
        <span class="n">SetupTask</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="n">deps</span><span class="p">,</span> <span class="n">restart_info</span><span class="o">=</span><span class="n">restart_info</span><span class="p">,</span> <span class="n">task_type</span><span class="o">=</span><span class="n">task_type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span> <span class="o">=</span> <span class="n">abiinput</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pass_input</span> <span class="o">=</span> <span class="n">pass_input</span>

        <span class="c1"># # deps are transformed to be a list or a dict of lists</span>
        <span class="c1"># if isinstance(deps, dict):</span>
        <span class="c1">#     deps = dict(deps)</span>
        <span class="c1">#     for k, v in deps.items():</span>
        <span class="c1">#         if not isinstance(v, (list, tuple)):</span>
        <span class="c1">#             deps[k] = [v]</span>
        <span class="c1"># elif deps and not isinstance(deps, (list, tuple)):</span>
        <span class="c1">#     deps = [deps]</span>
        <span class="c1"># self.deps = deps</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">task_helper</span> <span class="o">=</span> <span class="n">task_helper</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_helper</span><span class="o">.</span><span class="n">set_task</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="AbinitSetupTask.setup_directories"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.AbinitSetupTask.setup_directories">[docs]</a>    <span class="k">def</span> <span class="nf">setup_directories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">,</span> <span class="n">create_dirs</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">SetupTask</span><span class="o">.</span><span class="n">setup_directories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="o">=</span><span class="n">fw_spec</span><span class="p">,</span> <span class="n">create_dirs</span><span class="o">=</span><span class="n">create_dirs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_rundir</span><span class="p">(</span><span class="n">rundir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="p">,</span> <span class="n">create_dirs</span><span class="o">=</span><span class="n">create_dirs</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbinitSetupTask.run_task"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.AbinitSetupTask.run_task">[docs]</a>    <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="c1">#TODO create a initialize_setup abstract function in SetupTask and put it there? or move somewhere else?</span>
        <span class="c1">#setup the FWTaskManager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ftm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fw_task_manager</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;previous_src&#39;</span> <span class="ow">in</span> <span class="n">fw_spec</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prev_outdir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">[</span><span class="s1">&#39;previous_src&#39;</span><span class="p">][</span><span class="s1">&#39;src_directories&#39;</span><span class="p">][</span><span class="s1">&#39;run_dir&#39;</span><span class="p">],</span>
                                                      <span class="n">OUTDIR_NAME</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">run_task</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbinitSetupTask.setup_run_parameters"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.AbinitSetupTask.setup_run_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">setup_run_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">RUN_PARAMETERS</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">remove_vars</span><span class="p">([</span><span class="s1">&#39;npkpt&#39;</span><span class="p">,</span> <span class="s1">&#39;npspinor&#39;</span><span class="p">,</span> <span class="s1">&#39;npband&#39;</span><span class="p">,</span> <span class="s1">&#39;npfft&#39;</span><span class="p">,</span> <span class="s1">&#39;bandpp&#39;</span><span class="p">],</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">optconf</span><span class="p">,</span> <span class="n">qtk_qadapter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_autoparal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">)</span>

        <span class="c1"># if &#39;queue_adapter_update&#39; in fw_spec:</span>
        <span class="c1">#     for qa_key, qa_val in fw_spec[&#39;queue_adapter_update&#39;].items():</span>
        <span class="c1">#         if qa_key == &#39;timelimit&#39;:</span>
        <span class="c1">#             qtk_qadapter.set_timelimit(qa_val)</span>
        <span class="c1">#         elif qa_key == &#39;mem_per_proc&#39;:</span>
        <span class="c1">#             qtk_qadapter.set_mem_per_proc(qa_val)</span>
        <span class="c1">#         elif qa_key == &#39;master_mem_overhead&#39;:</span>
        <span class="c1">#             qtk_qadapter.set_master_mem_overhead(qa_val)</span>
        <span class="c1">#         else:</span>
        <span class="c1">#             raise ValueError(&#39;queue_adapter update &quot;{}&quot; is not valid&#39;.format(qa_key))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">optconf</span><span class="o">.</span><span class="n">vars</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;_queueadapter&#39;</span><span class="p">:</span> <span class="n">qtk_qadapter</span><span class="o">.</span><span class="n">get_subs_dict</span><span class="p">(),</span> <span class="s1">&#39;qtk_queueadapter&#39;</span><span class="p">:</span> <span class="n">qtk_qadapter</span><span class="p">}</span></div>

<div class="viewcode-block" id="AbinitSetupTask.file_transfers"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.AbinitSetupTask.file_transfers">[docs]</a>    <span class="k">def</span> <span class="nf">file_transfers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="AbinitSetupTask.fetch_previous_info"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.AbinitSetupTask.fetch_previous_info">[docs]</a>    <span class="k">def</span> <span class="nf">fetch_previous_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="c1"># Copy the appropriate dependencies in the in dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resolve_deps</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbinitSetupTask.prepare_run"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.AbinitSetupTask.prepare_run">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="c1"># if the input is a factory, dynamically create the abinit input. From now on the code will expect an</span>
        <span class="c1"># AbinitInput and not a factory. In this case there should be either a single input coming from the previous</span>
        <span class="c1"># fws or a deps specifying which input use</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="p">,</span> <span class="n">InputFactory</span><span class="p">):</span>
            <span class="c1">#FIXME save initialization_info somewhere. What to do with the TaskHistory?</span>
            <span class="c1"># initialization_info[&#39;input_factory&#39;] = self.abiinput</span>
            <span class="n">previous_input</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">input_required</span><span class="p">:</span>
                <span class="n">previous_fws</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;previous_fws&#39;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="c1"># check if the input source is specified</span>
                <span class="n">task_type_source</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">task_type_source</span> <span class="o">=</span> <span class="p">[</span><span class="n">tt</span> <span class="k">for</span> <span class="n">tt</span><span class="p">,</span> <span class="n">deps</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;@input&#39;</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="c1"># if not there should be only one previous fw</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">task_type_source</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">previous_fws</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;The input source cannot be identified from depenencies </span><span class="si">{}</span><span class="s1">. &#39;</span> \
                              <span class="s1">&#39;required by factory </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="n">SetupError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="n">task_type_source</span> <span class="o">=</span> <span class="n">previous_fws</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># the task_type_source should contain just one task and contain the &#39;input&#39; key</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">previous_fws</span><span class="p">[</span><span class="n">task_type_source</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">previous_fws</span><span class="p">[</span><span class="n">task_type_source</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;The factory </span><span class="si">{}</span><span class="s1"> requires the input from previous run in the spec&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">SetupError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="c1"># a single input exists</span>
                <span class="n">previous_input</span> <span class="o">=</span> <span class="n">previous_fws</span><span class="p">[</span><span class="n">task_type_source</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;input&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">previous_input</span><span class="p">,</span> <span class="n">AbinitInput</span><span class="p">):</span>
                    <span class="n">previous_input</span> <span class="o">=</span> <span class="n">AbinitInput</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">previous_input</span><span class="p">)</span>
                <span class="c1"># initialization_info[&#39;previous_input&#39;] = previous_input</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">build_input</span><span class="p">(</span><span class="n">previous_input</span><span class="p">)</span>

        <span class="c1"># initialization_info[&#39;initial_input&#39;] = self.abiinput</span>

        <span class="c1"># if it&#39;s the first run log the initialization of the task</span>
        <span class="c1"># if len(self.history) == 0:</span>
        <span class="c1">#     self.history.log_initialization(self, initialization_info)</span>

        <span class="c1">#TODO check if keeping this in the helpers or removing</span>
        <span class="c1"># update data from previous run if it is not a restart</span>
        <span class="c1"># if &#39;previous_fws&#39; in fw_spec and not self.restart_info:</span>
        <span class="c1">#     self.load_previous_fws_data(fw_spec)</span>

        <span class="c1"># THE FOLLOWING HAS BEEN MOVED TO setup_directories</span>
        <span class="c1"># self.setup_rundir(rundir=self.run_dir, create_dirs=True)</span>

        <span class="c1"># THE FOLLOWING HAS BEEN MOVED TO fetch_previous_info</span>
        <span class="c1"># Copy the appropriate dependencies in the in dir</span>
        <span class="c1"># self.resolve_deps(fw_spec)</span>

        <span class="c1"># if it&#39;s the restart of a previous task, perform specific task updates.</span>
        <span class="c1"># perform these updates before writing the input, but after creating the dirs.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_info</span><span class="p">:</span>
            <span class="c1">#TODO check if this is the correct way of doing the restart</span>
            <span class="c1"># self.history.log_restart(self.restart_info)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task_helper</span><span class="o">.</span><span class="n">restart</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">restart_info</span><span class="p">)</span>

        <span class="c1"># Write files file and input file.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">files_file</span><span class="o">.</span><span class="n">exists</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">files_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filesfile_string</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">input_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="p">))</span></div>

<div class="viewcode-block" id="AbinitSetupTask.run_autoparal"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.AbinitSetupTask.run_autoparal">[docs]</a>    <span class="k">def</span> <span class="nf">run_autoparal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">abiinput</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">,</span> <span class="n">clean_up</span><span class="o">=</span><span class="s1">&#39;partial&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs the autoparal using AbinitInput abiget_autoparal_pconfs method.</span>
<span class="sd">        The information are retrieved from the FWTaskManager that should be present and contain the standard</span>
<span class="sd">        abipy TaskManager, that provides information about the queue adapters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#FIXME autoparal may need the deps in some cases. here they are not resolved</span>
        <span class="n">manager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="o">.</span><span class="n">task_manager</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">manager</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;No task manager available: autoparal could not be performed.&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">SetupError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">autoparal_dir</span> <span class="o">=</span> <span class="s1">&#39;run_autoparal&#39;</span>
        <span class="c1"># Set npfft by hand in autoparal if ngfft is found ...</span>
        <span class="k">if</span> <span class="s1">&#39;ngfft&#39;</span> <span class="ow">in</span> <span class="n">abiinput</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">GROUND_STATE</span> <span class="ow">in</span> <span class="n">abiinput</span><span class="o">.</span><span class="n">runlevel</span> <span class="ow">or</span> <span class="n">NSCF</span> <span class="ow">in</span> <span class="n">abiinput</span><span class="o">.</span><span class="n">runlevel</span><span class="p">:</span>
                <span class="n">npfft_set</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">}</span>
                <span class="n">ngfft</span> <span class="o">=</span> <span class="n">abiinput</span><span class="p">[</span><span class="s1">&#39;ngfft&#39;</span><span class="p">]</span>
                <span class="n">divsy</span> <span class="o">=</span> <span class="n">divisors</span><span class="p">(</span><span class="n">ngfft</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">divsz</span> <span class="o">=</span> <span class="n">divisors</span><span class="p">(</span><span class="n">ngfft</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">npfft_set</span> <span class="o">=</span> <span class="n">npfft_set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">divsy</span><span class="p">))</span>
                <span class="n">npfft_set</span> <span class="o">=</span> <span class="n">npfft_set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">divsz</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">abiinput</span><span class="o">.</span><span class="n">ispaw</span><span class="p">:</span>
                    <span class="n">ngfftdg</span> <span class="o">=</span> <span class="n">abiinput</span><span class="p">[</span><span class="s1">&#39;ngfftdg&#39;</span><span class="p">]</span>
                    <span class="n">divsy</span> <span class="o">=</span> <span class="n">divisors</span><span class="p">(</span><span class="n">ngfftdg</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">divsz</span> <span class="o">=</span> <span class="n">divisors</span><span class="p">(</span><span class="n">ngfftdg</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">npfft_set</span> <span class="o">=</span> <span class="n">npfft_set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">divsy</span><span class="p">))</span>
                    <span class="n">npfft_set</span> <span class="o">=</span> <span class="n">npfft_set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">divsz</span><span class="p">))</span>
                <span class="n">abiinput</span><span class="p">[</span><span class="s1">&#39;npfft&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">npfft_set</span><span class="p">)</span>
        <span class="n">pconfs</span> <span class="o">=</span> <span class="n">abiinput</span><span class="o">.</span><span class="n">abiget_autoparal_pconfs</span><span class="p">(</span><span class="n">max_ncpus</span><span class="o">=</span><span class="n">manager</span><span class="o">.</span><span class="n">max_cores</span><span class="p">,</span> <span class="n">workdir</span><span class="o">=</span><span class="n">autoparal_dir</span><span class="p">,</span>
                                                  <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">)</span>
        <span class="n">optconf</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">select_qadapter</span><span class="p">(</span><span class="n">pconfs</span><span class="p">)</span>

        <span class="n">d</span> <span class="o">=</span> <span class="n">pconfs</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;optimal_conf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optconf</span>
        <span class="n">json_pretty_dump</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">autoparal_dir</span><span class="p">,</span> <span class="s2">&quot;autoparal.json&quot;</span><span class="p">))</span>

        <span class="c1"># Method to clean the output files</span>
        <span class="k">def</span> <span class="nf">safe_rm</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">autoparal_dir</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># clean up useless files.</span>
        <span class="k">if</span> <span class="n">clean_up</span> <span class="o">==</span> <span class="s1">&#39;partial&#39;</span><span class="p">:</span>
            <span class="n">to_be_removed</span> <span class="o">=</span> <span class="p">[</span><span class="n">TMPDIR_NAME</span><span class="p">,</span> <span class="n">OUTDIR_NAME</span><span class="p">,</span> <span class="n">INDIR_NAME</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">to_be_removed</span><span class="p">:</span>
                <span class="n">safe_rm</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">autoparal_dir</span><span class="p">,</span> <span class="n">r</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">clean_up</span> <span class="o">==</span> <span class="s1">&#39;full&#39;</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">autoparal_dir</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">optconf</span><span class="p">,</span> <span class="n">manager</span><span class="o">.</span><span class="n">qadapter</span></div>

<div class="viewcode-block" id="AbinitSetupTask.link_ext"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.AbinitSetupTask.link_ext">[docs]</a>    <span class="k">def</span> <span class="nf">link_ext</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">source_dir</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">odata</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">ext</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Need path </span><span class="si">{}</span><span class="s2"> with ext </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">ext</span><span class="p">))</span>
        <span class="n">dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">idata</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">ext</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
            <span class="c1"># Try netcdf file. TODO: this case should be treated in a cleaner way.</span>
            <span class="n">source</span> <span class="o">+=</span> <span class="s2">&quot;-etsf.nc&quot;</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">source</span><span class="p">):</span> <span class="n">dest</span> <span class="o">+=</span> <span class="s2">&quot;-etsf.nc&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">strict</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> is needed by this task but it does not exist&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">SetupError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Link path to dest if dest link does not exist.</span>
        <span class="c1"># else check that it points to the expected file.</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Linking path </span><span class="si">{}</span><span class="s2"> --&gt; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">strict</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="o">.</span><span class="n">fw_policy</span><span class="o">.</span><span class="n">copy_deps</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dest</span></div>

<div class="viewcode-block" id="AbinitSetupTask.link_ddk"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.AbinitSetupTask.link_ddk">[docs]</a>    <span class="k">def</span> <span class="nf">link_ddk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_dir</span><span class="p">):</span>
        <span class="c1"># handle the custom DDK extension on its own</span>
        <span class="c1"># accept more than one DDK file in the outdir: multiple perturbations are allowed in a</span>
        <span class="c1"># single calculation</span>
        <span class="n">outdata_dir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source_dir</span><span class="p">,</span> <span class="n">OUTDIR_NAME</span><span class="p">))</span>
        <span class="n">ddks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">outdata_dir</span><span class="o">.</span><span class="n">list_filepaths</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_DDK&#39;</span><span class="p">):</span>
                <span class="n">ddks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ddks</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;DDK is needed by this task but it does not exist&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">SetupError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">exts</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">ddk</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">ddk</span> <span class="ow">in</span> <span class="n">ddks</span><span class="p">]</span>
        <span class="n">ddk_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">exts</span><span class="p">:</span>
            <span class="n">ddk_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">link_ext</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="n">source_dir</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">ddk_files</span></div>

<div class="viewcode-block" id="AbinitSetupTask.resolve_deps_per_task_type"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.AbinitSetupTask.resolve_deps_per_task_type">[docs]</a>    <span class="k">def</span> <span class="nf">resolve_deps_per_task_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">previous_tasks</span><span class="p">,</span> <span class="n">deps_list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">previous_task</span> <span class="ow">in</span> <span class="n">previous_tasks</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">deps_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;@structure&#39;</span><span class="p">):</span>
                    <span class="n">source_dir</span> <span class="o">=</span> <span class="n">previous_task</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">]</span>
                    <span class="n">gsr_file</span> <span class="o">=</span> <span class="n">GsrFile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source_dir</span><span class="p">,</span> <span class="s1">&#39;outdata&#39;</span><span class="p">,</span> <span class="s1">&#39;out_GSR.nc&#39;</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">set_structure</span><span class="p">(</span><span class="n">gsr_file</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span>
                    <span class="c1"># if &#39;structure&#39; not in previous_task:</span>
                    <span class="c1">#     msg = &quot;previous_fws does not contain the structure.&quot;</span>
                    <span class="c1">#     logger.error(msg)</span>
                    <span class="c1">#     raise SetupError(msg)</span>
                    <span class="c1"># self.abiinput.set_structure(previous_task[&#39;structure&#39;])</span>
                <span class="k">elif</span> <span class="n">d</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;@outnc&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">d</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#outnc&#39;</span><span class="p">):</span>
                    <span class="n">varname</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">outnc_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">previous_task</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">odata</span> <span class="o">+</span> <span class="s2">&quot;_OUT.nc&quot;</span><span class="p">)</span>
                    <span class="n">outnc_file</span> <span class="o">=</span> <span class="n">_AbinitOutNcFile</span><span class="p">(</span><span class="n">outnc_path</span><span class="p">)</span>
                    <span class="nb">vars</span> <span class="o">=</span> <span class="n">outnc_file</span><span class="o">.</span><span class="n">get_vars</span><span class="p">(</span><span class="nb">vars</span><span class="o">=</span><span class="p">[</span><span class="n">varname</span><span class="p">],</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="nb">vars</span><span class="p">)</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">d</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;@&#39;</span><span class="p">):</span>
                    <span class="n">source_dir</span> <span class="o">=</span> <span class="n">previous_task</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">irdvars_for_ext</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="s2">&quot;DDK&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">link_ddk</span><span class="p">(</span><span class="n">source_dir</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">link_ext</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">source_dir</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbinitSetupTask.resolve_deps"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.AbinitSetupTask.resolve_deps">[docs]</a>    <span class="k">def</span> <span class="nf">resolve_deps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to link the required deps for the current FW.</span>
<span class="sd">        Note that different cases are handled here depending whether the current FW is a restart or not and whether</span>
<span class="sd">        the rerun is performed in the same folder or not.</span>
<span class="sd">        In case of restart the safest choice is to link the deps of the previous FW, so that if they have been</span>
<span class="sd">        updated in the meanwhile we are taking the correct one.</span>
<span class="sd">        TODO: this last case sounds quite unlikely and should be tested</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># If no deps, nothing to do here</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># If this is the first run of the task, the informations are taken from the &#39;previous_fws&#39;,</span>
        <span class="c1"># that should be present.</span>
        <span class="n">previous_fws</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;previous_fws&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">previous_fws</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No previous_fws data. Needed for dependecies </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">SetupError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">restart_info</span><span class="p">:</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="c1"># check that there is only one previous_fws</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">previous_fws</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">previous_fws</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;previous_fws does not contain a single reference. &quot;</span> \
                          <span class="s2">&quot;Specify the dependency for </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">SetupError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">resolve_deps_per_task_type</span><span class="p">(</span><span class="n">previous_fws</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># deps should be a dict</span>
                <span class="k">for</span> <span class="n">task_type</span><span class="p">,</span> <span class="n">deps_list</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">task_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">previous_fws</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No previous_fws data for task type </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_type</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="n">SetupError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">previous_fws</span><span class="p">[</span><span class="n">task_type</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Previous_fws does not contain any reference for task type </span><span class="si">{}</span><span class="s2">, &quot;</span> \
                              <span class="s2">&quot;needed in reference </span><span class="si">{}</span><span class="s2">. &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="n">SetupError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">previous_fws</span><span class="p">[</span><span class="n">task_type</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Previous_fws contains more than a single reference for task type </span><span class="si">{}</span><span class="s2">, &quot;</span> \
                              <span class="s2">&quot;needed in reference </span><span class="si">{}</span><span class="s2">. Risk of overwriting.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">resolve_deps_per_task_type</span><span class="p">(</span><span class="n">previous_fws</span><span class="p">[</span><span class="n">task_type</span><span class="p">],</span> <span class="n">deps_list</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If it is a restart, link the one from the previous task.</span>
            <span class="c1"># If it&#39;s in the same dir, it is assumed that the dependencies have been corretly resolved in the previous</span>
            <span class="c1"># run. So do nothing</span>
            <span class="c1"># if self.restart_info.previous_dir == self.run_dir:</span>
            <span class="n">previous_run_dir</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="p">[</span><span class="s1">&#39;previous_src&#39;</span><span class="p">][</span><span class="s1">&#39;src_directories&#39;</span><span class="p">][</span><span class="s1">&#39;run_dir&#39;</span><span class="p">]</span>
            <span class="c1">#TODO: remove this ?</span>
            <span class="k">if</span> <span class="n">previous_run_dir</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;rerunning in the same dir, no action on the deps&#39;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="c1">#just link everything from the indata folder of the previous run. files needed for restart will be overwritten</span>

            <span class="n">prev_indata</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">previous_run_dir</span><span class="p">,</span> <span class="n">INDIR_NAME</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">prev_indata</span><span class="p">):</span>
                <span class="c1"># if the target is already a link, link to the source to avoid many nested levels of linking</span>
                <span class="n">source</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">prev_indata</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
                    <span class="n">source</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">readlink</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="p">,</span> <span class="n">INDIR_NAME</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>

            <span class="c1"># Resolve the dependencies that start with &#39;#&#39;</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="c1"># check that there is only one previous_fws</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">previous_fws</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">previous_fws</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;previous_fws does not contain a single reference. &quot;</span> \
                          <span class="s2">&quot;Specify the dependency for </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">SetupError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">deps</span> <span class="o">=</span> <span class="p">[</span><span class="n">dep</span> <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">deps</span> <span class="k">if</span> <span class="n">dep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resolve_deps_per_task_type</span><span class="p">(</span><span class="n">previous_fws</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">deps</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># deps should be a dict</span>
                <span class="k">for</span> <span class="n">task_type</span><span class="p">,</span> <span class="n">deps_list</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">task_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">previous_fws</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No previous_fws data for task type </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_type</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="n">SetupError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">previous_fws</span><span class="p">[</span><span class="n">task_type</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Previous_fws does not contain any reference for task type </span><span class="si">{}</span><span class="s2">, &quot;</span> \
                              <span class="s2">&quot;needed in reference </span><span class="si">{}</span><span class="s2">. &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                        <span class="k">raise</span> <span class="n">SetupError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">previous_fws</span><span class="p">[</span><span class="n">task_type</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Previous_fws contains more than a single reference for task type </span><span class="si">{}</span><span class="s2">, &quot;</span> \
                              <span class="s2">&quot;needed in reference </span><span class="si">{}</span><span class="s2">. Risk of overwriting.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">))</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                    <span class="n">deps_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">dep</span> <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps_list</span> <span class="k">if</span> <span class="n">dep</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;#&#39;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">resolve_deps_per_task_type</span><span class="p">(</span><span class="n">previous_fws</span><span class="p">[</span><span class="n">task_type</span><span class="p">],</span> <span class="n">deps_list</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">filesfile_string</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;String with the list of files and prefixes needed to execute ABINIT.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">append</span>
        <span class="n">pj</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span>

        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_file</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>                 <span class="c1"># Path to the input file</span>
        <span class="n">app</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_file</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>                <span class="c1"># Path to the output file</span>
        <span class="n">app</span><span class="p">(</span><span class="n">pj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">idata</span><span class="p">))</span>  <span class="c1"># Prefix for input data</span>
        <span class="n">app</span><span class="p">(</span><span class="n">pj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">odata</span><span class="p">))</span>  <span class="c1"># Prefix for output data</span>
        <span class="n">app</span><span class="p">(</span><span class="n">pj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">tdata</span><span class="p">))</span>  <span class="c1"># Prefix for temporary data</span>

        <span class="c1"># Paths to the pseudopotential files.</span>
        <span class="c1"># Note that here the pseudos **must** be sorted according to znucl.</span>
        <span class="c1"># Here we reorder the pseudos if the order is wrong.</span>
        <span class="n">ord_pseudos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">znucl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">to_abivars</span><span class="p">()[</span><span class="s2">&quot;znucl&quot;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">znucl</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">pseudos</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">Z</span> <span class="o">==</span> <span class="n">z</span><span class="p">:</span>
                    <span class="n">ord_pseudos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot find pseudo with znucl </span><span class="si">%s</span><span class="s2"> in pseudos:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pseudos</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">pseudo</span> <span class="ow">in</span> <span class="n">ord_pseudos</span><span class="p">:</span>
            <span class="n">app</span><span class="p">(</span><span class="n">pseudo</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

    <span class="c1">#TODO move this functions to AbinitTaskHelper? they will probably be called just by them</span>
<div class="viewcode-block" id="AbinitSetupTask.out_to_in"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.AbinitSetupTask.out_to_in">[docs]</a>    <span class="k">def</span> <span class="nf">out_to_in</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        links or copies, according to the fw_policy, the output file to the input data directory of this task</span>
<span class="sd">        and rename the file so that ABINIT will read it as an input data file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The absolute path of the new file in the indata directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">in_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">out_file</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;out&quot;</span><span class="p">,</span> <span class="s2">&quot;in&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indir</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">in_file</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">dest</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Will overwrite </span><span class="si">%s</span><span class="s2"> with </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">out_file</span><span class="p">))</span>

        <span class="c1"># if rerunning in the same folder the file should be moved anyway</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="o">.</span><span class="n">fw_policy</span><span class="o">.</span><span class="n">copy_deps</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># if dest already exists should be overwritten. see also resolve_deps and config_run</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">EEXIST</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>

        <span class="k">return</span> <span class="n">dest</span></div>

<div class="viewcode-block" id="AbinitSetupTask.in_to_in"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.AbinitSetupTask.in_to_in">[docs]</a>    <span class="k">def</span> <span class="nf">in_to_in</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        copies the input file to the input of a previous task to the data directory of this task</span>

<span class="sd">        Returns:</span>
<span class="sd">            The absolute path of the new file in the indata directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indir</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">in_file</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">dest</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Will overwrite </span><span class="si">%s</span><span class="s2"> with </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">in_file</span><span class="p">))</span>

        <span class="c1"># os.rename(out_file, dest)</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">in_file</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dest</span></div>

<div class="viewcode-block" id="AbinitSetupTask.remove_restart_vars"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.AbinitSetupTask.remove_restart_vars">[docs]</a>    <span class="k">def</span> <span class="nf">remove_restart_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exts</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exts</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">exts</span> <span class="o">=</span> <span class="p">[</span><span class="n">exts</span><span class="p">]</span>

        <span class="n">remove_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">exts</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">irdvars_for_ext</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">remove_vars</span><span class="p">(</span><span class="n">remove_vars</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Removing variables </span><span class="si">{}</span><span class="s2"> from input&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">remove_vars</span><span class="p">))</span></div>

<div class="viewcode-block" id="AbinitSetupTask.additional_task_info"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.AbinitSetupTask.additional_task_info">[docs]</a>    <span class="k">def</span> <span class="nf">additional_task_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pass_input</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;input&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">abiinput</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span></div></div>


<div class="viewcode-block" id="AbinitRunTask"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.AbinitRunTask">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">AbinitRunTask</span><span class="p">(</span><span class="n">AbinitSRCMixin</span><span class="p">,</span> <span class="n">RunTask</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">control_procedure</span><span class="p">,</span> <span class="n">task_helper</span><span class="p">,</span> <span class="n">task_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">task_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">task_type</span> <span class="o">=</span> <span class="n">task_helper</span><span class="o">.</span><span class="n">task_type</span>
        <span class="n">RunTask</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">control_procedure</span><span class="o">=</span><span class="n">control_procedure</span><span class="p">,</span> <span class="n">task_type</span><span class="o">=</span><span class="n">task_type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_helper</span> <span class="o">=</span> <span class="n">task_helper</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_helper</span><span class="o">.</span><span class="n">set_task</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="AbinitRunTask.config"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.AbinitRunTask.config">[docs]</a>    <span class="k">def</span> <span class="nf">config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ftm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fw_task_manager</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_rundir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">run_dir</span><span class="p">,</span> <span class="n">create_dirs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="AbinitRunTask.run"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.AbinitRunTask.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="c1">#TODO switch back to a simple process instead of a separate thread?</span>
        <span class="k">def</span> <span class="nf">abinit_process</span><span class="p">():</span>
            <span class="n">command</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1">#consider the case of serial execution</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="o">.</span><span class="n">fw_policy</span><span class="o">.</span><span class="n">mpirun_cmd</span><span class="p">:</span>
                <span class="n">command</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="o">.</span><span class="n">fw_policy</span><span class="o">.</span><span class="n">mpirun_cmd</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
                <span class="k">if</span> <span class="s1">&#39;mpi_ncpus&#39;</span> <span class="ow">in</span> <span class="n">fw_spec</span><span class="p">:</span>
                    <span class="n">command</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;-np&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">[</span><span class="s1">&#39;mpi_ncpus&#39;</span><span class="p">])])</span>
            <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="o">.</span><span class="n">fw_policy</span><span class="o">.</span><span class="n">abinit_cmd</span><span class="p">)</span>
            <span class="n">mytimelimit</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="p">[</span><span class="s1">&#39;qtk_queueadapter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">timelimit</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="o">.</span><span class="n">fw_policy</span><span class="o">.</span><span class="n">timelimit_buffer</span>
            <span class="k">if</span> <span class="n">mytimelimit</span> <span class="o">&lt;</span> <span class="mi">120</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Abinit timelimit less than 2 min. Probably wrong queue/job configuration&#39;</span><span class="p">)</span>
            <span class="n">command</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;--timelimit&#39;</span><span class="p">,</span> <span class="n">time2slurm</span><span class="p">(</span><span class="n">mytimelimit</span><span class="p">)])</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files_file</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stdin</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_file</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stdout</span><span class="p">,</span> \
                    <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stderr_file</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stderr</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">stderr</span><span class="p">)</span>

            <span class="p">(</span><span class="n">stdoutdata</span><span class="p">,</span> <span class="n">stderrdata</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">returncode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">returncode</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s1">&#39;run.log&#39;</span><span class="p">):</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">EventsParser</span><span class="p">()</span>
            <span class="n">report</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;run.log&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">report</span><span class="o">.</span><span class="n">run_completed</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">returncode</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">return</span>

        <span class="c1"># initialize returncode to avoid missing references in case of exception in the other thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returncode</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">abinit_process</span><span class="p">)</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span></div>

<div class="viewcode-block" id="AbinitRunTask.postrun"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.AbinitRunTask.postrun">[docs]</a>    <span class="k">def</span> <span class="nf">postrun</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="c1">#TODO should this be a general feature of the SRC?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_helper</span><span class="o">.</span><span class="n">conclude_task</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;qtk_queueadapter&#39;</span> <span class="p">:</span><span class="n">fw_spec</span><span class="p">[</span><span class="s1">&#39;qtk_queueadapter&#39;</span><span class="p">]}</span></div></div>


<div class="viewcode-block" id="AbinitControlTask"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.AbinitControlTask">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">AbinitControlTask</span><span class="p">(</span><span class="n">AbinitSRCMixin</span><span class="p">,</span> <span class="n">ControlTask</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">control_procedure</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_restarts</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">src_cleaning</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">task_helper</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">ControlTask</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">control_procedure</span><span class="o">=</span><span class="n">control_procedure</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">,</span> <span class="n">max_restarts</span><span class="o">=</span><span class="n">max_restarts</span><span class="p">,</span>
                             <span class="n">src_cleaning</span><span class="o">=</span><span class="n">src_cleaning</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task_helper</span> <span class="o">=</span> <span class="n">task_helper</span>

<div class="viewcode-block" id="AbinitControlTask.get_initial_objects_info"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.AbinitControlTask.get_initial_objects_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_initial_objects_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">setup_fw</span><span class="p">,</span> <span class="n">run_fw</span><span class="p">,</span> <span class="n">src_directories</span><span class="p">):</span>
        <span class="n">run_dir</span> <span class="o">=</span> <span class="n">src_directories</span><span class="p">[</span><span class="s1">&#39;run_dir&#39;</span><span class="p">]</span>
        <span class="n">run_task</span> <span class="o">=</span> <span class="n">run_fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">run_task</span><span class="o">.</span><span class="n">setup_rundir</span><span class="p">(</span><span class="n">rundir</span><span class="o">=</span><span class="n">run_dir</span><span class="p">,</span> <span class="n">create_dirs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">directories_only</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">task_helper</span> <span class="o">=</span> <span class="n">run_task</span><span class="o">.</span><span class="n">task_helper</span>
        <span class="n">task_helper</span><span class="o">.</span><span class="n">set_task</span><span class="p">(</span><span class="n">run_task</span><span class="p">)</span>
        <span class="n">init_obj_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;abinit_input&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;object&#39;</span><span class="p">:</span> <span class="n">setup_fw</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">abiinput</span><span class="p">,</span>
                                          <span class="s1">&#39;updates&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="s1">&#39;setup_task&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;attribute&#39;</span><span class="p">:</span> <span class="s1">&#39;abiinput&#39;</span><span class="p">}]},</span>
                         <span class="s1">&#39;abinit_output_filepath&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;object&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="n">OUTPUT_FILE_NAME</span><span class="p">)},</span>
                         <span class="s1">&#39;abinit_log_filepath&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;object&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="n">LOG_FILE_NAME</span><span class="p">)},</span>
                         <span class="s1">&#39;abinit_mpi_abort_filepath&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;object&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="n">MPIABORTFILE</span><span class="p">)},</span>
                         <span class="s1">&#39;abinit_outdir_path&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;object&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="n">OUTDIR_NAME</span><span class="p">)},</span>
                         <span class="s1">&#39;abinit_err_filepath&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;object&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">run_dir</span><span class="p">,</span> <span class="n">STDERR_FILE_NAME</span><span class="p">)}}</span>
        <span class="c1"># &#39;structure&#39;: {&#39;object&#39;: task_helper.get_final_structure(),</span>
        <span class="c1">#               &#39;updates&#39;: [{&#39;target&#39;: &#39;setup_task.abiinput&#39;,</span>
        <span class="c1">#                            &#39;setter&#39;: &#39;set_structure&#39;}]}}</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">task_helper</span><span class="p">,</span> <span class="s1">&#39;get_final_structure&#39;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">final_structure</span> <span class="o">=</span> <span class="n">task_helper</span><span class="o">.</span><span class="n">get_final_structure</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">HelperError</span><span class="p">:</span>
                <span class="n">final_structure</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">except</span> <span class="n">PostProcessError</span><span class="p">:</span>
                <span class="n">final_structure</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">init_obj_info</span><span class="p">[</span><span class="s1">&#39;structure&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;object&#39;</span><span class="p">:</span> <span class="n">final_structure</span><span class="p">,</span>
                                          <span class="s1">&#39;updates&#39;</span><span class="p">:</span> <span class="p">[{</span><span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="s1">&#39;setup_task.abiinput&#39;</span><span class="p">,</span>
                                                       <span class="s1">&#39;setter&#39;</span><span class="p">:</span> <span class="s1">&#39;set_structure&#39;</span><span class="p">}]}</span>
        <span class="k">return</span> <span class="n">init_obj_info</span></div></div>

            <span class="c1"># initial_objects_info.update({&#39;queue_adapter&#39;: {&#39;object&#39;: self.run_fw.spec[&#39;qtk_queueadapter&#39;],</span>
            <span class="c1">#                                            &#39;updates&#39;: [{&#39;target&#39;: &#39;fw_spec&#39;,</span>
            <span class="c1">#                                                         &#39;key&#39;: &#39;qtk_queueadapter&#39;},</span>
            <span class="c1">#                                                        {&#39;target&#39;: &#39;fw_spec&#39;,</span>
            <span class="c1">#                                                         &#39;key&#39;: &#39;_queueadapter&#39;,</span>
            <span class="c1">#                                                         &#39;mod&#39;: &#39;get_subs_dict&#39;}]},</span>


<span class="c1">####################</span>
<span class="c1"># Helpers</span>
<span class="c1">####################</span>

<div class="viewcode-block" id="AbinitTaskHelper"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.AbinitTaskHelper">[docs]</a><span class="k">class</span> <span class="nc">AbinitTaskHelper</span><span class="p">(</span><span class="n">MSONable</span><span class="p">):</span>
    <span class="c1">#TODO add the task_type as an init parameter?</span>
    <span class="n">task_type</span> <span class="o">=</span> <span class="s1">&#39;abinit&#39;</span>

    <span class="n">CRITICAL_EVENTS</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="AbinitTaskHelper.set_task"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.AbinitTaskHelper.set_task">[docs]</a>    <span class="k">def</span> <span class="nf">set_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">task</span> <span class="o">=</span> <span class="n">task</span></div>

<div class="viewcode-block" id="AbinitTaskHelper.restart"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.AbinitTaskHelper.restart">[docs]</a>    <span class="k">def</span> <span class="nf">restart</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">restart_info</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Restart method. Each subclass should implement its own restart.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="AbinitTaskHelper.prepare_restart"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.AbinitTaskHelper.prepare_restart">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_restart</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="AbinitTaskHelper.conclude_task"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.AbinitTaskHelper.conclude_task">[docs]</a>    <span class="k">def</span> <span class="nf">conclude_task</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="AbinitTaskHelper.additional_update_spec"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.AbinitTaskHelper.additional_update_spec">[docs]</a>    <span class="k">def</span> <span class="nf">additional_update_spec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="AbinitTaskHelper.as_dict"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.AbinitTaskHelper.as_dict">[docs]</a>    <span class="nd">@pmg_serialize</span>
    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="AbinitTaskHelper.from_dict"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.AbinitTaskHelper.from_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="GsTaskHelper"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.GsTaskHelper">[docs]</a><span class="k">class</span> <span class="nc">GsTaskHelper</span><span class="p">(</span><span class="n">AbinitTaskHelper</span><span class="p">):</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">gsr_path</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Absolute path of the GSR file. Empty string if file is not present.&quot;&quot;&quot;</span>
        <span class="c1"># Lazy property to avoid multiple calls to has_abiext.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gsr_path</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">has_abiext</span><span class="p">(</span><span class="s2">&quot;GSR&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">path</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gsr_path</span> <span class="o">=</span> <span class="n">path</span>
            <span class="k">return</span> <span class="n">path</span>

<div class="viewcode-block" id="GsTaskHelper.open_gsr"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.GsTaskHelper.open_gsr">[docs]</a>    <span class="k">def</span> <span class="nf">open_gsr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Open the GSR file located in the in the task outdir.</span>
<span class="sd">        Returns :class:`GsrFile` object, raise a HelperError exception if file could not be found or file is not readable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">gsr_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gsr_path</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">gsr_path</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No GSR file available for task </span><span class="si">{}</span><span class="s2"> in </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">outdir</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">HelperError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Open the GSR file.</span>
        <span class="kn">from</span> <span class="nn">abipy.electrons.gsr</span> <span class="kn">import</span> <span class="n">GsrFile</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">GsrFile</span><span class="p">(</span><span class="n">gsr_path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Exception while reading GSR file at </span><span class="si">%s</span><span class="s2">:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">gsr_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">HelperError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ScfTaskHelper"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.ScfTaskHelper">[docs]</a><span class="k">class</span> <span class="nc">ScfTaskHelper</span><span class="p">(</span><span class="n">GsTaskHelper</span><span class="p">):</span>
    <span class="n">task_type</span> <span class="o">=</span> <span class="s2">&quot;scf&quot;</span>

    <span class="n">CRITICAL_EVENTS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">events</span><span class="o">.</span><span class="n">ScfConvergenceWarning</span><span class="p">,</span>
    <span class="p">]</span>

<div class="viewcode-block" id="ScfTaskHelper.restart"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.ScfTaskHelper.restart">[docs]</a>    <span class="k">def</span> <span class="nf">restart</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">restart_info</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;SCF calculations can be restarted if we have either the WFK file or the DEN file.&quot;&quot;&quot;</span>
        <span class="c1"># Prefer WFK over DEN files since we can reuse the wavefunctions.</span>
        <span class="k">if</span> <span class="n">restart_info</span> <span class="o">==</span> <span class="n">RESET_RESTART</span><span class="p">:</span>
            <span class="c1"># remove non reset keys that may have been added in a previous restart</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">remove_restart_vars</span><span class="p">([</span><span class="s2">&quot;WFK&quot;</span><span class="p">,</span> <span class="s2">&quot;DEN&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;WFK&quot;</span><span class="p">,</span> <span class="s2">&quot;DEN&quot;</span><span class="p">):</span>
                <span class="n">restart_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">prev_outdir</span><span class="o">.</span><span class="n">has_abiext</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>
                <span class="n">irdvars</span> <span class="o">=</span> <span class="n">irdvars_for_ext</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">restart_file</span><span class="p">:</span> <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Cannot find WFK or DEN file to restart from.&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">RestartError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="c1"># Move out --&gt; in.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">out_to_in</span><span class="p">(</span><span class="n">restart_file</span><span class="p">)</span>

            <span class="c1"># Add the appropriate variable for restarting.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">irdvars</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="NscfTaskHelper"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.NscfTaskHelper">[docs]</a><span class="k">class</span> <span class="nc">NscfTaskHelper</span><span class="p">(</span><span class="n">GsTaskHelper</span><span class="p">):</span>
    <span class="n">task_type</span> <span class="o">=</span> <span class="s2">&quot;nscf&quot;</span>

    <span class="n">CRITICAL_EVENTS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">events</span><span class="o">.</span><span class="n">NscfConvergenceWarning</span><span class="p">,</span>
    <span class="p">]</span>

<div class="viewcode-block" id="NscfTaskHelper.restart"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.NscfTaskHelper.restart">[docs]</a>    <span class="k">def</span> <span class="nf">restart</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">restart_info</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;NSCF calculations can be restarted only if we have the WFK file.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">restart_info</span> <span class="o">==</span> <span class="n">RESET_RESTART</span><span class="p">:</span>
            <span class="c1"># remove non reset keys that may have been added in a previous restart</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">remove_restart_vars</span><span class="p">([</span><span class="s2">&quot;WFK&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="s2">&quot;WFK&quot;</span>
            <span class="n">restart_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">prev_outdir</span><span class="o">.</span><span class="n">has_abiext</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">restart_file</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Cannot find the WFK file to restart from.&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">RestartError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="c1"># Move out --&gt; in.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">out_to_in</span><span class="p">(</span><span class="n">restart_file</span><span class="p">)</span>

            <span class="c1"># Add the appropriate variable for restarting.</span>
            <span class="n">irdvars</span> <span class="o">=</span> <span class="n">irdvars_for_ext</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">irdvars</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="RelaxTaskHelper"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.RelaxTaskHelper">[docs]</a><span class="k">class</span> <span class="nc">RelaxTaskHelper</span><span class="p">(</span><span class="n">GsTaskHelper</span><span class="p">):</span>
    <span class="n">task_type</span> <span class="o">=</span> <span class="s2">&quot;relax&quot;</span>

    <span class="n">CRITICAL_EVENTS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">events</span><span class="o">.</span><span class="n">RelaxConvergenceWarning</span><span class="p">,</span>
    <span class="p">]</span>

<div class="viewcode-block" id="RelaxTaskHelper.get_final_structure"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.RelaxTaskHelper.get_final_structure">[docs]</a>    <span class="k">def</span> <span class="nf">get_final_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read the final structure from the GSR file.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_gsr</span><span class="p">()</span> <span class="k">as</span> <span class="n">gsr</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">gsr</span><span class="o">.</span><span class="n">structure</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Cannot find the GSR file with the final structure.&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">PostProcessError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>

<div class="viewcode-block" id="RelaxTaskHelper.get_computed_entry"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.RelaxTaskHelper.get_computed_entry">[docs]</a>    <span class="k">def</span> <span class="nf">get_computed_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the computed entry from the GSR file.&quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_gsr</span><span class="p">()</span> <span class="k">as</span> <span class="n">gsr</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">gsr</span><span class="o">.</span><span class="n">get_computed_entry</span><span class="p">(</span><span class="n">inc_structure</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Cannot find the GSR file with the information to get the computed entry.&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">PostProcessError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>

    <span class="c1"># def prepare_restart(self):</span>
    <span class="c1">#     self.task.abiinput.set_structure(self.get_final_structure())</span>
    <span class="c1">#     return super().prepare_restart()</span>

<div class="viewcode-block" id="RelaxTaskHelper.restart"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.RelaxTaskHelper.restart">[docs]</a>    <span class="k">def</span> <span class="nf">restart</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">restart_info</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Restart the structural relaxation.</span>

<span class="sd">        See original RelaxTask for more details</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">restart_info</span> <span class="o">==</span> <span class="n">RESET_RESTART</span><span class="p">:</span>
            <span class="c1"># remove non reset keys that may have been added in a previous restart</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">remove_restart_vars</span><span class="p">([</span><span class="s2">&quot;WFK&quot;</span><span class="p">,</span> <span class="s2">&quot;DEN&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># for optcell &gt; 0 it may fail to restart if paral_kgb == 0. Do not use DEN or WFK in this case</span>
            <span class="c1">#FIXME fix when Matteo makes the restart possible for paral_kgb == 0</span>
            <span class="n">paral_kgb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;paral_kgb&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">optcell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;optcell&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">optcell</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">paral_kgb</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">restart_file</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="c1"># Try to restart from the WFK file if possible.</span>
                <span class="c1"># FIXME: This part has been disabled because WFK=IO is a mess if paral_kgb == 1</span>
                <span class="c1"># This is also the reason why I wrote my own MPI-IO code for the GW part!</span>
                <span class="n">wfk_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">prev_outdir</span><span class="o">.</span><span class="n">has_abiext</span><span class="p">(</span><span class="s2">&quot;WFK&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">wfk_file</span><span class="p">:</span>
                    <span class="n">irdvars</span> <span class="o">=</span> <span class="n">irdvars_for_ext</span><span class="p">(</span><span class="s2">&quot;WFK&quot;</span><span class="p">)</span>
                    <span class="n">restart_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">out_to_in</span><span class="p">(</span><span class="n">wfk_file</span><span class="p">)</span>

                <span class="c1"># Fallback to DEN file. Note that here we look for out_DEN instead of out_TIM?_DEN</span>
                <span class="c1"># This happens when the previous run completed and task.on_done has been performed.</span>
                <span class="c1"># ********************************************************************************</span>
                <span class="c1"># Note that it&#39;s possible to have an undected error if we have multiple restarts</span>
                <span class="c1"># and the last relax died badly. In this case indeed out_DEN is the file produced</span>
                <span class="c1"># by the last run that has executed on_done.</span>
                <span class="c1"># ********************************************************************************</span>
                <span class="k">if</span> <span class="n">restart_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">out_den</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">prev_outdir</span><span class="o">.</span><span class="n">path_in</span><span class="p">(</span><span class="s2">&quot;out_DEN&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">out_den</span><span class="p">):</span>
                        <span class="n">irdvars</span> <span class="o">=</span> <span class="n">irdvars_for_ext</span><span class="p">(</span><span class="s2">&quot;DEN&quot;</span><span class="p">)</span>
                        <span class="n">restart_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">out_to_in</span><span class="p">(</span><span class="n">out_den</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">restart_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Try to restart from the last TIM?_DEN file.</span>
                    <span class="c1"># This should happen if the previous run didn&#39;t complete in clean way.</span>
                    <span class="c1"># Find the last TIM?_DEN file.</span>
                    <span class="n">last_timden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">prev_outdir</span><span class="o">.</span><span class="n">find_last_timden_file</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">last_timden</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">ofile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">prev_outdir</span><span class="o">.</span><span class="n">path_in</span><span class="p">(</span><span class="s2">&quot;out_DEN&quot;</span><span class="p">)</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">last_timden</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">ofile</span><span class="p">)</span>
                        <span class="n">restart_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">out_to_in</span><span class="p">(</span><span class="n">ofile</span><span class="p">)</span>
                        <span class="n">irdvars</span> <span class="o">=</span> <span class="n">irdvars_for_ext</span><span class="p">(</span><span class="s2">&quot;DEN&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">restart_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Don&#39;t raise RestartError as the structure has been updated</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Cannot find the WFK|DEN|TIM?_DEN file to restart from.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Add the appropriate variable for restarting.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">irdvars</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Will restart from </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">restart_file</span><span class="p">)</span></div></div>

    <span class="c1"># def current_task_info(self, fw_spec):</span>
    <span class="c1">#     d = super().current_task_info(fw_spec)</span>
    <span class="c1">#     d[&#39;structure&#39;] = self.get_final_structure()</span>
    <span class="c1">#     return d</span>

    <span class="c1"># def conclude_task(self, fw_spec):</span>
    <span class="c1">#     update_spec, mod_spec, stored_data = super().conclude_task(fw_spec)</span>
    <span class="c1">#     update_spec[&#39;previous_run&#39;][&#39;structure&#39;] = self.get_final_structure()</span>
    <span class="c1">#     return update_spec, mod_spec, stored_data</span>


<div class="viewcode-block" id="DfptTaskHelper"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.DfptTaskHelper">[docs]</a><span class="k">class</span> <span class="nc">DfptTaskHelper</span><span class="p">(</span><span class="n">AbinitTaskHelper</span><span class="p">):</span>
    <span class="n">task_type</span> <span class="o">=</span> <span class="s2">&quot;dfpt&quot;</span>

    <span class="n">CRITICAL_EVENTS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">events</span><span class="o">.</span><span class="n">ScfConvergenceWarning</span><span class="p">,</span>
    <span class="p">]</span>

<div class="viewcode-block" id="DfptTaskHelper.restart"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.DfptTaskHelper.restart">[docs]</a>    <span class="k">def</span> <span class="nf">restart</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">restart_info</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Phonon calculations can be restarted only if we have the 1WF file or the 1DEN file.</span>
<span class="sd">        from which we can read the first-order wavefunctions or the first order density.</span>
<span class="sd">        Prefer 1WF over 1DEN since we can reuse the wavefunctions.</span>
<span class="sd">        Try to handle an input with many perturbation calculated at the same time. link/copy all the 1WF or 1DEN files</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Abinit adds the idir-ipert index at the end of the file and this breaks the extension</span>
        <span class="c1"># e.g. out_1WF4, out_DEN4. find_1wf_files and find_1den_files returns the list of files found</span>
        <span class="c1">#TODO check for reset</span>
        <span class="k">if</span> <span class="n">restart_info</span> <span class="o">==</span> <span class="n">RESET_RESTART</span><span class="p">:</span>
            <span class="c1"># remove non reset keys that may have been added in a previous restart</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">remove_restart_vars</span><span class="p">([</span><span class="s2">&quot;1WF&quot;</span><span class="p">,</span> <span class="s2">&quot;1DEN&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">restart_files</span><span class="p">,</span> <span class="n">irdvars</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

            <span class="c1"># Highest priority to the 1WF file because restart is more efficient.</span>
            <span class="n">wf_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">prev_outdir</span><span class="o">.</span><span class="n">find_1wf_files</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">wf_files</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">restart_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">path</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">wf_files</span><span class="p">]</span>
                <span class="n">irdvars</span> <span class="o">=</span> <span class="n">irdvars_for_ext</span><span class="p">(</span><span class="s2">&quot;1WF&quot;</span><span class="p">)</span>
                <span class="c1"># if len(wf_files) != 1:</span>
                <span class="c1">#     restart_files = None</span>
                <span class="c1">#     logger.critical(&quot;Found more than one 1WF file. Restart is ambiguous!&quot;)</span>

            <span class="k">if</span> <span class="n">restart_files</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">den_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">prev_outdir</span><span class="o">.</span><span class="n">find_1den_files</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">den_files</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">restart_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">path</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">den_files</span><span class="p">]</span>
                    <span class="n">irdvars</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;ird1den&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
                    <span class="c1"># if len(den_files) != 1:</span>
                    <span class="c1">#     restart_files = None</span>
                    <span class="c1">#     logger.critical(&quot;Found more than one 1DEN file. Restart is ambiguous!&quot;)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">restart_files</span><span class="p">:</span>
                <span class="c1"># Raise because otherwise restart is equivalent to a run from scratch --&gt; infinite loop!</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Cannot find the 1WF|1DEN file to restart from.&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">RestartError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="c1"># Move file.</span>
            <span class="k">for</span> <span class="n">restart_file</span> <span class="ow">in</span> <span class="n">restart_files</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">out_to_in</span><span class="p">(</span><span class="n">restart_file</span><span class="p">)</span>

            <span class="c1"># Add the appropriate variable for restarting.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">abiinput</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">irdvars</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="DdkTaskHelper"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.DdkTaskHelper">[docs]</a><span class="k">class</span> <span class="nc">DdkTaskHelper</span><span class="p">(</span><span class="n">DfptTaskHelper</span><span class="p">):</span>

    <span class="n">task_type</span> <span class="o">=</span> <span class="s2">&quot;ddk&quot;</span>

<div class="viewcode-block" id="DdkTaskHelper.conclude_task"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.DdkTaskHelper.conclude_task">[docs]</a>    <span class="k">def</span> <span class="nf">conclude_task</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># make a link to _DDK of the 1WF file to ease the link in the dependencies</span>
        <span class="n">wf_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">task</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">find_1wf_files</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">wf_files</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HelperError</span><span class="p">(</span><span class="s2">&quot;Couldn&#39;t link 1WF files.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">wf_files</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">path</span><span class="o">+</span><span class="s1">&#39;_DDK&#39;</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">conclude_task</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="DdeTaskHelper"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.DdeTaskHelper">[docs]</a><span class="k">class</span> <span class="nc">DdeTaskHelper</span><span class="p">(</span><span class="n">DfptTaskHelper</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="PhononTaskHelper"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.PhononTaskHelper">[docs]</a><span class="k">class</span> <span class="nc">PhononTaskHelper</span><span class="p">(</span><span class="n">DfptTaskHelper</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="BecTaskHelper"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.BecTaskHelper">[docs]</a><span class="k">class</span> <span class="nc">BecTaskHelper</span><span class="p">(</span><span class="n">DfptTaskHelper</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="StrainPertTaskHelper"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.StrainPertTaskHelper">[docs]</a><span class="k">class</span> <span class="nc">StrainPertTaskHelper</span><span class="p">(</span><span class="n">DfptTaskHelper</span><span class="p">):</span>
    <span class="n">task_type</span> <span class="o">=</span> <span class="s2">&quot;strain-pert&quot;</span></div>


<span class="c1">##############################</span>
<span class="c1"># Post-Processing tasks</span>
<span class="c1">##############################</span>


<div class="viewcode-block" id="Cut3DAbinitTaskOld"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.Cut3DAbinitTaskOld">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">Cut3DAbinitTaskOld</span><span class="p">(</span><span class="n">AbinitSRCMixin</span><span class="p">,</span> <span class="n">FireTaskBase</span><span class="p">):</span>
    <span class="n">task_type</span> <span class="o">=</span> <span class="s2">&quot;cut3d&quot;</span>

    <span class="n">CUT3D_OPTIONS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;den_to_cube&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cut3d_option</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cut3d_input_file</span><span class="o">=</span><span class="s1">&#39;cut3d.in&#39;</span><span class="p">,</span>
                 <span class="n">cut3d_log_file</span><span class="o">=</span><span class="s1">&#39;cut3d.log&#39;</span><span class="p">,</span> <span class="n">cut3d_err_file</span><span class="o">=</span><span class="s1">&#39;cut3d.err&#39;</span><span class="p">,</span> <span class="n">task_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        General constructor for Cut3D task.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deps</span> <span class="o">=</span> <span class="n">deps</span>
        <span class="k">if</span> <span class="n">cut3d_option</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">CUT3D_OPTIONS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Option &quot;</span><span class="si">{}</span><span class="s1">&quot; for cut3d is not allowed&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cut3d_option</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cut3d_option</span> <span class="o">=</span> <span class="n">cut3d_option</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cut3d_input_file</span> <span class="o">=</span> <span class="n">cut3d_input_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cut3d_log_file</span> <span class="o">=</span> <span class="n">cut3d_log_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cut3d_err_file</span> <span class="o">=</span> <span class="n">cut3d_err_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">task_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task_type</span> <span class="o">=</span> <span class="n">task_type</span>

<div class="viewcode-block" id="Cut3DAbinitTaskOld.run_cut3d"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.Cut3DAbinitTaskOld.run_cut3d">[docs]</a>    <span class="k">def</span> <span class="nf">run_cut3d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        executes cut3d and waits for the end of the process.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">cut3d_process</span><span class="p">():</span>
            <span class="n">command</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1">#consider the case of serial execution</span>
            <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="o">.</span><span class="n">fw_policy</span><span class="o">.</span><span class="n">cut3d_cmd</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cut3d_input_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stdin</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cut3d_log_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stdout</span><span class="p">,</span> \
                    <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cut3d_err_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stderr</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">stderr</span><span class="p">)</span>

            <span class="p">(</span><span class="n">stdoutdata</span><span class="p">,</span> <span class="n">stderrdata</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">returncode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">returncode</span>

        <span class="c1"># initialize returncode to avoid missing references in case of exception in the other thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returncode</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">cut3d_process</span><span class="p">)</span>
        <span class="c1"># the amount of time left plus a buffer of 2 minutes</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">walltime</span> <span class="o">-</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span> <span class="o">-</span> <span class="mi">120</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">walltime</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">WalltimeError</span><span class="p">(</span><span class="s2">&quot;The cut3d task couldn&#39;t be terminated within the time limit. Killed.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Cut3DAbinitTaskOld.setup_task"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.Cut3DAbinitTaskOld.setup_task">[docs]</a>    <span class="k">def</span> <span class="nf">setup_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># self.set_logger()</span>

        <span class="c1"># load the FWTaskManager to get configuration parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ftm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fw_task_manager</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">)</span>

        <span class="c1"># set walltime, if possible</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">walltime</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="o">.</span><span class="n">fw_policy</span><span class="o">.</span><span class="n">walltime_command</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="o">.</span><span class="n">fw_policy</span><span class="o">.</span><span class="n">walltime_command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                     <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
                <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">returncode</span>
                <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">walltime</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Impossible to get the walltime: &quot;</span> <span class="o">+</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Impossible to get the walltime: &quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="Cut3DAbinitTaskOld.resolve_deps"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.Cut3DAbinitTaskOld.resolve_deps">[docs]</a>    <span class="k">def</span> <span class="nf">resolve_deps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">previous_fws</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;previous_fws&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">previous_fws</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No previous_fws data. Needed for dependecies </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">InitializationError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="c1">#TODO: right now, only one file is allowed, in some uses of cut3d, this might not be enough</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Only one dependency for cut3d is allowed right now&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="c1"># check that there is only one previous_fws</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">previous_fws</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">previous_fws</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;previous_fws does not contain a single reference. &quot;</span> \
                      <span class="s2">&quot;Specify the dependency for </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">InitializationError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resolve_deps_per_task_type</span><span class="p">(</span><span class="n">previous_fws</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># deps should be a dict</span>
            <span class="k">for</span> <span class="n">task_type</span><span class="p">,</span> <span class="n">deps_list</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">task_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">previous_fws</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No previous_fws data for task type </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_type</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">InitializationError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">previous_fws</span><span class="p">[</span><span class="n">task_type</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Previous_fws does not contain any reference for task type </span><span class="si">{}</span><span class="s2">, &quot;</span> \
                          <span class="s2">&quot;needed in reference </span><span class="si">{}</span><span class="s2">. &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">InitializationError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">previous_fws</span><span class="p">[</span><span class="n">task_type</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Previous_fws contains more than a single reference for task type </span><span class="si">{}</span><span class="s2">, &quot;</span> \
                          <span class="s2">&quot;needed in reference </span><span class="si">{}</span><span class="s2">. Risk of overwriting.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resolve_deps_per_task_type</span><span class="p">(</span><span class="n">previous_fws</span><span class="p">[</span><span class="n">task_type</span><span class="p">],</span> <span class="n">deps_list</span><span class="p">)</span></div>

<div class="viewcode-block" id="Cut3DAbinitTaskOld.resolve_deps_per_task_type"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.Cut3DAbinitTaskOld.resolve_deps_per_task_type">[docs]</a>    <span class="k">def</span> <span class="nf">resolve_deps_per_task_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">previous_tasks</span><span class="p">,</span> <span class="n">deps_list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">previous_task</span> <span class="ow">in</span> <span class="n">previous_tasks</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">deps_list</span><span class="p">:</span>
                <span class="n">source_dir</span> <span class="o">=</span> <span class="n">previous_task</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">link_ext</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">source_dir</span><span class="p">)</span></div>

<div class="viewcode-block" id="Cut3DAbinitTaskOld.link_ext"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.Cut3DAbinitTaskOld.link_ext">[docs]</a>    <span class="k">def</span> <span class="nf">link_ext</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">source_dir</span><span class="p">):</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">odata</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">ext</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Need path </span><span class="si">{}</span><span class="s2"> with ext </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">ext</span><span class="p">))</span>
        <span class="n">dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">idata</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">ext</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
            <span class="c1"># Try netcdf file. TODO: this case should be treated in a cleaner way.</span>
            <span class="n">source</span> <span class="o">+=</span> <span class="s2">&quot;-etsf.nc&quot;</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">source</span><span class="p">):</span> <span class="n">dest</span> <span class="o">+=</span> <span class="s2">&quot;-etsf.nc&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> is needed by this task but it does not exist&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">InitializationError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="c1"># Link path to dest if dest link does not exist.</span>
        <span class="c1"># else check that it points to the expected file.</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Linking path </span><span class="si">{}</span><span class="s2"> --&gt; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;DEN&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;density&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dest</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InitializationError</span><span class="p">(</span><span class="s1">&#39;Only density files are allowed right now&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dest</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="o">.</span><span class="n">fw_policy</span><span class="o">.</span><span class="n">copy_deps</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dest</span></div>

<div class="viewcode-block" id="Cut3DAbinitTaskOld.run_task"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.Cut3DAbinitTaskOld.run_task">[docs]</a>    <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_task</span><span class="p">(</span><span class="n">fw_spec</span><span class="o">=</span><span class="n">fw_spec</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_rundir</span><span class="p">(</span><span class="n">rundir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">create_dirs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">directories_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">resolve_deps</span><span class="p">(</span><span class="n">fw_spec</span><span class="o">=</span><span class="n">fw_spec</span><span class="p">)</span>

        <span class="n">cube_filename</span> <span class="o">=</span> <span class="s1">&#39;density.cube&#39;</span>
        <span class="c1"># TODO: make this more general ?</span>
        <span class="kn">from</span> <span class="nn">abiflows.fireworks.tasks.abinit_common</span> <span class="kn">import</span> <span class="n">Cut3DInput</span>
        <span class="n">cut3d_input</span> <span class="o">=</span> <span class="n">Cut3DInput</span><span class="o">.</span><span class="n">den_to_cube</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;density&#39;</span><span class="p">],</span> <span class="n">cube_filename</span><span class="o">=</span><span class="n">cube_filename</span><span class="p">)</span>
        <span class="n">cut3d_input</span><span class="o">.</span><span class="n">write_input</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cut3d_input_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_cut3d</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">FWAction</span><span class="p">(</span><span class="n">update_spec</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;cut3d_directory&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s1">&#39;cube_filename&#39;</span><span class="p">:</span> <span class="n">cube_filename</span><span class="p">})</span></div>

<div class="viewcode-block" id="Cut3DAbinitTaskOld.den_to_cube"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.Cut3DAbinitTaskOld.den_to_cube">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">den_to_cube</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">deps</span><span class="p">,</span> <span class="n">task_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">task_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">task_type</span> <span class="o">=</span> <span class="s1">&#39;cut3d-den-to-cube&#39;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">cut3d_option</span><span class="o">=</span><span class="s1">&#39;den_to_cube&#39;</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="n">deps</span><span class="p">,</span> <span class="n">task_type</span><span class="o">=</span><span class="n">task_type</span><span class="p">)</span></div>

    <span class="nd">@serialize_fw</span>
    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">arg</span> <span class="o">!=</span> <span class="s2">&quot;self&quot;</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s2">&quot;as_dict&quot;</span><span class="p">):</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s2">&quot;as_dict&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span><span class="p">]</span>
                <span class="n">d</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

        <span class="k">return</span> <span class="n">d</span>

<div class="viewcode-block" id="Cut3DAbinitTaskOld.from_dict"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.Cut3DAbinitTaskOld.from_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="n">MontyDecoder</span><span class="p">()</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">dec</span><span class="o">.</span><span class="n">process_decoded</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                  <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)</span><span class="o">.</span><span class="n">args</span><span class="p">}</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="c1"># Prefixes for Abinit (input, output, temporary) files.</span>
    <span class="n">Prefix</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;Prefix&quot;</span><span class="p">,</span> <span class="s2">&quot;idata odata tdata&quot;</span><span class="p">)</span>
    <span class="n">pj</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span>

    <span class="n">prefix</span> <span class="o">=</span> <span class="n">Prefix</span><span class="p">(</span><span class="n">pj</span><span class="p">(</span><span class="s2">&quot;indata&quot;</span><span class="p">,</span> <span class="s2">&quot;in&quot;</span><span class="p">),</span> <span class="n">pj</span><span class="p">(</span><span class="s2">&quot;outdata&quot;</span><span class="p">,</span> <span class="s2">&quot;out&quot;</span><span class="p">),</span> <span class="n">pj</span><span class="p">(</span><span class="s2">&quot;tmpdata&quot;</span><span class="p">,</span> <span class="s2">&quot;tmp&quot;</span><span class="p">))</span>
    <span class="k">del</span> <span class="n">Prefix</span><span class="p">,</span> <span class="n">pj</span></div>


<div class="viewcode-block" id="Cut3DAbinitTask"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.Cut3DAbinitTask">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">Cut3DAbinitTask</span><span class="p">(</span><span class="n">AbinitSRCMixin</span><span class="p">,</span> <span class="n">FireTaskBase</span><span class="p">):</span>
    <span class="n">task_type</span> <span class="o">=</span> <span class="s2">&quot;cut3d&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cut3d_input</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">task_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        General constructor for Cut3D task.</span>
<span class="sd">        Structure needed for Hirshfeld</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deps</span> <span class="o">=</span> <span class="n">deps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cut3d_input</span> <span class="o">=</span> <span class="n">cut3d_input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="n">structure</span>
        <span class="k">if</span> <span class="n">task_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">task_type</span> <span class="o">=</span> <span class="n">task_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="Cut3DAbinitTask.run_cut3d"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.Cut3DAbinitTask.run_cut3d">[docs]</a>    <span class="k">def</span> <span class="nf">run_cut3d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        executes cut3d and waits for the end of the process.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">cut3d_process</span><span class="p">():</span>
            <span class="n">command</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1">#consider the case of serial execution</span>
            <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="o">.</span><span class="n">fw_policy</span><span class="o">.</span><span class="n">cut3d_cmd</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_file</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stdin</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_file</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stdout</span><span class="p">,</span> \
                    <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stderr_file</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stderr</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">stderr</span><span class="p">)</span>

            <span class="p">(</span><span class="n">stdoutdata</span><span class="p">,</span> <span class="n">stderrdata</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">returncode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">returncode</span>

        <span class="c1"># initialize returncode to avoid missing references in case of exception in the other thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returncode</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">cut3d_process</span><span class="p">)</span>
        <span class="c1"># the amount of time left plus a buffer of 2 minutes</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">walltime</span> <span class="o">-</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span> <span class="o">-</span> <span class="mi">120</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">walltime</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">WalltimeError</span><span class="p">(</span><span class="s2">&quot;The cut3d task couldn&#39;t be terminated within the time limit. Killed.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Cut3DAbinitTask.set_workdir"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.Cut3DAbinitTask.set_workdir">[docs]</a>    <span class="k">def</span> <span class="nf">set_workdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workdir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the working directory.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">workdir</span><span class="p">)</span>

        <span class="c1"># Files required for the execution.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s1">&#39;cut3d.in&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s1">&#39;cut3d.log&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stderr_file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s1">&#39;cut3d.err&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="Cut3DAbinitTask.setup_task"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.Cut3DAbinitTask.setup_task">[docs]</a>    <span class="k">def</span> <span class="nf">setup_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># self.set_logger()</span>

        <span class="c1"># load the FWTaskManager to get configuration parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ftm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fw_task_manager</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_workdir</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>

        <span class="c1"># set walltime, if possible</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">walltime</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="o">.</span><span class="n">fw_policy</span><span class="o">.</span><span class="n">walltime_command</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="o">.</span><span class="n">fw_policy</span><span class="o">.</span><span class="n">walltime_command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                     <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
                <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">returncode</span>
                <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">walltime</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Impossible to get the walltime: &quot;</span> <span class="o">+</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Impossible to get the walltime: &quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="Cut3DAbinitTask.resolve_deps"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.Cut3DAbinitTask.resolve_deps">[docs]</a>    <span class="k">def</span> <span class="nf">resolve_deps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">previous_fws</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;previous_fws&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">previous_fws</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No previous_fws data. Needed for dependecies </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">InitializationError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="c1">#TODO: right now, only one file is allowed, in some uses of cut3d, this might not be enough</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Only one dependency for cut3d is allowed right now&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="c1"># check that there is only one previous_fws</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">previous_fws</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">previous_fws</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;previous_fws does not contain a single reference. &quot;</span> \
                      <span class="s2">&quot;Specify the dependency for </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">InitializationError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resolve_deps_per_task_type</span><span class="p">(</span><span class="n">previous_fws</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># deps should be a dict</span>
            <span class="k">for</span> <span class="n">task_type</span><span class="p">,</span> <span class="n">deps_list</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">task_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">previous_fws</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;No previous_fws data for task type </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_type</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">InitializationError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">previous_fws</span><span class="p">[</span><span class="n">task_type</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Previous_fws does not contain any reference for task type </span><span class="si">{}</span><span class="s2">, &quot;</span> \
                          <span class="s2">&quot;needed in reference </span><span class="si">{}</span><span class="s2">. &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">InitializationError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">previous_fws</span><span class="p">[</span><span class="n">task_type</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Previous_fws contains more than a single reference for task type </span><span class="si">{}</span><span class="s2">, &quot;</span> \
                          <span class="s2">&quot;needed in reference </span><span class="si">{}</span><span class="s2">. Risk of overwriting.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deps</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">resolve_deps_per_task_type</span><span class="p">(</span><span class="n">previous_fws</span><span class="p">[</span><span class="n">task_type</span><span class="p">],</span> <span class="n">deps_list</span><span class="p">)</span></div>

<div class="viewcode-block" id="Cut3DAbinitTask.resolve_deps_per_task_type"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.Cut3DAbinitTask.resolve_deps_per_task_type">[docs]</a>    <span class="k">def</span> <span class="nf">resolve_deps_per_task_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">previous_tasks</span><span class="p">,</span> <span class="n">deps_list</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">previous_task</span> <span class="ow">in</span> <span class="n">previous_tasks</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">deps_list</span><span class="p">:</span>
                <span class="n">source_dir</span> <span class="o">=</span> <span class="n">previous_task</span><span class="p">[</span><span class="s1">&#39;dir&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">link_ext</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">source_dir</span><span class="p">)</span></div>

<div class="viewcode-block" id="Cut3DAbinitTask.link_ext"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.Cut3DAbinitTask.link_ext">[docs]</a>    <span class="k">def</span> <span class="nf">link_ext</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">source_dir</span><span class="p">):</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">source_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">odata</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">ext</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Need path </span><span class="si">{}</span><span class="s2"> with ext </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">ext</span><span class="p">))</span>
        <span class="n">dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">idata</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">ext</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
            <span class="c1"># Try netcdf file. TODO: this case should be treated in a cleaner way.</span>
            <span class="n">source</span> <span class="o">+=</span> <span class="s2">&quot;-etsf.nc&quot;</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">source</span><span class="p">):</span> <span class="n">dest</span> <span class="o">+=</span> <span class="s2">&quot;-etsf.nc&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">source</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> is needed by this task but it does not exist&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">InitializationError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="c1"># Link path to dest if dest link does not exist.</span>
        <span class="c1"># else check that it points to the expected file.</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Linking path </span><span class="si">{}</span><span class="s2"> --&gt; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s1">&#39;DEN&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;density&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dest</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InitializationError</span><span class="p">(</span><span class="s1">&#39;Only density files are allowed right now&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dest</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="o">.</span><span class="n">fw_policy</span><span class="o">.</span><span class="n">copy_deps</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">dest</span></div>

<div class="viewcode-block" id="Cut3DAbinitTask.run_task"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.Cut3DAbinitTask.run_task">[docs]</a>    <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_task</span><span class="p">(</span><span class="n">fw_spec</span><span class="o">=</span><span class="n">fw_spec</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_rundir</span><span class="p">(</span><span class="n">rundir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">create_dirs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">directories_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">resolve_deps</span><span class="p">(</span><span class="n">fw_spec</span><span class="o">=</span><span class="n">fw_spec</span><span class="p">)</span>

        <span class="c1">#TODO now it&#39;s just the filename as there are problems with full paths in cut3d, it should became the abspath</span>
        <span class="c1"># when it&#39;s fixed in abinit</span>
        <span class="n">converted_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cut3d_input</span><span class="o">.</span><span class="n">output_filepath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cut3d_input</span><span class="o">.</span><span class="n">infile_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;density&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cut3d_input</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_cut3d</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">FWAction</span><span class="p">(</span><span class="n">update_spec</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;cut3d_directory&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s1">&#39;converted_filename&#39;</span><span class="p">:</span> <span class="n">converted_filename</span><span class="p">})</span></div>

<div class="viewcode-block" id="Cut3DAbinitTask.den_to_cube"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.Cut3DAbinitTask.den_to_cube">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">den_to_cube</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">deps</span><span class="p">,</span> <span class="n">task_type</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">task_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">task_type</span> <span class="o">=</span> <span class="s1">&#39;cut3d-den-to-cube&#39;</span>

        <span class="n">cut3d_input</span> <span class="o">=</span> <span class="n">Cut3DInput</span><span class="o">.</span><span class="n">den_to_cube</span><span class="p">(</span><span class="n">density_filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_filepath</span><span class="o">=</span><span class="s1">&#39;density.cube&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">cut3d_input</span><span class="o">=</span><span class="n">cut3d_input</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="n">deps</span><span class="p">,</span> <span class="n">task_type</span><span class="o">=</span><span class="n">task_type</span><span class="p">)</span></div>

<div class="viewcode-block" id="Cut3DAbinitTask.hirshfeld"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.Cut3DAbinitTask.hirshfeld">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">hirshfeld</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">deps</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">task_type</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">all_el_dens_paths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fhi_all_el_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">task_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">task_type</span> <span class="o">=</span> <span class="s1">&#39;cut3d-hirshfeld&#39;</span>

        <span class="k">if</span> <span class="n">all_el_dens_paths</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">fhi_all_el_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;At least one source of all electron densities should be provided&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">all_el_dens_paths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cut3d_input</span> <span class="o">=</span> <span class="n">Cut3DInput</span><span class="o">.</span><span class="n">hirshfeld</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">all_el_dens_paths</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cut3d_input</span> <span class="o">=</span> <span class="n">Cut3DInput</span><span class="o">.</span><span class="n">hirshfeld_from_fhi_path</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">structure</span><span class="p">,</span> <span class="n">fhi_all_el_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">cut3d_input</span><span class="o">=</span><span class="n">cut3d_input</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">structure</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="n">deps</span><span class="p">,</span> <span class="n">task_type</span><span class="o">=</span><span class="n">task_type</span><span class="p">)</span></div>

<div class="viewcode-block" id="Cut3DAbinitTask.get_hirshfeld_charges"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.Cut3DAbinitTask.get_hirshfeld_charges">[docs]</a>    <span class="k">def</span> <span class="nf">get_hirshfeld_charges</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">hc</span> <span class="o">=</span> <span class="n">HirshfeldCharges</span><span class="o">.</span><span class="n">from_cut3d_outfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_file</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">hc</span></div>

    <span class="nd">@serialize_fw</span>
    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">arg</span> <span class="o">!=</span> <span class="s2">&quot;self&quot;</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s2">&quot;as_dict&quot;</span><span class="p">):</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s2">&quot;as_dict&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span><span class="p">]</span>
                <span class="n">d</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

        <span class="k">return</span> <span class="n">d</span>

<div class="viewcode-block" id="Cut3DAbinitTask.from_dict"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.Cut3DAbinitTask.from_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="n">MontyDecoder</span><span class="p">()</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">dec</span><span class="o">.</span><span class="n">process_decoded</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                  <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)</span><span class="o">.</span><span class="n">args</span><span class="p">}</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="c1"># Prefixes for Abinit (input, output, temporary) files.</span>
    <span class="n">Prefix</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;Prefix&quot;</span><span class="p">,</span> <span class="s2">&quot;idata odata tdata&quot;</span><span class="p">)</span>
    <span class="n">pj</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span>

    <span class="n">prefix</span> <span class="o">=</span> <span class="n">Prefix</span><span class="p">(</span><span class="n">pj</span><span class="p">(</span><span class="s2">&quot;indata&quot;</span><span class="p">,</span> <span class="s2">&quot;in&quot;</span><span class="p">),</span> <span class="n">pj</span><span class="p">(</span><span class="s2">&quot;outdata&quot;</span><span class="p">,</span> <span class="s2">&quot;out&quot;</span><span class="p">),</span> <span class="n">pj</span><span class="p">(</span><span class="s2">&quot;tmpdata&quot;</span><span class="p">,</span> <span class="s2">&quot;tmp&quot;</span><span class="p">))</span>
    <span class="k">del</span> <span class="n">Prefix</span><span class="p">,</span> <span class="n">pj</span></div>


<div class="viewcode-block" id="BaderTask"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.BaderTask">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">BaderTask</span><span class="p">(</span><span class="n">AbinitSRCMixin</span><span class="p">,</span> <span class="n">FireTaskBase</span><span class="p">):</span>
    <span class="n">task_type</span> <span class="o">=</span> <span class="s2">&quot;bader&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bader_log_file</span><span class="o">=</span><span class="s1">&#39;bader.log&#39;</span><span class="p">,</span> <span class="n">bader_err_file</span><span class="o">=</span><span class="s1">&#39;bader.err&#39;</span><span class="p">,</span> <span class="n">electrons</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        General constructor for Cut3D task.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bader_log_file</span> <span class="o">=</span> <span class="n">bader_log_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bader_err_file</span> <span class="o">=</span> <span class="n">bader_err_file</span>
        <span class="k">if</span> <span class="n">electrons</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">electrons</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;valence&#39;</span><span class="p">,</span> <span class="s1">&#39;all-electron&#39;</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Argument &quot;electrons&quot; should be &quot;valence&quot; or &quot;all-electron&quot;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">electrons</span> <span class="o">=</span> <span class="n">electrons</span>

<div class="viewcode-block" id="BaderTask.set_workdir"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.BaderTask.set_workdir">[docs]</a>    <span class="k">def</span> <span class="nf">set_workdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workdir</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="o">=</span> <span class="n">workdir</span></div>

<div class="viewcode-block" id="BaderTask.setup_task"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.BaderTask.setup_task">[docs]</a>    <span class="k">def</span> <span class="nf">setup_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># self.set_logger()</span>

        <span class="c1"># load the FWTaskManager to get configuration parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ftm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fw_task_manager</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">)</span>

        <span class="c1"># set walltime, if possible</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">walltime</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="o">.</span><span class="n">fw_policy</span><span class="o">.</span><span class="n">walltime_command</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftm</span><span class="o">.</span><span class="n">fw_policy</span><span class="o">.</span><span class="n">walltime_command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                                     <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
                <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">returncode</span>
                <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">walltime</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Impossible to get the walltime: &quot;</span> <span class="o">+</span> <span class="n">err</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Impossible to get the walltime: &quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaderTask.run_bader"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.BaderTask.run_bader">[docs]</a>    <span class="k">def</span> <span class="nf">run_bader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        executes bader and waits for the end of the process.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">bader_exe</span> <span class="o">=</span> <span class="n">which</span><span class="p">(</span><span class="s1">&#39;bader&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">bader_exe</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The bader executable is not in the PATH&#39;</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">bader_process</span><span class="p">():</span>
            <span class="n">command</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1">#consider the case of serial execution</span>
            <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bader_exe</span><span class="p">)</span>
            <span class="p">(</span><span class="n">cube_dirpath</span><span class="p">,</span> <span class="n">cube_filename</span><span class="p">)</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cube_filepath</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">symlink</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cube_filepath</span><span class="p">,</span> <span class="n">cube_filename</span><span class="p">)</span>
            <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cube_filename</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bader_log_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stdout</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bader_err_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stderr</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">stderr</span><span class="p">)</span>

            <span class="p">(</span><span class="n">stdoutdata</span><span class="p">,</span> <span class="n">stderrdata</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">returncode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">returncode</span>

        <span class="c1"># initialize returncode to avoid missing references in case of exception in the other thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">returncode</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">bader_process</span><span class="p">)</span>
        <span class="c1"># the amount of time left plus a buffer of 2 minutes</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">walltime</span> <span class="o">-</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span> <span class="o">-</span> <span class="mi">120</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">walltime</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">thread</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
            <span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">WalltimeError</span><span class="p">(</span><span class="s2">&quot;The cut3d task couldn&#39;t be terminated within the time limit. Killed.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="BaderTask.setup_rundir"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.BaderTask.setup_rundir">[docs]</a>    <span class="k">def</span> <span class="nf">setup_rundir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rundir</span><span class="p">,</span> <span class="n">create_dirs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">directories_only</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># Directories with input|output|temporary data.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">electrons</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bader_dir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rundir</span><span class="p">,</span> <span class="s1">&#39;bader&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bader_dir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rundir</span><span class="p">,</span> <span class="s1">&#39;bader&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">electrons</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rundir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bader_dir</span><span class="o">.</span><span class="n">path</span>

        <span class="c1"># Create dir for bader</span>
        <span class="k">if</span> <span class="n">create_dirs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bader_dir</span><span class="o">.</span><span class="n">makedirs</span><span class="p">()</span></div>

<div class="viewcode-block" id="BaderTask.run_task"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.BaderTask.run_task">[docs]</a>    <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_task</span><span class="p">(</span><span class="n">fw_spec</span><span class="o">=</span><span class="n">fw_spec</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cube_filepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">[</span><span class="s1">&#39;cut3d_directory&#39;</span><span class="p">],</span> <span class="n">fw_spec</span><span class="p">[</span><span class="s1">&#39;converted_filename&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_rundir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rundir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_bader</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">FWAction</span><span class="p">(</span><span class="n">update_spec</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;bader_directory&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">rundir</span><span class="p">})</span></div>

<div class="viewcode-block" id="BaderTask.get_bader_data"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.BaderTask.get_bader_data">[docs]</a>    <span class="k">def</span> <span class="nf">get_bader_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rundir</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;ACF.dat&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">raw</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">raw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
            <span class="n">raw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">l</span> <span class="o">=</span> <span class="n">raw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">):</span>
                    <span class="k">break</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">headers</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">vals</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">raw</span><span class="p">:</span>
                <span class="n">toks</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">toks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;VACUUM CHARGE&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vacuum_charge</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">toks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;VACUUM VOLUME&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vacuum_volume</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">toks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;NUMBER OF ELECTRONS&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nelectrons</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">toks</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">data</span></div>

    <span class="nd">@serialize_fw</span>
    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">arg</span> <span class="o">!=</span> <span class="s2">&quot;self&quot;</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s2">&quot;as_dict&quot;</span><span class="p">):</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s2">&quot;as_dict&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span><span class="p">]</span>
                <span class="n">d</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

        <span class="k">return</span> <span class="n">d</span>

<div class="viewcode-block" id="BaderTask.from_dict"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.BaderTask.from_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="n">MontyDecoder</span><span class="p">()</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">dec</span><span class="o">.</span><span class="n">process_decoded</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                  <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)</span><span class="o">.</span><span class="n">args</span><span class="p">}</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div></div>


<span class="c1">##############################</span>
<span class="c1"># Generation tasks</span>
<span class="c1">##############################</span>


<div class="viewcode-block" id="GeneratePiezoElasticFlowFWSRCAbinitTask"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.GeneratePiezoElasticFlowFWSRCAbinitTask">[docs]</a><span class="nd">@explicit_serialize</span>
<span class="k">class</span> <span class="nc">GeneratePiezoElasticFlowFWSRCAbinitTask</span><span class="p">(</span><span class="n">FireTaskBase</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">piezo_elastic_factory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">helper</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">previous_scf_task_type</span><span class="o">=</span><span class="n">ScfTaskHelper</span><span class="o">.</span><span class="n">task_type</span><span class="p">,</span>
                 <span class="n">previous_ddk_task_type</span><span class="o">=</span><span class="n">DdkTaskHelper</span><span class="o">.</span><span class="n">task_type</span><span class="p">,</span> <span class="n">control_procedure</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">additional_controllers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">mrgddb_task_type</span><span class="o">=</span><span class="s1">&#39;mrgddb-strains&#39;</span><span class="p">,</span>
                 <span class="n">rf_tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">additional_input_vars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rf_deps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">allow_parallel_perturbations</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">do_phonons</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">piezo_elastic_factory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">piezo_elastic_factory</span> <span class="o">=</span> <span class="n">PiezoElasticFromGsFactory</span><span class="p">(</span><span class="n">rf_tol</span><span class="o">=</span><span class="n">rf_tol</span><span class="p">,</span> <span class="n">rf_split</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">piezo_elastic_factory</span> <span class="o">=</span> <span class="n">piezo_elastic_factory</span>
        <span class="k">if</span> <span class="n">helper</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">helper</span> <span class="o">=</span> <span class="n">StrainPertTaskHelper</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">helper</span> <span class="o">=</span> <span class="n">helper</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">previous_scf_task_type</span> <span class="o">=</span> <span class="n">previous_scf_task_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">previous_ddk_task_type</span> <span class="o">=</span> <span class="n">previous_ddk_task_type</span>
        <span class="k">if</span> <span class="n">control_procedure</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">additional_controllers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">controllers</span> <span class="o">=</span> <span class="p">[</span><span class="n">AbinitController</span><span class="o">.</span><span class="n">from_helper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="p">),</span>
                               <span class="n">WalltimeController</span><span class="p">(),</span> <span class="n">MemoryController</span><span class="p">()]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">controllers</span> <span class="o">=</span> <span class="p">[</span><span class="n">AbinitController</span><span class="o">.</span><span class="n">from_helper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="p">)]</span>
                <span class="n">controllers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">additional_controllers</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control_procedure</span> <span class="o">=</span> <span class="n">ControlProcedure</span><span class="p">(</span><span class="n">controllers</span><span class="o">=</span><span class="n">controllers</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control_procedure</span> <span class="o">=</span> <span class="n">control_procedure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">additional_controllers</span> <span class="o">=</span> <span class="n">additional_controllers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mrgddb_task_type</span> <span class="o">=</span> <span class="n">mrgddb_task_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rf_tol</span> <span class="o">=</span> <span class="n">rf_tol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">additional_input_vars</span> <span class="o">=</span> <span class="n">additional_input_vars</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rf_deps</span> <span class="o">=</span> <span class="n">rf_deps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allow_parallel_perturbations</span> <span class="o">=</span> <span class="n">allow_parallel_perturbations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_phonons</span> <span class="o">=</span> <span class="n">do_phonons</span>

<div class="viewcode-block" id="GeneratePiezoElasticFlowFWSRCAbinitTask.run_task"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.GeneratePiezoElasticFlowFWSRCAbinitTask.run_task">[docs]</a>    <span class="k">def</span> <span class="nf">run_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>

        <span class="c1"># Get the previous SCF input</span>
        <span class="n">previous_scf_input</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;previous_fws&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_scf_task_type</span><span class="p">,</span>
                                                                 <span class="p">[{}])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">previous_scf_input</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InitializationError</span><span class="p">(</span><span class="s1">&#39;No input file available &#39;</span>
                                      <span class="s1">&#39;from task of type </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_scf_task_type</span><span class="p">))</span>
        <span class="n">ftm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_fw_task_manager</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">abipy.flowtkt</span> <span class="kn">import</span> <span class="n">tasks</span>
        <span class="n">tasks</span><span class="o">.</span><span class="n">_USER_CONFIG_TASKMANAGER</span> <span class="o">=</span> <span class="n">ftm</span><span class="o">.</span><span class="n">task_manager</span>

        <span class="c1"># Get the strain RF inputs</span>
        <span class="n">piezo_elastic_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">piezo_elastic_factory</span><span class="o">.</span><span class="n">build_input</span><span class="p">(</span><span class="n">previous_scf_input</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_phonons</span><span class="p">:</span>
            <span class="n">rf_strain_inputs</span> <span class="o">=</span> <span class="n">piezo_elastic_inputs</span><span class="o">.</span><span class="n">filter_by_tags</span><span class="p">(</span><span class="n">STRAIN</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rf_strain_inputs</span> <span class="o">=</span> <span class="n">piezo_elastic_inputs</span><span class="o">.</span><span class="n">filter_by_tags</span><span class="p">(</span><span class="n">STRAIN</span><span class="p">,</span> <span class="n">exclude_tags</span><span class="o">=</span><span class="n">PHONON</span><span class="p">)</span>

        <span class="n">initialization_info</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;initialization_info&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">initialization_info</span><span class="p">[</span><span class="s1">&#39;input_factory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">piezo_elastic_factory</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
        <span class="n">new_spec</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">initialization_info</span><span class="o">=</span><span class="n">initialization_info</span><span class="p">,</span> <span class="n">previous_fws</span><span class="o">=</span><span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;previous_fws&#39;</span><span class="p">,</span> <span class="p">{}))</span>
        <span class="n">initial_parameters</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;initial_parameters&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">initial_parameters</span><span class="p">:</span>
            <span class="n">new_spec</span><span class="p">[</span><span class="s1">&#39;initial_parameters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_parameters</span>

        <span class="k">if</span> <span class="s1">&#39;_preserve_fworker&#39;</span> <span class="ow">in</span> <span class="n">fw_spec</span><span class="p">:</span>
            <span class="n">new_spec</span><span class="p">[</span><span class="s1">&#39;_preserve_fworker&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="s1">&#39;_fworker&#39;</span> <span class="ow">in</span> <span class="n">fw_spec</span><span class="p">:</span>
            <span class="n">new_spec</span><span class="p">[</span><span class="s1">&#39;_fworker&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fw_spec</span><span class="p">[</span><span class="s1">&#39;_fworker&#39;</span><span class="p">]</span>

        <span class="c1"># Create the SRC fireworks for each perturbation</span>
        <span class="n">all_SRC_rf_fws</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">total_list_fws</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">strain_task_types</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fws_deps</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rf_deps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rf_deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rf_deps</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rf_deps</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_scf_task_type</span><span class="p">:</span> <span class="s1">&#39;WFK&#39;</span><span class="p">}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">previous_ddk_task_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">rf_deps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_ddk_task_type</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;DDK&#39;</span>

        <span class="n">prev_src_pert</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">istrain_pert</span><span class="p">,</span> <span class="n">rf_strain_input</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rf_strain_inputs</span><span class="p">):</span>
            <span class="n">strain_task_type</span> <span class="o">=</span> <span class="s1">&#39;strain-pert-</span><span class="si">{:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">istrain_pert</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">additional_input_vars</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">rf_strain_input</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">additional_input_vars</span><span class="p">)</span>
            <span class="n">rf_strain_input</span><span class="o">.</span><span class="n">set_vars</span><span class="p">(</span><span class="n">mem_test</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">setup_rf_task</span> <span class="o">=</span> <span class="n">AbinitSetupTask</span><span class="p">(</span><span class="n">abiinput</span><span class="o">=</span><span class="n">rf_strain_input</span><span class="p">,</span> <span class="n">task_helper</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="p">,</span>
                                            <span class="n">deps</span><span class="o">=</span><span class="n">rf_deps</span><span class="p">)</span>
            <span class="n">run_rf_task</span> <span class="o">=</span> <span class="n">AbinitRunTask</span><span class="p">(</span><span class="n">control_procedure</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">control_procedure</span><span class="p">,</span> <span class="n">task_helper</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="p">,</span>
                                        <span class="n">task_type</span><span class="o">=</span><span class="n">strain_task_type</span><span class="p">)</span>
            <span class="n">control_rf_task</span> <span class="o">=</span> <span class="n">AbinitControlTask</span><span class="p">(</span><span class="n">control_procedure</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">control_procedure</span><span class="p">,</span> <span class="n">task_helper</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">helper</span><span class="p">)</span>

            <span class="n">rf_fws</span> <span class="o">=</span> <span class="n">createSRCFireworks</span><span class="p">(</span><span class="n">setup_task</span><span class="o">=</span><span class="n">setup_rf_task</span><span class="p">,</span> <span class="n">run_task</span><span class="o">=</span><span class="n">run_rf_task</span><span class="p">,</span>
                                        <span class="n">control_task</span><span class="o">=</span><span class="n">control_rf_task</span><span class="p">,</span>
                                        <span class="n">spec</span><span class="o">=</span><span class="n">new_spec</span><span class="p">,</span> <span class="n">initialization_info</span><span class="o">=</span><span class="n">initialization_info</span><span class="p">)</span>
            <span class="n">all_SRC_rf_fws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rf_fws</span><span class="p">)</span>
            <span class="n">total_list_fws</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">rf_fws</span><span class="p">[</span><span class="s1">&#39;fws&#39;</span><span class="p">])</span>
            <span class="n">strain_task_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">strain_task_type</span><span class="p">)</span>
            <span class="n">links_dict_update</span><span class="p">(</span><span class="n">links_dict</span><span class="o">=</span><span class="n">fws_deps</span><span class="p">,</span> <span class="n">links_update</span><span class="o">=</span><span class="n">rf_fws</span><span class="p">[</span><span class="s1">&#39;links_dict&#39;</span><span class="p">])</span>
            <span class="c1"># Additional links if we want to avoid multiple perturbations to be run at the same time (e.g. to avoid</span>
            <span class="c1"># I/O bottlenecks because of reading the same file</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_parallel_perturbations</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">prev_src_pert</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">link_dict_update</span> <span class="o">=</span> <span class="p">{</span><span class="n">prev_src_pert</span><span class="p">[</span><span class="s1">&#39;control_fw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fw_id</span><span class="p">:</span> <span class="p">[</span><span class="n">rf_fws</span><span class="p">[</span><span class="s1">&#39;setup_fw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fw_id</span><span class="p">]}</span>
                    <span class="n">links_dict_update</span><span class="p">(</span><span class="n">links_dict</span><span class="o">=</span><span class="n">fws_deps</span><span class="p">,</span> <span class="n">links_update</span><span class="o">=</span><span class="n">link_dict_update</span><span class="p">)</span>
                <span class="n">prev_src_pert</span> <span class="o">=</span> <span class="n">rf_fws</span>

        <span class="c1"># Adding the MrgDdb Firework</span>
        <span class="n">mrgddb_spec</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">new_spec</span><span class="p">)</span>
        <span class="n">mrgddb_spec</span> <span class="o">=</span> <span class="n">set_short_single_core_to_spec</span><span class="p">(</span><span class="n">mrgddb_spec</span><span class="p">)</span>
        <span class="n">mrgddb_spec</span><span class="p">[</span><span class="s1">&#39;_priority&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="n">num_ddbs_to_be_merged</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_SRC_rf_fws</span><span class="p">)</span>
        <span class="n">mrgddb_fw</span> <span class="o">=</span> <span class="n">Firework</span><span class="p">(</span><span class="n">MergeDdbAbinitTask</span><span class="p">(</span><span class="n">ddb_source_task_types</span><span class="o">=</span><span class="n">strain_task_types</span><span class="p">,</span>
                                                <span class="n">num_ddbs</span><span class="o">=</span><span class="n">num_ddbs_to_be_merged</span><span class="p">,</span>
                                                <span class="n">delete_source_ddbs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                <span class="n">task_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mrgddb_task_type</span><span class="p">),</span>
                             <span class="n">spec</span><span class="o">=</span><span class="n">mrgddb_spec</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;mrgddb-strains&#39;</span><span class="p">)</span>
        <span class="n">total_list_fws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mrgddb_fw</span><span class="p">)</span>
        <span class="c1">#Adding the dependencies</span>
        <span class="k">for</span> <span class="n">src_fws</span> <span class="ow">in</span> <span class="n">all_SRC_rf_fws</span><span class="p">:</span>
            <span class="n">links_dict_update</span><span class="p">(</span><span class="n">links_dict</span><span class="o">=</span><span class="n">fws_deps</span><span class="p">,</span> <span class="n">links_update</span><span class="o">=</span><span class="p">{</span><span class="n">src_fws</span><span class="p">[</span><span class="s1">&#39;control_fw&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fw_id</span><span class="p">:</span> <span class="n">mrgddb_fw</span><span class="o">.</span><span class="n">fw_id</span><span class="p">})</span>

        <span class="n">rf_strains_wf</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">total_list_fws</span><span class="p">,</span> <span class="n">fws_deps</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">FWAction</span><span class="p">(</span><span class="n">detours</span><span class="o">=</span><span class="n">rf_strains_wf</span><span class="p">)</span></div>

    <span class="nd">@serialize_fw</span>
    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">arg</span> <span class="o">!=</span> <span class="s2">&quot;self&quot;</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__getattribute__</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s2">&quot;as_dict&quot;</span><span class="p">):</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s2">&quot;as_dict&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">val</span><span class="p">]</span>
                <span class="n">d</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

        <span class="k">return</span> <span class="n">d</span>

<div class="viewcode-block" id="GeneratePiezoElasticFlowFWSRCAbinitTask.from_dict"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.GeneratePiezoElasticFlowFWSRCAbinitTask.from_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="n">MontyDecoder</span><span class="p">()</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">dec</span><span class="o">.</span><span class="n">process_decoded</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                  <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)</span><span class="o">.</span><span class="n">args</span><span class="p">}</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="GeneratePiezoElasticFlowFWSRCAbinitTask.get_fw_task_manager"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.GeneratePiezoElasticFlowFWSRCAbinitTask.get_fw_task_manager">[docs]</a>    <span class="k">def</span> <span class="nf">get_fw_task_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fw_spec</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;ftm_file&#39;</span> <span class="ow">in</span> <span class="n">fw_spec</span><span class="p">:</span>
            <span class="n">ftm</span> <span class="o">=</span> <span class="n">FWTaskManager</span><span class="o">.</span><span class="n">from_file</span><span class="p">(</span><span class="n">fw_spec</span><span class="p">[</span><span class="s1">&#39;ftm_file&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ftm</span> <span class="o">=</span> <span class="n">FWTaskManager</span><span class="o">.</span><span class="n">from_user_config</span><span class="p">()</span>
        <span class="n">ftm</span><span class="o">.</span><span class="n">update_fw_policy</span><span class="p">(</span><span class="n">fw_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fw_policy&#39;</span><span class="p">,</span> <span class="p">{}))</span>
        <span class="k">return</span> <span class="n">ftm</span></div></div>


<span class="c1">####################</span>
<span class="c1"># Exceptions</span>
<span class="c1">####################</span>


<div class="viewcode-block" id="HelperError"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.HelperError">[docs]</a><span class="k">class</span> <span class="nc">HelperError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="InitializationError"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.InitializationError">[docs]</a><span class="k">class</span> <span class="nc">InitializationError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="RestartError"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.RestartError">[docs]</a><span class="k">class</span> <span class="nc">RestartError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="WalltimeError"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.WalltimeError">[docs]</a><span class="k">class</span> <span class="nc">WalltimeError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="PostProcessError"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.PostProcessError">[docs]</a><span class="k">class</span> <span class="nc">PostProcessError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>

<span class="c1">##############################</span>
<span class="c1"># Other objects</span>
<span class="c1">##############################</span>


<div class="viewcode-block" id="RestartInfo"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.RestartInfo">[docs]</a><span class="k">class</span> <span class="nc">RestartInfo</span><span class="p">(</span><span class="n">MSONable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Object that contains the information about the restart of a task.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">previous_dir</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">previous_dir</span> <span class="o">=</span> <span class="n">previous_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset</span> <span class="o">=</span> <span class="n">reset</span>

<div class="viewcode-block" id="RestartInfo.as_dict"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.RestartInfo.as_dict">[docs]</a>    <span class="nd">@pmg_serialize</span>
    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">previous_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_dir</span><span class="p">,</span> <span class="n">reset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reset</span><span class="p">)</span></div>

<div class="viewcode-block" id="RestartInfo.from_dict"><a class="viewcode-back" href="../../../../api/abiflows.fireworks.tasks.html#abiflows.fireworks.tasks.abinit_tasks_src.RestartInfo.from_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">previous_dir</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;previous_dir&#39;</span><span class="p">],</span> <span class="n">reset</span><span class="o">=</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;reset&#39;</span><span class="p">])</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">prev_outdir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Directory</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_dir</span><span class="p">,</span> <span class="n">OUTDIR_NAME</span><span class="p">))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">prev_indir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Directory</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">previous_dir</span><span class="p">,</span> <span class="n">INDIR_NAME</span><span class="p">))</span></div>


<span class="c1">#@deprecated(message=&quot;AbinitOutNcFile is deprecated, use abipy.abio.outputs.OutNcFile&quot;)</span>
<span class="k">class</span> <span class="nc">_AbinitOutNcFile</span><span class="p">(</span><span class="n">NetcdfReader</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class representing the _OUT.nc file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">get_vars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">vars</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># TODO: add a check on the variable names ?</span>
        <span class="n">default</span> <span class="o">=</span> <span class="n">NO_DEFAULT</span> <span class="k">if</span> <span class="n">strict</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">var_values</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">vars</span><span class="p">:</span>
            <span class="n">var_values</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="n">varname</span><span class="o">=</span><span class="n">var</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">default</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">var_values</span>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2017, The Abinit group.<br/>
      Last updated on May 29, 2020.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.2.0.<br/>
    </p>
  </div>
</footer>
  </body>
</html>